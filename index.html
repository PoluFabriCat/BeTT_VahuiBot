<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, viewport-fit=cover, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="color-scheme" content="dark light" />
  <title>–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ –¥–ª—è –î–∂–∞–º—ã</title>
  <style>
    /* ===========================
       Ultra-light SPA (Telegram WebView)
       GPU-friendly: transform/opacity only
       =========================== */

    :root{
      --bg0:#0c0d12;
      --bg1:#121427;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.14);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);
      --accent:#ff5fa2;
      --accent2:#ffb3d2;
      --ok:#39d98a;
      --warn:#ffcc66;
      --shadow: rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 22px;
      --pad: 16px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bot: env(safe-area-inset-bottom, 0px);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 900px at 50% -20%, rgba(255,95,162,.18), transparent 60%),
                  radial-gradient(900px 900px at 100% 40%, rgba(175,128,255,.14), transparent 60%),
                  radial-gradient(1000px 900px at 0% 80%, rgba(0,225,255,.10), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--txt);
      overflow:hidden;
      touch-action:none;
      user-select:none;
    }

    /* App root */
    .app{
      position:fixed; inset:0;
      display:flex;
      flex-direction:column;
      padding: calc(14px + var(--safe-top)) 14px calc(14px + var(--safe-bot));
      gap: 12px;
    }

    /* Top minimal HUD */
    .hud{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      opacity:.92;
      pointer-events:none;
    }
    .hud .badge{
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      box-shadow: 0 14px 40px rgba(0,0,0,.18);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      transform: translateZ(0);
    }
    .dot{
      width:10px; height:10px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, var(--accent));
      box-shadow: 0 0 0 2px rgba(255,95,162,.12);
    }
    .hud small{
      color:var(--muted);
      letter-spacing:.2px;
    }

    /* Scene container */
    .stage{
      position:relative;
      flex:1;
      min-height:0;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: 0 30px 100px rgba(0,0,0,.20);
      transform: translateZ(0);
    }

    /* Soft grain + cute "old TV" pixels */
    .fx{
      pointer-events:none;
      position:absolute; inset:-20px;
      opacity:.55;
      mix-blend-mode: overlay;
      transform: translateZ(0);
    }
    .fx:before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(0deg,
          rgba(255,255,255,.06) 0px,
          rgba(255,255,255,.06) 1px,
          rgba(255,255,255,0) 3px,
          rgba(255,255,255,0) 6px);
      opacity:.18;
      filter: blur(.0px);
    }
    .fx:after{
      content:"";
      position:absolute; inset:0;
      /* pixel-ish dither pattern */
      background-image:
        linear-gradient(90deg, rgba(255,255,255,.04) 1px, transparent 1px),
        linear-gradient(0deg,  rgba(255,255,255,.04) 1px, transparent 1px);
      background-size: 6px 6px, 6px 6px;
      opacity:.10;
      transform: translate3d(0,0,0);
    }

    /* Scanline shimmer */
    .scan{
      pointer-events:none;
      position:absolute; inset:-30%;
      background: linear-gradient(180deg,
        transparent 0%,
        rgba(255,255,255,.06) 46%,
        rgba(255,255,255,.08) 50%,
        rgba(255,255,255,.06) 54%,
        transparent 100%);
      opacity:.12;
      transform: translate3d(0,-60%,0);
      animation: scan 7.5s linear infinite;
      will-change: transform;
    }
    @keyframes scan{
      0%{ transform: translate3d(0,-70%,0); }
      100%{ transform: translate3d(0,70%,0); }
    }

    /* Particles canvas */
    canvas#particles{
      position:absolute; inset:0;
      pointer-events:none;
      transform: translateZ(0);
    }

    /* Scene pages */
    .scene{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 14px;
      padding: 18px;
      opacity:0;
      transform: translate3d(0,10px,0);
      transition: opacity 380ms ease, transform 380ms ease;
      will-change: opacity, transform;
    }
    .scene.active{
      opacity:1;
      transform: translate3d(0,0,0);
    }
    .scene.hidden{
      pointer-events:none;
    }

    .panel{
      width:min(520px, 92vw);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      box-shadow: 0 22px 70px rgba(0,0,0,.22);
      padding: 16px;
      transform: translateZ(0);
    }

    .row{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .title{
      font-size: 18px;
      letter-spacing: .2px;
    }
    .subtitle{
      margin-top:6px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.35;
    }

    .speech{
      display:flex;
      gap: 12px;
      align-items:flex-start;
    }
    .avatar{
      width: 54px; height: 54px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.75), rgba(255,255,255,0) 42%),
        radial-gradient(circle at 70% 20%, rgba(255,95,162,.35), rgba(255,255,255,0) 45%),
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      position:relative;
      flex:none;
      transform: translateZ(0);
      overflow:hidden;
    }
    .avatar:after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 50% 75%, rgba(0,0,0,.25), transparent 62%);
      opacity:.8;
    }
    .avatar i{
      position:absolute; inset:0;
      display:block;
      background:
        radial-gradient(circle at 50% 38%, rgba(255,255,255,.85) 0 18px, transparent 19px),
        radial-gradient(circle at 50% 72%, rgba(255,255,255,.85) 0 24px, transparent 25px),
        radial-gradient(circle at 35% 36%, rgba(0,0,0,.30) 0 3px, transparent 4px),
        radial-gradient(circle at 65% 36%, rgba(0,0,0,.30) 0 3px, transparent 4px);
      opacity:.55;
      transform: translateZ(0);
    }
    .bubble{
      flex:1;
      padding: 14px 14px;
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      color: var(--txt);
      line-height:1.35;
      font-size: 15px;
      transform: translateZ(0);
    }
    .bubble .name{
      color: var(--accent2);
      font-weight: 650;
      letter-spacing:.2px;
    }

    /* Buttons */
    .btns{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
      margin-top: 12px;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.11), rgba(255,255,255,.06));
      color: var(--txt);
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 600;
      letter-spacing:.15px;
      min-width: 96px;
      cursor:pointer;
      transform: translateZ(0);
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, opacity 180ms ease;
      touch-action: manipulation;
    }
    .btn:active{ transform: translate3d(0,1px,0) scale(.98); }
    .btn.primary{
      border-color: rgba(255,95,162,.30);
      background: linear-gradient(180deg, rgba(255,95,162,.28), rgba(255,255,255,.06));
      box-shadow: 0 18px 45px rgba(255,95,162,.12);
    }
    .btn.ghost{
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }
    .btn.danger{
      border-color: rgba(255,130,130,.30);
      background: linear-gradient(180deg, rgba(255,90,90,.22), rgba(255,255,255,.06));
    }
    .btn.icon{
      min-width: 0;
      width: 46px;
      padding: 12px 0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:0;
    }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    /* Modal sheet */
    .sheet{
      width:min(520px, 92vw);
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow: 0 24px 80px rgba(0,0,0,.28);
      padding: 16px;
      transform: translateZ(0);
      opacity:0;
      transform: translate3d(0,10px,0);
      transition: opacity 260ms ease, transform 260ms ease;
    }
    .sheet.show{
      opacity:1;
      transform: translate3d(0,0,0);
    }
    .sheet h3{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .sheet p{
      margin:8px 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height:1.35;
    }

    /* 3D object area */
    .object-area{
      width:min(560px, 92vw);
      height: min(52vh, 520px);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      transform: translateZ(0);
    }

    .hint{
      margin-top: 6px;
      color: var(--muted2);
      font-size: 13px;
      text-align:center;
      line-height:1.3;
    }

    .object3d{
      width: min(320px, 78vw);
      height: min(240px, 58vw);
      position:relative;
      transform-style: preserve-3d;
      will-change: transform;
      filter: none;
    }

    /* Card-like pseudo 3D box */
    .box{
      --w: min(320px, 78vw);
      --h: min(220px, 56vw);
      width: var(--w);
      height: var(--h);
      border-radius: 24px;
      position:relative;
      transform-style: preserve-3d;
    }
    .box .face{
      position:absolute;
      inset:0;
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(circle at 20% 10%, rgba(255,255,255,.16), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: 0 20px 70px rgba(0,0,0,.25);
      transform: translateZ(14px);
      overflow:hidden;
    }
    .box .face:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 75% 30%, rgba(255,95,162,.20), transparent 55%),
        radial-gradient(circle at 30% 70%, rgba(140,200,255,.14), transparent 55%);
      opacity:.9;
    }
    .label{
      position:absolute;
      left: 16px; right: 16px; top: 16px;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: var(--txt);
      font-weight: 650;
      letter-spacing:.2px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      transform: translateZ(0);
    }
    .label .to{
      color: var(--accent2);
      font-weight: 750;
    }

    .lock{
      position:absolute;
      left:50%; top: 58%;
      width: 86px; height: 86px;
      border-radius: 24px;
      transform: translate3d(-50%,-50%, 18px);
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.07));
      box-shadow: 0 18px 55px rgba(0,0,0,.26);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      will-change: transform, opacity;
    }
    .lock .shackle{
      position:absolute;
      top: 14px; left: 50%;
      width: 42px; height: 32px;
      border: 3px solid rgba(255,255,255,.55);
      border-bottom: none;
      border-radius: 18px 18px 0 0;
      transform: translateX(-50%);
      opacity:.9;
    }
    .lock .body{
      width: 44px; height: 34px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), rgba(255,255,255,.18));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 -10px 20px rgba(0,0,0,.10);
    }
    .lock.pulse{
      animation: pulse 1.4s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: translate3d(-50%,-50%, 18px) scale(1); }
      50%{ transform: translate3d(-50%,-50%, 18px) scale(1.05); }
    }
    .shake{
      animation: shake 420ms ease;
    }
    @keyframes shake{
      0%{ transform: translate3d(0,0,0); }
      20%{ transform: translate3d(-6px,0,0); }
      40%{ transform: translate3d(6px,0,0); }
      60%{ transform: translate3d(-4px,0,0); }
      80%{ transform: translate3d(4px,0,0); }
      100%{ transform: translate3d(0,0,0); }
    }

    /* Envelope */
    .envelope{
      width: min(320px, 78vw);
      height: min(220px, 56vw);
      border-radius: 26px;
      position:relative;
      transform-style: preserve-3d;
    }
    .envelope .card{
      position:absolute; inset:0;
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(circle at 20% 10%, rgba(255,255,255,.15), transparent 60%),
        radial-gradient(circle at 70% 30%, rgba(255,95,162,.16), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: 0 20px 75px rgba(0,0,0,.26);
      transform: translateZ(14px);
      overflow:hidden;
    }
    .envelope .tri{
      position:absolute; left:0; right:0; bottom:0; top:0;
      clip-path: polygon(0 0, 100% 0, 50% 55%);
      background: rgba(0,0,0,.18);
      border-radius: 26px;
      opacity:.6;
      transform: translateZ(16px);
    }
    .seal{
      position:absolute;
      left:50%; top: 58%;
      width: 84px; height: 84px;
      border-radius: 999px;
      transform: translate3d(-50%,-50%, 20px);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), rgba(255,255,255,.0) 48%),
        radial-gradient(circle at 50% 65%, rgba(255,95,162,.65), rgba(255,95,162,.20) 64%),
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 20px 70px rgba(255,95,162,.12), 0 22px 75px rgba(0,0,0,.28);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      color: rgba(20,10,18,.55);
      letter-spacing:.3px;
    }
    .seal span{
      transform: translateZ(0);
      font-size: 18px;
      opacity:.9;
      filter:none;
    }

    /* Lock mini-game */
    .overlay{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      opacity:0;
      pointer-events:none;
      transition: opacity 220ms ease;
      will-change: opacity;
    }
    .overlay.show{
      opacity:1;
      pointer-events:auto;
    }
    .overlay .modal{
      width:min(520px, 92vw);
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow: 0 30px 100px rgba(0,0,0,.30);
      padding: 16px;
      transform: translate3d(0,10px,0);
      transition: transform 220ms ease;
      will-change: transform;
    }
    .overlay.show .modal{ transform: translate3d(0,0,0); }

    .modal h3{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .modal .sub{
      margin-top:6px;
      color: var(--muted);
      font-size: 13.5px;
      line-height:1.35;
    }
    .wheels{
      margin-top: 12px;
      display:flex;
      gap:10px;
      justify-content:space-between;
    }
    .wheel{
      flex:1;
      height: 140px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      position:relative;
      touch-action:none;
      transform: translateZ(0);
    }
    .wheel .center-line{
      position:absolute;
      left:10px; right:10px;
      top:50%;
      height: 42px;
      transform: translateY(-50%);
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      pointer-events:none;
    }
    .wheel .list{
      position:absolute;
      left:0; right:0;
      top:50%;
      transform: translate3d(0,-50%,0);
      will-change: transform;
    }
    .wheel .item{
      height: 42px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 750;
      color: rgba(255,255,255,.85);
      letter-spacing:.2px;
      opacity:.42;
      transform: translateZ(0);
    }
    .wheel .item.active{
      opacity:1;
      color: var(--txt);
    }
    .wheel .hint2{
      position:absolute;
      left:10px; right:10px;
      bottom:10px;
      color: rgba(255,255,255,.45);
      font-size: 11.5px;
      text-align:center;
      pointer-events:none;
    }

    /* Date input */
    .dateRow{
      display:flex;
      gap:10px;
      margin-top: 12px;
      align-items:center;
    }
    .input{
      flex:1;
      border-radius: 16px;
      padding: 12px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      font-weight: 650;
      letter-spacing:.2px;
      outline:none;
      transform: translateZ(0);
    }
    .input::placeholder{ color: rgba(255,255,255,.45); font-weight: 600; }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12.5px;
    }
    .chip b{ color: var(--accent2); }

    /* Photo carousel */
    .photoWrap{
      width:min(520px, 92vw);
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      overflow:hidden;
      position:relative;
      transform: translateZ(0);
    }
    .photo{
      width:100%;
      height: min(46vh, 360px);
      display:block;
      object-fit: cover;
      opacity:0;
      transform: scale(1.02);
      transition: opacity 420ms ease, transform 420ms ease;
      will-change: opacity, transform;
    }
    .photo.show{
      opacity:1;
      transform: scale(1);
    }
    .photoOverlay{
      position:absolute; inset:0;
      background: radial-gradient(circle at 50% 20%, rgba(255,255,255,.10), transparent 60%),
                  linear-gradient(180deg, transparent 60%, rgba(0,0,0,.45));
      pointer-events:none;
    }
    .photoCaption{
      position:absolute; left:14px; right:14px; bottom:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(255,255,255,.82);
      font-size: 12.5px;
    }
    .dots{
      display:flex; gap:6px;
      align-items:center;
    }
    .dots i{
      width:8px; height:8px; border-radius:50%;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.06);
      opacity:.75;
    }
    .dots i.on{
      background: radial-gradient(circle at 30% 30%, #fff, var(--accent));
      border-color: rgba(255,95,162,.35);
      opacity:1;
    }

    /* Paper letter */
    .paper{
      width:min(520px, 92vw);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.18);
      background:
        repeating-linear-gradient(0deg,
          rgba(255,255,255,.05) 0px,
          rgba(255,255,255,.05) 1px,
          rgba(255,255,255,0) 10px,
          rgba(255,255,255,0) 22px),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      padding: 16px;
      box-shadow: 0 22px 80px rgba(0,0,0,.28);
      transform: translate3d(0,18px,0);
      opacity:0;
      transition: transform 420ms ease, opacity 420ms ease;
      will-change: transform, opacity;
    }
    .paper.show{
      transform: translate3d(0,0,0);
      opacity:1;
    }
    .paper .lines{
      color: rgba(255,255,255,.84);
      font-size: 14px;
      line-height: 1.55;
      white-space: pre-line;
      letter-spacing:.15px;
    }
    .paper .sig{
      margin-top: 10px;
      color: rgba(255,255,255,.70);
      font-size: 12.5px;
      display:flex;
      justify-content:flex-end;
    }

    /* Toast */
    .toast{
      position:absolute;
      left:50%;
      bottom: 18px;
      transform: translate3d(-50%, 20px,0);
      opacity:0;
      pointer-events:none;
      transition: opacity 220ms ease, transform 220ms ease;
      will-change: transform, opacity;
      padding: 12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.90);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.30);
      max-width: 92vw;
      text-align:center;
      font-weight: 650;
      letter-spacing:.2px;
    }
    .toast.show{
      opacity:1;
      transform: translate3d(-50%, 0,0);
    }

    /* Loader */
    .loader{
      position:fixed; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1200px 900px at 50% -20%, rgba(255,95,162,.20), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      z-index: 50;
    }
    .loaderCard{
      width:min(460px, 90vw);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: 0 30px 120px rgba(0,0,0,.28);
      padding: 16px;
    }
    .loaderTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .loaderTitle{
      font-weight: 800;
      letter-spacing:.2px;
      font-size: 15px;
    }
    .loaderMsg{
      margin-top:8px;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
    }
    .bar{
      margin-top: 12px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,95,162,.0), rgba(255,95,162,.55), rgba(255,255,255,.22));
      transform: translateZ(0);
      transition: width 180ms ease;
      will-change: width;
    }
    .smallRow{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: rgba(255,255,255,.65);
      font-size: 12.5px;
    }
    .dotsAnim{
      display:inline-flex;
      gap:4px;
      align-items:center;
    }
    .dotsAnim i{
      width:6px; height:6px; border-radius:50%;
      background: rgba(255,255,255,.45);
      opacity:.25;
      animation: d 1.1s ease-in-out infinite;
    }
    .dotsAnim i:nth-child(2){ animation-delay: .12s; }
    .dotsAnim i:nth-child(3){ animation-delay: .24s; }
    @keyframes d{
      0%,100%{ opacity:.25; transform: translate3d(0,0,0); }
      50%{ opacity:.90; transform: translate3d(0,-2px,0); }
    }

    /* Audio button */
    .audioBtn{
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.80);
      font-size: 12.5px;
      font-weight: 650;
      letter-spacing:.15px;
      cursor:pointer;
      transform: translateZ(0);
      transition: transform 120ms ease, opacity 180ms ease;
      touch-action: manipulation;
    }
    .audioBtn:active{ transform: translate3d(0,1px,0) scale(.98); }
    .audioBtn b{ color: var(--accent2); }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .scene, .sheet, .overlay, .paper, .photo, .scan { transition:none !important; animation:none !important; }
    }

    /* Small screens */
    @media (max-width: 360px){
      .btn{ min-width: 86px; padding: 11px 12px; }
      .bubble{ font-size: 14px; }
      .title{ font-size: 17px; }
    }
  </style>
</head>
<body>
  <!-- LOADER -->
  <div class="loader" id="loader">
    <div class="loaderCard">
      <div class="loaderTop">
        <div class="loaderTitle">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞–ª–µ–Ω—Ç–∏–Ω–∫–∏‚Ä¶</div>
        <div class="dotsAnim" aria-hidden="true"><i></i><i></i><i></i></div>
      </div>
      <div class="loaderMsg" id="loaderMsg">–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é –º–∞–≥–∏—é, —Ñ–æ—Ç–æ –∏ –∑–≤—É–∫ üòä</div>
      <div class="bar"><i id="barFill"></i></div>
      <div class="smallRow">
        <span id="progressText">0%</span>
        <span id="assetText">assets‚Ä¶</span>
      </div>
    </div>
  </div>

  <div class="app" id="app" style="opacity:0">
    <div class="hud">
      <div class="badge">
        <span class="dot"></span>
        <small id="hudText">–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ ‚Ä¢ –¥–ª—è –î–∂–∞–º—ã</small>
      </div>
      <button class="audioBtn" id="audioBtn" type="button" aria-label="–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫">
        <span id="audioIcon">üîá</span>
        <span><b>–ó–≤—É–∫</b> <span id="audioLabel">–≤—ã–∫–ª</span></span>
      </button>
    </div>

    <div class="stage" id="stage">
      <canvas id="particles"></canvas>
      <div class="fx" aria-hidden="true"></div>
      <div class="scan" aria-hidden="true"></div>

      <!-- Toast -->
      <div class="toast" id="toast"></div>

      <!-- Scene 1 -->
      <section class="scene active" id="scene1" aria-label="–°—Ü–µ–Ω–∞ 1: –ö—É—Ä—å–µ—Ä">
        <div class="panel">
          <div class="speech">
            <div class="avatar" aria-hidden="true"><i></i></div>
            <div class="bubble">
              <div><span class="name">–ö—É—Ä—å–µ—Ä:</span> <span id="courierLine">–í–∞–º –ø–æ—Å—ã–ª–∫–∞ –æ—Ç —Ñ–∞–Ω–∞—Ç–∞ üòâ</span></div>
              <div class="subtitle">–ü–æ–¥–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞. –≠—Ç–æ‚Ä¶ —Å—Ä–æ—á–Ω–æ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ.</div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="sheet" id="signSheet" role="dialog" aria-modal="true">
            <h3>–í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ø–æ—Å—ã–ª–∫—É –æ—Ç —Ñ–∞–Ω–∞—Ç–∞?</h3>
            <p>–ü–æ–¥–ø–∏—Å—å –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –∫—Ä–∞—Å–∏–≤–æ. –ü–æ—á—Ç–∏ –∫–∞–∫ —Å—É–¥—å–±–∞.</p>
            <div class="btns" id="signBtns">
              <button class="btn ghost" id="btnNo" type="button">–ù–µ—Ç</button>
              <button class="btn primary" id="btnYes" type="button">–î–∞</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Scene 2 -->
      <section class="scene hidden" id="scene2" aria-label="–°—Ü–µ–Ω–∞ 2: –ü–æ—Å—ã–ª–∫–∞">
        <div class="panel">
          <div class="row">
            <div>
              <div class="title">–ü–æ—Å—ã–ª–∫–∞</div>
              <div class="subtitle">–ü–æ–≤–µ—Ä–Ω–∏ –ø–∞–ª—å—Ü–µ–º. –ù–∞–∂–º–∏ –Ω–∞ –∑–∞–º–æ–∫.</div>
            </div>
            <div class="chip">–∞–¥—Ä–µ—Å–∞—Ç: <b>–î–∂–∞–º–∞</b></div>
          </div>
        </div>

        <div class="object-area">
          <div class="object3d" id="boxObj" aria-label="3D –∫–æ—Ä–æ–±–∫–∞">
            <div class="box">
              <div class="face">
                <div class="label">
                  <span>–¥–ª—è <span class="to">–î–∂–∞–º—ã</span></span>
                  <span style="color:rgba(255,255,255,.60); font-weight:700;">‚ô•</span>
                </div>
                <button class="lock pulse" id="lockBtn" type="button" aria-label="–ó–∞–º–æ–∫">
                  <div class="shackle"></div>
                  <div class="body"></div>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="hint">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π, —á—Ç–æ–±—ã –∫—Ä—É—Ç–∏—Ç—å (–µ—Å—Ç—å –∏–Ω–µ—Ä—Ü–∏—è). –°–∫–æ—Ä–æ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞.</div>

        <!-- Lock overlay -->
        <div class="overlay" id="lockOverlay" aria-hidden="true">
          <div class="modal">
            <h3>–ö–æ–¥–æ–≤—ã–π –∑–∞–º–æ–∫</h3>
            <div class="sub">–ü—Ä–æ–∫—Ä—É—Ç–∏ –∫–æ–ª—ë—Å–∏–∫–∏ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑. –§–æ—Ä–º–∞—Ç: –¥–µ–Ω—å ‚Ä¢ –º–µ—Å—è—Ü ‚Ä¢ –≥–æ–¥</div>

            <div class="wheels" id="wheels">
              <div class="wheel" data-wheel="day" aria-label="–î–µ–Ω—å">
                <div class="center-line"></div>
                <div class="list"></div>
                <div class="hint2">–¥–µ–Ω—å</div>
              </div>
              <div class="wheel" data-wheel="month" aria-label="–ú–µ—Å—è—Ü">
                <div class="center-line"></div>
                <div class="list"></div>
                <div class="hint2">–º–µ—Å—è—Ü</div>
              </div>
              <div class="wheel" data-wheel="year" aria-label="–ì–æ–¥">
                <div class="center-line"></div>
                <div class="list"></div>
                <div class="hint2">–≥–æ–¥</div>
              </div>
            </div>

            <div class="btns" style="justify-content:space-between;">
              <button class="btn ghost" id="lockBack" type="button">–ù–∞–∑–∞–¥</button>
              <button class="btn primary" id="lockDone" type="button">–ì–æ—Ç–æ–≤–æ</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Scene 3 -->
      <section class="scene hidden" id="scene3" aria-label="–°—Ü–µ–Ω–∞ 3: –ö–æ–Ω–≤–µ—Ä—Ç">
        <div class="panel" id="scene3Panel">
          <div class="row">
            <div>
              <div class="title">–ö–æ–Ω–≤–µ—Ä—Ç —Å –ø–µ—á–∞—Ç—å—é</div>
              <div class="subtitle">–ú–æ–∂–Ω–æ –∫—Ä—É—Ç–∏—Ç—å. –ò –ª—É—á—à–µ –±—ã –æ—Ç–∫—Ä—ã—Ç—å üôÇ</div>
            </div>
            <div class="chip">—É—Ä–æ–≤–µ–Ω—å –º–∏–ª–æ—Ç—ã: <b>–º–∞–∫—Å</b></div>
          </div>
          <div class="btns" id="envBtns">
            <button class="btn danger" id="btnThrow" type="button">–í—ã–±—Ä–æ—Å–∏—Ç—å</button>
            <button class="btn primary" id="btnOpen" type="button">–û—Ç–∫—Ä—ã—Ç—å</button>
          </div>
        </div>

        <div class="object-area">
          <div class="object3d" id="envObj" aria-label="3D –∫–æ–Ω–≤–µ—Ä—Ç">
            <div class="envelope">
              <div class="card"></div>
              <div class="tri"></div>
              <div class="seal" id="seal">
                <span>J</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Seal zoom / birthday input -->
        <div class="overlay" id="sealOverlay" aria-hidden="true">
          <div class="modal" id="sealModal">
            <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥</h3>
            <div class="sub">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ñ–∞–Ω–∞—Ç–∞ (—Ñ–æ—Ä–º–∞—Ç: –î–î.–ú–ú.–ì–ì–ì–ì)</div>

            <div class="dateRow">
              <input class="input" id="bdayInput" inputmode="numeric" placeholder="01.02.2005" maxlength="10" />
              <button class="btn primary icon" id="bdayOk" type="button" aria-label="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å">‚úì</button>
            </div>
            <div class="sub" id="bdayHint" style="margin-top:10px; opacity:.85;">
              –ü–æ–¥—Å–∫–∞–∑–∫–∞: —ç—Ç–æ –æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ –∫ –Ω–∞—á–∞–ª—É —Ñ–µ–≤—Ä–∞–ª—è.
            </div>

            <div class="btns" style="justify-content:flex-start;">
              <button class="btn ghost" id="sealBack" type="button">–ù–∞–∑–∞–¥</button>
            </div>
          </div>
        </div>

        <!-- Final montage -->
        <div class="panel" id="finalPanel" style="display:none;">
          <div class="title">–û—Ç–∫—Ä—ã–ª–æ—Å—å üíò</div>
          <div class="subtitle">–ù–µ–º–Ω–æ–≥–æ —Å–≤–µ—Ç–∞, –Ω–µ–º–Ω–æ–≥–æ —Å–µ—Ä–¥–µ—á–µ–∫‚Ä¶ –∏ –≥–ª–∞–≤–Ω–æ–µ ‚Äî –ø–∏—Å—å–º–æ.</div>
        </div>

        <div class="photoWrap" id="photoWrap" style="display:none;">
          <img class="photo" id="photoEl" alt="–ù–∞—à–µ —Ñ–æ—Ç–æ" />
          <div class="photoOverlay"></div>
          <div class="photoCaption">
            <span id="photoIdx">1/4</span>
            <span class="dots" id="photoDots" aria-hidden="true"></span>
          </div>
        </div>

        <div class="paper" id="paper" style="display:none;">
          <div class="lines" id="letterText">
–ü—Ä–∏–≤–µ—Ç, –î–∂–∞–º–∞.

[–¢–£–¢ –ë–£–î–ï–¢ –¢–í–û–ô –¢–ï–ö–°–¢ ‚Äî 6‚Äì10 —Å—Ç—Ä–æ–∫]
–ù–∞–ø—Ä–∏–º–µ—Ä:
‚Äî –Ø —Ö–æ—Ç–µ–ª —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ —á—É—Ç—å –∏–Ω–∞—á–µ, —á–µ–º –æ–±—ã—á–Ω–æ.
‚Äî –ß—Ç–æ–±—ã —Ç—ã —É–ª—ã–±–Ω—É–ª–∞—Å—å –Ω–µ –Ω–∞ —Å–µ–∫—É–Ω–¥—É, –∞ –ø–æ–¥–æ–ª—å—à–µ.
‚Äî –¢—ã –ø—Ä–∞–≤–¥–∞ –æ—Å–æ–±–µ–Ω–Ω–∞—è.
‚Äî –ò —è —Ä–∞–¥, —á—Ç–æ –º–æ–≥—É –±—ã—Ç—å —Ä—è–¥–æ–º (—Ö–æ—Ç—è –±—ã —Ç–∞–∫).
‚Äî –° –î–Ω—ë–º –í–∞–ª–µ–Ω—Ç–∏–Ω–∞, –∫—Ä–∞—Å–∞–≤–∏—Ü–∞.
‚Äî ‚ù§Ô∏è
          </div>
          <div class="sig">‚Äî —Ç–≤–æ–π —Ñ–∞–Ω–∞—Ç</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Audio (local files —Ä—è–¥–æ–º) -->
  <!-- –ü–æ–ª–æ–∂–∏ —Ñ–∞–π–ª—ã —Ä—è–¥–æ–º: Audio/bgm.mp3, Audio/click.mp3, Audio/success.mp3, Audio/error.mp3 -->
  <audio id="bgm" src="Audio/bgm.mp3" preload="auto" loop></audio>
  <audio id="sClick" src="Audio/click.mp3" preload="auto"></audio>
  <audio id="sSuccess" src="Audio/success.mp3" preload="auto"></audio>
  <audio id="sError" src="Audio/error.mp3" preload="auto"></audio>

  <script>
  (() => {
    "use strict";

    /* ===========================
       CONFIG: images in Images/
       Choose 3‚Äì4 photos max
       =========================== */
    const IMAGES = [
      "Images/photo1.jpg",
      "Images/photo2.jpg",
      "Images/photo3.jpg",
      "Images/photo4.jpg",
    ];

    // Required codes
    const LOCK_CODE = { day: 5, monthIndex: 10, year: 2025 }; // November is 10 in 0-based monthIndex? We'll store months list and compare by value (november index 10 if list starts Jan=0)
    const BDAY_CODE = "01.02.2005"; // DD.MM.YYYY

    // Months (RU)
    const MONTHS = [
      "—è–Ω–≤–∞—Ä—å","—Ñ–µ–≤—Ä–∞–ª—å","–º–∞—Ä—Ç","–∞–ø—Ä–µ–ª—å","–º–∞–π","–∏—é–Ω—å",
      "–∏—é–ª—å","–∞–≤–≥—É—Å—Ç","—Å–µ–Ω—Ç—è–±—Ä—å","–æ–∫—Ç—è–±—Ä—å","–Ω–æ—è–±—Ä—å","–¥–µ–∫–∞–±—Ä—å"
    ];

    // DOM
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

    const loader = $("#loader");
    const barFill = $("#barFill");
    const progressText = $("#progressText");
    const assetText = $("#assetText");
    const loaderMsg = $("#loaderMsg");
    const app = $("#app");

    const stage = $("#stage");
    const toast = $("#toast");

    const scene1 = $("#scene1");
    const scene2 = $("#scene2");
    const scene3 = $("#scene3");

    const courierLine = $("#courierLine");
    const signSheet = $("#signSheet");
    const btnNo = $("#btnNo");
    const btnYes = $("#btnYes");

    const boxObj = $("#boxObj");
    const lockBtn = $("#lockBtn");
    const lockOverlay = $("#lockOverlay");
    const lockBack = $("#lockBack");
    const lockDone = $("#lockDone");

    const envObj = $("#envObj");
    const btnThrow = $("#btnThrow");
    const btnOpen = $("#btnOpen");

    const sealOverlay = $("#sealOverlay");
    const sealModal = $("#sealModal");
    const bdayInput = $("#bdayInput");
    const bdayOk = $("#bdayOk");
    const bdayHint = $("#bdayHint");
    const sealBack = $("#sealBack");
    const sealEl = $("#seal");

    const finalPanel = $("#finalPanel");
    const photoWrap = $("#photoWrap");
    const photoEl = $("#photoEl");
    const photoIdx = $("#photoIdx");
    const photoDots = $("#photoDots");
    const paper = $("#paper");

    const hudText = $("#hudText");
    const audioBtn = $("#audioBtn");
    const audioIcon = $("#audioIcon");
    const audioLabel = $("#audioLabel");

    // Audio
    const bgm = $("#bgm");
    const sClick = $("#sClick");
    const sSuccess = $("#sSuccess");
    const sError = $("#sError");

    // State
    const state = {
      scene: 1,
      noUsed: false,
      audioEnabled: false,
      raf: 0,
      t0: performance.now(),
      // 3D physics (box)
      box: { yaw: 0, pitch: -10, vyaw: 0, vpitch: 0, dragging: false, lx: 0, ly: 0 },
      // 3D physics (envelope)
      env: { yaw: 0, pitch: -8, vyaw: 0, vpitch: 0, dragging: false, lx: 0, ly: 0 },
      // wheels
      wheels: { day: 1, month: 0, year: 2025 },
      // photos
      photoIndex: 0,
      photoTimer: 0,
      unlocked: false,
      opened: false,
    };

    /* ===========================
       Helpers (micro, GPU-safe)
       =========================== */
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const lerp = (a,b,t) => a + (b-a)*t;
    const now = () => performance.now();

    function addShake(el){
      el.classList.remove("shake");
      // reflow to restart animation
      void el.offsetWidth;
      el.classList.add("shake");
    }

    let toastTimer = 0;
    function showToast(text, ms=1400){
      toast.textContent = text;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove("show"), ms);
    }

    function playSfx(aud, vol=0.85){
      if(!state.audioEnabled) return;
      try{
        aud.pause();
        aud.currentTime = 0;
        aud.volume = vol;
        aud.play().catch(()=>{});
      }catch(e){}
    }

    function setScene(n){
      state.scene = n;
      const all = [scene1, scene2, scene3];
      all.forEach((s, i) => {
        const isActive = (i+1) === n;
        s.classList.toggle("active", isActive);
        s.classList.toggle("hidden", !isActive);
      });

      if(n === 1) hudText.textContent = "–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ ‚Ä¢ –∫—É—Ä—å–µ—Ä";
      if(n === 2) hudText.textContent = "–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ ‚Ä¢ –ø–æ—Å—ã–ª–∫–∞";
      if(n === 3) hudText.textContent = "–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ ‚Ä¢ –∫–æ–Ω–≤–µ—Ä—Ç";
    }

    function reveal(el, show){
      if(show) el.classList.add("show");
      else el.classList.remove("show");
    }

    /* ===========================
       Preload images + audio
       =========================== */
    async function preload(){
      const assets = [];
      // images: pick up to 4 —Ä–µ–∞–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö ‚Äî –µ—Å–ª–∏ —É —Ç–µ–±—è 3 —Ñ–æ—Ç–æ, –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏ –æ–¥–∏–Ω –ø—É—Ç—å –∏–∑ IMAGES.
      IMAGES.forEach(src => assets.push({type:"img", src}));
      // audio
      assets.push({type:"aud", el:bgm});
      assets.push({type:"aud", el:sClick});
      assets.push({type:"aud", el:sSuccess});
      assets.push({type:"aud", el:sError});

      let loaded = 0;
      const total = assets.length;

      function update(){
        const p = Math.round((loaded/total)*100);
        barFill.style.width = p + "%";
        progressText.textContent = p + "%";
        assetText.textContent = `${loaded}/${total}`;
      }
      update();

      // Preload images (with graceful fallback)
      const imgPromises = IMAGES.map((src) => new Promise((res) => {
        const img = new Image();
        img.onload = () => { loaded++; update(); res({src, ok:true}); };
        img.onerror = () => { loaded++; update(); res({src, ok:false}); };
        img.src = src;
      }));

      // Preload audio metadata
      const audPromises = [bgm, sClick, sSuccess, sError].map((a) => new Promise((res) => {
        const done = () => { loaded++; update(); cleanup(); res(true); };
        const fail = () => { loaded++; update(); cleanup(); res(false); };
        const cleanup = () => {
          a.removeEventListener("canplaythrough", done);
          a.removeEventListener("loadeddata", done);
          a.removeEventListener("error", fail);
        };
        a.addEventListener("canplaythrough", done, {once:true});
        a.addEventListener("loadeddata", done, {once:true});
        a.addEventListener("error", fail, {once:true});
        // trigger load
        try{ a.load(); }catch(e){}
        // fallback timeout (mobile can be strict)
        setTimeout(() => { if(loaded < total) { /* do nothing */ } }, 2500);
      }));

      loaderMsg.textContent = "–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ. –°–µ–π—á–∞—Å –±—É–¥–µ—Ç –∫—Ä–∞—Å–∏–≤–æ.";

      await Promise.all([...imgPromises, ...audPromises]);

      // Hide loader
      loader.style.opacity = "0";
      loader.style.transition = "opacity 280ms ease";
      setTimeout(() => {
        loader.style.display = "none";
        app.style.opacity = "1";
        app.style.transition = "opacity 320ms ease";
        // show sheet
        setTimeout(() => signSheet.classList.add("show"), 220);
      }, 260);
    }

    /* ===========================
       Scene 1 logic
       =========================== */
    btnNo.addEventListener("click", () => {
      playSfx(sClick, .75);
      signSheet.classList.remove("show");
      courierLine.textContent = "–í—ã —á—Ç–æ, –±–∞–ª–±–µ—Å? –ù–∞ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –ø—Ä–æ—â–∞—é.";
      state.noUsed = true;

      // Return paper, but only "–î–∞"
      setTimeout(() => {
        signSheet.classList.add("show");
        btnNo.style.display = "none";
      }, 620);
    });

    btnYes.addEventListener("click", () => {
      playSfx(sClick, .75);
      // Courier hands box (quick micro animation with toast)
      signSheet.classList.remove("show");
      courierLine.textContent = "–ü–µ—Ä–µ–¥–∞—é –ø–æ—Å—ã–ª–∫—É. –ë–µ—Ä–µ–∂–Ω–æ! –¢–∞–º‚Ä¶ –≤–∞–∂–Ω–æ–µ.";
      showToast("–ü–æ—Å—ã–ª–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞ ‚ú®", 1100);

      // Transition to scene 2
      setTimeout(() => {
        setScene(2);
        // Make lock pulse
        lockBtn.classList.add("pulse");
      }, 980);
    });

    /* ===========================
       3D drag physics
       =========================== */
    function attachSpin(el, model){
      // model: state.box or state.env
      const SPEED = 0.22;    // degrees per px (feel)
      const MAX_V = 160;     // deg/s limit
      const PITCH_MIN = -28;
      const PITCH_MAX = 18;

      const onDown = (e) => {
        // block when overlay open
        if(el === boxObj && lockOverlay.classList.contains("show")) return;
        if(el === envObj && sealOverlay.classList.contains("show")) return;

        model.dragging = true;
        const p = getPoint(e);
        model.lx = p.x; model.ly = p.y;
        model.vyaw = 0; model.vpitch = 0;
        try { el.setPointerCapture(p.id); } catch(_) {}
      };

      const onMove = (e) => {
        if(!model.dragging) return;
        const p = getPoint(e);
        const dx = p.x - model.lx;
        const dy = p.y - model.ly;
        model.lx = p.x; model.ly = p.y;

        // direct manipulation
        model.yaw += dx * SPEED;
        model.pitch -= dy * SPEED * 0.9;

        model.pitch = clamp(model.pitch, PITCH_MIN, PITCH_MAX);

        // estimate velocities (px per frame -> deg per frame -> deg/s)
        const dt = 1/60;
        model.vyaw = clamp((dx * SPEED)/dt, -MAX_V, MAX_V);
        model.vpitch = clamp((-dy * SPEED * 0.9)/dt, -MAX_V, MAX_V);
      };

      const onUp = (e) => {
        if(!model.dragging) return;
        model.dragging = false;
      };

      el.addEventListener("pointerdown", onDown, {passive:true});
      window.addEventListener("pointermove", onMove, {passive:true});
      window.addEventListener("pointerup", onUp, {passive:true});
      window.addEventListener("pointercancel", onUp, {passive:true});
    }

    function getPoint(e){
      // Support pointer events
      if(e.changedTouches && e.changedTouches[0]){
        const t = e.changedTouches[0];
        return { x:t.clientX, y:t.clientY, id: t.identifier };
      }
      return { x:e.clientX, y:e.clientY, id: e.pointerId ?? 1 };
    }

    attachSpin(boxObj, state.box);
    attachSpin(envObj, state.env);

    function apply3D(){
      // apply transforms (GPU)
      boxObj.style.transform = `translateZ(0) rotateX(${state.box.pitch}deg) rotateY(${state.box.yaw}deg)`;
      envObj.style.transform = `translateZ(0) rotateX(${state.env.pitch}deg) rotateY(${state.env.yaw}deg)`;
    }

    /* ===========================
       Scene 2: lock overlay + wheels
       =========================== */
    lockBtn.addEventListener("click", () => {
      playSfx(sClick, .75);
      reveal(lockOverlay, true);
      lockOverlay.classList.add("show");
      lockOverlay.setAttribute("aria-hidden","false");
    });

    lockBack.addEventListener("click", () => {
      playSfx(sClick, .7);
      lockOverlay.classList.remove("show");
      lockOverlay.setAttribute("aria-hidden","true");
    });

    function initWheels(){
      // default values
      state.wheels.day = 5;
      state.wheels.month = 10; // November (0-based)
      state.wheels.year = 2024;

      // Build lists
      const dayItems = Array.from({length:31}, (_,i)=>String(i+1));
      const yearItems = [];
      for(let y=2020; y<=2030; y++) yearItems.push(String(y));

      const map = {
        day: dayItems,
        month: MONTHS,
        year: yearItems,
      };

      $$(".wheel").forEach(w => {
        const type = w.dataset.wheel;
        const list = $(".list", w);
        list.textContent = "";
        // Render 9 visible items (looped feel) but we'll update by shifting list
        // We'll just render full list; still lightweight (31 + 12 + 11 = 54 nodes)
        map[type].forEach((txt, idx) => {
          const div = document.createElement("div");
          div.className = "item";
          div.textContent = txt;
          div.dataset.idx = String(idx);
          list.appendChild(div);
        });

        // start at selected index
        setWheel(type, state.wheels[type], false);
        attachWheelSwipe(w, type, map[type].length);
      });
    }

    function setWheel(type, idx, animate=true){
      const wheel = $(`.wheel[data-wheel="${type}"]`);
      const list = $(".list", wheel);
      const items = $$(".item", list);
      const itemH = 42; // css height
      const max = items.length;
      idx = (idx % max + max) % max;
      state.wheels[type] = idx;

      // translate so that selected item is in center
      const y = -idx * itemH;
      if(!animate){
        list.style.transition = "none";
        list.style.transform = `translate3d(0, calc(-50% + ${y}px), 0)`;
        // force
        void list.offsetWidth;
        list.style.transition = "";
      }else{
        list.style.transform = `translate3d(0, calc(-50% + ${y}px), 0)`;
      }

      // active class
      items.forEach(it => it.classList.toggle("active", Number(it.dataset.idx) === idx));
    }

    function attachWheelSwipe(wheel, type, count){
      let dragging = false;
      let startY = 0;
      let lastY = 0;
      let accum = 0;
      const TH = 18; // threshold px per step
      let pointerId = null;

      const onDown = (e) => {
        dragging = true;
        const p = getPoint(e);
        pointerId = p.id;
        startY = p.y;
        lastY = p.y;
        accum = 0;
        try { wheel.setPointerCapture(pointerId); } catch(_) {}
      };

      const onMove = (e) => {
        if(!dragging) return;
        const p = getPoint(e);
        const dy = p.y - lastY;
        lastY = p.y;
        accum += dy;

        // step changes
        if(Math.abs(accum) >= TH){
          const steps = (accum > 0) ? 1 : -1;
          accum = 0;
          // swipe up => decrease, swipe down => increase
          const next = state.wheels[type] + (steps > 0 ? 1 : -1);
          setWheel(type, next, true);
          playSfx(sClick, .25);
        }
      };

      const onUp = () => { dragging = false; pointerId=null; };

      wheel.addEventListener("pointerdown", onDown, {passive:true});
      wheel.addEventListener("pointermove", onMove, {passive:true});
      wheel.addEventListener("pointerup", onUp, {passive:true});
      wheel.addEventListener("pointercancel", onUp, {passive:true});
    }

    lockDone.addEventListener("click", () => {
      playSfx(sClick, .7);

      const day = state.wheels.day + 1;          // 0->1
      const monthIdx = state.wheels.month;       // already 0-based
      const year = 2020 + state.wheels.year;     // because year wheel starts at 2020 index 0

      const ok = (day === LOCK_CODE.day) && (monthIdx === LOCK_CODE.monthIndex) && (year === LOCK_CODE.year);

      if(!ok){
        playSfx(sError, .9);
        addShake($(".modal", lockOverlay));
        showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ üòà", 1000);
        return;
      }

      state.unlocked = true;
      playSfx(sSuccess, .9);

      // unlock animation: lock pop + open box -> move to scene 3
      lockBtn.classList.remove("pulse");
      lockBtn.style.transition = "transform 280ms ease, opacity 280ms ease";
      lockBtn.style.transform = "translate3d(-50%,-50%, 18px) scale(.85)";
      lockBtn.style.opacity = "0.0";

      lockOverlay.classList.remove("show");

      showToast("–©—ë–ª–∫! –û—Ç–∫—Ä—ã—Ç–æ ‚ú®", 1100);

      setTimeout(() => {
        // Scene 2 to 3 transition
        setScene(3);
        // little "box breakdown" illusion via toast + particles burst
        burst(0.55, 0.52, 18);
      }, 900);
    });

    /* ===========================
       Scene 3: throw/open logic
       =========================== */
    let throwUsed = false;
    btnThrow.addEventListener("click", () => {
      playSfx(sClick, .75);
      if(throwUsed) return;
      throwUsed = true;

      // shake everything slightly
      addShake($("#scene3Panel"));
      addShake(envObj);

      showToast("–©–∞—Å –ø–æ —à–µ–µ –ø–æ–ª—É—á–∏—à—å", 1200);

      // morph buttons: "–û—Ç–∫—Ä—ã—Ç—å" slides and replaces
      const btns = $("#envBtns");
      btnThrow.style.transition = "opacity 280ms ease, transform 280ms ease";
      btnThrow.style.opacity = "0";
      btnThrow.style.transform = "translate3d(14px,0,0) scale(.98)";

      btnOpen.style.transition = "transform 420ms ease";
      btnOpen.style.transform = "translate3d(-56px,0,0)";

      setTimeout(() => {
        btnThrow.remove();
        btnOpen.style.transform = "translate3d(0,0,0)";
      }, 520);
    });

    btnOpen.addEventListener("click", () => {
      playSfx(sClick, .75);

      // zoom-in to seal -> show overlay
      sealEl.style.transition = "transform 320ms ease";
      sealEl.style.transform = "translate3d(-50%,-50%, 20px) scale(1.06)";
      setTimeout(() => {
        sealOverlay.classList.add("show");
        sealOverlay.setAttribute("aria-hidden","false");
        bdayInput.focus({preventScroll:true});
      }, 220);
    });

    sealBack.addEventListener("click", () => {
      playSfx(sClick, .7);
      sealOverlay.classList.remove("show");
      sealOverlay.setAttribute("aria-hidden","true");
      sealEl.style.transform = "translate3d(-50%,-50%, 20px) scale(1)";
    });

    function normalizeBday(s){
      s = (s || "").trim();
      // allow digits and dots only
      s = s.replace(/[^\d.]/g,"");
      // auto-insert dots: dd.mm.yyyy
      const digits = s.replace(/\./g,"");
      let out = "";
      for(let i=0;i<digits.length && i<8;i++){
        out += digits[i];
        if(i===1 || i===3) out += ".";
      }
      // if user typed full year
      if(digits.length > 8) out += digits.slice(8,12);
      return out.slice(0,10);
    }

    bdayInput.addEventListener("input", () => {
      const v = normalizeBday(bdayInput.value);
      if(v !== bdayInput.value) bdayInput.value = v;
    });

    function checkBday(){
      const v = normalizeBday(bdayInput.value);
      bdayInput.value = v;

      if(v !== BDAY_CODE){
        playSfx(sError, .85);
        addShake(sealModal);
        bdayHint.textContent = "–ú—è–≥–∫–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞: —ç—Ç–æ 01.02.2005 üôÇ";
        bdayHint.style.color = "rgba(255,204,102,.92)";
        setTimeout(() => {
          bdayHint.style.color = "rgba(255,255,255,.70)";
        }, 1200);
        return false;
      }
      return true;
    }

    bdayOk.addEventListener("click", () => {
      playSfx(sClick, .7);
      if(!checkBday()) return;

      state.opened = true;
      playSfx(sSuccess, .95);

      // seal "falls"
      sealEl.style.transition = "transform 420ms ease, opacity 420ms ease";
      sealEl.style.transform = "translate3d(-50%, calc(-50% + 64px), 20px) scale(.92)";
      sealEl.style.opacity = "0.0";

      // overlay closes
      sealOverlay.classList.remove("show");
      sealOverlay.setAttribute("aria-hidden","true");

      // big romantic burst
      burst(0.5, 0.55, 42);
      showToast("–ü–µ—á–∞—Ç—å —Å–Ω—è—Ç–∞. –û—Ç–∫—Ä—ã–≤–∞–µ–º‚Ä¶", 1200);

      // reveal final UI
      setTimeout(() => {
        finalPanel.style.display = "";
        photoWrap.style.display = "";
        paper.style.display = "";

        // animate in by toggling classes
        requestAnimationFrame(() => {
          // photos will fade in via class on <img>
          startCarousel();
          paper.classList.add("show");
        });

      }, 520);
    });

    // Enter key like "ok"
    bdayInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        bdayOk.click();
      }
    });

    /* ===========================
       Photo carousel
       =========================== */
    function buildDots(n){
      photoDots.textContent = "";
      for(let i=0;i<n;i++){
        const d = document.createElement("i");
        if(i===0) d.classList.add("on");
        photoDots.appendChild(d);
      }
    }

    function showPhoto(i){
      const n = IMAGES.length;
      i = (i % n + n) % n;
      state.photoIndex = i;

      photoEl.classList.remove("show");
      // swap src after fade-out tick
      setTimeout(() => {
        photoEl.src = IMAGES[i];
        photoEl.onload = () => {
          // fade in
          requestAnimationFrame(() => photoEl.classList.add("show"));
        };
        photoEl.onerror = () => {
          // fallback: keep hidden and show toast
          showToast("–§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø–∞–ø–∫–µ Images/", 1200);
        };

        photoIdx.textContent = `${i+1}/${n}`;
        const dots = Array.from(photoDots.children);
        dots.forEach((d, idx) => d.classList.toggle("on", idx===i));
      }, 120);
    }

    function startCarousel(){
      // init dots
      buildDots(IMAGES.length);
      state.photoTimer = now();
      showPhoto(0);

      // gentle auto-advance
      // (stop if user taps photo)
      let stopped = false;

      photoWrap.addEventListener("click", () => {
        playSfx(sClick, .4);
        stopped = true;
        showPhoto(state.photoIndex + 1);
      }, {once:false});

      // keep in RAF loop: auto every ~3.8s
      state.carouselTick = () => {
        if(stopped) return;
        const t = now();
        if(t - state.photoTimer > 3800){
          state.photoTimer = t;
          showPhoto(state.photoIndex + 1);
        }
      };
      finalPanel.style.opacity = "0";
      finalPanel.style.transform = "translate3d(0,10px,0)";
      finalPanel.style.transition = "opacity 420ms ease, transform 420ms ease";
      requestAnimationFrame(() => {
        finalPanel.style.opacity = "1";
        finalPanel.style.transform = "translate3d(0,0,0)";
      });

      // photoWrap initial animation handled by img .show
    }

    /* ===========================
       Audio toggle (Telegram iOS needs user gesture)
       =========================== */
    function setAudio(enabled){
      state.audioEnabled = enabled;
      audioIcon.textContent = enabled ? "üîä" : "üîá";
      audioLabel.textContent = enabled ? "–≤–∫–ª" : "–≤—ã–∫–ª";
      if(enabled){
        try{
          bgm.volume = 0.22;
          bgm.play().catch(()=>{});
        }catch(e){}
      }else{
        try{ bgm.pause(); }catch(e){}
      }
    }

    audioBtn.addEventListener("click", () => {
      // This click is the "gesture" for autoplay policies
      setAudio(!state.audioEnabled);
      playSfx(sClick, .55);
      if(state.audioEnabled){
        showToast("–ó–≤—É–∫ –≤–∫–ª—é—á—ë–Ω", 900);
      }else{
        showToast("–ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω", 900);
      }
    });

    /* ===========================
       Particles (hearts/sparks)
       Canvas, lightweight, 60fps-friendly
       =========================== */
    const c = $("#particles");
    const ctx = c.getContext("2d", { alpha:true });
    let W=0,H=0, dpr=1;
    const parts = [];
    function resize(){
      const r = stage.getBoundingClientRect();
      dpr = Math.min(2, window.devicePixelRatio || 1);
      W = Math.max(1, Math.floor(r.width));
      H = Math.max(1, Math.floor(r.height));
      c.width = Math.floor(W*dpr);
      c.height = Math.floor(H*dpr);
      c.style.width = W+"px";
      c.style.height = H+"px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", resize, {passive:true});

    function spawn(x, y, kind){
      const p = {
        x, y,
        vx: (Math.random()*2-1)*0.9,
        vy: -0.8 - Math.random()*1.6,
        a: 1,
        r: 3 + Math.random()*3.5,
        rot: Math.random()*Math.PI*2,
        vr: (Math.random()*2-1)*0.08,
        kind,
        life: 900 + Math.random()*800,
        born: now()
      };
      parts.push(p);
      // cap
      if(parts.length > 120) parts.splice(0, parts.length-120);
    }

    function burst(nx, ny, n){
      // normalized coords
      const x = nx * W;
      const y = ny * H;
      for(let i=0;i<n;i++){
        const kind = (Math.random()<0.58) ? "heart" : "spark";
        spawn(x + (Math.random()*2-1)*18, y + (Math.random()*2-1)*18, kind);
      }
    }

    function drawHeart(x,y,s,rot,alpha){
      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(rot);
      ctx.globalAlpha = alpha;
      ctx.beginPath();
      // tiny heart path
      const k = s/14;
      ctx.moveTo(0, 4*k);
      ctx.bezierCurveTo(0, 0, -6*k, 0, -6*k, 4*k);
      ctx.bezierCurveTo(-6*k, 8*k, 0, 10*k, 0, 12*k);
      ctx.bezierCurveTo(0, 10*k, 6*k, 8*k, 6*k, 4*k);
      ctx.bezierCurveTo(6*k, 0, 0, 0, 0, 4*k);
      ctx.closePath();
      // gradient-ish via fillStyle alpha shift
      ctx.fillStyle = "rgba(255,95,162,0.95)";
      ctx.fill();
      ctx.restore();
    }

    function drawSpark(x,y,s,rot,alpha){
      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(rot);
      ctx.globalAlpha = alpha;
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.fillRect(-s*0.5, -1, s, 2);
      ctx.fillRect(-1, -s*0.5, 2, s);
      ctx.restore();
    }

    /* ===========================
       RAF main loop: physics + particles
       =========================== */
    function tick(t){
      const dt = Math.min(0.033, (t - state.t0) / 1000);
      state.t0 = t;

      // Spin physics (springy + damping)
      // tuned for "physical" feel
      function stepModel(m){
        const DAMP = 6.8;     // damping
        const SPR = 14.0;     // spring towards 0 velocity
        const MAX_V = 160;    // deg/s limit

        if(!m.dragging){
          // apply damping to velocities
          m.vyaw = m.vyaw * Math.exp(-DAMP*dt);
          m.vpitch = m.vpitch * Math.exp(-DAMP*dt);

          // small "return" spring on pitch (slight)
          const targetPitch = -10; // box baseline
          const k = (m === state.env) ? -8 : -10;
          const target = k;
          m.vpitch += (target - m.pitch) * SPR * dt;
          m.vpitch = clamp(m.vpitch, -MAX_V, MAX_V);
          m.vyaw = clamp(m.vyaw, -MAX_V, MAX_V);

          m.yaw += m.vyaw * dt;
          m.pitch += m.vpitch * dt;

          // keep pitch bounds with soft spring
          const PITCH_MIN = (m === state.env) ? -26 : -28;
          const PITCH_MAX = (m === state.env) ? 18 : 18;
          if(m.pitch < PITCH_MIN){
            m.pitch = lerp(m.pitch, PITCH_MIN, 0.35);
            m.vpitch *= -0.25;
          }
          if(m.pitch > PITCH_MAX){
            m.pitch = lerp(m.pitch, PITCH_MAX, 0.35);
            m.vpitch *= -0.25;
          }
        }
      }
      if(state.scene === 2) stepModel(state.box);
      if(state.scene === 3) stepModel(state.env);

      apply3D();

      // particles
      ctx.clearRect(0,0,W,H);
      const T = now();
      for(let i=parts.length-1;i>=0;i--){
        const p = parts[i];
        const age = T - p.born;
        const k = age / p.life;
        if(k >= 1){
          parts.splice(i,1);
          continue;
        }
        // move
        p.x += p.vx * (dt*60);
        p.y += p.vy * (dt*60);
        p.vy += 0.03 * (dt*60); // gravity
        p.rot += p.vr * (dt*60);
        p.a = 1 - k;
        const alpha = p.a * 0.85;

        if(p.kind === "heart") drawHeart(p.x,p.y,p.r*2.2,p.rot,alpha);
        else drawSpark(p.x,p.y,p.r*1.3,p.rot,alpha);
      }

      // gentle ambient particles
      if(Math.random() < 0.06){
        const x = Math.random()*W;
        const y = H + 10;
        spawn(x, y, Math.random()<0.5 ? "heart":"spark");
      }

      // carousel tick
      if(state.scene === 3 && state.opened && typeof state.carouselTick === "function"){
        state.carouselTick();
      }

      state.raf = requestAnimationFrame(tick);
    }

    /* ===========================
       Start
       =========================== */
    function setup(){
      resize();
      initWheels();
      // start loop
      state.t0 = performance.now();
      state.raf = requestAnimationFrame(tick);
    }

    // Wheel year mapping:
    // we stored state.wheels.year as index into [2020..2030]
    // adapt setWheel / init
    // (fix: setWheel expects idx, so year wheel uses index)
    // After initWheels: state.wheels.year = 2024 -> wrong (should be index), fix:
    function fixYearState(){
      // set 2024 as index
      state.wheels.year = 2024 - 2020;
      setWheel("year", state.wheels.year, false);
    }

    // Patch init after wheels
    const origInitWheels = initWheels;
    initWheels = function(){
      origInitWheels();
      // Adjust to show default year index
      fixYearState();
      // Also refresh day/month
      setWheel("day", state.wheels.day, false);
      setWheel("month", state.wheels.month, false);
    };

    // Also adjust LOCK_CODE monthIndex to match MONTHS index
    // 5 –Ω–æ—è–±—Ä—è 2025 => monthIndex 10 (0-based)
    // ok.

    // Prevent page scroll bounce in Telegram WebView
    document.addEventListener("touchmove", (e)=> e.preventDefault(), {passive:false});

    // Start preloading then setup
    preload().then(setup).catch(() => {
      // still start
      loader.style.display = "none";
      app.style.opacity = "1";
      setup();
      signSheet.classList.add("show");
      showToast("–ù–µ –≤—Å–µ –∞—Å—Å–µ—Ç—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, –Ω–æ –∏–≥—Ä–∞ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å.", 1600);
    });

    // Initial ambient burst when user arrives
    setTimeout(() => burst(0.5, 0.35, 10), 800);

    // If Telegram provides theme hints, we ignore for consistent style (as requested).
  })();
  </script>

  <!--
    ===========================
    –ö–ê–ö –ü–û–î–ì–û–¢–û–í–ò–¢–¨ –§–ê–ô–õ–´
    ===========================
    –†—è–¥–æ–º —Å index.html –ø–æ–ª–æ–∂–∏:
      Images/photo1.jpg
      Images/photo2.jpg
      Images/photo3.jpg
      Images/photo4.jpg   (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø—É—Ç—å –∏–∑ IMAGES, –µ—Å–ª–∏ —Ñ–æ—Ç–æ –º–µ–Ω—å—à–µ)

      Audio/bgm.mp3       (—Ç–≤–æ—è Je te laisserai des mots)
      Audio/click.mp3     (–∫–æ—Ä–æ—Ç–∫–∏–π –∫–ª–∏–∫)
      Audio/success.mp3   (–ø—Ä–∏—è—Ç–Ω—ã–π "—É—Å–ø–µ—Ö")
      Audio/error.mp3     (–º—è–≥–∫–∏–π "–æ—à–∏–±–∫–∞")

    –¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞ –º–µ–Ω—è–µ—Ç—Å—è –≤ –±–ª–æ–∫–µ #letterText.
  -->
</body>
</html>
