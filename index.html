<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0b0c0f" />
  <title>–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ –¥–ª—è –î–∂–∞–º—ã</title>
  <style>
    :root{
      --bg:#0b0c0f;
      --ink:#1b1c20;
      --paper:#f2efe5;
      --paper2:#eae4d5;

      --cardboard:#c7a07a;
      --cardboard2:#ad8460;
      --cardboardDark:#7a5a3f;

      --pink:#ff4d7d;
      --pink2:#ffb3c7;

      --good:#3ee59a;
      --bad:#ff6b6b;

      --radius:22px;
      --radius2:28px;

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeLeft: env(safe-area-inset-left, 0px);
      --safeRight: env(safe-area-inset-right, 0px);

      --shadow: 0 18px 40px rgba(0,0,0,.42);
      --shadow2: 0 10px 22px rgba(0,0,0,.28);
      --stroke: rgba(0,0,0,.18);
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{height:100%; margin:0; background: var(--bg); overflow:hidden;}
    body{
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#f6f6f8;
      user-select:none;
      touch-action: pan-x pan-y; /* –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–µ –∏–Ω–ø—É—Ç—ã/–¥–∞—Ç—É */
      overscroll-behavior: none;
    }

    /* –ú–∏–ª—ã–π ‚Äú—Å—Ç–∞—Ä—ã–π —Ç–µ–ª–µ–∫‚Äù ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω–æ, –±–µ–∑ –Ω–µ–æ–Ω–∞/—Å—Ç–µ–∫–ª–∞ */
    .crt{
      position:fixed; inset:0; pointer-events:none; z-index:60;
      opacity:.16;
      mix-blend-mode:multiply;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.03) 0px,
          rgba(255,255,255,.03) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 6px
        );
      animation: flick 6.5s linear infinite;
    }
    @keyframes flick{
      0%,100%{opacity:.14}
      30%{opacity:.18}
      55%{opacity:.12}
      80%{opacity:.19}
    }

    /* –ë—É–º–∞–∂–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏: –º–∞—Ç–æ–≤—ã–µ, —Ç–µ–∫—Å—Ç—É—Ä–Ω—ã–µ */
    .paper{
      position:relative;
      background:
        linear-gradient(180deg, var(--paper) 0%, var(--paper2) 100%);
      color: rgba(20,20,24,.92);
      border: 1px solid rgba(0,0,0,.14);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .paper::before{
      content:"";
      position:absolute; inset:0; pointer-events:none;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply;
      opacity:.45;
      transform: scale(1.05);
    }
    .paper::after{
      content:"";
      position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(900px 520px at 50% 0%, rgba(0,0,0,.06), rgba(0,0,0,0) 60%),
        radial-gradient(700px 420px at 0% 100%, rgba(0,0,0,.05), rgba(0,0,0,0) 62%),
        radial-gradient(700px 420px at 100% 100%, rgba(0,0,0,.05), rgba(0,0,0,0) 62%);
      opacity:.9;
    }

    #app{
      position:fixed; inset:0;
      padding: calc(14px + var(--safeTop)) calc(14px + var(--safeRight)) calc(14px + var(--safeBottom)) calc(14px + var(--safeLeft));
      display:flex; align-items:center; justify-content:center;
    }
    .stage{
      width:min(430px, 100%);
      height:min(820px, 100%);
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî –±—É–º–∞–∂–Ω—ã–π, –±–µ–∑ —Å—Ç–µ–∫–ª–∞ */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-radius: 22px;
      background:
        linear-gradient(180deg, #f3f0e7 0%, #ebe3d5 100%);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: var(--shadow2);
      color: rgba(20,20,24,.86);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
      letter-spacing:.2px;
      font-size: 14px;
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      color: rgba(20,20,24,.85);
      background: linear-gradient(180deg, rgba(255,179,199,.85), rgba(255,179,199,.62));
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      font-weight: 900;
    }

    .viewport{
      position:relative;
      flex:1;
      border-radius: var(--radius2);
      overflow:hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.04);
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(255,255,255,.06), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, #14151a 0%, #0c0d11 100%);
    }

    .scene{
      position:absolute; inset:0;
      padding: 14px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:14px;
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      transition: opacity .45s ease, transform .55s cubic-bezier(.2,.8,.2,1);
    }
    .scene.active{
      opacity:1; transform: translateY(0);
      pointer-events:auto;
    }
    .center{flex:1; display:flex; align-items:center; justify-content:center; position:relative;}

    /* –†–µ–ø–ª–∏–∫–∏ ‚Äî –±—É–º–∞–∂–Ω—ã–µ —Å—Ç–∏–∫–µ—Ä—ã */
    .bubble{
      align-self:center;
      max-width: 92%;
      padding: 12px 14px;
      border-radius: 22px;
      background: linear-gradient(180deg, #f3f0e7, #ebe3d5);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: var(--shadow2);
      color: rgba(20,20,24,.88);
    }
    .bubble .who{font-size:12px; opacity:.7; font-weight:900; margin-bottom:6px;}
    .bubble .txt{font-size:16px; font-weight:900; letter-spacing:.1px;}
    .bubble.small .txt{font-size:14px;}
    .shake{animation: shake .35s ease;}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      55%{transform:translateX(6px)}
      75%{transform:translateX(-4px)}
      100%{transform:translateX(0)}
    }

    .row{display:flex; gap:10px; justify-content:center; flex-wrap:wrap;}

    /* –ö–Ω–æ–ø–∫–∏ ‚Äî –º–∞—Ç–æ–≤—ã–µ, ‚Äú–∫–∞—Ä—Ç–æ–Ω–Ω—ã–µ‚Äù */
    .btn{
      border:none;
      padding: 12px 16px;
      border-radius: 20px;
      font-weight: 950;
      font-size: 14px;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      color: rgba(20,20,24,.88);
      background: linear-gradient(180deg, #f3f0e7, #e9e1d3);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      transition: transform .12s ease, filter .12s ease, opacity .22s ease;
    }
    .btn:active{transform: translateY(1px) scale(.99); filter: brightness(.98);}
    .btn.primary{
      background: linear-gradient(180deg, rgba(255,179,199,.95), rgba(255,179,199,.70));
      border: 1px solid rgba(0,0,0,.12);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,185,185,.92), rgba(255,185,185,.70));
      border: 1px solid rgba(0,0,0,.12);
    }
    .btn.ghost{
      background: linear-gradient(180deg, rgba(245,240,230,.70), rgba(235,227,210,.70));
      border: 1px dashed rgba(0,0,0,.20);
    }
    .btn.wide{min-width: 160px;}
    .btn.hidden{opacity:0; pointer-events:none; transform: translateX(12px) scale(.98);}

    /* –ú–æ–¥–∞–ª–∫–∏ */
    .modalWrap{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.35);
      opacity:0; pointer-events:none;
      transition: opacity .28s ease;
      z-index: 10;
    }
    .modalWrap.show{opacity:1; pointer-events:auto;}
    .modal{
      width:min(390px, 100%);
      padding: 16px;
      border-radius: var(--radius2);
      transform: translateY(10px) scale(.99);
      transition: transform .35s cubic-bezier(.2,.8,.2,1);
    }
    .modalWrap.show .modal{transform: translateY(0) scale(1);}
    .modal h3{margin:0 0 8px 0; font-size:16px; font-weight:950;}
    .modal p{margin:0 0 14px 0; font-size:13px; font-weight:800; color: rgba(20,20,24,.70);}

    /* =========================================================
       REAL CSS-3D OBJECTS
       ========================================================= */
    .objectStage{
      width:100%;
      height:100%;
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .hintPill{
      position:absolute; top: 10px; left: 10px; right: 10px;
      display:flex; justify-content:center;
      pointer-events:none;
    }
    .hintPill span{
      padding: 8px 12px;
      border-radius: 999px;
      background: linear-gradient(180deg, #f3f0e7, #ebe3d5);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      color: rgba(20,20,24,.80);
      font-weight: 900;
      font-size: 12px;
    }

    /* Common 3D stage */
    .objWrap{
      width: min(330px, 86vw);
      aspect-ratio: 1 / 1;
      position:relative;
      perspective: 900px;
      filter: drop-shadow(0 28px 28px rgba(0,0,0,.45));
      touch-action: none;
    }
    .obj{
      width:100%; height:100%;
      position:absolute; inset:0;
      transform-style: preserve-3d;
      will-change: transform;
    }

    /* Pixel-ish edge overlay to sell style */
    .pixelFrame{
      position:absolute; inset:0; border-radius: 28px; pointer-events:none;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.10);
    }
    .pixelFrame::after{
      content:"";
      position:absolute; inset: 6px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.06);
      opacity:.9;
    }

    /* 3D Box (cube-ish) */
    .cube{
      --size: 260px;
      --depth: 150px;
      width: var(--size);
      height: var(--size);
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      transform-style: preserve-3d;
    }
    .face{
      position:absolute;
      width: var(--size);
      height: var(--size);
      border-radius: 22px;
      border: 1px solid rgba(0,0,0,.18);
      overflow:hidden;
      background:
        linear-gradient(180deg, var(--cardboard), var(--cardboard2));
    }
    .face::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.16'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply; opacity:.55;
      transform: scale(1.06);
      pointer-events:none;
    }
    .face::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(220px 160px at 25% 15%, rgba(255,255,255,.18), rgba(255,255,255,0) 62%),
        radial-gradient(240px 180px at 80% 20%, rgba(255,255,255,.12), rgba(255,255,255,0) 65%),
        linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,0) 40%);
      opacity:.95;
      pointer-events:none;
    }

    /* Faces placement */
    .front { transform: rotateY(0deg) translateZ(calc(var(--depth) / 2)); }
    .back  { transform: rotateY(180deg) translateZ(calc(var(--depth) / 2)); }
    .right { transform: rotateY(90deg) translateZ(calc(var(--depth) / 2)); }
    .left  { transform: rotateY(-90deg) translateZ(calc(var(--depth) / 2)); }
    .top   { transform: rotateX(90deg) translateZ(calc(var(--depth) / 2)); }
    .bottom{ transform: rotateX(-90deg) translateZ(calc(var(--depth) / 2)); }

    /* Make side faces ‚Äúdarker‚Äù */
    .right, .left { background: linear-gradient(180deg, #b08863, #8f6a49); }
    .back { background: linear-gradient(180deg, #b18a64, #916a49); }
    .bottom { background: linear-gradient(180deg, #9a7350, #7a5a3f); }
    .top { background: linear-gradient(180deg, #d3b08d, #b99570); }

    /* Front content: label + tape + lock */
    .label{
      position:absolute; left: 14%; right:14%; top: 14%;
      padding: 10px 12px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.74), rgba(240,235,220,.90));
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 10px 18px rgba(0,0,0,.16);
      text-align:center;
      font-weight: 950;
      color: rgba(20,20,24,.88);
    }
    .label small{
      display:block;
      margin-top:4px;
      font-size:12px;
      font-weight:900;
      color: rgba(30,30,34,.58);
    }
    .tape{
      position:absolute; left: 12%; right:12%; top: 46%;
      height: 16%;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,240,200,.82), rgba(230,205,160,.80));
      border:1px solid rgba(0,0,0,.12);
      transform: rotate(-3deg);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.20), inset 0 -2px 0 rgba(0,0,0,.10);
      opacity:.95;
    }

    /* 3D lock: small ‚Äúblock‚Äù extruded */
    .lock3d{
      position:absolute;
      left:50%; top: 64%;
      width: 92px; height: 92px;
      transform: translate(-50%,-50%);
      transform-style: preserve-3d;
      cursor:pointer;
      touch-action: manipulation;
      z-index: 5;
    }
    .lockBody{
      position:absolute; inset:0;
      border-radius: 22px;
      background: linear-gradient(180deg, #f2ddaa, #d9b96a);
      border: 1px solid rgba(0,0,0,.16);
      box-shadow: 0 14px 22px rgba(0,0,0,.22);
      transform: translateZ(10px);
    }
    .lockBody::before{
      content:"";
      position:absolute; inset:10px;
      border-radius: 18px;
      background: rgba(0,0,0,.08);
      border: 1px dashed rgba(0,0,0,.18);
    }
    .lockBack{
      position:absolute; inset:0;
      border-radius: 22px;
      background: linear-gradient(180deg, #caa95f, #b08a3c);
      border: 1px solid rgba(0,0,0,.16);
      transform: translateZ(-10px);
    }
    .lockSide{
      position:absolute;
      left:0; top:0;
      width: 20px; height: 92px;
      background: linear-gradient(180deg, #caa95f, #9e7a2f);
      border: 1px solid rgba(0,0,0,.16);
      transform-origin: left center;
      transform: rotateY(90deg) translateZ(10px);
      border-radius: 10px;
    }
    .lockSide.r{
      left:auto; right:0;
      transform-origin: right center;
      transform: rotateY(-90deg) translateZ(10px);
    }
    .lockShackle{
      position:absolute;
      left:50%; top: 18%;
      width: 36px; height: 26px;
      transform: translate(-50%,-50%) translateZ(12px);
      border-radius: 16px 16px 12px 12px;
      border: 6px solid rgba(30,24,10,.55);
      border-bottom: 0;
      opacity:.95;
    }
    .lockKeyhole{
      position:absolute;
      left:50%; top: 62%;
      width: 20px; height: 28px;
      transform: translate(-50%,-50%) translateZ(12px);
      border-radius: 10px;
      background: rgba(30,24,10,.55);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.16);
    }
    .lock3d.pulse{
      animation: lockPulse 1.25s infinite ease-in-out;
    }
    @keyframes lockPulse{
      0%,100%{transform: translate(-50%,-50%) scale(1)}
      50%{transform: translate(-50%,-50%) scale(1.06)}
    }

    /* =========================================================
       3D Envelope (thick card)
       ========================================================= */
    .env3d{
      --size: 270px;
      --thick: 46px;
      width: var(--size);
      height: var(--size);
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      transform-style: preserve-3d;
    }
    .envFace{
      position:absolute;
      width: var(--size);
      height: var(--size);
      border-radius: 24px;
      border: 1px solid rgba(0,0,0,.16);
      overflow:hidden;
      background: linear-gradient(180deg, #f6e6ea 0%, #e7bcc8 100%);
    }
    .envFace::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.78' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply; opacity:.55; transform: scale(1.06);
      pointer-events:none;
    }
    .envFront{ transform: translateZ(calc(var(--thick)/2)); }
    .envBack{ transform: rotateY(180deg) translateZ(calc(var(--thick)/2)); background: linear-gradient(180deg, #f1d3dc, #d9a9b8); }
    .envSide{
      position:absolute;
      background: linear-gradient(180deg, #d9a9b8, #b98797);
      border: 1px solid rgba(0,0,0,.16);
      border-radius: 14px;
    }
    .envSide.top{
      width: var(--size); height: var(--thick);
      left:0; top:0;
      transform-origin: top center;
      transform: rotateX(90deg) translateZ(calc(var(--thick)/2));
    }
    .envSide.bottom{
      width: var(--size); height: var(--thick);
      left:0; bottom:0;
      transform-origin: bottom center;
      transform: rotateX(-90deg) translateZ(calc(var(--thick)/2));
    }
    .envSide.left{
      width: var(--thick); height: var(--size);
      left:0; top:0;
      transform-origin: left center;
      transform: rotateY(-90deg) translateZ(calc(var(--thick)/2));
    }
    .envSide.right{
      width: var(--thick); height: var(--size);
      right:0; top:0;
      transform-origin: right center;
      transform: rotateY(90deg) translateZ(calc(var(--thick)/2));
    }

    /* flap + seal on front face */
    .flap{
      position:absolute; left: 14%; right:14%; top: 16%;
      height: 44%;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.44), rgba(0,0,0,.06));
      clip-path: polygon(50% 85%, 0% 0%, 100% 0%);
      opacity:.9;
      transform-origin: 50% 0%;
    }
    .seal{
      position:absolute; left:50%; top: 60%;
      width: 86px; height: 86px;
      transform: translate(-50%,-50%);
      border-radius: 24px;
      background: linear-gradient(180deg, #ff6c90, #ff3f73);
      border: 1px solid rgba(0,0,0,.18);
      box-shadow: 0 16px 22px rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      touch-action: manipulation;
    }
    .seal b{color: rgba(20,10,14,.72); font-size:18px; font-weight:950;}
    .seal.wiggle{ animation: sealWiggle .35s ease; }
    @keyframes sealWiggle{
      0%{transform:translate(-50%,-50%) rotate(0)}
      30%{transform:translate(-50%,-50%) rotate(-6deg)}
      65%{transform:translate(-50%,-50%) rotate(6deg)}
      100%{transform:translate(-50%,-50%) rotate(0)}
    }

    /* =========================================================
       Lock minigame (reels)
       ========================================================= */
    .reels{
      display:grid;
      grid-template-columns: 1fr 1.2fr 1fr;
      gap: 10px;
    }
    .reel{
      position:relative;
      height: 160px;
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.14);
      background:
        linear-gradient(180deg, rgba(255,255,255,.88), rgba(240,235,220,.96));
      box-shadow: 0 12px 22px rgba(0,0,0,.14);
      touch-action: none;
    }
    .reel::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply;
      opacity:.40;
      pointer-events:none;
    }
    .reelHeader{
      position:absolute; top: 10px; left:10px; right:10px;
      font-weight: 950;
      font-size: 12px;
      color: rgba(30,30,34,.62);
      text-align:center;
      pointer-events:none;
    }
    .windowLine{
      position:absolute; left:10px; right:10px; top: 50%;
      height: 46px;
      transform: translateY(-50%);
      border-radius: 16px;
      border: 1px dashed rgba(20,20,26,.25);
      background: rgba(255,255,255,.50);
      pointer-events:none;
    }
    .reelList{
      position:absolute; left:0; right:0; top:0; bottom:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 18px;
      padding: 24px 10px;
      transform: translateY(0);
      will-change: transform;
    }
    .reelItem{
      font-weight: 950;
      font-size: 18px;
      color: rgba(20,20,26,.86);
      text-align:center;
      letter-spacing:.4px;
      min-height: 22px;
      padding: 2px 6px;
      border-radius: 10px;
    }
    .reelItem.dim{opacity:.38; filter: blur(.1px);}

    .lockFooter{display:flex; gap:10px;}
    .lockFooter .btn{flex:1}

    /* =========================================================
       Date check
       ========================================================= */
    .dateCard{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 14px 14px 12px 14px;
      border-radius: 22px;
      background: linear-gradient(180deg, #f3f0e7, #ebe3d5);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: var(--shadow2);
      color: rgba(20,20,24,.88);
      position:relative;
      overflow:hidden;
    }
    .dateCard::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.16'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply; opacity:.35;
      pointer-events:none;
    }
    .dateRow{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center;}
    .chip{
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(240,235,220,.92));
      font-weight: 950;
      display:flex; align-items:center; gap:10px;
    }
    .chip input{
      border:none; outline:none;
      background: transparent;
      font-weight: 950;
      font-size: 14px;
      color: rgba(20,20,24,.85);
      min-width: 168px;
    }
    .hint{
      text-align:center;
      font-size: 12px;
      font-weight: 850;
      color: rgba(20,20,24,.72);
      line-height:1.2;
      min-height: 16px;
    }

    /* =========================================================
       Gallery
       ========================================================= */
    .gallery{display:flex; flex-direction:column; gap:10px; align-items:center; justify-content:center;}
    .photoFrame{
      width: min(360px, 100%);
      aspect-ratio: 9/12;
      border-radius: 26px;
      overflow:hidden;
      position:relative;
      border: 1px solid rgba(0,0,0,.18);
      box-shadow: var(--shadow);
      background: linear-gradient(180deg, #1a1b20, #0c0d11);
    }
    .photoFrame img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: cover;
      opacity:0;
      transform: scale(1.02);
      transition: opacity .8s ease, transform 1.1s cubic-bezier(.2,.8,.2,1);
    }
    .photoFrame img.show{opacity:1; transform: scale(1);}
    .photoOverlay{
      position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(900px 650px at 50% 0%, rgba(255,255,255,.08), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.30));
    }
    .dots{display:flex; gap:8px; justify-content:center; align-items:center;}
    .dot{
      width: 8px; height: 8px;
      border-radius: 99px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(0,0,0,.20);
      transition: transform .15s ease, background .15s ease;
    }
    .dot.on{background: rgba(255,179,199,.95); transform: scale(1.35);}

    .letter{width:min(390px,100%); padding: 14px;}
    .letter .title{font-weight: 950; font-size: 16px; margin-bottom: 8px;}
    .foot{
      display:flex; justify-content:center;
      color: rgba(255,255,255,.50);
      font-weight:800;
      font-size:11px;
      padding-bottom: 2px;
    }

    /* Loader */
    .loader{
      position:fixed; inset:0; z-index:90;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, #101116, #08080b);
      transition: opacity .45s ease, transform .55s ease;
    }
    .loader.hide{opacity:0; pointer-events:none; transform: translateY(-6px);}
    .loaderCard{
      width: min(380px, 92vw);
      padding: 16px;
      border-radius: 28px;
      background: linear-gradient(180deg, #f3f0e7, #ebe3d5);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: var(--shadow);
      text-align:center;
      color: rgba(20,20,24,.88);
      position:relative;
      overflow:hidden;
    }
    .loaderCard::before{
      content:"";
      position:absolute; inset:0; pointer-events:none;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.16'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply; opacity:.35;
    }
    .loaderTitle{font-weight: 950; font-size:16px; margin-bottom:6px;}
    .loaderSub{font-weight: 850; font-size:12px; color: rgba(20,20,24,.70); margin-bottom:14px; line-height:1.25;}
    .bar{
      height: 12px; border-radius: 999px;
      background: rgba(0,0,0,.08);
      border: 1px solid rgba(0,0,0,.10);
      overflow:hidden;
      box-shadow: inset 0 2px 0 rgba(255,255,255,.10);
    }
    .bar > i{
      display:block; height:100%; width:0%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,179,199,.95), rgba(255,179,199,.70));
      transition: width .22s ease;
    }
    .tapToStart{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(255,179,199,.75), rgba(255,179,199,.55));
      border: 1px solid rgba(0,0,0,.10);
      font-weight: 950;
      font-size: 12px;
      display:inline-flex; align-items:center; gap:10px;
      opacity:0; transform: translateY(6px);
      transition: opacity .35s ease, transform .45s cubic-bezier(.2,.8,.2,1);
    }
    .tapToStart.show{opacity:1; transform: translateY(0);}
    .tapDot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(255,77,125,.95);
      box-shadow: 0 0 0 6px rgba(255,77,125,.12);
      animation: tapPulse 1.1s infinite ease-in-out;
    }
    @keyframes tapPulse{0%,100%{transform: scale(1)}50%{transform: scale(1.35)}}

    canvas#fx{
      position:absolute; inset:0; pointer-events:none; z-index: 6;
    }

    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important;}
    }
  </style>
</head>

<body>
  <div class="loader" id="loader">
    <div class="loaderCard">
      <div class="loaderTitle">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ—Å—ã–ª–∫–∏‚Ä¶</div>
      <div class="loaderSub">–ó–∞–≥—Ä—É–∂–∞—é —Ñ–æ—Ç–æ –∏ –∑–≤—É–∫–∏. –ü–æ—Ç–æ–º –æ–¥–∏–Ω —Ä–∞–∑ —Ç–∞–ø–Ω–∏ ‚Äî —á—Ç–æ–±—ã Telegram —Ä–∞–∑—Ä–µ—à–∏–ª –º—É–∑—ã–∫—É.</div>
      <div class="bar"><i id="barFill"></i></div>
      <div class="tapToStart" id="tapToStart"><span class="tapDot"></span>–¢–∞–ø–Ω–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
    </div>
  </div>

  <div id="app">
    <div class="stage">
      <div class="topbar">
        <div class="brand">üì¶ –í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞</div>
        <div class="badge" id="sceneBadge">–°—Ü–µ–Ω–∞ 1/3</div>
      </div>

      <div class="viewport" id="viewport">
        <canvas id="fx"></canvas>

        <!-- SCENE 1 -->
        <section class="scene" id="scene1">
          <div class="bubble" id="courierBubble">
            <div class="who">–ö—É—Ä—å–µ—Ä</div>
            <div class="txt" id="courierText">–í–∞–º –ø–æ—Å—ã–ª–∫–∞ –æ—Ç —Ñ–∞–Ω–∞—Ç–∞ üòâ</div>
          </div>

          <div class="center">
            <div class="objectStage">
              <div class="hintPill"><span>–°—Ç–∏–ª—å: –±—É–º–∞–≥–∞ + –∫–∞—Ä—Ç–æ–Ω + ‚Äú–º–∏–ª—ã–π –¢–í-—à—É–º‚Äù</span></div>

              <div class="paper" style="width:min(360px,100%); padding:14px;">
                <div style="display:flex; gap:12px; align-items:center;">
                  <div style="width:78px;height:78px;border-radius:22px;background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.10);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;">
                    <div style="width:54px;height:54px;border-radius:20px;background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.08));border:1px solid rgba(0,0,0,.10);"></div>
                    <div style="position:absolute;bottom:8px;left:10px;right:10px;height:8px;border-radius:6px;background:rgba(0,0,0,.10);"></div>
                  </div>
                  <div style="flex:1;">
                    <div style="font-weight:950;font-size:16px;">–ö—É—Ä—å–µ—Ä</div>
                    <div style="margin-top:4px;color:rgba(0,0,0,.62);font-weight:850;font-size:12px;line-height:1.2;">
                      –ü—Ä–æ—Å—Ç–æ –¥–æ—Å—Ç–∞–≤–ª—è—é. –ù–∏–∫–∞–∫–∏—Ö –ª–æ–≥–æ—Ç–∏–ø–æ–≤. –¢–æ–ª—å–∫–æ —Ä–æ–º–∞–Ω—Ç–∏–∫–∞ üòå
                    </div>
                  </div>
                </div>
              </div>

              <div class="modalWrap" id="signModal">
                <div class="modal paper">
                  <h3>–ë—É–º–∞–∂–∫–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏</h3>
                  <p>–í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ø–æ—Å—ã–ª–∫—É –æ—Ç —Ñ–∞–Ω–∞—Ç–∞?</p>
                  <div class="row" id="signButtons">
                    <button class="btn ghost wide" id="btnNo">–ù–µ—Ç</button>
                    <button class="btn primary wide" id="btnYes">–î–∞</button>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- SCENE 2 -->
        <section class="scene" id="scene2">
          <div class="bubble small" id="boxBubble">
            <div class="who">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
            <div class="txt">–¢–µ–ø–µ—Ä—å —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ 3D: 6 –≥—Ä–∞–Ω–µ–π. –ö—Ä—É—Ç–∏ –ø–∞–ª—å—Ü–µ–º. –ù–∞–∂–º–∏ –Ω–∞ –∑–∞–º–æ–∫.</div>
          </div>

          <div class="center">
            <div class="objectStage">
              <div class="hintPill"><span>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π: –≤—Ä–∞—â–µ–Ω–∏–µ + –∏–Ω–µ—Ä—Ü–∏—è</span></div>

              <div class="objWrap" id="boxWrap">
                <div class="obj" id="boxObj">
                  <div class="cube" id="cube">
                    <div class="face front" id="boxFront">
                      <div class="label">–¥–ª—è –î–∂–∞–º—ã <small>–æ—Ç —Ñ–∞–Ω–∞—Ç–∞ üòâ</small></div>
                      <div class="tape"></div>

                      <div class="lock3d pulse" id="lockBtn" aria-label="lock">
                        <div class="lockBack"></div>
                        <div class="lockSide"></div>
                        <div class="lockSide r"></div>
                        <div class="lockBody"></div>
                        <div class="lockShackle"></div>
                        <div class="lockKeyhole"></div>
                      </div>
                    </div>

                    <div class="face back"></div>
                    <div class="face right"></div>
                    <div class="face left"></div>
                    <div class="face top"></div>
                    <div class="face bottom"></div>
                  </div>
                </div>
                <div class="pixelFrame"></div>
              </div>

              <div class="modalWrap" id="lockModal">
                <div class="modal paper">
                  <h3>–ö–æ–¥–æ–≤—ã–π –∑–∞–º–æ–∫</h3>
                  <p>3 –∫–æ–ª—ë—Å–∏–∫–∞ ‚Äî –¥–µ–Ω—å, –º–µ—Å—è—Ü, –≥–æ–¥. –°–≤–∞–π–ø–∞–π –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑. –ü–æ—Ç–æ–º ‚Äú–ì–æ—Ç–æ–≤–æ‚Äù.</p>

                  <div class="reels" id="reels">
                    <div class="reel" data-reel="day">
                      <div class="reelHeader">–î–ï–ù–¨</div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="reelDay"></div>
                    </div>
                    <div class="reel" data-reel="month">
                      <div class="reelHeader">–ú–ï–°–Ø–¶</div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="reelMonth"></div>
                    </div>
                    <div class="reel" data-reel="year">
                      <div class="reelHeader">–ì–û–î</div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="reelYear"></div>
                    </div>
                  </div>

                  <div class="lockFooter" style="margin-top:12px;">
                    <button class="btn ghost" id="lockBack">–ù–∞–∑–∞–¥</button>
                    <button class="btn primary" id="lockDone">–ì–æ—Ç–æ–≤–æ</button>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="row">
            <button class="btn ghost wide" id="boxReset">–°–±—Ä–æ—Å–∏—Ç—å –≤—Ä–∞—â–µ–Ω–∏–µ</button>
          </div>
        </section>

        <!-- SCENE 3 -->
        <section class="scene" id="scene3">
          <div class="bubble small" id="envBubble">
            <div class="who">–ü–æ—Å—ã–ª–∫–∞</div>
            <div class="txt">–ö–æ–Ω–≤–µ—Ä—Ç —Ç–æ–∂–µ 3D. –û—Ç–∫—Ä—ã–≤–∞—Ç—å –±—É–¥–µ–º –ø–æ-—á–µ—Å—Ç–Ω–æ–º—É üòå</div>
          </div>

          <div class="center">
            <div class="objectStage">
              <div class="hintPill"><span>–ö—Ä—É—Ç–∏ –∫–æ–Ω–≤–µ—Ä—Ç –ø–∞–ª—å—Ü–µ–º ‚Äî –æ–Ω ‚Äú—Ç–æ–ª—Å—Ç—ã–π‚Äù</span></div>

              <div class="objWrap" id="envWrap">
                <div class="obj" id="envObj">
                  <div class="env3d" id="env3d">
                    <div class="envFace envFront" id="envFront">
                      <div class="flap" id="flap"></div>
                      <div class="seal" id="sealBtn"><b>‚ô•</b></div>
                    </div>
                    <div class="envFace envBack"></div>
                    <div class="envSide top"></div>
                    <div class="envSide bottom"></div>
                    <div class="envSide left"></div>
                    <div class="envSide right"></div>
                  </div>
                </div>
                <div class="pixelFrame"></div>
              </div>

              <div class="modalWrap" id="dateModal">
                <div class="modal" style="padding:0; background:transparent; box-shadow:none; border:none;">
                  <div class="dateCard">
                    <div style="text-align:center;font-weight:950;font-size:16px;">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ñ–∞–Ω–∞—Ç–∞</div>
                    <div class="hint">–ù–∞–∂–º–∏ –Ω–∞ –¥–∞—Ç—É ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∫–∞–ª–µ–Ω–¥–∞—Ä—å. –ü–æ—Ç–æ–º –Ω–∞–∂–º–∏ ‚Äú‚úì‚Äù.</div>

                    <div class="dateRow">
                      <label class="chip" style="cursor:pointer;">
                        üìÖ <input id="dateInput" type="date" />
                      </label>
                      <button class="btn primary" id="dateCheck" style="min-width:76px;">‚úì</button>
                    </div>

                    <div class="hint" id="dateHint"></div>
                    <div class="row">
                      <button class="btn ghost wide" id="dateCancel">–ù–∞–∑–∞–¥</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="modalWrap" id="finalModal">
                <div class="modal" style="width:min(410px,100%); padding:0; background:transparent; box-shadow:none; border:none;">
                  <div class="gallery">
                    <div class="photoFrame">
                      <img id="ph0" alt="photo 1" />
                      <img id="ph1" alt="photo 2" />
                      <img id="ph2" alt="photo 3" />
                      <img id="ph3" alt="photo 4" />
                      <div class="photoOverlay"></div>
                    </div>
                    <div class="dots" id="dots"></div>

                    <div class="paper letter" id="letter">
                      <div class="title">–ü–∏—Å—å–º–æ üìù</div>
                      <div style="font-weight:850;color:rgba(20,20,24,.70);font-size:12px;margin-bottom:10px;line-height:1.25;">
                        –ó–∞–º–µ–Ω–∏—à—å –Ω–∞ —Å–≤–æ–π —Ç–µ–∫—Å—Ç (6‚Äì10 —Å—Ç—Ä–æ–∫) –ø—Ä—è–º–æ –≤ –±–ª–æ–∫–µ –Ω–∏–∂–µ.
                      </div>
                      <div id="letterText" style="font-weight:900;color:rgba(20,20,24,.86);line-height:1.35;font-size:14px;">
                        <div>–î–∂–∞–º–∞, –ø—Ä–∏–≤–µ—Ç‚Ä¶</div>
                        <div>–≠—Ç–æ –º–∞–ª–µ–Ω—å–∫–∞—è –ø–æ—Å—ã–ª–∫–∞,</div>
                        <div>–≤ –∫–æ—Ç–æ—Ä–æ–π —Å–ø—Ä—è—Ç–∞–Ω–æ —á—É—Ç—å-—á—É—Ç—å</div>
                        <div>–º–æ–µ–≥–æ —Ç–µ–ø–ª–∞ –∏ —É–ª—ã–±–∫–∏.</div>
                        <div>–ï—Å–ª–∏ —Ç—ã —á–∏—Ç–∞–µ—à—å —ç—Ç–æ ‚Äî</div>
                        <div>–∑–Ω–∞—á–∏—Ç —Ç—ã –≤—Å—ë —Å–¥–µ–ª–∞–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ. ‚ô•</div>
                        <div>‚Ä¶</div>
                      </div>
                    </div>

                    <div class="row">
                      <button class="btn primary wide" id="restart">–ï—â—ë —Ä–∞–∑</button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="row" id="envButtons">
            <button class="btn danger wide" id="throwBtn">–í—ã–±—Ä–æ—Å–∏—Ç—å</button>
            <button class="btn primary wide" id="openBtn">–û—Ç–∫—Ä—ã—Ç—å</button>
          </div>
        </section>

      </div>

      <div class="foot">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è ‚Ä¢ Telegram WebView</div>
    </div>
  </div>

  <div class="crt" aria-hidden="true"></div>

  <script>
    /* =========================================================
       CONFIG
       ========================================================= */
    const CONFIG = {
      images: [
        "Images/photo1.jpg",
        "Images/photo2.jpg",
        "Images/photo3.jpg",
        "Images/photo4.jpg"
      ],
      audio: {
        bgm: "Audio/JeTeLaisseraiDesMots.mp3",
        click: "Audio/click.mp3",
        paper: "Audio/paper.mp3",
        lock: "Audio/lock.mp3",
        success: "Audio/success.mp3",
        wrong: "Audio/wrong.mp3",
        whoosh: "Audio/whoosh.mp3"
      },
      lockCode: { day: 5, monthIndex: 10, year: 2025 }, // 5 Nov 2025
      fanBirthday: "2005-02-01",
      maxParticles: 90
    };

    const $ = (id)=>document.getElementById(id);
    const clamp = (v,a,b)=>Math.max(a, Math.min(b,v));
    const lerp = (a,b,t)=>a+(b-a)*t;
    const now = ()=>performance.now();

    /* =========================================================
       Audio (–∫–∞–∫ —Ä–∞–Ω—å—à–µ, –Ω–æ –±–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö preventDefault, —á—Ç–æ–±—ã –≤—Å—ë —Ä–∞–±–æ—Ç–∞–ª–æ)
       ========================================================= */
    class AudioEngine{
      constructor(){
        this.ctx=null; this.unlocked=false;
        this.buffers=new Map();
        this.bgmEl=null;
        this.bgmGain=0.24;
        this.sfxGain=0.70;
        this.master=null; this.sfxBus=null;
      }
      async init(){
        if (this.ctx) return;
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        this.ctx = new AC();
        this.master = this.ctx.createGain();
        this.master.gain.value = 0.85;
        this.master.connect(this.ctx.destination);
        this.sfxBus = this.ctx.createGain();
        this.sfxBus.gain.value = this.sfxGain;
        this.sfxBus.connect(this.master);

        const sfxKeys = ["click","paper","lock","success","wrong","whoosh"];
        await Promise.all(sfxKeys.map(k=>this._tryLoadBuffer(k, CONFIG.audio[k])));
      }
      async unlock(){
        if (!this.ctx) await this.init();
        if (!this.ctx) return;
        try{ if (this.ctx.state!=="running") await this.ctx.resume(); }catch(e){}
        this._beep(0.0001,220,0.01,0);
        this.unlocked=true;
        this.startBGM();
      }
      async _tryLoadBuffer(key,url){
        if (!url) return;
        try{
          const res = await fetch(url, {cache:"force-cache"});
          if (!res.ok) return;
          const arr = await res.arrayBuffer();
          const buf = await this.ctx.decodeAudioData(arr);
          this.buffers.set(key, buf);
        }catch(e){}
      }
      _playBuffer(key, vol=1){
        if (!this.ctx || !this.unlocked) return false;
        const buf = this.buffers.get(key);
        if (!buf) return false;
        const src = this.ctx.createBufferSource();
        const g = this.ctx.createGain();
        g.gain.value = vol;
        src.buffer = buf;
        src.connect(g); g.connect(this.sfxBus);
        src.start();
        return true;
      }
      _beep(vol,freq,dur,type=0){
        if (!this.ctx || !this.unlocked) return;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.type = type===0 ? "sine" : (type===1 ? "triangle" : "square");
        osc.frequency.value = freq;
        g.gain.value = 0;
        osc.connect(g); g.connect(this.sfxBus);
        const t0 = this.ctx.currentTime;
        g.gain.setValueAtTime(0, t0);
        g.gain.linearRampToValueAtTime(vol, t0+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
        osc.start(t0);
        osc.stop(t0+dur+0.02);
      }
      sfx(name){
        const ok = this._playBuffer(name,1);
        if (ok || !this.unlocked) return;
        switch(name){
          case "click":  this._beep(0.06,520,0.06,1); this._beep(0.03,760,0.04,0); break;
          case "paper":  this._beep(0.03,240,0.06,1); this._beep(0.02,310,0.05,1); this._beep(0.02,420,0.05,1); break;
          case "lock":   this._beep(0.06,220,0.08,1); this._beep(0.05,320,0.10,0); break;
          case "wrong":  this._beep(0.05,180,0.10,2); this._beep(0.04,140,0.10,2); break;
          case "success":this._beep(0.06,520,0.08,0); this._beep(0.05,660,0.10,1); this._beep(0.04,820,0.12,0); break;
          case "whoosh": this._beep(0.03,240,0.18,1); this._beep(0.02,180,0.20,1); break;
        }
      }
      async startBGM(){
        if (!this.unlocked) return;
        const url = CONFIG.audio.bgm;
        if (!url) return;
        if (!this.bgmEl){
          this.bgmEl = new Audio(url);
          this.bgmEl.loop = true;
          this.bgmEl.preload = "auto";
          this.bgmEl.volume = this.bgmGain;
        }
        try{ await this.bgmEl.play(); }catch(e){}
      }
    }
    const audio = new AudioEngine();

    /* =========================================================
       Loader / Preload
       ========================================================= */
    const loader = $("loader");
    const barFill = $("barFill");
    const tapToStart = $("tapToStart");

    const PRELOAD = { total:0, done:0, set(p){ barFill.style.width = `${Math.round(p*100)}%`; } };

    async function preloadImages(urls){
      const list = urls.filter(Boolean).slice(0,4);
      PRELOAD.total += list.length;
      await Promise.all(list.map(u => new Promise(resolve=>{
        const img = new Image();
        img.decoding="async";
        img.onload=()=>{ PRELOAD.done++; PRELOAD.set(PRELOAD.done/PRELOAD.total); resolve(true); };
        img.onerror=()=>{ PRELOAD.done++; PRELOAD.set(PRELOAD.done/PRELOAD.total); resolve(false); };
        img.src=u;
      })));
    }
    async function preload(){
      PRELOAD.total = 1;
      PRELOAD.done = 0;
      PRELOAD.set(0);
      PRELOAD.total = CONFIG.images.slice(0,4).length + 1;
      await preloadImages(CONFIG.images.slice(0,4));
      PRELOAD.done++;
      PRELOAD.set(PRELOAD.done/PRELOAD.total);
      tapToStart.classList.add("show");
    }

    /* =========================================================
       Scenes
       ========================================================= */
    const scenes = [
      { el:$("scene1") },
      { el:$("scene2") },
      { el:$("scene3") },
    ];
    let sceneIndex = 0;
    function setBadge(i){ $("sceneBadge").textContent = `–°—Ü–µ–Ω–∞ ${i+1}/3`; }
    function showScene(i){
      sceneIndex = clamp(i,0,2);
      scenes.forEach((s,idx)=>s.el.classList.toggle("active", idx===sceneIndex));
      setBadge(sceneIndex);
    }

    /* =========================================================
       Inertial rotation for 3D object container (applies to #boxObj / #envObj)
       NOTE: This rotates whole 3D object (cube), not a flat image.
       ========================================================= */
    class InertialRotator{
      constructor(el){
        this.el = el;
        this.dragging=false;
        this.rotX = 14;
        this.rotY = -22;
        this.vx=0; this.vy=0;
        this.maxSpeed=260;
        this.damping=10.8;
        this.spring=46;
        this.xMin=-18; this.xMax=30;
        this._px=0; this._py=0;
        this.lastT = now();
        this._raf=null;

        this._down=(e)=>this.onDown(e);
        this._move=(e)=>this.onMove(e);
        this._up=()=>this.onUp();

        this.el.addEventListener("pointerdown", this._down, {passive:false});
        window.addEventListener("pointermove", this._move, {passive:false});
        window.addEventListener("pointerup", this._up, {passive:true});
        window.addEventListener("pointercancel", this._up, {passive:true});

        this.apply();
        this.loop();
      }
      reset(){ this.rotX=14; this.rotY=-22; this.vx=this.vy=0; this.apply(); }
      onDown(e){
        if (e.isPrimary === false) return;
        // if pressed on interactive element (lock/seal/buttons), skip rotation
        const t = e.target;
        if (t.closest && (t.closest("#lockBtn") || t.closest("#sealBtn") || t.closest("button") || t.closest("input"))) return;

        this.dragging=true;
        this.el.setPointerCapture?.(e.pointerId);
        this._px=e.clientX; this._py=e.clientY;
        this.vx=this.vy=0;
        audio.sfx("click");
        e.preventDefault();
      }
      onMove(e){
        if (!this.dragging) return;
        const dx=e.clientX - this._px;
        const dy=e.clientY - this._py;
        this._px=e.clientX; this._py=e.clientY;

        const scale=0.22;
        this.rotY += dx*scale;
        this.rotX -= dy*scale;

        const instantVX = (-dy*scale)*60;
        const instantVY = (dx*scale)*60;
        this.vx = clamp(lerp(this.vx, instantVX, 0.35), -this.maxSpeed, this.maxSpeed);
        this.vy = clamp(lerp(this.vy, instantVY, 0.35), -this.maxSpeed, this.maxSpeed);

        if (this.rotX < this.xMin) this.rotX = lerp(this.rotX, this.xMin, 0.35);
        if (this.rotX > this.xMax) this.rotX = lerp(this.rotX, this.xMax, 0.35);

        this.apply();
        e.preventDefault();
      }
      onUp(){
        if (!this.dragging) return;
        this.dragging=false;
        audio.sfx("paper");
      }
      loop(){
        const t=now();
        const dt=Math.min(0.033, (t-this.lastT)/1000);
        this.lastT=t;

        if (!this.dragging){
          const damp = Math.exp(-this.damping*dt);
          this.vx *= damp; this.vy *= damp;
          this.rotX += this.vx*dt;
          this.rotY += this.vy*dt;

          if (this.rotX < this.xMin){ this.vx += (this.xMin - this.rotX)*this.spring*dt; }
          else if (this.rotX > this.xMax){ this.vx += (this.xMax - this.rotX)*this.spring*dt; }

          this.vx = clamp(this.vx, -this.maxSpeed, this.maxSpeed);
          this.vy = clamp(this.vy, -this.maxSpeed, this.maxSpeed);

          if (Math.abs(this.vx) < 0.02) this.vx=0;
          if (Math.abs(this.vy) < 0.02) this.vy=0;

          if (this.vx || this.vy) this.apply();
        }
        this._raf=requestAnimationFrame(()=>this.loop());
      }
      apply(){
        this.el.style.transform =
          `translateZ(0) rotateX(${this.rotX.toFixed(2)}deg) rotateY(${this.rotY.toFixed(2)}deg)`;
      }
    }

    /* =========================================================
       Reels (slot) - unchanged but reliable
       ========================================================= */
    class Reel{
      constructor(rootEl, listEl, values, formatter){
        this.root=rootEl; this.list=listEl;
        this.values=values;
        this.formatter=formatter||((v)=>String(v));
        this.index=0;
        this.offset=0;
        this.velocity=0;
        this.dragging=false;

        this.itemGap=18;
        this.itemH=24;
        this.maxVel=1800;
        this.damping=12;
        this.snapK=85;

        this._py=0;
        this._lastT=now();

        this.populate();
        this.measure();

        this._down=(e)=>this.onDown(e);
        this._move=(e)=>this.onMove(e);
        this._up=()=>this.onUp();

        this.root.addEventListener("pointerdown", this._down, {passive:false});
        window.addEventListener("pointermove", this._move, {passive:false});
        window.addEventListener("pointerup", this._up, {passive:true});
        window.addEventListener("pointercancel", this._up, {passive:true});

        this.render();
        this.loop();
      }
      populate(){
        this.list.innerHTML="";
        for(let i=0;i<9;i++){
          const d=document.createElement("div");
          d.className="reelItem";
          this.list.appendChild(d);
        }
      }
      measure(){
        const first=this.list.querySelector(".reelItem");
        if (first){
          const r=first.getBoundingClientRect();
          if (r.height>0) this.itemH=r.height;
        }
      }
      setIndex(idx, quiet=false){
        const n=this.values.length;
        this.index=((idx%n)+n)%n;
        if(!quiet) audio.sfx("click");
        this.offset=0; this.velocity=0;
        this.render();
      }
      getValue(){ return this.values[this.index]; }

      onDown(e){
        if (e.isPrimary===false) return;
        this.dragging=true;
        this.root.setPointerCapture?.(e.pointerId);
        this._py=e.clientY;
        this.velocity=0;
        audio.sfx("click");
        e.preventDefault();
      }
      onMove(e){
        if(!this.dragging) return;
        const dy=e.clientY - this._py;
        this._py=e.clientY;

        this.offset += dy;
        this.velocity = clamp(lerp(this.velocity, dy*60, 0.35), -this.maxVel, this.maxVel);

        const step = this.itemH + this.itemGap;
        while(this.offset > step){
          this.offset -= step;
          this.index = (this.index - 1 + this.values.length) % this.values.length;
          audio.sfx("paper");
        }
        while(this.offset < -step){
          this.offset += step;
          this.index = (this.index + 1) % this.values.length;
          audio.sfx("paper");
        }
        this.render();
        e.preventDefault();
      }
      onUp(){
        if(!this.dragging) return;
        this.dragging=false;
        audio.sfx("paper");
      }
      loop(){
        const t=now();
        const dt=Math.min(0.033, (t-this._lastT)/1000);
        this._lastT=t;

        if(!this.dragging){
          const damp=Math.exp(-this.damping*dt);
          this.velocity *= damp;
          this.offset += this.velocity*dt;

          const step=this.itemH+this.itemGap;
          while(this.offset > step){ this.offset -= step; this.index = (this.index-1+this.values.length)%this.values.length; }
          while(this.offset < -step){ this.offset += step; this.index = (this.index+1)%this.values.length; }

          const snapForce = -this.offset * this.snapK;
          this.velocity += snapForce * dt;

          if(Math.abs(this.offset)<0.4 && Math.abs(this.velocity)<8){ this.offset=0; this.velocity=0; }
          this.render();
        }
        requestAnimationFrame(()=>this.loop());
      }
      render(){
        const items=[...this.list.children];
        const center=4;
        const n=this.values.length;
        for(let i=0;i<items.length;i++){
          const rel=i-center;
          const idx=(this.index+rel+n)%n;
          items[i].textContent=this.formatter(this.values[idx]);
          if(Math.abs(rel)>=3) items[i].classList.add("dim");
          else items[i].classList.remove("dim");
        }
        this.list.style.transform=`translateY(${this.offset}px)`;
      }
    }

    /* =========================================================
       FX particles (same lightweight)
       ========================================================= */
    class FX{
      constructor(canvas){
        this.c=canvas;
        this.ctx=canvas.getContext("2d");
        this.w=0; this.h=0;
        this.dpr=Math.min(2, window.devicePixelRatio||1);
        this.particles=[];
        this._last=now();
        this._raf=null;
        window.addEventListener("resize", ()=>this.resize(), {passive:true});
        this.resize();
      }
      resize(){
        const r=this.c.getBoundingClientRect();
        this.w=Math.max(1, Math.floor(r.width));
        this.h=Math.max(1, Math.floor(r.height));
        this.c.width=Math.floor(this.w*this.dpr);
        this.c.height=Math.floor(this.h*this.dpr);
        this.ctx.setTransform(this.dpr,0,0,this.dpr,0,0);
      }
      burst(kind="hearts"){
        const count = kind==="hearts" ? 32 : 44;
        const max=CONFIG.maxParticles;
        const cx=this.w*0.5, cy=this.h*0.42;
        for(let i=0;i<count;i++){
          if(this.particles.length>=max) break;
          const a=Math.random()*Math.PI*2;
          const sp=(kind==="hearts"? (90+Math.random()*220):(120+Math.random()*260));
          const vx=Math.cos(a)*sp;
          const vy=Math.sin(a)*sp - (kind==="hearts"?160:120);
          this.particles.push({
            x: cx+(Math.random()*24-12),
            y: cy+(Math.random()*24-12),
            vx, vy,
            g: kind==="hearts"?620:720,
            life: 1,
            rot: Math.random()*Math.PI*2,
            vr: (Math.random()*2-1)*6,
            s: kind==="hearts"? (10+Math.random()*10):(7+Math.random()*7),
            kind
          });
        }
        if(!this._raf) this.loop();
      }
      loop(){
        const t=now();
        const dt=Math.min(0.033, (t-this._last)/1000);
        this._last=t;

        this.ctx.clearRect(0,0,this.w,this.h);

        for(let i=this.particles.length-1;i>=0;i--){
          const p=this.particles[i];
          p.vy += p.g*dt;
          p.x += p.vx*dt;
          p.y += p.vy*dt;
          p.rot += p.vr*dt;
          p.life -= dt*(p.kind==="hearts"?0.55:0.72);

          const alpha=clamp(p.life,0,1);
          if(alpha<=0 || p.y>this.h+80){
            this.particles.splice(i,1);
            continue;
          }

          this.ctx.save();
          this.ctx.globalAlpha=alpha;
          this.ctx.translate(p.x,p.y);
          this.ctx.rotate(p.rot);

          if(p.kind==="hearts") this.drawHeart(0,0,p.s);
          else this.drawConfetti(0,0,p.s);

          this.ctx.restore();
        }

        if(this.particles.length>0) this._raf=requestAnimationFrame(()=>this.loop());
        else this._raf=null;
      }
      drawHeart(x,y,s){
        const ctx=this.ctx;
        const t=s*0.3;
        ctx.beginPath();
        ctx.moveTo(x, y+t);
        ctx.bezierCurveTo(x, y, x-s/2, y, x-s/2, y+t);
        ctx.bezierCurveTo(x-s/2, y+(s+t)/2, x, y+(s+t)/1.2, x, y+s);
        ctx.bezierCurveTo(x, y+(s+t)/1.2, x+s/2, y+(s+t)/2, x+s/2, y+t);
        ctx.bezierCurveTo(x+s/2, y, x, y, x, y+t);
        ctx.closePath();
        ctx.fillStyle="rgba(255,179,199,.90)";
        ctx.fill();
        ctx.strokeStyle="rgba(0,0,0,.18)";
        ctx.lineWidth=1;
        ctx.stroke();
      }
      drawConfetti(x,y,s){
        const ctx=this.ctx;
        ctx.beginPath();
        ctx.rect(x-s*0.6, y-s*0.3, s*1.2, s*0.6);
        ctx.fillStyle="rgba(255,255,255,.70)";
        ctx.fill();
        ctx.strokeStyle="rgba(0,0,0,.16)";
        ctx.lineWidth=1;
        ctx.stroke();
      }
    }
    const fx = new FX($("fx"));

    /* =========================================================
       Scene 1
       ========================================================= */
    const signModal=$("signModal");
    const courierText=$("courierText");
    const courierBubble=$("courierBubble");
    const btnNo=$("btnNo");
    const btnYes=$("btnYes");
    let noUsed=false;

    function openSignModal(){ signModal.classList.add("show"); }
    function closeSignModal(){ signModal.classList.remove("show"); }

    btnNo.addEventListener("click", ()=>{
      audio.sfx("wrong");
      closeSignModal();
      noUsed=true;
      courierText.textContent="–í—ã —á—Ç–æ, –±–∞–ª–±–µ—Å? –ù–∞ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –ø—Ä–æ—â–∞—é.";
      courierBubble.classList.add("shake");
      setTimeout(()=>courierBubble.classList.remove("shake"), 380);
      setTimeout(()=>{
        openSignModal();
        btnNo.remove(); // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ ‚Äú–î–∞‚Äù
      }, 650);
    });

    btnYes.addEventListener("click", ()=>{
      audio.sfx("click"); audio.sfx("paper");
      closeSignModal();
      courierText.textContent="–ü–æ–¥–ø–∏—Å—å –µ—Å—Ç—å. –ü–µ—Ä–µ–¥–∞—é –∫–æ—Ä–æ–±–∫—É‚Ä¶";
      setTimeout(()=> showScene(1), 520);
    });

    /* =========================================================
       Scene 2: 3D box rotate + lock
       ========================================================= */
    const boxObj=$("boxObj");
    const lockBtn=$("lockBtn");
    const lockModal=$("lockModal");
    const lockBack=$("lockBack");
    const lockDone=$("lockDone");
    const boxReset=$("boxReset");

    const boxRot = new InertialRotator(boxObj);

    boxReset.addEventListener("click", ()=>{ audio.sfx("click"); boxRot.reset(); });

    function openLock(){
      audio.sfx("lock");
      lockModal.classList.add("show");
    }
    function closeLockUI(){
      audio.sfx("paper");
      lockModal.classList.remove("show");
    }

    // IMPORTANT: lock press must not be ‚Äú—Å—ä–µ–¥–µ–Ω‚Äù –ø–æ–≤–æ—Ä–æ—Ç–æ–º.
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º pointerup –∏ stopPropagation + –º–∞–ª–µ–Ω—å–∫–∏–π threshold.
    let lockDown = null;
    lockBtn.addEventListener("pointerdown", (e)=>{
      lockDown = {x:e.clientX, y:e.clientY, t: now()};
      e.stopPropagation();
    }, {passive:true});

    lockBtn.addEventListener("pointerup", (e)=>{
      if(!lockDown) return;
      const dx=Math.abs(e.clientX-lockDown.x);
      const dy=Math.abs(e.clientY-lockDown.y);
      const dt=now()-lockDown.t;
      lockDown=null;
      if(dx<8 && dy<8 && dt<600) openLock();
      e.stopPropagation();
    }, {passive:true});

    lockBack.addEventListener("click", ()=> closeLockUI());

    // Reels
    const days = Array.from({length:31}, (_,i)=>i+1);
    const months = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
    const years = [2020,2021,2022,2023,2024,2025,2026];

    const reelDay = new Reel($("reels").querySelector('[data-reel="day"]'), $("reelDay"), days, v=>String(v));
    const reelMonth = new Reel($("reels").querySelector('[data-reel="month"]'), $("reelMonth"), months, v=>v);
    const reelYear = new Reel($("reels").querySelector('[data-reel="year"]'), $("reelYear"), years, v=>String(v));

    reelDay.setIndex(0,true);
    reelMonth.setIndex(0,true);
    reelYear.setIndex(0,true);

    function lockShake(){
      audio.sfx("wrong");
      const m = lockModal.querySelector(".modal");
      m.classList.add("shake");
      setTimeout(()=>m.classList.remove("shake"), 380);
    }

    async function unlockSequence(){
      audio.sfx("success");
      fx.burst("confetti"); fx.burst("hearts");

      // lock fades
      lockBtn.classList.remove("pulse");
      lockBtn.animate([
        { transform: "translate(-50%,-50%) scale(1)", opacity: 1 },
        { transform: "translate(-50%,-50%) scale(.90)", opacity: 0 }
      ], {duration: 520, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards"});

      closeLockUI();

      // cube ‚Äúopens‚Äù illusion: front face slightly tilts + then scene change
      const front = $("boxFront");
      front.animate([
        { transform: "rotateY(0deg) translateZ(calc(var(--depth) / 2))" },
        { transform: "rotateY(0deg) translateZ(calc(var(--depth) / 2)) rotateX(-10deg)" },
        { transform: "rotateY(0deg) translateZ(calc(var(--depth) / 2)) rotateX(-22deg)", opacity: .0 }
      ], {duration: 720, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards"});

      audio.sfx("whoosh");
      setTimeout(()=> showScene(2), 740);
    }

    lockDone.addEventListener("click", ()=>{
      audio.sfx("click");
      const day = reelDay.getValue();
      const month = reelMonth.getValue();
      const year = reelYear.getValue();
      const ok = (day===CONFIG.lockCode.day && months.indexOf(month)===CONFIG.lockCode.monthIndex && year===CONFIG.lockCode.year);
      if(!ok){ lockShake(); return; }
      unlockSequence();
    });

    /* =========================================================
       Scene 3: 3D envelope rotate + buttons + date
       ========================================================= */
    const envObj=$("envObj");
    const env3d=$("env3d");
    const sealBtn=$("sealBtn");
    const flap=$("flap");
    const throwBtn=$("throwBtn");
    const openBtn=$("openBtn");
    const envBubble=$("envBubble");

    const dateModal=$("dateModal");
    const dateInput=$("dateInput");
    const dateCheck=$("dateCheck");
    const dateHint=$("dateHint");
    const dateCancel=$("dateCancel");

    const finalModal=$("finalModal");
    const restart=$("restart");

    const envRot = new InertialRotator(envObj);

    function toast(text){
      const prev = envBubble.querySelector(".txt").textContent;
      envBubble.querySelector(".txt").textContent = text;
      envBubble.classList.add("shake");
      setTimeout(()=>envBubble.classList.remove("shake"), 380);
      setTimeout(()=> envBubble.querySelector(".txt").textContent = prev, 1200);
    }

    let throwUsed=false;

    throwBtn.addEventListener("click", ()=>{
      audio.sfx("wrong"); audio.sfx("paper");
      toast("–©–∞—Å –ø–æ —à–µ–µ –ø–æ–ª—É—á–∏—à—å");
      if(!throwUsed){
        throwUsed=true;
        throwBtn.classList.add("hidden");
        setTimeout(()=> throwBtn.remove(), 260);
      }
    });

    function openDateCheck(){
      audio.sfx("click"); audio.sfx("paper");
      dateHint.textContent="";
      dateModal.classList.add("show");
      setTimeout(()=>{ try{ dateInput.focus(); }catch(e){} }, 80);
    }
    function closeDateCheck(){
      audio.sfx("paper");
      dateModal.classList.remove("show");
    }

    openBtn.addEventListener("click", ()=>{
      audio.sfx("whoosh");
      // zoom feel
      envObj.animate([
        { transform: envObj.style.transform },
        { transform: envObj.style.transform + " scale(1.06)" }
      ], {duration: 460, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards"});
      setTimeout(()=> openDateCheck(), 260);
    });

    dateCancel.addEventListener("click", ()=>{
      closeDateCheck();
      envObj.animate([
        { transform: envObj.style.transform + " scale(1.06)" },
        { transform: envObj.style.transform }
      ], {duration: 420, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards"});
    });

    function sealFail(){
      audio.sfx("wrong");
      sealBtn.classList.add("wiggle");
      setTimeout(()=>sealBtn.classList.remove("wiggle"), 380);
      dateHint.textContent="–ü–æ—á—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ üòå";
      dateHint.style.color="rgba(20,20,24,.72)";
    }
    function sealSuccess(){
      audio.sfx("success"); audio.sfx("paper");
      closeDateCheck();

      // seal slides away
      sealBtn.animate([
        { transform:"translate(-50%,-50%) rotate(0deg)", opacity: 1 },
        { transform:"translate(-50%,-10%) rotate(16deg)", opacity: 0 }
      ], {duration: 620, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards"});

      // flap opens
      flap.animate([
        { transform:"rotateX(0deg) translateY(0)", opacity:.9 },
        { transform:"rotateX(55deg) translateY(-6px)", opacity:.78 }
      ], {duration: 680, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards"});

      fx.burst("hearts");
      setTimeout(()=>fx.burst("confetti"), 120);

      setTimeout(()=> showFinal(), 680);
    }

    dateCheck.addEventListener("click", ()=>{
      audio.sfx("click");
      const v = dateInput.value;
      if(!v) return sealFail();
      if(v !== CONFIG.fanBirthday) return sealFail();
      sealSuccess();
    });

    /* =========================================================
       Gallery
       ========================================================= */
    const photoEls=[$("ph0"),$("ph1"),$("ph2"),$("ph3")];
    const dots=$("dots");
    let galleryTimer=null;
    let galleryIndex=0;
    let galleryUrls=[];

    function setupGallery(){
      galleryUrls = CONFIG.images.slice(0,4).filter(Boolean);
      for(let i=0;i<photoEls.length;i++){
        const el=photoEls[i];
        if(galleryUrls[i]){
          el.src=galleryUrls[i];
          el.style.display="block";
          el.classList.remove("show");
        }else{
          el.removeAttribute("src");
          el.style.display="none";
          el.classList.remove("show");
        }
      }
      dots.innerHTML="";
      for(let i=0;i<galleryUrls.length;i++){
        const d=document.createElement("div");
        d.className="dot" + (i===0?" on":"");
        dots.appendChild(d);
      }
      galleryIndex=0;
      showPhoto(0);
      if(galleryTimer) clearInterval(galleryTimer);
      if(galleryUrls.length>1){
        galleryTimer=setInterval(()=>showPhoto((galleryIndex+1)%galleryUrls.length), 2700);
      }
    }
    function showPhoto(i){
      if(!galleryUrls.length) return;
      galleryIndex=i;
      for(let k=0;k<photoEls.length;k++){
        photoEls[k].classList.toggle("show", k===i);
      }
      [...dots.children].forEach((d,idx)=>d.classList.toggle("on", idx===i));
    }

    function showFinal(){
      audio.sfx("success");
      finalModal.classList.add("show");
      setupGallery();
      const letter=$("letter");
      letter.animate([
        { transform:"translateY(10px) scale(.99)", opacity:0 },
        { transform:"translateY(0) scale(1)", opacity:1 }
      ], {duration: 640, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards"});
    }

    /* Restart (–ø—Ä–æ—Å—Ç–æ–µ ‚Äî reload, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –∏ –∞–Ω–∏–º–∞—Ü–∏–∏) */
    restart.addEventListener("click", ()=>{
      audio.sfx("click");
      location.reload();
    });

    /* =========================================================
       Boot
       ========================================================= */
    function setDefaultDateConstraints(){
      dateInput.min="1998-01-01";
      dateInput.max="2010-12-31";
      dateInput.value="";
    }

    function startApp(){
      showScene(0);
      setDefaultDateConstraints();
      setTimeout(()=> $("signModal").classList.add("show"), 420);
    }

    // Loader tap unlock
    async function onFirstTap(){
      loader.removeEventListener("pointerdown", onFirstTap);
      audio.sfx("click");
      await audio.unlock();
      loader.classList.add("hide");
      setTimeout(()=> loader.style.display="none", 520);
      startApp();
    }

    (async ()=>{
      await preload();
      try{ await audio.init(); }catch(e){}
      loader.addEventListener("pointerdown", onFirstTap, {passive:true});
    })();
  </script>
</body>
</html>
