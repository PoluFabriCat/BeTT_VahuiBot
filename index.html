<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0b0c0f" />
  <title>–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞</title>

  <style>
    :root{
      --bg:#0b0c0f;

      --paper:#f2efe5;
      --paper2:#eae4d5;

      --cardboard:#c7a07a;
      --cardboard2:#ad8460;

      --pink:#ff4d7d;
      --pink2:#ffb3c7;

      --radius:22px;
      --radius2:28px;

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeLeft: env(safe-area-inset-left, 0px);
      --safeRight: env(safe-area-inset-right, 0px);

      --shadow: 0 18px 40px rgba(0,0,0,.42);
      --shadow2: 0 10px 22px rgba(0,0,0,.28);
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{height:100%; margin:0; background: var(--bg); overflow:hidden;}
    body{
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#f6f6f8;
      user-select:none;
      touch-action: pan-x pan-y;
      overscroll-behavior: none;
    }

    /* ===== CRT + Pixel TV feel (stronger) ===== */
    .crt{
      position:fixed; inset:0; pointer-events:none; z-index:60;
      opacity:.22;
      mix-blend-mode:multiply;
      background:
        radial-gradient(1200px 800px at 50% 50%, rgba(255,255,255,.06), rgba(0,0,0,0) 65%),
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.045) 0px,
          rgba(255,255,255,.045) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 7px
        );
      animation: flick 5.8s linear infinite;
    }
    @keyframes flick{
      0%,100%{opacity:.20}
      20%{opacity:.26}
      55%{opacity:.18}
      80%{opacity:.28}
    }

    .crtMask{
      position:fixed; inset:0; pointer-events:none; z-index:61;
      opacity:.16;
      mix-blend-mode: overlay;
      background:
        repeating-linear-gradient(
          90deg,
          rgba(255,0,0,.09) 0px,
          rgba(255,0,0,.09) 1px,
          rgba(0,255,255,.06) 1px,
          rgba(0,255,255,.06) 2px
        );
      animation: jitter 2.9s steps(10) infinite;
    }
    @keyframes jitter{
      0%,100%{transform: translate(0,0)}
      18%{transform: translate(.6px,0)}
      38%{transform: translate(-.8px,0)}
      58%{transform: translate(.3px,-.2px)}
      78%{transform: translate(-.4px,.2px)}
    }

    .pxGrid{
      position:fixed; inset:0; pointer-events:none; z-index:62;
      opacity:.16;
      mix-blend-mode: overlay;
      background:
        linear-gradient(rgba(255,255,255,.12) 1px, rgba(0,0,0,0) 1px) 0 0/8px 8px,
        linear-gradient(90deg, rgba(255,255,255,.12) 1px, rgba(0,0,0,0) 1px) 0 0/8px 8px;
      filter: contrast(1.2);
      animation: pxShift 1.6s steps(6) infinite;
    }
    @keyframes pxShift{
      0%{transform: translate(0,0)}
      50%{transform: translate(1px,0)}
      100%{transform: translate(0,0)}
    }

    .paper{
      position:relative;
      background: linear-gradient(180deg, var(--paper) 0%, var(--paper2) 100%);
      color: rgba(20,20,24,.92);
      border: 1px solid rgba(0,0,0,.14);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .paper::before{
      content:"";
      position:absolute; inset:0; pointer-events:none;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply;
      opacity:.45;
      transform: scale(1.05);
    }
    .paper::after{
      content:"";
      position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(900px 520px at 50% 0%, rgba(0,0,0,.06), rgba(0,0,0,0) 60%),
        radial-gradient(700px 420px at 0% 100%, rgba(0,0,0,.05), rgba(0,0,0,0) 62%),
        radial-gradient(700px 420px at 100% 100%, rgba(0,0,0,.05), rgba(0,0,0,0) 62%);
      opacity:.9;
    }

    #app{
      position:fixed; inset:0;
      padding: calc(14px + var(--safeTop)) calc(14px + var(--safeRight)) calc(14px + var(--safeBottom)) calc(14px + var(--safeLeft));
      display:flex; align-items:center; justify-content:center;
    }
    .stage{
      width:min(430px, 100%);
      height:min(820px, 100%);
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;
    }

    .viewport{
      position:relative;
      flex:1;
      border-radius: var(--radius2);
      overflow:hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.04);
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(255,255,255,.06), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, #14151a 0%, #0c0d11 100%);
      transform: translateZ(0);
    }

    .scene{
      position:absolute; inset:0;
      padding: 14px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:12px;
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      transition: opacity .45s ease, transform .55s cubic-bezier(.2,.8,.2,1);
    }
    .scene.active{
      opacity:1; transform: translateY(0);
      pointer-events:auto;
    }

    .center{flex:1; display:flex; align-items:center; justify-content:center; position:relative;}
    .row{display:flex; gap:10px; justify-content:center; flex-wrap:wrap;}

    .bubble{
      align-self:center;
      max-width: 92%;
      padding: 10px 12px;
      border-radius: 22px;
      background: linear-gradient(180deg, #f3f0e7, #ebe3d5);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: var(--shadow2);
      color: rgba(20,20,24,.88);
    }
    .bubble .who{font-size:12px; opacity:.7; font-weight:900; margin-bottom:4px;}
    .bubble .txt{font-size:15px; font-weight:900; letter-spacing:.1px;}
    .bubble.small .txt{font-size:13px;}

    .btn{
      border:none;
      padding: 12px 16px;
      border-radius: 20px;
      font-weight: 950;
      font-size: 14px;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      color: rgba(20,20,24,.88);
      background: linear-gradient(180deg, #f3f0e7, #e9e1d3);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      transition: transform .12s ease, filter .12s ease, opacity .22s ease;
    }
    .btn:active{transform: translateY(1px) scale(.99); filter: brightness(.98);}
    .btn.primary{
      background: linear-gradient(180deg, rgba(255,179,199,.95), rgba(255,179,199,.70));
      border: 1px solid rgba(0,0,0,.12);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,185,185,.92), rgba(255,185,185,.70));
      border: 1px solid rgba(0,0,0,.12);
    }
    .btn.ghost{
      background: linear-gradient(180deg, rgba(245,240,230,.70), rgba(235,227,210,.70));
      border: 1px dashed rgba(0,0,0,.20);
    }
    .btn.wide{min-width: 160px;}
    .btn.hidden{opacity:0; pointer-events:none; transform: translateX(12px) scale(.98);}

    /* Screen shakes */
    .shake{animation: shake .35s ease;}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      55%{transform:translateX(6px)}
      75%{transform:translateX(-4px)}
      100%{transform:translateX(0)}
    }
    .screenShake{ animation: screenShake .42s ease; }
    @keyframes screenShake{
      0%{transform: translateZ(0) translateX(0)}
      18%{transform: translateZ(0) translateX(-6px)}
      36%{transform: translateZ(0) translateX(6px)}
      54%{transform: translateZ(0) translateX(-4px)}
      72%{transform: translateZ(0) translateX(4px)}
      100%{transform: translateZ(0) translateX(0)}
    }

    .modalWrap{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.35);
      opacity:0; pointer-events:none;
      transition: opacity .28s ease;
      z-index: 10;
    }
    .modalWrap.show{opacity:1; pointer-events:auto;}
    .modal{
      width:min(390px, 100%);
      padding: 16px;
      border-radius: var(--radius2);
      transform: translateY(10px) scale(.99);
      transition: transform .35s cubic-bezier(.2,.8,.2,1);
    }
    .modalWrap.show .modal{transform: translateY(0) scale(1);}
    .modal h3{margin:0 0 8px 0; font-size:16px; font-weight:950;}
    .modal p{margin:0 0 14px 0; font-size:13px; font-weight:800; color: rgba(20,20,24,.70);}

    /* 3D stage */
    .objectStage{
      width:100%;
      height:100%;
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .objWrap{
      width: min(330px, 86vw);
      aspect-ratio: 1 / 1;
      position:relative;
      perspective: 950px;
      filter: drop-shadow(0 28px 28px rgba(0,0,0,.45));
      touch-action: none;
    }
    .obj{
      width:100%; height:100%;
      position:absolute; inset:0;
      transform-style: preserve-3d;
      will-change: transform;
    }

    .pixelFrame{
      position:absolute; inset:0; border-radius: 28px; pointer-events:none;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.10);
    }
    .pixelFrame::after{
      content:"";
      position:absolute; inset: 6px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.06);
      opacity:.9;
    }

    /* ===== Door (intro) ===== */
    .doorWrap{
      width:min(360px, 92%);
      height:min(520px, 68vh);
      border-radius: 28px;
      position:relative;
      perspective: 1100px;
      filter: drop-shadow(0 26px 26px rgba(0,0,0,.45));
    }
    .door{
      position:absolute; inset:0;
      border-radius: 28px;
      transform-style:preserve-3d;
      transform: rotateY(0deg);
      transform-origin: 0% 50%;
      transition: transform 900ms cubic-bezier(.2,.8,.2,1);
      background:
        radial-gradient(800px 520px at 50% 0%, rgba(255,255,255,.08), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, #3a2d22, #241b14);
      border: 1px solid rgba(0,0,0,.35);
      overflow:hidden;
    }
    .door::before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,0) 35%),
        repeating-linear-gradient(
          90deg,
          rgba(0,0,0,.10) 0px,
          rgba(0,0,0,.10) 2px,
          rgba(255,255,255,.03) 2px,
          rgba(255,255,255,.03) 6px
        );
      opacity:.65;
      pointer-events:none;
    }
    .doorPanel{
      position:absolute; left:10%; right:10%; top:12%; bottom:12%;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.18);
    }
    .doorHandle{
      position:absolute;
      right: 12%;
      top: 52%;
      width: 46px; height: 14px;
      border-radius: 999px;
      background: linear-gradient(180deg, #e2c28a, #b98c3d);
      border: 1px solid rgba(0,0,0,.35);
      box-shadow: 0 10px 14px rgba(0,0,0,.25);
      transform: translateY(-50%);
    }
    .doorKey{
      position:absolute;
      right: 12%;
      top: 57%;
      width: 16px; height: 16px;
      border-radius: 6px;
      background: rgba(0,0,0,.38);
      border: 1px solid rgba(255,255,255,.06);
      transform: translate(14px,-50%);
    }
    .door.open{
      transform: rotateY(-70deg);
    }

    /* ===== Box cuboid ===== */
    .box3d{
      --w: 270px;
      --h: 240px;
      --d: 170px;
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      transform-style: preserve-3d;
      will-change: transform;
      transition: transform 820ms cubic-bezier(.18,.88,.16,1), opacity 500ms ease;
    }
    .box3d.drop{
      transform: translate(-50%,-50%) translateY(88px) scale(.98);
      opacity: .96;
    }
    .bface{
      position:absolute;
      left:50%; top:50%;
      border-radius: 22px;
      border: 1px solid rgba(0,0,0,.18);
      overflow:hidden;
      background: linear-gradient(180deg, var(--cardboard), var(--cardboard2));
    }
    .bface::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.16'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply; opacity:.55;
      transform: scale(1.06);
      pointer-events:none;
    }
    .bface::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(220px 160px at 25% 15%, rgba(255,255,255,.18), rgba(255,255,255,0) 62%),
        radial-gradient(240px 180px at 80% 20%, rgba(255,255,255,.12), rgba(255,255,255,0) 65%),
        linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,0) 40%);
      opacity:.95;
      pointer-events:none;
    }

    .bface.front, .bface.back{ width: var(--w); height: var(--h); }
    .bface.right, .bface.left{
      width: var(--d); height: var(--h);
      background: linear-gradient(180deg, #b08863, #8f6a49);
    }
    .bface.top, .bface.bottom{ width: var(--w); height: var(--d); }
    .bface.back{ background: linear-gradient(180deg, #b18a64, #916a49); }
    .bface.bottom{ background: linear-gradient(180deg, #9a7350, #7a5a3f); }
    .bface.top{ background: linear-gradient(180deg, #d3b08d, #b99570); }

    .bface.front  { transform: translate(-50%,-50%) rotateY(0deg)   translateZ(calc(var(--d)/2)); }
    .bface.back   { transform: translate(-50%,-50%) rotateY(180deg) translateZ(calc(var(--d)/2)); }
    .bface.right  { transform: translate(-50%,-50%) rotateY(90deg)  translateZ(calc(var(--w)/2)); }
    .bface.left   { transform: translate(-50%,-50%) rotateY(-90deg) translateZ(calc(var(--w)/2)); }

    /* FIX lid: sits on the box + rotates around back edge */
    .bface.top{
      transform-origin: 50% 100%;
      transition: transform .88s cubic-bezier(.2,.8,.2,1);
    }
    /* closed top: flush with box */
    .bface.top{
      transform: translate(-50%,-50%) rotateX(90deg) translateZ(calc(var(--h)/2 - 0px));
    }
    .bface.bottom { transform: translate(-50%,-50%) rotateX(-90deg) translateZ(calc(var(--h)/2 - 1px)); }

    .box3d.opened .bface.top{
      transform: translate(-50%,-50%) rotateX(90deg) translateZ(calc(var(--h)/2 - 0px)) rotateX(-112deg);
    }

    .label{
      position:absolute; left: 12%; right:12%; top: 12%;
      padding: 10px 12px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.74), rgba(240,235,220,.90));
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 10px 18px rgba(0,0,0,.16);
      text-align:center;
      font-weight: 950;
      color: rgba(20,20,24,.88);
    }
    .label small{
      display:block;
      margin-top:4px;
      font-size:12px;
      font-weight:900;
      color: rgba(30,30,34,.58);
    }
    .tape{
      position:absolute; left: 10%; right:10%; top: 46%;
      height: 16%;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,240,200,.82), rgba(230,205,160,.80));
      border:1px solid rgba(0,0,0,.12);
      transform: rotate(-3deg);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.20), inset 0 -2px 0 rgba(0,0,0,.10);
      opacity:.95;
    }

    /* 3D lock on box */
    .lock3d{
      position:absolute;
      left:50%; top: 66%;
      width: 92px; height: 92px;
      transform: translate(-50%,-50%);
      transform-style: preserve-3d;
      cursor:pointer;
      touch-action: manipulation;
      z-index: 5;
    }
    .lockBody{
      position:absolute; inset:0;
      border-radius: 22px;
      background: linear-gradient(180deg, #f2ddaa, #d9b96a);
      border: 1px solid rgba(0,0,0,.16);
      box-shadow: 0 14px 22px rgba(0,0,0,.22);
      transform: translateZ(10px);
    }
    .lockBody::before{
      content:"";
      position:absolute; inset:10px;
      border-radius: 18px;
      background: rgba(0,0,0,.08);
      border: 1px dashed rgba(0,0,0,.18);
    }
    .lockBack{
      position:absolute; inset:0;
      border-radius: 22px;
      background: linear-gradient(180deg, #caa95f, #b08a3c);
      border: 1px solid rgba(0,0,0,.16);
      transform: translateZ(-10px);
    }
    .lockSide{
      position:absolute;
      left:0; top:0;
      width: 20px; height: 92px;
      background: linear-gradient(180deg, #caa95f, #9e7a2f);
      border: 1px solid rgba(0,0,0,.16);
      transform-origin: left center;
      transform: rotateY(90deg) translateZ(10px);
      border-radius: 10px;
    }
    .lockSide.r{
      left:auto; right:0;
      transform-origin: right center;
      transform: rotateY(-90deg) translateZ(10px);
    }
    .lockShackle{
      position:absolute;
      left:50%; top: 18%;
      width: 36px; height: 26px;
      transform: translate(-50%,-50%) translateZ(12px);
      border-radius: 16px 16px 12px 12px;
      border: 6px solid rgba(30,24,10,.55);
      border-bottom: 0;
      opacity:.95;
    }
    .lockKeyhole{
      position:absolute;
      left:50%; top: 62%;
      width: 20px; height: 28px;
      transform: translate(-50%,-50%) translateZ(12px);
      border-radius: 10px;
      background: rgba(30,24,10,.55);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.16);
    }
    .lock3d.pulse{ animation: lockPulse 1.25s infinite ease-in-out; }
    @keyframes lockPulse{
      0%,100%{transform: translate(-50%,-50%) scale(1)}
      50%{transform: translate(-50%,-50%) scale(1.06)}
    }

    /* ===== Envelope 3D prism ===== */
    .env3d{
      --w: 280px;
      --h: 190px;
      --d: 56px;
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      transform-style: preserve-3d;
      transition: transform 900ms cubic-bezier(.18,.88,.16,1), opacity 550ms ease;
      will-change: transform, opacity;
    }
    .env3d.downOut{
      transform: translate(-50%,-50%) translateY(132px) scale(.96);
      opacity: .12;
    }
    .eface{
      position:absolute;
      left:50%; top:50%;
      border-radius: 22px;
      border: 1px solid rgba(0,0,0,.16);
      overflow:hidden;
      background: linear-gradient(180deg, #f6e6ea 0%, #e7bcc8 100%);
    }
    .eface::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.78' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply; opacity:.55; transform: scale(1.06);
      pointer-events:none;
    }
    .eface.front, .eface.back{ width: var(--w); height: var(--h); }
    .eface.left, .eface.right{ width: var(--d); height: var(--h); background: linear-gradient(180deg, #d9a9b8, #b98797); }
    .eface.top, .eface.bottom{ width: var(--w); height: var(--d); background: linear-gradient(180deg, #eec4d1, #c99aa9); }

    .eface.front  { transform: translate(-50%,-50%) rotateY(0deg)   translateZ(calc(var(--d)/2)); }
    .eface.back   { transform: translate(-50%,-50%) rotateY(180deg) translateZ(calc(var(--d)/2)); background: linear-gradient(180deg, #f1d3dc, #d9a9b8); }
    .eface.right  { transform: translate(-50%,-50%) rotateY(90deg)  translateZ(calc(var(--w)/2)); }
    .eface.left   { transform: translate(-50%,-50%) rotateY(-90deg) translateZ(calc(var(--w)/2)); }
    .eface.top    { transform: translate(-50%,-50%) rotateX(90deg)  translateZ(calc(var(--h)/2)); }
    .eface.bottom { transform: translate(-50%,-50%) rotateX(-90deg) translateZ(calc(var(--h)/2)); }

    .envFrontUI{ position:absolute; inset:0; }
    .envLabel{
      position:absolute;
      left: 12%;
      right: 12%;
      top: 10px;
      padding: 8px 10px;
      border-radius: 16px;
      text-align:center;
      font-weight: 950;
      font-size: 13px;
      color: rgba(20,20,24,.82);
      background: linear-gradient(180deg, rgba(255,255,255,.68), rgba(240,235,220,.88));
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 18px rgba(0,0,0,.14);
      pointer-events:none;
    }

    .envFlap{
      position:absolute; left: 10%; right:10%; top: 22%;
      height: 50%;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.44), rgba(0,0,0,.06));
      clip-path: polygon(50% 86%, 0% 0%, 100% 0%);
      opacity:.92;
      transform-origin: 50% 0%;
      transform: rotateX(0deg);
      transition: transform .78s cubic-bezier(.2,.8,.2,1), opacity .78s cubic-bezier(.2,.8,.2,1);
    }
    .env3d.opened .envFlap{
      transform: rotateX(62deg) translateY(-6px);
      opacity:.80;
    }

    .seal{
      position:absolute; left:50%; top: 62%;
      width: 84px; height: 84px;
      transform: translate(-50%,-50%);
      border-radius: 24px;
      background: linear-gradient(180deg, #ff6c90, #ff3f73);
      border: 1px solid rgba(0,0,0,.18);
      box-shadow: 0 16px 22px rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      touch-action: manipulation;
    }
    .seal b{color: rgba(20,10,14,.72); font-size:18px; font-weight:950;}
    .seal.pulse{ animation: sealPulse 1.15s ease-in-out infinite; }
    @keyframes sealPulse{
      0%,100%{transform: translate(-50%,-50%) scale(1)}
      50%{transform: translate(-50%,-50%) scale(1.07)}
    }

    /* Reels */
    .reels{
      display:grid;
      grid-template-columns: 1fr 1.2fr 1fr;
      gap: 10px;
    }
    .reel{
      position:relative;
      height: 160px;
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.88), rgba(240,235,220,.96));
      box-shadow: 0 12px 22px rgba(0,0,0,.14);
      touch-action: none;
    }
    .reel::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply;
      opacity:.40;
      pointer-events:none;
    }
    .reelHeader{
      position:absolute; top: 10px; left:10px; right:10px;
      font-weight: 950;
      font-size: 12px;
      color: rgba(30,30,34,.62);
      text-align:center;
      pointer-events:none;
    }
    .windowLine{
      position:absolute; left:10px; right:10px; top: 50%;
      height: 46px;
      transform: translateY(-50%);
      border-radius: 16px;
      border: 1px dashed rgba(20,20,26,.25);
      background: rgba(255,255,255,.50);
      pointer-events:none;
    }
    .reelList{
      position:absolute; left:0; right:0; top:0; bottom:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 18px;
      padding: 24px 10px;
      transform: translateY(0);
      will-change: transform;
    }
    .reelItem{
      font-weight: 950;
      font-size: 18px;
      color: rgba(20,20,26,.86);
      text-align:center;
      letter-spacing:.4px;
      min-height: 22px;
      padding: 2px 6px;
      border-radius: 10px;
    }
    .reelItem.dim{opacity:.38; filter: blur(.1px);}
    .lockFooter{display:flex; gap:10px;}
    .lockFooter .btn{flex:1}

    /* Letter */
    .notebook{
      width:min(390px,100%);
      padding: 16px 16px 14px 16px;
      border-radius: 22px;
      border: 1px solid rgba(0,0,0,.14);
      box-shadow: var(--shadow);
      background:
        linear-gradient(90deg, rgba(255,75,115,.55) 0 2px, rgba(0,0,0,0) 2px) 34px 0/100% 100% no-repeat,
        repeating-linear-gradient(
          to bottom,
          rgba(80,150,255,.26) 0px,
          rgba(80,150,255,.26) 1px,
          rgba(0,0,0,0) 22px,
          rgba(0,0,0,0) 26px
        ),
        linear-gradient(180deg, #fbfaf6, #f1eadc);
      color: rgba(20,20,24,.88);
      position:relative;
      overflow:hidden;
    }
    .notebook::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply;
      opacity:.35;
      pointer-events:none;
    }
    .noteTitle{
      font-weight: 950;
      font-size: 16px;
      margin: 0 0 10px 0;
      padding-left: 22px;
    }
    .noteText{
      padding-left: 22px;
      font-weight: 900;
      font-size: 14px;
      line-height: 1.55;
      letter-spacing:.1px;
    }
    .noteText div{ margin: 2px 0; }

    .foot{
      display:flex; justify-content:center;
      color: rgba(255,255,255,.50);
      font-weight:800;
      font-size:11px;
      padding-bottom: 2px;
    }

    /* Loader */
    .loader{
      position:fixed; inset:0; z-index:90;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, #101116, #08080b);
      transition: opacity .45s ease, transform .55s ease;
    }
    .loader.hide{opacity:0; pointer-events:none; transform: translateY(-6px);}
    .loaderCard{
      width: min(380px, 92vw);
      padding: 16px;
      border-radius: 28px;
      background: linear-gradient(180deg, #f3f0e7, #ebe3d5);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: var(--shadow);
      text-align:center;
      color: rgba(20,20,24,.88);
      position:relative;
      overflow:hidden;
    }
    .loaderCard::before{
      content:"";
      position:absolute; inset:0; pointer-events:none;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.16'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply; opacity:.35;
    }
    .loaderTitle{font-weight: 950; font-size:16px; margin-bottom:6px;}
    .loaderSub{font-weight: 850; font-size:12px; color: rgba(20,20,24,.70); margin-bottom:14px; line-height:1.25;}
    .bar{
      height: 12px; border-radius: 999px;
      background: rgba(0,0,0,.08);
      border: 1px solid rgba(0,0,0,.10);
      overflow:hidden;
      box-shadow: inset 0 2px 0 rgba(255,255,255,.10);
    }
    .bar > i{
      display:block; height:100%; width:0%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,179,199,.95), rgba(255,179,199,.70));
      transition: width .22s ease;
    }
    .tapToStart{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(255,179,199,.75), rgba(255,179,199,.55));
      border: 1px solid rgba(0,0,0,.10);
      font-weight: 950;
      font-size: 12px;
      display:inline-flex; align-items:center; gap:10px;
      opacity:0; transform: translateY(6px);
      transition: opacity .35s ease, transform .45s cubic-bezier(.2,.8,.2,1);
    }
    .tapToStart.show{opacity:1; transform: translateY(0);}
    .tapDot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(255,77,125,.95);
      box-shadow: 0 0 0 6px rgba(255,77,125,.12);
      animation: tapPulse 1.1s infinite ease-in-out;
    }
    @keyframes tapPulse{0%,100%{transform: scale(1)}50%{transform: scale(1.35)}}

    /* FX canvases */
    canvas#fx{ position:absolute; inset:0; pointer-events:none; z-index: 6; }
    /* Real pixelation overlay: low-res canvas scaled up by CSS */
    canvas#pix{
      position:absolute; inset:0; pointer-events:none; z-index: 7;
      image-rendering: pixelated;
      opacity:.28;
      mix-blend-mode: overlay;
      filter: contrast(1.25);
      transform: translateZ(0);
    }

    /* Envelope rise out of box + box goes down */
    .envPull{
      position:absolute;
      left:50%; top:64%;
      transform: translate(-50%,-50%) translateY(44px) rotateZ(0deg) rotateY(-10deg) scale(.76);
      opacity:0;
      pointer-events:none;
      z-index: 9;
      filter: drop-shadow(0 26px 26px rgba(0,0,0,.40));
      will-change: transform, opacity;
    }
    .envPull.fly{
      opacity:1;
      animation: envRise 950ms cubic-bezier(.18,.88,.16,1) both;
    }
    @keyframes envRise{
      0%{
        transform: translate(-50%,-50%) translateY(54px) rotateZ(0deg) rotateY(-12deg) scale(.74);
        opacity:0;
      }
      20%{ opacity:1; }
      100%{
        transform: translate(-50%,-50%) translateY(-116px) rotateZ(-10deg) rotateY(14deg) scale(.92);
        opacity:1;
      }
    }

    /* Letter transition */
    .letterSlide{
      position:absolute;
      left:50%;
      top:50%;
      width:min(390px, 92%);
      transform: translate(-50%,-50%) translateY(12px) scale(.94);
      opacity:0;
      pointer-events:none;
      z-index: 12;
      filter: drop-shadow(0 22px 22px rgba(0,0,0,.35));
    }
    .letterSlide.show{
      opacity:1;
      pointer-events:auto;
      animation: letterPop 700ms cubic-bezier(.18,.88,.16,1) both;
    }
    @keyframes letterPop{
      0%{ transform: translate(-50%,-50%) translateY(22px) scale(.92); opacity:0; }
      100%{ transform: translate(-50%,-50%) translateY(-10px) scale(1); opacity:1; }
    }

    /* Center message */
    .centerMsg{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index: 30;
      pointer-events:none;
      opacity:0;
      transition: opacity .22s ease;
    }
    .centerMsg.show{opacity:1;}
    .centerMsgBox{
      max-width: 92%;
      padding: 12px 14px;
      border-radius: 22px;
      background: linear-gradient(180deg, #f3f0e7, #ebe3d5);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: var(--shadow2);
      color: rgba(20,20,24,.88);
      font-weight: 950;
      text-align:center;
    }

    /* "New item unlocked" */
    .unlockToast{
      position:absolute;
      left:50%; top:14%;
      transform: translate(-50%,-50%) translateY(8px) scale(.98);
      opacity:0;
      z-index: 40;
      pointer-events:none;
      transition: opacity .22s ease, transform .35s cubic-bezier(.2,.8,.2,1);
    }
    .unlockToast.show{
      opacity:1;
      transform: translate(-50%,-50%) translateY(0) scale(1);
    }
    .unlockToast .paper{ padding: 12px 14px; }

    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important;}
    }
  </style>
</head>

<body>
  <div class="loader" id="loader">
    <div class="loaderCard">
      <div class="loaderTitle">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶</div>
      <div class="loaderSub">–û–¥–∏–Ω —Ä–∞–∑ —Ç–∞–ø–Ω–∏ ‚Äî —á—Ç–æ–±—ã Telegram —Ä–∞–∑—Ä–µ—à–∏–ª –º—É–∑—ã–∫—É.</div>
      <div class="bar"><i id="barFill"></i></div>
      <div class="tapToStart" id="tapToStart"><span class="tapDot"></span>–¢–∞–ø–Ω–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
    </div>
  </div>

  <div id="app">
    <div class="stage">
      <div class="viewport" id="viewport">
        <canvas id="fx"></canvas>
        <canvas id="pix"></canvas>

        <div class="unlockToast" id="unlockToast">
          <div class="paper">
            <div style="font-weight:950;color:rgba(20,20,24,.9); text-align:center;">
              –í–∞–º –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç ‚ú®
              <div style="font-weight:850; font-size:12px; color:rgba(20,20,24,.64); margin-top:4px;">
                3D –ø–æ—Å—ã–ª–∫–∞
              </div>
            </div>
          </div>
        </div>

        <!-- STEP 0: DOOR -->
        <section class="scene active" id="step0">
          <div class="bubble" id="doorBubble">
            <div class="who">???</div>
            <div class="txt" id="doorText">*—Ç—É–∫-—Ç—É–∫*</div>
          </div>

          <div class="center">
            <div class="objectStage">
              <div class="doorWrap">
                <div class="door" id="door">
                  <div class="doorPanel"></div>
                  <div class="doorHandle"></div>
                  <div class="doorKey"></div>
                </div>
              </div>

              <div class="modalWrap show" id="doorModal">
                <div class="modal paper">
                  <h3>–í –¥–≤–µ—Ä—å —Å—Ç—É—á–∞—Ç—Å—è</h3>
                  <p id="doorModalText">–û—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å?</p>
                  <div class="row" id="doorButtons">
                    <button class="btn ghost wide" id="doorNo">–ù–µ—Ç</button>
                    <button class="btn primary wide" id="doorYes">–î–∞</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- STEP 1: COURIER DIALOG -->
        <section class="scene" id="step1">
          <div class="bubble" id="courierBubble">
            <div class="who" id="courierWho">–ö—É—Ä—å–µ—Ä</div>
            <div class="txt" id="courierText">–ü—Ä–∏–≤–µ—Ç. –í—ã –î–∂–∞–º–∞?</div>
          </div>

          <div class="center">
            <div class="objectStage">
              <div class="paper" style="width:min(380px,100%); padding:14px;">
                <div style="display:flex; gap:12px; align-items:center;">
                  <div style="width:78px;height:78px;border-radius:22px;background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.10);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;">
                    <div style="width:54px;height:54px;border-radius:20px;background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.08));border:1px solid rgba(0,0,0,.10);"></div>
                    <div style="position:absolute;bottom:8px;left:10px;right:10px;height:8px;border-radius:6px;background:rgba(0,0,0,.10);"></div>
                  </div>
                  <div style="flex:1;">
                    <div style="font-weight:950;font-size:16px;">–Ø–Ω–¥–µ–∫—Å-–¥–æ—Å—Ç–∞–≤—â–∏–∫</div>
                    <div style="margin-top:4px;color:rgba(0,0,0,.62);font-weight:850;font-size:12px;line-height:1.2;">
                      ‚Äú–Ø –Ω–µ –ø–æ–¥–∫–∞—Ç—ã–≤–∞—é. –Ø —Ä–∞–±–æ—Ç–∞—é.‚Äù üòê
                    </div>
                  </div>
                </div>
              </div>

              <div class="modalWrap show" id="courierModal">
                <div class="modal paper">
                  <h3 id="courierTitle">–í–æ–ø—Ä–æ—Å</h3>
                  <p id="courierPrompt">–ü—Ä–∏–≤–µ—Ç. –í—ã –î–∂–∞–º–∞?</p>
                  <div class="row" id="courierButtons"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- STEP 2: BOX (as before) -->
        <section class="scene" id="step2">
          <div class="bubble small" id="boxBubble">
            <div class="who">–ü–æ—Å—ã–ª–∫–∞</div>
            <div class="txt">–ü–æ–∫—Ä—É—Ç–∏ –∫–æ—Ä–æ–±–∫—É –ø–∞–ª—å—Ü–µ–º –∏ –Ω–∞–∂–º–∏ –Ω–∞ –∑–∞–º–æ–∫.</div>
          </div>

          <div class="center">
            <div class="objectStage">
              <div class="objWrap" id="boxWrap">
                <div class="obj" id="boxObj">
                  <div class="box3d" id="box3d">
                    <div class="bface front" id="boxFront">
                      <div class="label">–¥–ª—è –î–∂–∞–º—ã <small>–æ—Ç —Ñ–∞–Ω–∞—Ç–∞ üòâ</small></div>
                      <div class="tape"></div>

                      <div class="lock3d pulse" id="lockBtn" aria-label="lock">
                        <div class="lockBack"></div>
                        <div class="lockSide"></div>
                        <div class="lockSide r"></div>
                        <div class="lockBody"></div>
                        <div class="lockShackle"></div>
                        <div class="lockKeyhole"></div>
                      </div>
                    </div>

                    <div class="bface back"></div>
                    <div class="bface right"></div>
                    <div class="bface left"></div>
                    <div class="bface top" id="boxTop"></div>
                    <div class="bface bottom"></div>
                  </div>
                </div>

                <div class="pixelFrame"></div>

                <!-- envelope preview that rises out -->
                <div class="envPull" id="envPull">
                  <div class="env3d">
                    <div class="eface front">
                      <div class="envFrontUI">
                        <div class="envLabel">–ö–æ–Ω–≤–µ—Ä—Ç</div>
                        <div class="envFlap"></div>
                        <div class="seal" style="top:62%;"><b>‚ô•</b></div>
                      </div>
                    </div>
                    <div class="eface back"></div>
                    <div class="eface right"></div>
                    <div class="eface left"></div>
                    <div class="eface top"></div>
                    <div class="eface bottom"></div>
                  </div>
                </div>
              </div>

              <div class="modalWrap" id="lockModal">
                <div class="modal paper">
                  <h3>–ß—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å, –≤–≤–µ–¥–∏ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π</h3>
                  <p>–°–≤–∞–π–ø–∞–π –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ –Ω–∞ –∫–æ–ª—ë—Å–∏–∫–∞—Ö. –ü–æ—Ç–æ–º –Ω–∞–∂–º–∏ ‚Äú–ì–æ—Ç–æ–≤–æ‚Äù.</p>

                  <div class="reels" id="reels">
                    <div class="reel" data-reel="day">
                      <div class="reelHeader">–î–ï–ù–¨</div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="reelDay"></div>
                    </div>
                    <div class="reel" data-reel="month">
                      <div class="reelHeader">–ú–ï–°–Ø–¶</div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="reelMonth"></div>
                    </div>
                    <div class="reel" data-reel="year">
                      <div class="reelHeader">–ì–û–î</div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="reelYear"></div>
                    </div>
                  </div>

                  <div class="lockFooter" style="margin-top:12px;">
                    <button class="btn ghost" id="lockBack">–ù–∞–∑–∞–¥</button>
                    <button class="btn primary" id="lockDone">–ì–æ—Ç–æ–≤–æ</button>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="row">
            <button class="btn ghost wide" id="boxReset">–°–±—Ä–æ—Å–∏—Ç—å –≤—Ä–∞—â–µ–Ω–∏–µ</button>
          </div>
        </section>

        <!-- STEP 3: ENVELOPE -->
        <section class="scene" id="step3">
          <div class="bubble small" id="envBubble">
            <div class="who" id="envWho">–ö–æ–Ω–≤–µ—Ä—Ç</div>
            <div class="txt" id="envHint">–ù–∞–∂–º–∏ –Ω–∞ –ø–µ—á–∞—Ç—å (–æ–Ω–∞ ‚Äú—Å –∑–∞–º–∫–æ–º‚Äù).</div>
          </div>

          <div class="center">
            <div class="objectStage">

              <div class="centerMsg" id="centerMsg">
                <div class="centerMsgBox" id="centerMsgBox"></div>
              </div>

              <div class="objWrap" id="envWrap">
                <div class="obj" id="envObj">
                  <div class="env3d" id="env3d">
                    <div class="eface front">
                      <div class="envFrontUI">
                        <div class="envLabel">–ö–æ–Ω–≤–µ—Ä—Ç</div>
                        <div class="envFlap" id="flap"></div>
                        <div class="seal pulse" id="sealBtn" aria-label="seal"><b>‚ô•</b></div>
                      </div>
                    </div>
                    <div class="eface back"></div>
                    <div class="eface right"></div>
                    <div class="eface left"></div>
                    <div class="eface top"></div>
                    <div class="eface bottom"></div>
                  </div>
                </div>
                <div class="pixelFrame"></div>

                <div class="letterSlide" id="letterSlide">
                  <div class="notebook">
                    <div class="noteTitle">–ü–∏—Å—å–º–æ üìù</div>
                    <div class="noteText" id="letterText">
                      <div>–î–∂–∞–º–∞, –ø—Ä–∏–≤–µ—Ç‚Ä¶</div>
                      <div>–Ø —Å–ø—Ä—è—Ç–∞–ª(–∞) —ç—Ç–æ –ø–∏—Å—å–º–æ –≤–Ω—É—Ç—Ä–∏ –ø–æ—Å—ã–ª–∫–∏,</div>
                      <div>—á—Ç–æ–±—ã —Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –≤–µ—â—å:</div>
                      <div>—Ç—ã ‚Äî –º–æ–π —Å–∞–º—ã–π –∫—Ä–∞—Å–∏–≤—ã–π ‚Äú—Å—á–∞—Å—Ç–ª–∏–≤—ã–π —Å–ª—É—á–∞–π‚Äù.</div>
                      <div>–ü—É—Å—Ç—å —É —Ç–µ–±—è –±—É–¥–µ—Ç —Ç–µ–ø–ª–æ,</div>
                      <div>–¥–∞–∂–µ –∫–æ–≥–¥–∞ –≤–æ–∫—Ä—É–≥ —Ö–æ–ª–æ–¥–Ω–æ.</div>
                      <div>‚ô•</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="modalWrap" id="envLockModal">
                <div class="modal paper">
                  <h3>–ö–æ–≥–¥–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —É –≤–∞—à–µ–≥–æ —Ñ–∞–Ω–∞—Ç–∞?</h3>
                  <p>–°–≤–∞–π–ø–∞–π –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ –Ω–∞ –∫–æ–ª—ë—Å–∏–∫–∞—Ö. –ü–æ—Ç–æ–º –Ω–∞–∂–º–∏ ‚Äú–ì–æ—Ç–æ–≤–æ‚Äù.</p>

                  <div class="reels" id="envReels">
                    <div class="reel" data-reel="day">
                      <div class="reelHeader">–î–ï–ù–¨</div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="envReelDay"></div>
                    </div>
                    <div class="reel" data-reel="month">
                      <div class="reelHeader">–ú–ï–°–Ø–¶</div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="envReelMonth"></div>
                    </div>
                    <div class="reel" data-reel="year">
                      <div class="reelHeader">–ì–û–î</div>
                      <div class="windowLine"></div>
                      <div class="reelList" id="envReelYear"></div>
                    </div>
                  </div>

                  <div class="lockFooter" style="margin-top:12px;">
                    <button class="btn ghost" id="envLockBack">–ù–∞–∑–∞–¥</button>
                    <button class="btn primary" id="envLockDone">–ì–æ—Ç–æ–≤–æ</button>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="row" id="envButtons">
            <button class="btn danger wide" id="throwBtn">–í—ã–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </section>

      </div>

      <div class="foot">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è ‚Ä¢ Telegram WebView</div>
    </div>
  </div>

  <div class="crt" aria-hidden="true"></div>
  <div class="crtMask" aria-hidden="true"></div>
  <div class="pxGrid" aria-hidden="true"></div>

  <script>
    /* =========================================================
       CONFIG
       ========================================================= */
    const CONFIG = {
      audio: {
        bgm: "Audio/JeTeLaisseraiDesMots.mp3",
        click: "Audio/click.mp3",
        paper: "Audio/paper.mp3",
        lock: "Audio/lock.mp3",
        success: "Audio/success.mp3",
        wrong: "Audio/wrong.mp3",
        whoosh: "Audio/whoosh.mp3"
      },
      boxLock: { day: 5, monthIndex: 10, year: 2025 },
      envLock: { day: 1, monthIndex: 1, year: 2005 },
      maxParticles: 90
    };

    const $ = (id)=>document.getElementById(id);
    const clamp = (v,a,b)=>Math.max(a, Math.min(b,v));
    const lerp = (a,b,t)=>a+(b-a)*t;
    const now = ()=>performance.now();

    function screenShake(){
      const vp = $("viewport");
      vp.classList.remove("screenShake");
      // restart anim
      void vp.offsetWidth;
      vp.classList.add("screenShake");
      setTimeout(()=>vp.classList.remove("screenShake"), 520);
    }

    /* =========================================================
       Audio (kept lightweight, fallback beeps)
       ========================================================= */
    class AudioEngine{
      constructor(){
        this.ctx=null; this.unlocked=false;
        this.buffers=new Map();
        this.bgmEl=null;
        this.bgmGain=0.24;
        this.sfxGain=0.70;
        this.master=null; this.sfxBus=null;
      }
      async init(){
        if (this.ctx) return;
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        this.ctx = new AC();
        this.master = this.ctx.createGain();
        this.master.gain.value = 0.85;
        this.master.connect(this.ctx.destination);
        this.sfxBus = this.ctx.createGain();
        this.sfxBus.gain.value = this.sfxGain;
        this.sfxBus.connect(this.master);

        const sfxKeys = ["click","paper","lock","success","wrong","whoosh"];
        await Promise.all(sfxKeys.map(k=>this._tryLoadBuffer(k, CONFIG.audio[k])));
      }
      async unlock(){
        if (!this.ctx) await this.init();
        if (!this.ctx) return;
        try{ if (this.ctx.state!=="running") await this.ctx.resume(); }catch(e){}
        this._beep(0.0001,220,0.01,0);
        this.unlocked=true;
        this.startBGM();
      }
      async _tryLoadBuffer(key,url){
        if (!url) return;
        try{
          const res = await fetch(url, {cache:"force-cache"});
          if (!res.ok) return;
          const arr = await res.arrayBuffer();
          const buf = await this.ctx.decodeAudioData(arr);
          this.buffers.set(key, buf);
        }catch(e){}
      }
      _playBuffer(key, vol=1){
        if (!this.ctx || !this.unlocked) return false;
        const buf = this.buffers.get(key);
        if (!buf) return false;
        const src = this.ctx.createBufferSource();
        const g = this.ctx.createGain();
        g.gain.value = vol;
        src.buffer = buf;
        src.connect(g); g.connect(this.sfxBus);
        src.start();
        return true;
      }
      _beep(vol,freq,dur,type=0){
        if (!this.ctx || !this.unlocked) return;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.type = type===0 ? "sine" : (type===1 ? "triangle" : "square");
        osc.frequency.value = freq;
        g.gain.value = 0;
        osc.connect(g); g.connect(this.sfxBus);
        const t0 = this.ctx.currentTime;
        g.gain.setValueAtTime(0, t0);
        g.gain.linearRampToValueAtTime(vol, t0+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
        osc.start(t0);
        osc.stop(t0+dur+0.02);
      }
      sfx(name){
        const ok = this._playBuffer(name,1);
        if (ok || !this.unlocked) return;
        switch(name){
          case "click":  this._beep(0.06,520,0.06,1); this._beep(0.03,760,0.04,0); break;
          case "paper":  this._beep(0.03,240,0.06,1); this._beep(0.02,310,0.05,1); this._beep(0.02,420,0.05,1); break;
          case "lock":   this._beep(0.06,220,0.08,1); this._beep(0.05,320,0.10,0); break;
          case "wrong":  this._beep(0.05,180,0.10,2); this._beep(0.04,140,0.10,2); break;
          case "success":this._beep(0.06,520,0.08,0); this._beep(0.05,660,0.10,1); this._beep(0.04,820,0.12,0); break;
          case "whoosh": this._beep(0.03,240,0.18,1); this._beep(0.02,180,0.20,1); break;
        }
      }
      async startBGM(){
        if (!this.unlocked) return;
        const url = CONFIG.audio.bgm;
        if (!url) return;
        if (!this.bgmEl){
          this.bgmEl = new Audio(url);
          this.bgmEl.loop = true;
          this.bgmEl.preload = "auto";
          this.bgmEl.volume = this.bgmGain;
        }
        try{ await this.bgmEl.play(); }catch(e){}
      }
    }
    const audio = new AudioEngine();

    /* =========================================================
       Loader
       ========================================================= */
    const loader = $("loader");
    const barFill = $("barFill");
    const tapToStart = $("tapToStart");

    async function preload(){
      barFill.style.width = `100%`;
      tapToStart.classList.add("show");
    }

    /* =========================================================
       Steps
       ========================================================= */
    const steps = [$("step0"), $("step1"), $("step2"), $("step3")];
    let stepIndex = 0;
    function showStep(i){
      stepIndex = clamp(i,0,steps.length-1);
      steps.forEach((s,idx)=>s.classList.toggle("active", idx===stepIndex));
      fx.resize();
      pix.resize();
    }

    /* =========================================================
       Inertial rotation
       ========================================================= */
    class InertialRotator{
      constructor(el, opts={}){
        this.el = el;
        this.dragging=false;

        this.rotX = opts.rotX ?? 12;
        this.rotY = opts.rotY ?? -18;
        this.vx=0; this.vy=0;

        this.maxSpeed=240;
        this.damping=11.2;
        this.spring=48;
        this.xMin=-12; this.xMax=24;

        this._px=0; this._py=0;
        this.lastT = now();

        this._down=(e)=>this.onDown(e);
        this._move=(e)=>this.onMove(e);
        this._up=()=>this.onUp();

        this.el.addEventListener("pointerdown", this._down, {passive:false});
        window.addEventListener("pointermove", this._move, {passive:false});
        window.addEventListener("pointerup", this._up, {passive:true});
        window.addEventListener("pointercancel", this._up, {passive:true});

        this.apply();
        this.loop();
      }
      reset(){
        this.rotX=12; this.rotY=-18; this.vx=this.vy=0;
        this.apply();
      }
      onDown(e){
        if (e.isPrimary === false) return;
        const t = e.target;
        if (t.closest && (t.closest("#lockBtn") || t.closest("#sealBtn") || t.closest("button"))) return;

        this.dragging=true;
        this.el.setPointerCapture?.(e.pointerId);
        this._px=e.clientX; this._py=e.clientY;
        this.vx=this.vy=0;
        audio.sfx("click");
        e.preventDefault();
      }
      onMove(e){
        if (!this.dragging) return;
        const dx=e.clientX - this._px;
        const dy=e.clientY - this._py;
        this._px=e.clientX; this._py=e.clientY;

        const scale=0.22;
        this.rotY += dx*scale;
        this.rotX -= dy*scale;

        const instantVX = (-dy*scale)*60;
        const instantVY = (dx*scale)*60;
        this.vx = clamp(lerp(this.vx, instantVX, 0.35), -this.maxSpeed, this.maxSpeed);
        this.vy = clamp(lerp(this.vy, instantVY, 0.35), -this.maxSpeed, this.maxSpeed);

        if (this.rotX < this.xMin) this.rotX = lerp(this.rotX, this.xMin, 0.35);
        if (this.rotX > this.xMax) this.rotX = lerp(this.rotX, this.xMax, 0.35);

        this.apply();
        e.preventDefault();
      }
      onUp(){
        if (!this.dragging) return;
        this.dragging=false;
        audio.sfx("paper");
      }
      loop(){
        const t=now();
        const dt=Math.min(0.033, (t-this.lastT)/1000);
        this.lastT=t;

        if (!this.dragging){
          const damp = Math.exp(-this.damping*dt);
          this.vx *= damp; this.vy *= damp;
          this.rotX += this.vx*dt;
          this.rotY += this.vy*dt;

          if (this.rotX < this.xMin){ this.vx += (this.xMin - this.rotX)*this.spring*dt; }
          else if (this.rotX > this.xMax){ this.vx += (this.xMax - this.rotX)*this.spring*dt; }

          this.vx = clamp(this.vx, -this.maxSpeed, this.maxSpeed);
          this.vy = clamp(this.vy, -this.maxSpeed, this.maxSpeed);

          if (Math.abs(this.vx) < 0.02) this.vx=0;
          if (Math.abs(this.vy) < 0.02) this.vy=0;
        }

        this.apply();
        requestAnimationFrame(()=>this.loop());
      }
      apply(){
        this.el.style.transform =
          `translateZ(0) rotateX(${this.rotX.toFixed(2)}deg) rotateY(${this.rotY.toFixed(2)}deg)`;
      }
    }

    /* =========================================================
       Reels
       ========================================================= */
    class Reel{
      constructor(rootEl, listEl, values, formatter){
        this.root=rootEl; this.list=listEl;
        this.values=values;
        this.formatter=formatter||((v)=>String(v));
        this.index=0;
        this.offset=0;
        this.velocity=0;
        this.dragging=false;

        this.itemGap=18;
        this.itemH=24;
        this.maxVel=1800;
        this.damping=12;
        this.snapK=85;

        this._py=0;
        this._lastT=now();

        this.populate();
        this.measure();

        this._down=(e)=>this.onDown(e);
        this._move=(e)=>this.onMove(e);
        this._up=()=>this.onUp();

        this.root.addEventListener("pointerdown", this._down, {passive:false});
        window.addEventListener("pointermove", this._move, {passive:false});
        window.addEventListener("pointerup", this._up, {passive:true});
        window.addEventListener("pointercancel", this._up, {passive:true});

        this.render();
        this.loop();
      }
      populate(){
        this.list.innerHTML="";
        for(let i=0;i<9;i++){
          const d=document.createElement("div");
          d.className="reelItem";
          this.list.appendChild(d);
        }
      }
      measure(){
        const first=this.list.querySelector(".reelItem");
        if (first){
          const r=first.getBoundingClientRect();
          if (r.height>0) this.itemH=r.height;
        }
      }
      setIndex(idx, quiet=false){
        const n=this.values.length;
        this.index=((idx%n)+n)%n;
        if(!quiet) audio.sfx("click");
        this.offset=0; this.velocity=0;
        this.render();
      }
      getValue(){ return this.values[this.index]; }

      onDown(e){
        if (e.isPrimary===false) return;
        this.dragging=true;
        this.root.setPointerCapture?.(e.pointerId);
        this._py=e.clientY;
        this.velocity=0;
        audio.sfx("click");
        e.preventDefault();
      }
      onMove(e){
        if(!this.dragging) return;
        const dy=e.clientY - this._py;
        this._py=e.clientY;

        this.offset += dy;
        this.velocity = clamp(lerp(this.velocity, dy*60, 0.35), -this.maxVel, this.maxVel);

        const step = this.itemH + this.itemGap;
        while(this.offset > step){
          this.offset -= step;
          this.index = (this.index - 1 + this.values.length) % this.values.length;
          audio.sfx("paper");
        }
        while(this.offset < -step){
          this.offset += step;
          this.index = (this.index + 1) % this.values.length;
          audio.sfx("paper");
        }
        this.render();
        e.preventDefault();
      }
      onUp(){
        if(!this.dragging) return;
        this.dragging=false;
        audio.sfx("paper");
      }
      loop(){
        const t=now();
        const dt=Math.min(0.033, (t-this._lastT)/1000);
        this._lastT=t;

        if(!this.dragging){
          const damp=Math.exp(-this.damping*dt);
          this.velocity *= damp;
          this.offset += this.velocity*dt;

          const step=this.itemH+this.itemGap;
          while(this.offset > step){ this.offset -= step; this.index = (this.index-1+this.values.length)%this.values.length; }
          while(this.offset < -step){ this.offset += step; this.index = (this.index+1)%this.values.length; }

          const snapForce = -this.offset * this.snapK;
          this.velocity += snapForce * dt;

          if(Math.abs(this.offset)<0.4 && Math.abs(this.velocity)<8){ this.offset=0; this.velocity=0; }
          this.render();
        }
        requestAnimationFrame(()=>this.loop());
      }
      render(){
        const items=[...this.list.children];
        const center=4;
        const n=this.values.length;
        for(let i=0;i<items.length;i++){
          const rel=i-center;
          const idx=(this.index+rel+n)%n;
          items[i].textContent=this.formatter(this.values[idx]);
          if(Math.abs(rel)>=3) items[i].classList.add("dim");
          else items[i].classList.remove("dim");
        }
        this.list.style.transform=`translateY(${this.offset}px)`;
      }
    }

    /* =========================================================
       FX
       ========================================================= */
    class FX{
      constructor(canvas){
        this.c=canvas;
        this.ctx=canvas.getContext("2d");
        this.w=0; this.h=0;
        this.dpr=Math.min(2, window.devicePixelRatio||1);
        this.particles=[];
        this._last=now();
        this._raf=null;
        window.addEventListener("resize", ()=>this.resize(), {passive:true});
        this.resize();
      }
      resize(){
        const r=this.c.getBoundingClientRect();
        this.w=Math.max(1, Math.floor(r.width));
        this.h=Math.max(1, Math.floor(r.height));
        this.c.width=Math.floor(this.w*this.dpr);
        this.c.height=Math.floor(this.h*this.dpr);
        this.ctx.setTransform(this.dpr,0,0,this.dpr,0,0);
      }
      burst(kind="hearts"){
        const count = kind==="hearts" ? 32 : 44;
        const max=CONFIG.maxParticles;
        const cx=this.w*0.5, cy=this.h*0.42;
        for(let i=0;i<count;i++){
          if(this.particles.length>=max) break;
          const a=Math.random()*Math.PI*2;
          const sp=(kind==="hearts"? (90+Math.random()*220):(120+Math.random()*260));
          const vx=Math.cos(a)*sp;
          const vy=Math.sin(a)*sp - (kind==="hearts"?160:120);
          this.particles.push({
            x: cx+(Math.random()*24-12),
            y: cy+(Math.random()*24-12),
            vx, vy,
            g: kind==="hearts"?620:720,
            life: 1,
            rot: Math.random()*Math.PI*2,
            vr: (Math.random()*2-1)*6,
            s: kind==="hearts"? (10+Math.random()*10):(7+Math.random()*7),
            kind
          });
        }
        if(!this._raf) this.loop();
      }
      loop(){
        const t=now();
        const dt=Math.min(0.033, (t-this._last)/1000);
        this._last=t;

        this.ctx.clearRect(0,0,this.w,this.h);

        for(let i=this.particles.length-1;i>=0;i--){
          const p=this.particles[i];
          p.vy += p.g*dt;
          p.x += p.vx*dt;
          p.y += p.vy*dt;
          p.rot += p.vr*dt;
          p.life -= dt*(p.kind==="hearts"?0.55:0.72);

          const alpha=clamp(p.life,0,1);
          if(alpha<=0 || p.y>this.h+80){
            this.particles.splice(i,1);
            continue;
          }

          this.ctx.save();
          this.ctx.globalAlpha=alpha;
          this.ctx.translate(p.x,p.y);
          this.ctx.rotate(p.rot);

          if(p.kind==="hearts") this.drawHeart(0,0,p.s);
          else this.drawConfetti(0,0,p.s);

          this.ctx.restore();
        }

        if(this.particles.length>0) this._raf=requestAnimationFrame(()=>this.loop());
        else this._raf=null;
      }
      drawHeart(x,y,s){
        const ctx=this.ctx;
        const t=s*0.3;
        ctx.beginPath();
        ctx.moveTo(x, y+t);
        ctx.bezierCurveTo(x, y, x-s/2, y, x-s/2, y+t);
        ctx.bezierCurveTo(x-s/2, y+(s+t)/2, x, y+(s+t)/1.2, x, y+s);
        ctx.bezierCurveTo(x, y+(s+t)/1.2, x+s/2, y+(s+t)/2, x+s/2, y+t);
        ctx.bezierCurveTo(x+s/2, y, x, y, x, y+t);
        ctx.closePath();
        ctx.fillStyle="rgba(255,179,199,.92)";
        ctx.fill();
        ctx.strokeStyle="rgba(0,0,0,.18)";
        ctx.lineWidth=1;
        ctx.stroke();
      }
      drawConfetti(x,y,s){
        const ctx=this.ctx;
        ctx.beginPath();
        ctx.rect(x-s*0.6, y-s*0.3, s*1.2, s*0.6);
        ctx.fillStyle="rgba(255,255,255,.70)";
        ctx.fill();
        ctx.strokeStyle="rgba(0,0,0,.16)";
        ctx.lineWidth=1;
        ctx.stroke();
      }
    }
    const fx = new FX($("fx"));

    /* =========================================================
       Pixel TV overlay (real pixel blocks + scanline noise)
       ========================================================= */
    class PixelOverlay{
      constructor(canvas){
        this.c=canvas;
        this.ctx=canvas.getContext("2d", {alpha:true});
        this.w=0; this.h=0;
        this.scale=9; // stronger pixelation
        this._t=0;
        window.addEventListener("resize", ()=>this.resize(), {passive:true});
        this.resize();
        this.loop();
      }
      resize(){
        const r=this.c.getBoundingClientRect();
        this.w=Math.max(1, Math.floor(r.width/this.scale));
        this.h=Math.max(1, Math.floor(r.height/this.scale));
        this.c.width=this.w;
        this.c.height=this.h;
      }
      loop(){
        const ctx=this.ctx;
        this._t = (this._t + 1) % 6000;

        ctx.clearRect(0,0,this.w,this.h);

        // grain
        const img = ctx.createImageData(this.w, this.h);
        const d = img.data;
        for(let i=0;i<d.length;i+=4){
          const v = (Math.random()*255)|0;
          d[i]=v; d[i+1]=v; d[i+2]=v; d[i+3]=44; // alpha
        }
        ctx.putImageData(img,0,0);

        // random scanlines
        if (Math.random()<0.35){
          const y = (Math.random()*this.h)|0;
          ctx.fillStyle = "rgba(255,255,255,.22)";
          ctx.fillRect(0,y,this.w,1);
        }
        if (Math.random()<0.16){
          const y = (Math.random()*this.h)|0;
          ctx.fillStyle = "rgba(0,0,0,.24)";
          ctx.fillRect(0,y,this.w,2);
        }

        // ‚Äútracking‚Äù band sometimes
        if (Math.random()<0.06){
          const y = (Math.random()*this.h)|0;
          ctx.fillStyle = "rgba(255,255,255,.10)";
          ctx.fillRect(0,y,this.w,6);
        }

        requestAnimationFrame(()=>this.loop());
      }
    }
    const pix = new PixelOverlay($("pix"));

    /* =========================================================
       Door scene logic
       ========================================================= */
    const door = $("door");
    const doorModal = $("doorModal");
    const doorNo = $("doorNo");
    const doorYes = $("doorYes");
    const doorText = $("doorText");
    const doorModalText = $("doorModalText");

    let doorNoUsed = false;

    function knock(){
      audio.sfx("wrong");
      screenShake();
      doorText.textContent = "*—Ç—É–∫-—Ç—É–∫*";
    }

    doorNo.addEventListener("click", ()=>{
      audio.sfx("wrong");
      screenShake();
      doorModalText.textContent = "—ç—ç—ç, –Ω—É –ø–æ–∂–∞–ª—É–π—Å—Ç–∞–∞–∞–∞–∞";
      doorText.textContent = "*—Ç—É–∫-—Ç—É–∫* *—Ç—É–∫*";
      // hide NO button nicely
      if (!doorNoUsed){
        doorNoUsed = true;
        doorNo.classList.add("hidden");
        setTimeout(()=>doorNo.remove(), 260);
      }
      setTimeout(()=>audio.sfx("wrong"), 120);
    });

    doorYes.addEventListener("click", ()=>{
      audio.sfx("click");
      door.open = true;
      door.classList.add("open");
      doorModal.classList.remove("show");
      // small whoosh + then courier
      setTimeout(()=>{
        audio.sfx("whoosh");
        showStep(1);
      }, 520);
    });

    /* =========================================================
       Courier dialog logic (mini-game)
       ========================================================= */
    const courierBubble = $("courierBubble");
    const courierText = $("courierText");
    const courierModal = $("courierModal");
    const courierTitle = $("courierTitle");
    const courierPrompt = $("courierPrompt");
    const courierButtons = $("courierButtons");
    const unlockToast = $("unlockToast");

    function setCourierDialog(title, prompt, buttons){
      courierTitle.textContent = title;
      courierPrompt.textContent = prompt;
      courierButtons.innerHTML = "";
      buttons.forEach(b=>{
        const btn=document.createElement("button");
        btn.className = `btn wide ${b.kind||"ghost"}`;
        btn.textContent = b.text;
        btn.addEventListener("click", b.onClick, {passive:true});
        courierButtons.appendChild(btn);
      });
      courierModal.classList.add("show");
    }

    function courierShake(){
      courierBubble.classList.add("shake");
      setTimeout(()=>courierBubble.classList.remove("shake"), 380);
    }

    function showUnlockToast(){
      unlockToast.classList.add("show");
      setTimeout(()=>unlockToast.classList.remove("show"), 1200);
    }

    function goToBox(){
      // meme unlock + then box scene
      audio.sfx("success");
      fx.burst("confetti"); fx.burst("hearts");
      showUnlockToast();
      setTimeout(()=>showStep(2), 820);
    }

    function startCourierDialog(){
      setCourierDialog("–í–æ–ø—Ä–æ—Å", "–ü—Ä–∏–≤–µ—Ç. –í—ã –î–∂–∞–º–∞?", [
        {
          text:"–î–∞",
          kind:"primary",
          onClick: ()=>{
            audio.sfx("click");
            courierText.textContent = "–û—Ç–ª–∏—á–Ω–æ. –í–∞–º –ø–æ—Å—ã–ª–∫–∞ –æ—Ç —Ñ–∞–Ω–∞—Ç–∞.";
            courierShake();
            setCourierDialog("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", "–ë–µ—Ä—ë—Ç–µ –ø–æ—Å—ã–ª–∫—É?", [
              { text:"–í–∑—è—Ç—å", kind:"primary", onClick: ()=>{ audio.sfx("success"); courierModal.classList.remove("show"); goToBox(); } },
              { text:"–ù–µ –≤–∑—è—Ç—å", kind:"ghost", onClick: ()=>{ audio.sfx("wrong"); courierText.textContent="–ê–π —Å—á–∞—Å—Ç–ª–∏–≤–æ–≥–æ –¥–ª—è –≤–ª—é–±–ª—ë–Ω–Ω—ã—Ö üòê"; courierShake(); setCourierDialog("–õ–∞–¥–Ω–æ", "‚Ä¶–Ω–æ —è –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Å—Ç–∞–≤–ª—é.", [
                  { text:"–õ–∞–¥–Ω–æ, –≤–∑—è—Ç—å", kind:"primary", onClick: ()=>{ audio.sfx("success"); courierModal.classList.remove("show"); goToBox(); } }
                ]); } }
            ]);
          }
        },
        {
          text:"–ù–µ—Ç",
          kind:"ghost",
          onClick: ()=>{
            audio.sfx("click");
            courierText.textContent = "–ù–µ –ø–∏–∑–¥–∏—Ç–µ. –Ø –Ω–µ –ø–æ–¥–∫–∞—Ç—ã–≤–∞—é, —è –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–Ω—ë—Å –∫–æ—Ä–æ–±–∫—É. –í–æ—Ç –≤–∞–º –ø–æ—Å—ã–ª–∫–∞ –æ—Ç —Ñ–∞–Ω–∞—Ç–∞.";
            courierShake();
            setCourierDialog("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", "–ë–µ—Ä—ë—Ç–µ –ø–æ—Å—ã–ª–∫—É?", [
              { text:"–í–∑—è—Ç—å", kind:"primary", onClick: ()=>{ audio.sfx("success"); courierModal.classList.remove("show"); goToBox(); } },
              { text:"–ù–µ –≤–∑—è—Ç—å", kind:"ghost", onClick: ()=>{ audio.sfx("wrong"); courierText.textContent="–î–∞ —Ñ—Ç–æ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å‚Ä¶ –î–µ—Ä–∂–∏. –†–∞–¥–∏ —Ç–µ–±—è –≤–æ–æ–±—â–µ-—Ç–æ —Å—Ç–∞—Ä–∞–ª–∏—Å—å."; courierShake(); setCourierDialog("–ë–µ–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤", "–û–Ω–∞ —É–∂–µ —Ç–≤–æ—è.", [
                  { text:"–í–∑—è—Ç—å", kind:"primary", onClick: ()=>{ audio.sfx("success"); courierModal.classList.remove("show"); goToBox(); } }
                ]); } }
            ]);
          }
        }
      ]);
    }

    /* =========================================================
       Step 2: Box (kept)
       ========================================================= */
    const boxObj=$("boxObj");
    const lockBtn=$("lockBtn");
    const lockModal=$("lockModal");
    const lockBack=$("lockBack");
    const lockDone=$("lockDone");
    const boxReset=$("boxReset");
    const box3d=$("box3d");
    const envPull=$("envPull");

    const boxRot = new InertialRotator(boxObj, {rotX: 14, rotY: -22});
    boxReset.addEventListener("click", ()=>{ audio.sfx("click"); boxRot.reset(); });

    function openLock(){ audio.sfx("lock"); lockModal.classList.add("show"); }
    function closeLockUI(){ audio.sfx("paper"); lockModal.classList.remove("show"); }

    let lockDown = null;
    lockBtn.addEventListener("pointerdown", (e)=>{
      lockDown = {x:e.clientX, y:e.clientY, t: now()};
      e.stopPropagation();
    }, {passive:true});

    lockBtn.addEventListener("pointerup", (e)=>{
      if(!lockDown) return;
      const dx=Math.abs(e.clientX-lockDown.x);
      const dy=Math.abs(e.clientY-lockDown.y);
      const dt=now()-lockDown.t;
      lockDown=null;
      if(dx<8 && dy<8 && dt<600) openLock();
      e.stopPropagation();
    }, {passive:true});

    lockBack.addEventListener("click", ()=> closeLockUI());

    const days = Array.from({length:31}, (_,i)=>i+1);
    const months = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
    const years = [2020,2021,2022,2023,2024,2025,2026];

    const reelDay = new Reel($("reels").querySelector('[data-reel="day"]'), $("reelDay"), days, v=>String(v));
    const reelMonth = new Reel($("reels").querySelector('[data-reel="month"]'), $("reelMonth"), months, v=>v);
    const reelYear = new Reel($("reels").querySelector('[data-reel="year"]'), $("reelYear"), years, v=>String(v));

    reelDay.setIndex(0,true);
    reelMonth.setIndex(0,true);
    reelYear.setIndex(0,true);

    function lockShake(modalEl){
      audio.sfx("wrong");
      const m = modalEl.querySelector(".modal");
      m.classList.add("shake");
      setTimeout(()=>m.classList.remove("shake"), 380);
      screenShake();
    }

    function unlockSequence(){
      audio.sfx("success");
      fx.burst("confetti"); fx.burst("hearts");

      lockBtn.classList.remove("pulse");
      lockBtn.style.opacity = "0";
      lockBtn.style.transform = "translate(-50%,-50%) scale(.90)";

      closeLockUI();

      box3d.classList.add("opened");
      audio.sfx("whoosh");

      setTimeout(()=>{
        box3d.classList.add("drop");
        envPull.classList.add("fly");
        audio.sfx("paper");
        fx.burst("hearts");
      }, 520);

      setTimeout(()=> showStep(3), 1500);
    }

    lockDone.addEventListener("click", ()=>{
      audio.sfx("click");
      const day = reelDay.getValue();
      const month = reelMonth.getValue();
      const year = reelYear.getValue();
      const ok = (day===CONFIG.boxLock.day && months.indexOf(month)===CONFIG.boxLock.monthIndex && year===CONFIG.boxLock.year);
      if(!ok){ lockShake(lockModal); return; }
      unlockSequence();
    });

    /* =========================================================
       Step 3: Envelope (kept)
       ========================================================= */
    const envObj=$("envObj");
    const envRot = new InertialRotator(envObj, {rotX: 12, rotY: 18});

    const sealBtn=$("sealBtn");
    const env3d=$("env3d");
    const envHint=$("envHint");
    const envWho=$("envWho");

    const throwBtn=$("throwBtn");
    const centerMsg=$("centerMsg");
    const centerMsgBox=$("centerMsgBox");

    const envLockModal=$("envLockModal");
    const envLockBack=$("envLockBack");
    const envLockDone=$("envLockDone");

    const letterSlide=$("letterSlide");

    const envReelDay = new Reel($("envReels").querySelector('[data-reel="day"]'), $("envReelDay"), days, v=>String(v));
    const envReelMonth = new Reel($("envReels").querySelector('[data-reel="month"]'), $("envReelMonth"), months, v=>v);
    const envReelYear = new Reel($("envReels").querySelector('[data-reel="year"]'), $("envReelYear"), [2000,2001,2002,2003,2004,2005,2006,2007], v=>String(v));

    envReelDay.setIndex(0,true);
    envReelMonth.setIndex(0,true);
    envReelYear.setIndex(0,true);

    let envelopeOpened = false;

    function showCenterText(text){
      centerMsgBox.textContent = text;
      centerMsg.classList.add("show");
      setTimeout(()=>centerMsg.classList.remove("show"), 1200);
    }

    function openEnvLock(){
      audio.sfx("lock");
      envLockModal.classList.add("show");
    }
    function closeEnvLock(){
      audio.sfx("paper");
      envLockModal.classList.remove("show");
    }

    envLockBack.addEventListener("click", ()=> closeEnvLock());

    function openEnvelopeAndLetter(){
      if (envelopeOpened) return;
      envelopeOpened = true;

      audio.sfx("whoosh");
      env3d.classList.add("opened");
      fx.burst("hearts");
      setTimeout(()=>fx.burst("confetti"), 120);

      setTimeout(()=>{
        envWho.textContent = "–ü–∏—Å—å–º–æ";
        envHint.textContent = "–í–æ—Ç —á—Ç–æ –±—ã–ª–æ –≤–Ω—É—Ç—Ä–∏.";
        env3d.classList.add("downOut");
        audio.sfx("paper");
        letterSlide.classList.add("show");
      }, 420);
    }

    envLockDone.addEventListener("click", ()=>{
      audio.sfx("click");
      const day = envReelDay.getValue();
      const month = envReelMonth.getValue();
      const year = envReelYear.getValue();
      const ok = (day===CONFIG.envLock.day && months.indexOf(month)===CONFIG.envLock.monthIndex && year===CONFIG.envLock.year);
      if(!ok){ lockShake(envLockModal); return; }

      closeEnvLock();
      audio.sfx("success");
      fx.burst("confetti"); fx.burst("hearts");

      setTimeout(()=>openEnvelopeAndLetter(), 260);
    });

    let sealDown = null;
    sealBtn.addEventListener("pointerdown", (e)=>{
      sealDown = {x:e.clientX, y:e.clientY, t: now()};
      e.stopPropagation();
    }, {passive:true});

    sealBtn.addEventListener("pointerup", (e)=>{
      if(!sealDown) return;
      const dx=Math.abs(e.clientX-sealDown.x);
      const dy=Math.abs(e.clientY-sealDown.y);
      const dt=now()-sealDown.t;
      sealDown=null;
      if(dx>=10 || dy>=10 || dt>650) return;

      if (!envelopeOpened) openEnvLock();
      e.stopPropagation();
    }, {passive:true});

    let throwUsed=false;
    throwBtn.addEventListener("click", ()=>{
      audio.sfx("wrong");
      showCenterText("—Ç—ã —á—Ç–æ –≤–æ–æ–±—â–µ –æ—à–∞–ª–µ–ª–∞ –∏–¥–∏ –æ—Ç–∫—Ä—ã–≤–∞–π –∏ –Ω–µ –Ω–∞–≥–ª–µ–π");
      $("envWrap").classList.add("shake");
      screenShake();
      setTimeout(()=>$("envWrap").classList.remove("shake"), 380);

      if (!throwUsed){
        throwUsed=true;
        audio.sfx("whoosh");
        throwBtn.classList.add("hidden");
        setTimeout(()=> throwBtn.remove(), 260);
      }
    });

    /* =========================================================
       Boot
       ========================================================= */
    function startApp(){
      showStep(0);
      // initial knock
      setTimeout(()=>{ knock(); }, 220);
    }

    async function onFirstTap(){
      loader.removeEventListener("pointerdown", onFirstTap);
      audio.sfx("click");
      await audio.unlock();
      loader.classList.add("hide");
      setTimeout(()=> loader.style.display="none", 520);
      startApp();
      // Start courier dialog once we arrive to step1
      const obs = new MutationObserver(()=>{
        if ($("step1").classList.contains("active")){
          obs.disconnect();
          setTimeout(()=>startCourierDialog(), 260);
        }
      });
      obs.observe($("step1"), {attributes:true, attributeFilter:["class"]});
    }

    (async ()=>{
      await preload();
      try{ await audio.init(); }catch(e){}
      loader.addEventListener("pointerdown", onFirstTap, {passive:true});
    })();
  </script>
</body>
</html>
