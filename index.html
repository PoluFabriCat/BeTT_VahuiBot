<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#0f0b10" />
  <title>Valentine Mini Game ‚Äî –î–∂–∞–º–∞</title>
  <style>
    :root{
      --bg0:#0f0b10;
      --bg1:#18111d;
      --paper:#f7f1ea;
      --paper2:#efe7df;
      --ink:#241a2a;
      --muted:#6b5a73;
      --red:#e63b50;
      --red2:#ff6b7a;
      --glow: rgba(255,107,122,.28);
      --radius:18px;
      --radius2:26px;
      --pad: clamp(14px, 3.2vw, 22px);
      --ui: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: var(--ui);
      color: var(--paper);
      background: radial-gradient(1200px 900px at 50% 20%, #22172b 0%, var(--bg0) 60%, #0b0810 100%);
      overflow:hidden;
      user-select:none;
      -webkit-user-select:none;
      touch-action: none;
    }

    /* ===== CRT / pixel-ish overlay (lightweight, no heavy filters) ===== */
    .crt{
      pointer-events:none;
      position:fixed; inset:0;
      mix-blend-mode: overlay;
      opacity:.22;
    }
    .crt::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient( to bottom,
          rgba(255,255,255,.06) 0px,
          rgba(255,255,255,.06) 1px,
          rgba(0,0,0,0) 2px,
          rgba(0,0,0,0) 4px
        );
      opacity:.55;
      transform: translateZ(0);
      will-change: opacity;
      animation: scan 4.2s linear infinite;
    }
    .crt::after{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(90deg, rgba(255,0,90,.06), rgba(0,255,220,.05), rgba(255,255,255,.05));
      opacity:.35;
      transform: translateZ(0);
    }
    @keyframes scan{
      0%{ opacity:.18; }
      45%{ opacity:.25; }
      50%{ opacity:.18; }
      100%{ opacity:.18; }
    }

    /* ===== App shell ===== */
    #app{
      position:fixed; inset:0;
      padding: calc(var(--pad) + env(safe-area-inset-top)) var(--pad)
               calc(var(--pad) + env(safe-area-inset-bottom)) var(--pad);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .stack{
      width:min(560px, 100%);
      height:min(920px, 100%);
      position:relative;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
    }

    .scene{
      position:absolute; inset:0;
      display:flex;
      flex-direction:column;
      gap:14px;
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      transition: opacity .32s ease, transform .32s ease;
      will-change: opacity, transform;
    }
    .scene.active{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: var(--radius2);
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      backdrop-filter: none;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff 0%, var(--red2) 35%, var(--red) 80%);
      box-shadow: 0 0 0 6px rgba(230,59,80,.12);
    }
    .title{
      font-weight:700;
      letter-spacing:.2px;
      font-size:14px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .hint{
      font-size:12px;
      color: rgba(255,255,255,.72);
      white-space:nowrap;
    }

    .card{
      border-radius: var(--radius2);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      position:relative;
      overflow:hidden;
    }

    .paper{
      color: var(--ink);
      background: linear-gradient(180deg, var(--paper) 0%, var(--paper2) 100%);
      border: 1px solid rgba(36,26,42,.14);
      border-radius: var(--radius2);
      padding: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.16);
    }
    .paper small{ color: rgba(36,26,42,.66); }

    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .col{ display:flex; flex-direction:column; gap:8px; }
    .center{ display:flex; align-items:center; justify-content:center; }

    /* ===== Buttons ===== */
    .btns{ display:flex; gap:10px; }
    button{
      border:0;
      appearance:none;
      font-family: var(--ui);
      border-radius: 999px;
      padding: 12px 14px;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      transition: transform .12s ease, background .18s ease, box-shadow .18s ease, opacity .18s ease;
      transform: translateZ(0);
      will-change: transform;
    }
    button:active{ transform: translateY(1px) scale(.99); }
    .btn-primary{
      color:#fff;
      background: linear-gradient(180deg, var(--red2), var(--red));
      box-shadow: 0 10px 22px rgba(230,59,80,.20);
    }
    .btn-secondary{
      color: rgba(255,255,255,.92);
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 22px rgba(0,0,0,.16);
    }
    .btn-ghost{
      color: rgba(255,255,255,.85);
      background: rgba(0,0,0,.00);
      border: 1px dashed rgba(255,255,255,.20);
    }
    .btn-primary:focus, .btn-secondary:focus, .btn-ghost:focus{ outline:none; }
    .btn-primary.glow{
      box-shadow: 0 0 0 6px rgba(255,107,122,.12), 0 12px 24px rgba(230,59,80,.22);
    }

    /* ===== Toast ===== */
    #toast{
      position:fixed;
      left:50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%) translateY(12px);
      opacity:0;
      pointer-events:none;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.62);
      border: 1px solid rgba(255,255,255,.12);
      color:#fff;
      font-weight:700;
      font-size:13px;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 50;
      max-width: min(520px, calc(100% - 28px));
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(0);
    }

    /* ===== Preloader ===== */
    #preloader{
      position:fixed; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1100px 900px at 50% 20%, #23162a 0%, var(--bg0) 62%, #0b0810 100%);
      z-index: 100;
    }
    .loadbox{
      width:min(520px, calc(100% - 28px));
      border-radius: var(--radius2);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 18px;
    }
    .loadline{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
    }
    .loadline > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--red), var(--red2));
      border-radius: 999px;
      transition: width .18s ease;
    }
    .loadmeta{
      display:flex; justify-content:space-between; align-items:center;
      margin-top: 10px;
      gap:10px;
      color: rgba(255,255,255,.78);
      font-size:12px;
    }
    .dots::after{
      content:"";
      display:inline-block;
      width: 14px;
      text-align:left;
      animation: dots 1.2s steps(4, end) infinite;
    }
    @keyframes dots{
      0%{ content:""; }
      25%{ content:"."; }
      50%{ content:".."; }
      75%{ content:"..."; }
      100%{ content:""; }
    }

    /* ===== Character / Courier ===== */
    .courier-wrap{
      flex: 1;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .courier{
      width:min(360px, 88%);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 16px;
      display:flex;
      gap:14px;
      align-items:center;
      transform: translateZ(0);
    }
    .avatar{
      width:64px; height:64px;
      border-radius: 18px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)),
        radial-gradient(50px 50px at 30% 30%, rgba(255,255,255,.22), rgba(255,255,255,0));
      border: 1px solid rgba(255,255,255,.12);
      position:relative;
      overflow:hidden;
    }
    .avatar::before{
      content:"";
      position:absolute; inset: 12px 18px 10px 18px;
      border-radius: 14px 14px 18px 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
    }
    .avatar::after{
      content:"";
      position:absolute; left: 18px; right: 18px; top: 22px; height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
    }
    .speech{
      flex:1;
      min-width:0;
    }
    .speech .name{
      font-weight:800;
      font-size:12px;
      color: rgba(255,255,255,.76);
      letter-spacing:.2px;
      margin-bottom: 4px;
    }
    .speech .txt{
      font-weight:800;
      font-size: 18px;
      line-height:1.18;
      letter-spacing:.2px;
    }

    /* ===== Modal "paper for signature" ===== */
    .modal{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: var(--pad);
      background: rgba(0,0,0,.22);
      opacity:0;
      pointer-events:none;
      transition: opacity .22s ease;
    }
    .modal.show{ opacity:1; pointer-events:auto; }
    .sheet{
      width: min(460px, 100%);
      border-radius: var(--radius2);
      transform: translateY(10px) rotate(-0.3deg);
      transition: transform .22s ease;
    }
    .modal.show .sheet{ transform: translateY(0) rotate(-0.3deg); }

    /* ===== 3D-ish objects ===== */
    .stage{
      flex:1;
      position:relative;
      border-radius: var(--radius2);
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .stage::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(700px 420px at 50% 30%, rgba(255,107,122,.12), rgba(0,0,0,0) 60%),
        radial-gradient(800px 600px at 50% 110%, rgba(255,255,255,.07), rgba(0,0,0,0) 60%);
      pointer-events:none;
    }
    .object3d{
      position:relative;
      width: min(340px, 74vw);
      aspect-ratio: 1 / 1;
      transform-style: preserve-3d;
      will-change: transform;
      touch-action:none;
    }
    .object3d .face{
      position:absolute;
      inset: 16%;
      border-radius: 22px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02)),
        repeating-linear-gradient(45deg, rgba(255,255,255,.04) 0 6px, rgba(0,0,0,0) 6px 12px);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 40px rgba(0,0,0,.22);
      backface-visibility: hidden;
      overflow:hidden;
    }
    .pixel-edge{
      position:absolute; inset:0;
      border-radius: 22px;
      border: 1px solid rgba(0,0,0,.22);
      pointer-events:none;
      opacity:.35;
      background:
        repeating-linear-gradient( to right, rgba(0,0,0,.09) 0 1px, rgba(0,0,0,0) 1px 6px),
        repeating-linear-gradient( to bottom, rgba(0,0,0,.07) 0 1px, rgba(0,0,0,0) 1px 6px);
      mix-blend-mode: multiply;
    }
    .label{
      position:absolute; left:10%; right:10%;
      bottom: 12%;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.14);
      font-weight:800;
      text-align:center;
      letter-spacing:.2px;
    }
    .label b{ color: #fff; }
    .sub{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(255,255,255,.74);
      font-weight:700;
    }

    /* lock on box */
    .lock{
      position:absolute;
      left:50%;
      top:44%;
      width: 70px;
      height: 70px;
      transform: translate(-50%,-50%) translateZ(34px);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.16);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      will-change: transform, opacity;
      animation: pulse 1.25s ease-in-out infinite;
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
    }
    .lock::before{
      content:"";
      width: 30px; height: 26px;
      border-radius: 10px;
      border: 2px solid rgba(255,255,255,.88);
      position:absolute;
      bottom: 16px;
    }
    .lock::after{
      content:"";
      width: 24px; height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.70);
      position:absolute;
      top: 14px;
      clip-path: inset(0 0 40% 0);
      opacity:.9;
    }
    @keyframes pulse{
      0%,100%{ transform: translate(-50%,-50%) translateZ(34px) scale(1); box-shadow: 0 12px 26px rgba(0,0,0,.22); }
      50%{ transform: translate(-50%,-50%) translateZ(34px) scale(1.03); box-shadow: 0 0 0 10px rgba(255,107,122,.10), 0 16px 32px rgba(0,0,0,.24); }
    }

    /* box open animation */
    .box .lid{
      position:absolute;
      inset: 14% 14% 46% 14%;
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.14);
      transform-origin: 50% 100%;
      transform: translateZ(18px) rotateX(0deg);
      transition: transform .7s cubic-bezier(.2,.9,.2,1);
      overflow:hidden;
    }
    .box.open .lid{
      transform: translateZ(18px) rotateX(-115deg);
    }
    .box .lid::after{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(45deg, rgba(255,255,255,.04) 0 6px, rgba(0,0,0,0) 6px 12px);
      opacity:.8;
    }

    /* envelope */
    .envelope .seal{
      position:absolute;
      left:50%; top:44%;
      width: 74px; height: 74px;
      transform: translate(-50%,-50%) translateZ(34px);
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fff 0%, rgba(255,255,255,.18) 20%, rgba(0,0,0,0) 26%),
                  linear-gradient(180deg, var(--red2), var(--red));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 14px 30px rgba(230,59,80,.20);
      display:flex;
      align-items:center;
      justify-content:center;
      will-change: transform;
    }
    .envelope .seal i{
      width: 26px; height: 26px;
      background: rgba(255,255,255,.85);
      clip-path: path("M13 23 C2 16 0 10 0 7 C0 3 3 0 7 0 C10 0 12 2 13 4 C14 2 16 0 19 0 C23 0 26 3 26 7 C26 10 24 16 13 23 Z");
      opacity:.95;
    }
    .zoom{
      animation: zoomIn .55s cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes zoomIn{
      from{ transform: translateZ(0) scale(1); }
      to{ transform: translateZ(0) scale(1.14); }
    }

    /* ===== Code lock mini game ===== */
    .overlay{
      position:absolute; inset:0;
      background: rgba(0,0,0,.40);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: var(--pad);
      opacity:0;
      pointer-events:none;
      transition: opacity .22s ease;
      z-index: 20;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }
    .panel{
      width: min(520px, 100%);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
    }
    .panel-h{
      padding: 14px 14px 10px 14px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .panel-h .h1{
      font-weight:900;
      font-size: 14px;
      letter-spacing:.3px;
    }
    .panel-h .h2{
      font-size: 12px;
      color: rgba(255,255,255,.70);
      font-weight:700;
    }
    .wheels{
      display:grid;
      grid-template-columns: 1fr 1.2fr 1fr;
      gap: 10px;
      padding: 14px;
    }
    .wheel{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      height: 190px;
      overflow:hidden;
      position:relative;
      touch-action:none;
    }
    .wheel::before{
      content:"";
      position:absolute; left:0; right:0;
      top: 50%;
      height: 42px;
      transform: translateY(-50%);
      border-top: 1px solid rgba(255,255,255,.16);
      border-bottom: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      pointer-events:none;
    }
    .wheel-list{
      position:absolute; left:0; right:0; top: 50%;
      transform: translateY(-50%);
      will-change: transform;
      transition: transform .18s ease;
    }
    .wheel-item{
      height: 42px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      letter-spacing:.2px;
      color: rgba(255,255,255,.86);
      font-size: 14px;
    }
    .wheel-item.dim{ color: rgba(255,255,255,.52); font-weight:800; }

    .panel-f{
      padding: 12px 14px 14px 14px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .panel-f .left, .panel-f .right{ display:flex; gap:10px; }
    .shake{
      animation: shake .32s ease-in-out;
    }
    @keyframes shake{
      0%,100%{ transform: translateX(0); }
      20%{ transform: translateX(-7px); }
      40%{ transform: translateX(6px); }
      60%{ transform: translateX(-5px); }
      80%{ transform: translateX(4px); }
    }

    /* ===== Gallery ===== */
    .gallery{
      margin-top: 10px;
      border-radius: var(--radius2);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      position:relative;
      height: min(260px, 30vh);
    }
    .gallery img{
      position:absolute; inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      opacity:0;
      transition: opacity .5s ease;
      will-change: opacity;
      image-rendering: auto;
    }
    .gallery img.show{ opacity:1; }
    .gallery .badge{
      position:absolute;
      left: 12px; top: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.40);
      border: 1px solid rgba(255,255,255,.12);
      font-size: 12px;
      font-weight: 800;
      color: rgba(255,255,255,.90);
    }

    /* ===== Letter (notebook paper) ===== */
    .letter{
      margin-top: 12px;
      transform: translateY(14px);
      opacity:0;
      transition: transform .45s cubic-bezier(.2,.9,.2,1), opacity .45s ease;
      will-change: transform, opacity;
    }
    .letter.show{
      transform: translateY(0);
      opacity:1;
    }
    .notebook{
      background: linear-gradient(180deg, #fff 0%, #f3ece4 100%);
      color: #241a2a;
      border-radius: var(--radius2);
      border: 1px solid rgba(36,26,42,.14);
      overflow:hidden;
      position:relative;
      padding: 14px 14px 12px 14px;
    }
    .notebook::before{
      content:"";
      position:absolute; left:0; right:0; top:0; height: 14px;
      background: linear-gradient(180deg, rgba(230,59,80,.18), rgba(0,0,0,0));
      opacity:.85;
    }
    .notebook::after{
      content:"";
      position:absolute; left: 14px; top: 0; bottom: 0;
      width: 2px;
      background: rgba(230,59,80,.25);
      border-radius: 2px;
    }
    .lines{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      font-weight:800;
      letter-spacing:.1px;
      line-height:1.25;
    }
    .lines p{
      margin:0;
      padding-left: 10px;
      border-bottom: 1px dashed rgba(36,26,42,.16);
      padding-bottom: 6px;
    }

    /* ===== Particles canvas ===== */
    #fx{
      position:fixed; inset:0;
      pointer-events:none;
      z-index: 30;
      opacity:0;
      transition: opacity .22s ease;
    }
    #fx.on{ opacity:1; }

    /* small screens */
    @media (max-height: 720px){
      .wheel{ height: 172px; }
      .wheel-item{ height: 40px; }
      .wheel::before{ height: 40px; }
      .wheel-list{ transition: transform .16s ease; }
    }
  </style>
</head>
<body>
  <canvas id="fx"></canvas>
  <div class="crt"></div>

  <!-- Background music (file should be —Ä—è–¥–æ–º —Å index.html) -->
  <audio id="bgm" src="Je_te_laissserai_des_mots.mp3" loop preload="auto"></audio>

  <!-- Preloader -->
  <div id="preloader">
    <div class="loadbox">
      <div class="row" style="margin-bottom:10px;">
        <div class="brand">
          <span class="dot"></span>
          <div class="col" style="gap:2px;">
            <div class="title">–ú–∏–Ω–∏-–≤–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ –¥–ª—è –î–∂–∞–º—ã</div>
            <div class="hint"><span class="dots">–∑–∞–≥—Ä—É–∑–∫–∞</span></div>
          </div>
        </div>
        <div id="pPct" class="hint" style="font-weight:800;">0%</div>
      </div>
      <div class="loadline"><i id="pBar"></i></div>
      <div class="loadmeta">
        <div id="pText">–ì–æ—Ç–æ–≤–∏–º –º–∏–ª–æ—Ç—É‚Ä¶</div>
        <div class="hint" id="pCount">0/0</div>
      </div>
      <div class="hint" style="margin-top:10px; line-height:1.35;">
        –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∑–≤—É–∫ –≤–∫–ª—é—á–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è üôå
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <div id="app">
    <div class="stack">

      <!-- Scene 1 -->
      <section id="scene1" class="scene active">
        <div class="topbar">
          <div class="brand">
            <span class="dot"></span>
            <div class="title">–î–æ—Å—Ç–∞–≤–∫–∞ ‚Ä¢ –≤—Ö–æ–¥—è—â–∞—è –ø–æ—Å—ã–ª–∫–∞</div>
          </div>
          <div class="hint">—Å—Ü–µ–Ω–∞ 1/3</div>
        </div>

        <div class="courier-wrap card" style="flex:1;">
          <div class="courier" id="courierCard">
            <div class="avatar" aria-hidden="true"></div>
            <div class="speech">
              <div class="name">–∫—É—Ä—å–µ—Ä</div>
              <div class="txt" id="courierText">–í–∞–º –ø–æ—Å—ã–ª–∫–∞ –æ—Ç —Ñ–∞–Ω–∞—Ç–∞ üòâ</div>
            </div>
          </div>

          <div id="signModal" class="modal">
            <div class="sheet paper">
              <div style="font-weight:900; font-size:14px; margin-bottom:8px;">–ë—É–º–∞–∂–∫–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏</div>
              <div style="font-weight:900; font-size:18px; line-height:1.15; margin-bottom:10px;">
                –í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ø–æ—Å—ã–ª–∫—É –æ—Ç —Ñ–∞–Ω–∞—Ç–∞?
              </div>
              <small>–ü–æ–¥–ø–∏—Å—å: ‚Äú–î–∂–∞–º–∞‚Äù (—É—Å–ª–æ–≤–Ω–æ üòå)</small>
              <div style="height:12px;"></div>
              <div class="btns" id="signBtns">
                <button class="btn-secondary" id="btnNo">–ù–µ—Ç</button>
                <button class="btn-primary glow" id="btnYes">–î–∞</button>
              </div>
            </div>
          </div>
        </div>

        <div class="hint" style="text-align:center; opacity:.85;">
          (–º–∏–Ω–∏-–∏–≥—Ä–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Telegram WebView ‚Ä¢ –≤—Å—ë –ª—ë–≥–∫–æ–µ –∏ –ø–ª–∞–≤–Ω–æ–µ)
        </div>
      </section>

      <!-- Scene 2 -->
      <section id="scene2" class="scene">
        <div class="topbar">
          <div class="brand">
            <span class="dot"></span>
            <div class="title">–ü–æ—Å—ã–ª–∫–∞ ‚Ä¢ –∑–∞–º–æ–∫</div>
          </div>
          <div class="hint">—Å—Ü–µ–Ω–∞ 2/3</div>
        </div>

        <div class="stage">
          <div id="box3d" class="object3d box" aria-label="–ü–æ—Å—ã–ª–∫–∞">
            <div class="face">
              <div class="pixel-edge"></div>
              <div class="label">
                <div><b>–¥–ª—è –î–∂–∞–º—ã</b> üíå</div>
                <div class="sub">–ø–æ—Ç—Ä–æ–≥–∞–π –∏ –ø–æ–∫—Ä—É—Ç–∏ –∫–æ—Ä–æ–±–∫—É</div>
              </div>
            </div>
            <div class="lid"></div>
            <div class="lock" id="lockBtn" title="–ù–∞–∂–º–∏ –Ω–∞ –∑–∞–º–æ–∫"></div>
          </div>

          <!-- Code lock overlay -->
          <div id="lockOverlay" class="overlay">
            <div id="lockPanel" class="panel">
              <div class="panel-h">
                <div class="col" style="gap:2px;">
                  <div class="h1">–ö–æ–¥–æ–≤—ã–π –∑–∞–º–æ–∫</div>
                  <div class="h2">–¥–µ–Ω—å ‚Ä¢ –º–µ—Å—è—Ü ‚Ä¢ –≥–æ–¥</div>
                </div>
                <div class="h2" id="lockHint">—Å–≤–∞–π–ø–∞–π –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑</div>
              </div>

              <div class="wheels">
                <div class="wheel" data-wheel="day">
                  <div class="wheel-list" id="dayList"></div>
                </div>
                <div class="wheel" data-wheel="month">
                  <div class="wheel-list" id="monthList"></div>
                </div>
                <div class="wheel" data-wheel="year">
                  <div class="wheel-list" id="yearList"></div>
                </div>
              </div>

              <div class="panel-f">
                <div class="left">
                  <button class="btn-secondary" id="btnBackToBox">–ù–∞–∑–∞–¥</button>
                </div>
                <div class="right">
                  <button class="btn-primary glow" id="btnCodeDone">–ì–æ—Ç–æ–≤–æ</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="hint" style="text-align:center; opacity:.85;">
          –ü–æ–¥—Å–∫–∞–∑–∫–∞: —ç—Ç–æ –≤–∞–∂–Ω–∞—è –¥–∞—Ç–∞ üòâ
        </div>
      </section>

      <!-- Scene 3 -->
      <section id="scene3" class="scene">
        <div class="topbar">
          <div class="brand">
            <span class="dot"></span>
            <div class="title">–ö–æ–Ω–≤–µ—Ä—Ç ‚Ä¢ –ø–µ—á–∞—Ç—å</div>
          </div>
          <div class="hint">—Å—Ü–µ–Ω–∞ 3/3</div>
        </div>

        <div class="stage">
          <div id="env3d" class="object3d envelope" aria-label="–ö–æ–Ω–≤–µ—Ä—Ç">
            <div class="face">
              <div class="pixel-edge"></div>
              <div class="label">
                <div><b>—Å–µ–∫—Ä–µ—Ç–Ω–æ–µ –ø–∏—Å—å–º–æ</b></div>
                <div class="sub">–ø–æ–∫—Ä—É—Ç–∏ –∫–æ–Ω–≤–µ—Ä—Ç –ø–∞–ª—å—Ü–µ–º</div>
              </div>
            </div>
            <div class="seal" id="seal"><i aria-hidden="true"></i></div>
          </div>

          <!-- Envelope overlay: open / trash -->
          <div id="envOverlay" class="overlay show" style="background: rgba(0,0,0,.20);">
            <div class="panel" style="max-width:520px;">
              <div class="panel-h">
                <div class="col" style="gap:2px;">
                  <div class="h1">–ß—Ç–æ –¥–µ–ª–∞–µ–º?</div>
                  <div class="h2">–ø–µ—á–∞—Ç—å –¥–µ—Ä–∂–∏—Ç —Å—é—Ä–ø—Ä–∏–∑</div>
                </div>
                <div class="h2">üôÇ</div>
              </div>
              <div style="padding:14px;">
                <div class="btns" id="envBtns" style="justify-content:center;">
                  <button class="btn-secondary" id="btnTrash">–í—ã–±—Ä–æ—Å–∏—Ç—å</button>
                  <button class="btn-primary glow" id="btnOpen">–û—Ç–∫—Ä—ã—Ç—å</button>
                </div>

                <!-- Quiz -->
                <div id="quiz" style="margin-top:12px; display:none;">
                  <div class="paper" style="margin-top:10px;">
                    <div style="font-weight:900; font-size:14px; margin-bottom:6px;">–ü—Ä–æ–≤–µ—Ä–∫–∞ üòå</div>
                    <div style="font-weight:900; font-size:18px; line-height:1.15; margin-bottom:10px;">
                      –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ñ–∞–Ω–∞—Ç–∞
                    </div>
                    <div class="row" style="gap:10px;">
                      <input id="dob" inputmode="numeric" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥"
                        style="
                          flex:1;
                          height: 46px;
                          border-radius: 14px;
                          border: 1px solid rgba(36,26,42,.18);
                          background: rgba(255,255,255,.88);
                          padding: 10px 12px;
                          font-weight:900;
                          font-size:16px;
                          color: #241a2a;
                          outline:none;
                        "/>
                      <button class="btn-primary glow" id="btnDobOk" style="height:46px; padding: 0 14px;">
                        ‚úì
                      </button>
                    </div>
                    <small id="dobHint" style="display:block; margin-top:8px; color: rgba(36,26,42,.66); font-weight:800;">
                      –§–æ—Ä–º–∞—Ç: 01.02.2005
                    </small>
                  </div>
                </div>

                <!-- Gallery + letter appear after success -->
                <div id="final" style="display:none;">
                  <div class="gallery" id="gallery">
                    <span class="badge">–º—ã</span>
                    <!-- imgs injected -->
                  </div>

                  <div class="letter" id="letter">
                    <div class="notebook">
                      <div style="font-weight:1000; letter-spacing:.2px;">–ü–∏—Å—å–º–æ</div>
                      <div class="lines" id="loveText">
                        <!-- –ü–õ–ï–ô–°–•–û–õ–î–ï–†: –∑–∞–º–µ–Ω–∏ —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏ –Ω–∞ —Å–≤–æ–π —Ç–µ–∫—Å—Ç -->
                        <p>–î–∂–∞–º–∞, –ø—Ä–∏–≤–µ—Ç üôÇ</p>
                        <p>–Ø –ø—Ä–æ—Å—Ç–æ —Ö–æ—Ç–µ–ª –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–±–µ —Ç—ë–ø–ª—ã–µ —Å–ª–æ–≤–∞‚Ä¶</p>
                        <p>–ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –±—É–¥–µ—Ç –º—è–≥–∫–∏–º –∏ —Å–≤–µ—Ç–ª—ã–º.</p>
                        <p>–¢—ã ‚Äî –º–æ—è –ª—é–±–∏–º–∞—è —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å.</p>
                        <p>–ï—Å–ª–∏ —É–ª—ã–±–Ω—É–ª–∞—Å—å ‚Äî –∑–Ω–∞—á–∏—Ç –≤—Å—ë –ø–æ–ª—É—á–∏–ª–æ—Å—å.</p>
                        <p>–° –ª—é–±–æ–≤—å—é, —Ç–≤–æ–π —Ñ–∞–Ω–∞—Ç ‚ù§Ô∏è</p>
                      </div>
                    </div>
                  </div>

                </div>

              </div>
            </div>
          </div>
        </div>

        <div class="hint" style="text-align:center; opacity:.85;">
          –°–µ–∫—Ä–µ—Ç –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∞—Ç–µ üòâ
        </div>
      </section>

    </div>
  </div>

  <script>
    (() => {
      "use strict";

      /* =======================
         Settings / assets
      ======================= */
      const ASSET_IMAGES = [
        "Images/photo1.jpg",
        "Images/photo2.jpg",
        "Images/photo3.jpg",
        "Images/photo4.jpg",
      ];

      // IMPORTANT: user said the song will be —Ä—è–¥–æ–º —Å index.html.
      // You can rename here to your real file name.
      const BGM_FILE = "Je_te_laissserai_des_mots.mp3"; // <-- change if needed

      // Scene codes
      const SCENES = {
        S1: "scene1",
        S2: "scene2",
        S3: "scene3",
      };

      // Correct codes
      const CODE_DAY = 5;
      const CODE_MONTH = "–ù–æ—è–±—Ä—å";
      const CODE_YEAR = 2025;

      const DOB_CORRECT = "01.02.2005"; // dd.mm.yyyy

      // UI nodes
      const $ = (q, root=document) => root.querySelector(q);
      const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));

      const preloader = $("#preloader");
      const pBar = $("#pBar");
      const pPct = $("#pPct");
      const pText = $("#pText");
      const pCount = $("#pCount");
      const toast = $("#toast");

      const bgm = $("#bgm");
      bgm.src = BGM_FILE;

      // Scene 1
      const signModal = $("#signModal");
      const btnNo = $("#btnNo");
      const btnYes = $("#btnYes");
      const courierText = $("#courierText");
      let noWasPressed = false;

      // Scene 2
      const box3d = $("#box3d");
      const lockBtn = $("#lockBtn");
      const lockOverlay = $("#lockOverlay");
      const lockPanel = $("#lockPanel");
      const btnBackToBox = $("#btnBackToBox");
      const btnCodeDone = $("#btnCodeDone");
      const dayList = $("#dayList");
      const monthList = $("#monthList");
      const yearList = $("#yearList");

      // Scene 3
      const env3d = $("#env3d");
      const envOverlay = $("#envOverlay");
      const btnTrash = $("#btnTrash");
      const btnOpen = $("#btnOpen");
      const envBtns = $("#envBtns");
      const quiz = $("#quiz");
      const dob = $("#dob");
      const btnDobOk = $("#btnDobOk");
      const dobHint = $("#dobHint");
      const seal = $("#seal");
      const final = $("#final");
      const gallery = $("#gallery");
      const letter = $("#letter");

      // FX
      const fx = $("#fx");
      const fxCtx = fx.getContext("2d", { alpha: true, desynchronized: true });
      let fxOn = false;

      // Gallery sources after preload
      let photos = [];

      /* =======================
         Helpers
      ======================= */
      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      const lerp = (a, b, t) => a + (b - a) * t;

      function showToast(msg, ms=1400){
        toast.textContent = msg;
        toast.classList.add("show");
        window.clearTimeout(showToast._t);
        showToast._t = window.setTimeout(() => toast.classList.remove("show"), ms);
      }

      function setScene(id){
        for(const s of Object.values(SCENES)){
          const el = $("#"+s);
          el.classList.toggle("active", s === id);
        }
      }

      function safePlay(el){
        // Mobile autoplay restrictions: only plays after first user interaction
        const p = el.play();
        if(p && typeof p.catch === "function") p.catch(() => {});
      }

      /* =======================
         WebAudio: tiny SFX synth
      ======================= */
      const Audio = (() => {
        let ctx = null;
        let master = null;
        let enabled = false;

        function init(){
          if(ctx) return;
          ctx = new (window.AudioContext || window.webkitAudioContext)();
          master = ctx.createGain();
          master.gain.value = 0.55;
          master.connect(ctx.destination);
        }

        function unlock(){
          init();
          if(!ctx) return;
          if(ctx.state === "suspended") ctx.resume().catch(()=>{});
          enabled = true;
        }

        function beep(type="tap"){
          if(!enabled || !ctx) return;

          const t0 = ctx.currentTime;
          const o = ctx.createOscillator();
          const g = ctx.createGain();

          let f = 220, dur = 0.08;
          if(type === "tap"){ f = 420; dur = 0.05; }
          if(type === "no"){ f = 180; dur = 0.09; }
          if(type === "open"){ f = 520; dur = 0.12; }
          if(type === "ok"){ f = 620; dur = 0.11; }
          if(type === "shake"){ f = 260; dur = 0.10; }
          if(type === "win"){ f = 740; dur = 0.16; }

          o.type = "triangle";
          o.frequency.setValueAtTime(f, t0);

          g.gain.setValueAtTime(0.0001, t0);
          g.gain.exponentialRampToValueAtTime(0.18, t0 + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

          o.connect(g);
          g.connect(master);

          o.start(t0);
          o.stop(t0 + dur + 0.02);
        }

        function whoosh(){
          if(!enabled || !ctx) return;
          const t0 = ctx.currentTime;
          const n = ctx.createBufferSource();
          const len = Math.floor(ctx.sampleRate * 0.18);
          const buf = ctx.createBuffer(1, len, ctx.sampleRate);
          const data = buf.getChannelData(0);
          for(let i=0;i<len;i++){
            const x = i/len;
            // soft noise envelope
            data[i] = (Math.random()*2-1) * (1 - x) * 0.35;
          }
          n.buffer = buf;

          const bp = ctx.createBiquadFilter();
          bp.type = "bandpass";
          bp.frequency.setValueAtTime(900, t0);
          bp.Q.setValueAtTime(0.8, t0);

          const g = ctx.createGain();
          g.gain.setValueAtTime(0.0001, t0);
          g.gain.exponentialRampToValueAtTime(0.25, t0 + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);

          n.connect(bp);
          bp.connect(g);
          g.connect(master);

          n.start(t0);
          n.stop(t0 + 0.2);
        }

        return { unlock, beep, whoosh };
      })();

      /* =======================
         Placeholder image (white bg + red heart)
      ======================= */
      function makeHeartPlaceholder(size=640){
        const c = document.createElement("canvas");
        c.width = c.height = size;
        const g = c.getContext("2d");

        // white paper with slight warm tint
        g.fillStyle = "#ffffff";
        g.fillRect(0,0,size,size);
        g.fillStyle = "rgba(230,59,80,0.06)";
        g.fillRect(0,0,size,size);

        // subtle pixel grid
        g.globalAlpha = 0.10;
        g.fillStyle = "#000";
        for(let y=0; y<size; y+=8){
          g.fillRect(0,y,size,1);
        }
        for(let x=0; x<size; x+=8){
          g.fillRect(x,0,1,size);
        }
        g.globalAlpha = 1;

        // heart
        g.save();
        g.translate(size/2, size/2 + 18);
        const s = size * 0.27;
        g.fillStyle = "#e63b50";
        g.beginPath();
        g.moveTo(0, s*0.90);
        g.bezierCurveTo(-s*1.10, s*0.12, -s*0.95, -s*0.95, 0, -s*0.42);
        g.bezierCurveTo(s*0.95, -s*0.95, s*1.10, s*0.12, 0, s*0.90);
        g.closePath();
        g.fill();

        // highlight
        g.globalAlpha = 0.25;
        g.fillStyle = "#fff";
        g.beginPath();
        g.arc(-s*0.28, -s*0.24, s*0.22, 0, Math.PI*2);
        g.fill();
        g.restore();

        return c.toDataURL("image/png");
      }

      /* =======================
         Preload images with fallback
      ======================= */
      function preloadImages(urls){
        const total = urls.length;
        let done = 0;
        const out = new Array(total);

        pCount.textContent = `0/${total}`;
        pText.textContent = "–ü–æ–¥–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏‚Ä¶";

        return new Promise(resolve => {
          if(total === 0) resolve([]);

          urls.forEach((url, i) => {
            const img = new Image();
            img.decoding = "async";
            img.loading = "eager";
            img.onload = () => {
              out[i] = url;
              done++;
              update();
              if(done === total) resolve(out);
            };
            img.onerror = () => {
              out[i] = makeHeartPlaceholder(720);
              done++;
              update();
              if(done === total) resolve(out);
            };
            img.src = url;
          });

          function update(){
            const pct = Math.round((done/total)*100);
            pBar.style.width = pct + "%";
            pPct.textContent = pct + "%";
            pCount.textContent = `${done}/${total}`;
          }
        });
      }

      /* =======================
         Rotation controller (phys-ish drag with inertia)
      ======================= */
      class RotationController{
        constructor(el, opts={}){
          this.el = el;
          this.rx = opts.rx ?? -10;
          this.ry = opts.ry ?? 18;
          this.vx = 0;
          this.vy = 0;
          this.dragging = false;

          this.maxVel = opts.maxVel ?? 6.0;
          this.dragFactor = opts.dragFactor ?? 0.22;
          this.damp = opts.damp ?? 0.92;
          this.spring = opts.spring ?? 0.08;
          this.rxMin = opts.rxMin ?? -26;
          this.rxMax = opts.rxMax ?? 26;

          this._pid = null;
          this._lx = 0; this._ly = 0; this._lt = 0;

          this._onDown = this.onDown.bind(this);
          this._onMove = this.onMove.bind(this);
          this._onUp = this.onUp.bind(this);

          el.addEventListener("pointerdown", this._onDown, { passive:false });
          window.addEventListener("pointermove", this._onMove, { passive:false });
          window.addEventListener("pointerup", this._onUp, { passive:true });
          window.addEventListener("pointercancel", this._onUp, { passive:true });
        }

        onDown(e){
          if(e.button !== undefined && e.button !== 0) return;
          this.dragging = true;
          this._pid = e.pointerId;
          this.el.setPointerCapture?.(e.pointerId);
          this._lx = e.clientX; this._ly = e.clientY; this._lt = performance.now();
          this.vx = 0; this.vy = 0;
          Audio.beep("tap");
          e.preventDefault();
        }

        onMove(e){
          if(!this.dragging || (this._pid !== null && e.pointerId !== this._pid)) return;

          const now = performance.now();
          const dt = Math.max(8, now - this._lt);
          const dx = e.clientX - this._lx;
          const dy = e.clientY - this._ly;

          this.ry += dx * this.dragFactor;
          this.rx -= dy * this.dragFactor;

          // velocity estimation (deg per frame-ish)
          const vx = (dx / dt) * 16 * this.dragFactor;
          const vy = (-dy / dt) * 16 * this.dragFactor;

          this.vy = clamp(lerp(this.vy, vx, 0.6), -this.maxVel, this.maxVel);
          this.vx = clamp(lerp(this.vx, vy, 0.6), -this.maxVel, this.maxVel);

          this._lx = e.clientX; this._ly = e.clientY; this._lt = now;
          e.preventDefault();
        }

        onUp(e){
          if(!this.dragging) return;
          if(this._pid !== null && e.pointerId !== this._pid) return;
          this.dragging = false;
          this._pid = null;
        }

        tick(){
          if(!this.dragging){
            this.ry += this.vy;
            this.rx += this.vx;

            this.vx *= this.damp;
            this.vy *= this.damp;

            // spring clamp rx to keep it comfy
            if(this.rx < this.rxMin){
              const d = (this.rxMin - this.rx);
              this.vx += d * this.spring;
            } else if(this.rx > this.rxMax){
              const d = (this.rxMax - this.rx);
              this.vx += d * this.spring;
            }
          } else {
            // hard clamp while dragging
            this.rx = clamp(this.rx, this.rxMin, this.rxMax);
          }

          this.el.style.transform = `rotateX(${this.rx}deg) rotateY(${this.ry}deg)`;
        }
      }

      /* =======================
         Wheel picker
      ======================= */
      class Wheel{
        constructor(root, listEl, items, initialIndex=0){
          this.root = root;
          this.listEl = listEl;
          this.items = items;
          this.index = clamp(initialIndex, 0, items.length-1);

          this.itemH = 42;
          this.dragging = false;
          this._pid = null;
          this._sy = 0;
          this._dy = 0;
          this._lt = 0;
          this._vy = 0;

          this.render();
          this.apply();

          root.addEventListener("pointerdown", this.onDown.bind(this), { passive:false });
          window.addEventListener("pointermove", this.onMove.bind(this), { passive:false });
          window.addEventListener("pointerup", this.onUp.bind(this), { passive:true });
          window.addEventListener("pointercancel", this.onUp.bind(this), { passive:true });
        }

        render(){
          const frag = document.createDocumentFragment();

          // add padding items for dim look (simple)
          const pad = 3;
          const all = [
            ...Array(pad).fill(""),
            ...this.items,
            ...Array(pad).fill("")
          ];

          this._pad = pad;
          this.listEl.innerHTML = "";
          all.forEach((v) => {
            const div = document.createElement("div");
            div.className = "wheel-item" + (v === "" ? " dim" : "");
            div.textContent = v === "" ? " " : v;
            frag.appendChild(div);
          });
          this.listEl.appendChild(frag);

          // compute from DOM (support small screens)
          const one = this.listEl.querySelector(".wheel-item");
          if(one){
            const h = one.getBoundingClientRect().height;
            if(h > 0) this.itemH = h;
          }
        }

        apply(instant=false){
          const y = -(this.index) * this.itemH;
          if(instant){
            const prev = this.listEl.style.transition;
            this.listEl.style.transition = "none";
            this.listEl.style.transform = `translateY(${y}px)`;
            this.listEl.offsetHeight; // reflow
            this.listEl.style.transition = prev || "";
          } else {
            this.listEl.style.transform = `translateY(${y}px)`;
          }
        }

        value(){
          return this.items[this.index];
        }

        onDown(e){
          this.dragging = true;
          this._pid = e.pointerId;
          this.root.setPointerCapture?.(e.pointerId);
          this._sy = e.clientY;
          this._dy = 0;
          this._vy = 0;
          this._lt = performance.now();
          Audio.beep("tap");
          e.preventDefault();
        }

        onMove(e){
          if(!this.dragging || (this._pid !== null && e.pointerId !== this._pid)) return;
          const now = performance.now();
          const dt = Math.max(8, now - this._lt);
          const dy = e.clientY - this._sy;

          // instantaneous velocity (px/ms)
          const vy = (dy - this._dy) / dt;
          this._vy = lerp(this._vy, vy, 0.7);

          this._dy = dy;
          this._lt = now;
          e.preventDefault();
        }

        onUp(e){
          if(!this.dragging) return;
          if(this._pid !== null && e.pointerId !== this._pid) return;

          this.dragging = false;
          this._pid = null;

          // snap
          let steps = Math.round(this._dy / this.itemH);
          // flick adds a step
          steps += Math.round(this._vy * 2.2);

          this.index = clamp(this.index + steps, 0, this.items.length - 1);
          this.apply();
          Audio.beep("tap");
        }
      }

      /* =======================
         Particles (hearts + confetti)
      ======================= */
      const FX = (() => {
        let w=0,h=0,dpr=1;
        let particles = [];
        let tPrev = 0;
        let running = false;

        function resize(){
          dpr = Math.min(2, window.devicePixelRatio || 1);
          w = Math.floor(window.innerWidth * dpr);
          h = Math.floor(window.innerHeight * dpr);
          fx.width = w; fx.height = h;
        }

        function heartPath(ctx, x, y, s){
          ctx.beginPath();
          // lightweight heart
          ctx.moveTo(x, y + s*0.35);
          ctx.bezierCurveTo(x - s*0.75, y - s*0.05, x - s*0.65, y - s*0.75, x, y - s*0.35);
          ctx.bezierCurveTo(x + s*0.65, y - s*0.75, x + s*0.75, y - s*0.05, x, y + s*0.35);
          ctx.closePath();
        }

        function burst(){
          particles = [];
          const n = 120;
          const cx = w*0.5, cy = h*0.42;
          for(let i=0;i<n;i++){
            const a = Math.random()*Math.PI*2;
            const sp = (0.7 + Math.random()*1.8) * dpr;
            particles.push({
              x: cx, y: cy,
              vx: Math.cos(a)*sp*(1.6+Math.random()*2.2),
              vy: Math.sin(a)*sp*(1.2+Math.random()*2.0) - (1.8*dpr),
              g: (0.065 + Math.random()*0.055) * dpr,
              s: (6 + Math.random()*10) * dpr,
              r: Math.random()*Math.PI*2,
              vr: (Math.random()*2-1) * 0.09,
              life: 1.0,
              kind: Math.random() < 0.45 ? "heart" : "rect"
            });
          }
        }

        function start(){
          resize();
          window.addEventListener("resize", resize, { passive:true });
          burst();
          tPrev = performance.now();
          running = true;
          tick(tPrev);
        }

        function stop(){
          running = false;
          fxCtx.clearRect(0,0,w,h);
        }

        function tick(t){
          if(!running) return;
          const dt = Math.min(32, t - tPrev);
          tPrev = t;

          fxCtx.clearRect(0,0,w,h);
          fxCtx.save();
          fxCtx.globalCompositeOperation = "source-over";

          for(const p of particles){
            p.vy += p.g * (dt/16);
            p.x += p.vx * (dt/16);
            p.y += p.vy * (dt/16);
            p.r += p.vr * (dt/16);
            p.life -= 0.0065 * (dt/16);

            const alpha = clamp(p.life, 0, 1);
            if(alpha <= 0) continue;

            fxCtx.save();
            fxCtx.translate(p.x, p.y);
            fxCtx.rotate(p.r);

            if(p.kind === "heart"){
              fxCtx.globalAlpha = alpha * 0.95;
              fxCtx.fillStyle = "rgba(230,59,80,0.95)";
              heartPath(fxCtx, 0, 0, p.s);
              fxCtx.fill();

              fxCtx.globalAlpha = alpha * 0.22;
              fxCtx.fillStyle = "#fff";
              fxCtx.beginPath();
              fxCtx.arc(-p.s*0.18, -p.s*0.18, p.s*0.16, 0, Math.PI*2);
              fxCtx.fill();
            } else {
              fxCtx.globalAlpha = alpha * 0.9;
              fxCtx.fillStyle = Math.random() < 0.5 ? "rgba(255,255,255,0.85)" : "rgba(255,107,122,0.85)";
              fxCtx.fillRect(-p.s*0.6, -p.s*0.25, p.s*1.2, p.s*0.5);
            }

            fxCtx.restore();
          }
          fxCtx.restore();

          requestAnimationFrame(tick);
        }

        return { start, stop, burst };
      })();

      /* =======================
         Build wheel lists
      ======================= */
      const months = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
      const days = Array.from({length:31}, (_,i)=> String(i+1));
      const years = Array.from({length:7}, (_,i)=> String(2020+i));

      function initWheels(){
        // default near-correct (nice UX)
        dayList.innerHTML = "";
        monthList.innerHTML = "";
        yearList.innerHTML = "";

        const wheelDay = new Wheel($(".wheel[data-wheel='day']"), dayList, days, 4); // 5
        const wheelMonth = new Wheel($(".wheel[data-wheel='month']"), monthList, months, 10); // –ù–æ—è–±—Ä—å
        const wheelYear = new Wheel($(".wheel[data-wheel='year']"), yearList, years, 5); // 2025

        return { wheelDay, wheelMonth, wheelYear };
      }

      /* =======================
         Main logic
      ======================= */
      let rotBox, rotEnv, wheels;
      let rafId = 0;

      function startRAF(){
        const tick = () => {
          rotBox?.tick();
          rotEnv?.tick();
          rafId = requestAnimationFrame(tick);
        };
        cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(tick);
      }

      function openSignModal(){
        signModal.classList.add("show");
      }
      function closeSignModal(){
        signModal.classList.remove("show");
      }

      function scene1Init(){
        // show modal after a tiny delay (feels staged)
        setTimeout(openSignModal, 250);
      }

      function scene2Init(){
        // Setup rotation
        rotBox = new RotationController(box3d, {
          rx: -10, ry: 18,
          maxVel: 6.2, dragFactor: 0.24,
          damp: 0.92, spring: 0.11,
          rxMin: -24, rxMax: 24
        });

        wheels = initWheels();
      }

      function scene3Init(){
        rotEnv = new RotationController(env3d, {
          rx: -10, ry: 18,
          maxVel: 6.2, dragFactor: 0.24,
          damp: 0.92, spring: 0.11,
          rxMin: -24, rxMax: 24
        });
      }

      function lockOpen(){
        lockOverlay.classList.add("show");
        Audio.beep("open");
        // freeze box inertia a bit (gentle)
        if(rotBox){ rotBox.vx *= 0.2; rotBox.vy *= 0.2; }
      }
      function lockClose(){
        lockOverlay.classList.remove("show");
        Audio.beep("tap");
      }

      function checkLockCode(){
        const day = parseInt(wheels.wheelDay.value(),10);
        const month = wheels.wheelMonth.value();
        const year = parseInt(wheels.wheelYear.value(),10);

        const ok = (day === CODE_DAY && month === CODE_MONTH && year === CODE_YEAR);
        if(!ok){
          lockPanel.classList.remove("shake");
          void lockPanel.offsetWidth;
          lockPanel.classList.add("shake");
          Audio.beep("shake");
          return false;
        }
        return true;
      }

      function openBoxToEnvelope(){
        lockClose();
        Audio.beep("win");
        Audio.whoosh();

        box3d.classList.add("open");

        // short dramatic pause -> next scene
        setTimeout(() => {
          setScene(SCENES.S3);
          // keep overlay visible at scene3 start (already show)
          envOverlay.classList.add("show");
          showToast("–û–≥–æ‚Ä¶ —Ç–∞–º –ø–∏—Å—å–º–æ üëÄ", 1200);
        }, 820);
      }

      function normalizeDOB(v){
        // keep digits & dots
        v = (v || "").trim();
        // If user types 01022005 -> format
        const digits = v.replace(/\D/g,"");
        if(digits.length === 8){
          return digits.slice(0,2)+"."+digits.slice(2,4)+"."+digits.slice(4,8);
        }
        // If user uses slashes
        v = v.replace(/\//g,".");
        // pad basic dd.mm.yyyy if possible
        const parts = v.split(".").filter(Boolean);
        if(parts.length === 3){
          const dd = parts[0].padStart(2,"0");
          const mm = parts[1].padStart(2,"0");
          const yy = parts[2].length === 2 ? ("20"+parts[2]) : parts[2];
          return `${dd}.${mm}.${yy}`;
        }
        return v;
      }

      function dobWrong(){
        // shake seal & hint
        seal.classList.remove("shake");
        void seal.offsetWidth;
        seal.classList.add("shake");
        Audio.beep("shake");

        dobHint.textContent = "–ú—è–≥–∫–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞: —ç—Ç–æ –Ω–∞—á–∞–ª–æ —Ñ–µ–≤—Ä–∞–ª—è üôÇ";
        dobHint.style.color = "rgba(230,59,80,.80)";
        setTimeout(() => {
          dobHint.textContent = "–§–æ—Ä–º–∞—Ç: 01.02.2005";
          dobHint.style.color = "rgba(36,26,42,.66)";
        }, 1400);
      }

      function dobCorrect(){
        Audio.beep("win");
        Audio.whoosh();

        // seal "slides off"
        seal.style.transition = "transform .55s cubic-bezier(.2,.9,.2,1), opacity .55s ease";
        seal.style.transform = "translate(-50%,-50%) translateZ(34px) translateY(120px) rotate(18deg)";
        seal.style.opacity = "0";

        // confetti hearts
        fx.classList.add("on");
        if(!fxOn){
          fxOn = true;
          FX.start();
        } else {
          FX.burst();
        }

        // show final block
        setTimeout(() => {
          final.style.display = "block";
          buildGallery();
          // show first image
          cycleGallery(true);
          // letter slide in after a bit
          setTimeout(() => letter.classList.add("show"), 520);
        }, 520);

        showToast("–û—Ç–∫—Ä—ã—Ç–æ ‚ù§Ô∏è", 1400);

        // calm down FX later
        setTimeout(() => {
          fx.classList.remove("on");
        }, 3200);
      }

      let galleryIdx = 0;
      let galleryTimer = 0;

      function buildGallery(){
        gallery.querySelectorAll("img").forEach(n => n.remove());
        const srcs = photos.slice(0,4);
        srcs.forEach((src, i) => {
          const img = document.createElement("img");
          img.alt = "photo " + (i+1);
          img.src = src;
          img.decoding = "async";
          img.loading = "eager";
          gallery.appendChild(img);
        });

        // restart loop
        clearInterval(galleryTimer);
        galleryIdx = 0;
        galleryTimer = setInterval(() => cycleGallery(false), 3400);
      }

      function cycleGallery(instant){
        const imgs = Array.from(gallery.querySelectorAll("img"));
        if(imgs.length === 0) return;
        imgs.forEach((im, i) => im.classList.toggle("show", i === galleryIdx));
        galleryIdx = (galleryIdx + 1) % imgs.length;
        if(instant) galleryIdx = 1 % imgs.length;
      }

      /* =======================
         Event wiring
      ======================= */
      function wire(){
        // One-time user interaction unlock for audio & bgm
        const unlockOnce = () => {
          Audio.unlock();
          safePlay(bgm);
          window.removeEventListener("pointerdown", unlockOnce);
          window.removeEventListener("touchstart", unlockOnce);
        };
        window.addEventListener("pointerdown", unlockOnce, { passive:true });
        window.addEventListener("touchstart", unlockOnce, { passive:true });

        // Scene 1 buttons
        btnNo.addEventListener("click", () => {
          Audio.beep("no");
          closeSignModal();

          courierText.textContent = "–í—ã —á—Ç–æ, –±–∞–ª–±–µ—Å? –ù–∞ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –ø—Ä–æ—â–∞—é.";
          showToast("–º–º‚Ä¶ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ üòÑ", 1100);

          // reopen modal but remove "No"
          setTimeout(() => {
            if(!noWasPressed){
              noWasPressed = true;
              btnNo.remove();
            }
            openSignModal();
          }, 650);
        });

        btnYes.addEventListener("click", () => {
          Audio.beep("ok");
          closeSignModal();

          // "courier passes box" animation by fading courier
          const c = $("#courierCard");
          c.style.transition = "opacity .35s ease, transform .35s ease";
          c.style.opacity = "0";
          c.style.transform = "translateY(8px)";

          Audio.whoosh();
          showToast("–ü–æ—Å—ã–ª–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞ ‚úÖ", 1100);

          setTimeout(() => {
            setScene(SCENES.S2);
          }, 420);
        });

        // Scene 2 interactions
        lockBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          lockOpen();
        });

        btnBackToBox.addEventListener("click", () => lockClose());

        btnCodeDone.addEventListener("click", () => {
          const ok = checkLockCode();
          if(ok) openBoxToEnvelope();
        });

        // Clicking outside panel closes lock (nice on mobile)
        lockOverlay.addEventListener("click", (e) => {
          if(e.target === lockOverlay) lockClose();
        });

        // Scene 3 buttons
        btnTrash.addEventListener("click", () => {
          Audio.beep("no");
          // little shake of overlay
          envOverlay.querySelector(".panel").classList.remove("shake");
          void envOverlay.offsetWidth;
          envOverlay.querySelector(".panel").classList.add("shake");
          showToast("–©–∞—Å –ø–æ —à–µ–µ –ø–æ–ª—É—á–∏—à—å", 1400);

          // morph buttons: "–û—Ç–∫—Ä—ã—Ç—å" –≤—ã—Ç–µ—Å–Ω—è–µ—Ç "–í—ã–±—Ä–æ—Å–∏—Ç—å"
          setTimeout(() => {
            btnTrash.style.transition = "opacity .22s ease, transform .22s ease";
            btnTrash.style.opacity = "0";
            btnTrash.style.transform = "translateX(8px)";
            btnOpen.style.transition = "transform .35s cubic-bezier(.2,.9,.2,1), width .35s cubic-bezier(.2,.9,.2,1)";
            btnOpen.style.transform = "translateX(-12px)";
            setTimeout(() => {
              btnTrash.remove();
              btnOpen.style.transform = "translateX(0)";
            }, 220);
          }, 520);
        });

        btnOpen.addEventListener("click", () => {
          Audio.beep("open");
          // zoom to seal
          env3d.classList.remove("zoom");
          void env3d.offsetWidth;
          env3d.classList.add("zoom");

          quiz.style.display = "block";
          final.style.display = "none";
          letter.classList.remove("show");
          setTimeout(() => dob.focus?.(), 80);
        });

        dob.addEventListener("input", () => {
          // gentle auto-format
          const v = dob.value;
          const digits = v.replace(/\D/g,"");
          if(digits.length === 8){
            dob.value = normalizeDOB(v);
          }
        });

        btnDobOk.addEventListener("click", () => {
          Audio.beep("tap");
          const v = normalizeDOB(dob.value);
          dob.value = v;
          if(v !== DOB_CORRECT){
            dobWrong();
            return;
          }

          // success!
          quiz.style.display = "none";
          dobCorrect();
        });
      }

      /* =======================
         Boot
      ======================= */
      async function boot(){
        // Preload photos (fallback if missing)
        const urls = ASSET_IMAGES.slice(0,4);
        pCount.textContent = `0/${urls.length}`;
        pText.textContent = "–ü–æ–¥–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏‚Ä¶";

        photos = await preloadImages(urls);

        pText.textContent = "–§–∏–Ω–∞–ª—å–Ω—ã–µ —à—Ç—Ä–∏—Ö–∏‚Ä¶";
        pBar.style.width = "100%";
        pPct.textContent = "100%";
        pCount.textContent = `${urls.length}/${urls.length}`;

        // init scenes
        scene1Init();
        scene2Init();
        scene3Init();
        startRAF();
        wire();

        // canvas size
        const resizeFx = () => {
          const dpr = Math.min(2, window.devicePixelRatio || 1);
          fx.style.width = "100%";
          fx.style.height = "100%";
          fx.width = Math.floor(window.innerWidth * dpr);
          fx.height = Math.floor(window.innerHeight * dpr);
        };
        resizeFx();
        window.addEventListener("resize", resizeFx, { passive:true });

        // hide preloader with fade
        preloader.style.transition = "opacity .28s ease";
        preloader.style.opacity = "0";
        setTimeout(() => preloader.remove(), 300);
      }

      boot().catch(err => {
        console.error(err);
        pText.textContent = "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –Ω–æ –º—ã –¥–µ—Ä–∂–∏–º—Å—è üôÇ";
      });

    })();
  </script>
</body>
</html>
