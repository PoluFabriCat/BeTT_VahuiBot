<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#070A12" />
  <title>–î–ª—è –î–∂–∞–º—ã üíå</title>

  <style>
    :root{
      --bg0:#050711;
      --bg1:#0a1022;

      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.09);
      --stroke: rgba(255,255,255,.12);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);

      --pink:#ff4da6;
      --pink2:#ff85c7;
      --gold:#f6d36b;
      --ok:#37d67a;
      --bad:#ff4b4b;

      --shadow: 0 18px 60px rgba(0,0,0,.52);
      --shadow2: 0 12px 30px rgba(0,0,0,.42);

      --r: 22px;
      --r2: 16px;
      --ease: cubic-bezier(.2,.8,.2,1);

      --ui: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: var(--ui);
      color: var(--text);
      overflow:hidden;
      background:
        radial-gradient(1100px 780px at 12% 10%, rgba(255,77,166,.16), transparent 60%),
        radial-gradient(900px 720px at 88% 22%, rgba(246,211,107,.13), transparent 62%),
        radial-gradient(1000px 900px at 55% 95%, rgba(87,142,255,.11), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      -webkit-tap-highlight-color: transparent;
    }

    /* stage */
    .app{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: clamp(10px, 2.2vw, 22px);
    }
    .stage{
      width:min(1020px, 100%);
      height:min(720px, 100%);
      border-radius: clamp(18px, 2.6vw, 30px);
      position:relative;
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      filter: saturate(1.03) contrast(1.02);
    }

    /* CRT cute horror-ish */
    .crtScanlines, .crtVignette, .crtNoise{
      position:absolute; inset:0; pointer-events:none; z-index: 60;
    }
    .crtScanlines{
      opacity:.34; mix-blend-mode: overlay;
      background: repeating-linear-gradient(
        180deg,
        rgba(255,255,255,.08),
        rgba(255,255,255,.08) 1px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,0) 6px
      );
    }
    .crtVignette{
      opacity:.75;
      background: radial-gradient(110% 85% at 50% 50%, transparent 55%, rgba(0,0,0,.36) 100%);
    }
    .crtNoise{
      opacity:.10;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.82' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      animation: noiseMove 1.0s steps(2,end) infinite;
    }
    @keyframes noiseMove{
      0%{ transform: translate3d(0,0,0) }
      25%{ transform: translate3d(-2px,1px,0) }
      50%{ transform: translate3d(1px,-2px,0) }
      75%{ transform: translate3d(2px,2px,0) }
      100%{ transform: translate3d(0,0,0) }
    }

    /* FX canvas */
    canvas#fx{
      position:absolute; inset:0;
      z-index: 5;
      pointer-events:none;
    }

    /* main content */
    .main{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 10;
    }

    /* bottom controls */
    .controls{
      position:absolute;
      inset:auto 0 0 0;
      z-index: 20;
      padding: 14px 14px 16px;
      display:flex;
      justify-content:center;
      gap:10px;
      background: linear-gradient(0deg, rgba(0,0,0,.46), rgba(0,0,0,0));
    }
    .controls[hidden]{ display:none; }
    .controls .btn{ max-width: 320px; flex: 1 1 220px; }

    /* toast */
    .toast{
      position:absolute;
      left: 50%;
      bottom: 86px;
      transform: translateX(-50%) translateY(8px);
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      font-size: 12px;
      box-shadow: var(--shadow2);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s var(--ease), transform .18s var(--ease);
      z-index: 40;
      max-width: calc(100% - 28px);
      text-align:center;
      font-family: var(--mono);
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(0px); }

    /* shared UI */
    .panel{
      width:min(560px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.085), rgba(255,255,255,.035));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      padding: 16px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .panel h2{
      margin:0 0 8px 0;
      font-size: 15px;
      letter-spacing:.3px;
      font-family: var(--mono);
    }
    .panel p{
      margin:0;
      color: var(--muted);
      line-height:1.45;
      font-size: 12.5px;
    }

    .row{
      display:flex;
      gap:10px;
      margin-top: 14px;
      flex-wrap:wrap;
    }

    .btn{
      border:0;
      cursor:pointer;
      user-select:none;
      padding: 12px 14px;
      border-radius: 14px;
      color: var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      transition: transform .12s var(--ease), background .12s var(--ease), border-color .12s var(--ease), opacity .12s var(--ease);
      font-weight: 850;
      letter-spacing:.15px;
      font-size: 12.5px;
      min-width: 140px;
      flex: 1 1 160px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-family: var(--mono);
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(0px) scale(.99); }

    .btn.primary{
      background: linear-gradient(135deg, rgba(255,77,166,.26), rgba(255,133,199,.12));
      border-color: rgba(255,77,166,.40);
      box-shadow: 0 10px 30px rgba(255,77,166,.12);
    }
    .btn.ok{
      background: linear-gradient(135deg, rgba(55,214,122,.22), rgba(255,255,255,.05));
      border-color: rgba(55,214,122,.38);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,75,75,.20), rgba(255,255,255,.05));
      border-color: rgba(255,75,75,.38);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.78);
      font-size: 11.5px;
      user-select:none;
      font-family: var(--mono);
    }

    /* 3D object */
    .objectWrap{
      width:min(560px, 100%);
      height:min(460px, 58vh);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      perspective: 900px;
      touch-action:none;
      user-select:none;
    }
    .object{
      width: min(360px, 80vw);
      height: min(280px, 60vw);
      position:relative;
      transform-style: preserve-3d;
      will-change: transform;
      filter: drop-shadow(0 18px 35px rgba(0,0,0,.45));
    }

    /* box */
    .box{
      border-radius: 22px;
      background:
        radial-gradient(140px 90px at 20% 20%, rgba(255,255,255,.20), transparent 55%),
        linear-gradient(135deg, rgba(246,211,107,.20), rgba(255,77,166,.12)),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.12));
      border: 1px solid rgba(255,255,255,.14);
      overflow:hidden;
    }
    .box::before{
      content:"";
      position:absolute; inset:0;
      opacity:.55; pointer-events:none;
      background:
        linear-gradient(90deg, rgba(0,0,0,.18), transparent 40%, rgba(255,255,255,.06) 65%, rgba(0,0,0,.18)),
        repeating-linear-gradient(0deg, rgba(255,255,255,.06), rgba(255,255,255,.06) 2px, transparent 2px, transparent 8px);
      mix-blend-mode: overlay;
    }
    .boxLabel{
      position:absolute; left: 16px; bottom: 14px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 950;
      letter-spacing:.4px;
      text-transform: lowercase;
      font-family: var(--mono);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .boxLabel span{
      background: linear-gradient(90deg, var(--pink2), var(--gold));
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
    }

    .lock{
      position:absolute; top: 20px; right: 20px;
      width: 86px; height: 86px;
      border-radius: 22px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.14);
      display:grid; place-items:center;
      cursor:pointer;
      transform: translateZ(18px);
      box-shadow: 0 0 0 1px rgba(255,255,255,.05) inset;
    }
    .lockGlow{
      position:absolute; inset:-10px;
      border-radius: 28px;
      background: radial-gradient(circle at 50% 50%, rgba(255,77,166,.60), transparent 62%);
      filter: blur(10px);
      opacity:.95;
      animation: pulse 1.2s var(--ease) infinite alternate;
      pointer-events:none;
    }
    @keyframes pulse{ from{ transform: scale(.96); opacity:.55 } to{ transform: scale(1.03); opacity: .98 } }
    .lockIcon{ width: 34px; height: 34px; position:relative; }
    .lockIcon::before{
      content:""; position:absolute;
      left: 7px; right: 7px; top: 16px; bottom: 2px;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.24), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.18);
    }
    .lockIcon::after{
      content:""; position:absolute;
      width: 22px; height: 18px;
      left: 50%; top: 2px;
      transform: translateX(-50%);
      border-radius: 14px 14px 10px 10px;
      border: 3px solid rgba(255,255,255,.42);
      border-bottom: 0;
      box-shadow: 0 0 18px rgba(255,77,166,.18);
    }

    /* envelope */
    .envelope{
      border-radius: 22px;
      background:
        radial-gradient(150px 90px at 18% 22%, rgba(255,255,255,.20), transparent 55%),
        linear-gradient(135deg, rgba(255,77,166,.15), rgba(87,142,255,.10)),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.14));
      border: 1px solid rgba(255,255,255,.14);
      overflow:hidden;
    }
    .envTop{
      position:absolute; inset:0;
      background:
        linear-gradient(0deg, transparent 54%, rgba(0,0,0,.20)),
        conic-gradient(from 225deg at 50% 52%, rgba(255,255,255,.08), rgba(255,255,255,.02), rgba(255,255,255,.08));
      opacity:.9; pointer-events:none;
    }
    .seal{
      position:absolute; left: 50%; top: 50%;
      transform: translate(-50%,-50%) translateZ(20px);
      width: 88px; height: 88px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), transparent 55%),
        linear-gradient(135deg, rgba(246,211,107,.22), rgba(255,77,166,.20));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      display:grid; place-items:center;
      font-weight: 950;
      letter-spacing:.6px;
      user-select:none;
      font-family: var(--mono);
    }
    .seal span{
      background: linear-gradient(90deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
      font-size: 18px;
    }

    /* modal */
    .modalOverlay{
      position:absolute; inset:0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 50;
      padding: 16px;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width:min(660px, 100%);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .modalHead{
      padding: 14px 16px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.20), transparent);
    }
    .modalHead h3{ margin:0; font-size:14px; letter-spacing:.25px; font-family: var(--mono); }
    .modalHead p{ margin:4px 0 0 0; font-size:12px; color:var(--muted); line-height:1.35; }
    .modalBody{ padding: 12px 16px 14px; }

    .wheels{
      display:grid;
      grid-template-columns: 1fr 1.2fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .wheel{
      height: 210px;
      border-radius: 18px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      position:relative;
      overflow:hidden;
      touch-action:none;
      user-select:none;
    }
    .wheel::before{
      content:""; position:absolute; inset:0;
      background:
        linear-gradient(180deg, rgba(0,0,0,.84), transparent 28%, transparent 72%, rgba(0,0,0,.84)),
        radial-gradient(260px 140px at 50% 50%, rgba(255,77,166,.10), transparent 58%);
      pointer-events:none;
    }
    .wheel .items{
      position:absolute; left:0; right:0;
      top: 50%;
      transform: translateY(-50%);
      will-change: transform;
    }
    .wheel .item{
      height: 42px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      letter-spacing:.35px;
      color: rgba(255,255,255,.75);
      opacity:.82;
      transition: opacity .12s var(--ease), transform .12s var(--ease), color .12s var(--ease);
      font-family: var(--mono);
    }
    .wheel .item.active{
      color: rgba(255,255,255,.95);
      opacity: 1;
      transform: scale(1.06);
      text-shadow: 0 0 18px rgba(255,77,166,.18);
    }
    .wheel .selector{
      position:absolute; left:10px; right:10px;
      top: 50%;
      transform: translateY(-50%);
      height: 46px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      box-shadow: 0 0 0 1px rgba(0,0,0,.20) inset;
      pointer-events:none;
    }
    .modalActions{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap:wrap;
    }

    /* date input */
    .datePrompt{ display:grid; gap: 10px; margin-top: 10px; }
    .field{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[type="text"]{
      flex: 1 1 220px;
      min-width: 210px;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
      outline:none;
      font-weight: 950;
      letter-spacing:.2px;
      font-variant-numeric: tabular-nums;
      font-family: var(--mono);
    }
    input[type="text"]::placeholder{ color: rgba(255,255,255,.40); }

    /* finale */
    .finale{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 12;
    }
    .finale.show{ display:flex; }

    .finaleGrid{
      width:min(940px, 100%);
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
      align-items:stretch;
    }
    @media (max-width: 860px){
      .finaleGrid{ grid-template-columns: 1fr; }
    }
    .photoCard{
      border-radius: var(--r);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
      box-shadow: var(--shadow2);
      position:relative;
      min-height: 260px;
    }
    .photoRail{
      position:absolute; inset:0;
      display:flex;
      transition: transform .6s var(--ease);
    }
    .photoRail img{
      width:100%;
      height:100%;
      object-fit: cover;
      flex: 0 0 100%;
      filter: saturate(1.03) contrast(1.02);
    }
    .photoDots{
      position:absolute; left: 12px; bottom: 12px;
      display:flex; gap:8px;
      z-index:2;
      background: rgba(0,0,0,.32);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 8px 10px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .photoDots button{
      width: 9px; height: 9px;
      border-radius:999px;
      border:0;
      background: rgba(255,255,255,.26);
      cursor:pointer;
      padding:0;
    }
    .photoDots button.active{ background: rgba(255,255,255,.86); }

    .noteCard{
      border-radius: var(--r);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      padding: 14px;
      position:relative;
      overflow:hidden;
    }
    .paper{
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.84));
      color: rgba(10,12,18,.92);
      border: 1px solid rgba(0,0,0,.08);
      padding: 18px 16px;
      box-shadow: 0 18px 50px rgba(0,0,0,.28);
      position:relative;
      overflow:hidden;
    }
    .paper::before{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        180deg,
        rgba(12,16,30,.08),
        rgba(12,16,30,.08) 1px,
        transparent 1px,
        transparent 26px
      );
      opacity:.55;
      pointer-events:none;
    }
    .paper h4{
      margin:0 0 10px 0;
      font-size: 15px;
      letter-spacing:.2px;
      position:relative;
      z-index:1;
      font-family: var(--mono);
    }
    .paper p{
      margin:0;
      line-height:1.6;
      font-size: 13px;
      position:relative;
      z-index:1;
      white-space: pre-wrap;
      font-family: var(--ui);
    }
    .miniFooter{
      margin-top: 10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
      font-family: var(--mono);
    }

    /* motion helpers */
    .fadeIn{ animation: fadeIn .30s var(--ease) both; }
    @keyframes fadeIn{ from{ opacity:0; transform: translateY(10px) } to{ opacity:1; transform: translateY(0) } }
    .shake{ animation: shake .22s linear 1; }
    @keyframes shake{
      0%{ transform: translate3d(0,0,0) }
      20%{ transform: translate3d(-6px,2px,0) }
      40%{ transform: translate3d(6px,-2px,0) }
      60%{ transform: translate3d(-4px,1px,0) }
      80%{ transform: translate3d(4px,-1px,0) }
      100%{ transform: translate3d(0,0,0) }
    }

    /* ================= Chat widget (corner) ================= */
    .chatFab{
      position:absolute;
      left: 14px;
      bottom: 14px;
      z-index: 45;
      width: 56px;
      height: 56px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.18), transparent 55%),
        linear-gradient(135deg, rgba(255,77,166,.22), rgba(246,211,107,.12));
      box-shadow: 0 18px 40px rgba(0,0,0,.42);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      transition: transform .14s var(--ease);
    }
    .chatFab:hover{ transform: translateY(-1px); }
    .chatFab:active{ transform: translateY(0) scale(.99); }

    .chatFab .ico{
      font-family: var(--mono);
      font-weight: 950;
      letter-spacing:.4px;
      color: rgba(255,255,255,.92);
      font-size: 12px;
      width: 32px; height: 32px;
      border-radius: 12px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.12);
      display:grid;
      place-items:center;
      box-shadow: 0 0 0 1px rgba(0,0,0,.14) inset;
    }

    .badgeCount{
      position:absolute;
      right: -4px;
      top: -4px;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      border-radius: 999px;
      background: rgba(255,77,166,.95);
      color: rgba(255,255,255,.96);
      font-family: var(--mono);
      font-weight: 950;
      font-size: 11px;
      display:none;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 20px rgba(255,77,166,.20);
    }
    .badgeCount.show{ display:flex; }

    .chatPanel{
      position:absolute;
      left: 14px;
      bottom: 78px;
      z-index: 46;
      width: min(320px, calc(100% - 28px));
      max-height: min(420px, calc(100% - 140px));
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.095), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      flex-direction:column;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .chatPanel.show{ display:flex; animation: fadeIn .22s var(--ease) both; }

    .chatHead{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.22), transparent);
    }
    .chatTitle{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .avatar{
      width: 34px; height: 34px;
      border-radius: 12px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.18), transparent 55%),
        linear-gradient(135deg, rgba(255,77,166,.20), rgba(246,211,107,.12));
      border: 1px solid rgba(255,255,255,.14);
      display:grid;
      place-items:center;
      font-family: var(--mono);
      font-weight: 950;
      letter-spacing:.4px;
      color: rgba(255,255,255,.92);
      box-shadow: 0 0 0 1px rgba(0,0,0,.14) inset;
    }
    .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .meta .name{
      font-family: var(--mono);
      font-weight: 950;
      font-size: 12.5px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta .status{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
    }

    .chatBtns{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .iconBtn{
      cursor:pointer;
      border:0;
      color: rgba(255,255,255,.88);
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      padding: 8px 10px;
      border-radius: 12px;
      font-family: var(--mono);
      font-weight: 950;
      font-size: 12px;
      transition: transform .12s var(--ease), background .12s var(--ease);
      user-select:none;
    }
    .iconBtn:hover{ transform: translateY(-1px); background: rgba(0,0,0,.26); }
    .iconBtn:active{ transform: translateY(0) scale(.99); }

    .chatBody{
      padding: 10px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }
    .bubble{
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      font-size: 12.5px;
      line-height: 1.35;
      color: rgba(255,255,255,.88);
      font-family: var(--ui);
      opacity:0;
      transform: translateY(4px);
      animation: popIn .22s var(--ease) forwards;
    }
    @keyframes popIn{ to{ opacity:1; transform: translateY(0); } }

    .typing{
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.70);
      font-family: var(--mono);
      font-size: 12px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .dots{ display:inline-flex; gap:4px; }
    .dots i{
      width:5px;height:5px;border-radius:99px;
      background: rgba(255,255,255,.55);
      display:block;
      animation: dot 1s var(--ease) infinite;
    }
    .dots i:nth-child(2){ animation-delay: .12s }
    .dots i:nth-child(3){ animation-delay: .24s }
    @keyframes dot{
      0%,100%{ transform: translateY(0); opacity:.45 }
      50%{ transform: translateY(-2px); opacity:1 }
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
      .lockGlow{ display:none; }
      .crtNoise{ display:none; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="stage" id="stage">
      <canvas id="fx"></canvas>

      <div class="main" id="main"></div>
      <div class="controls" id="controls" hidden></div>
      <div class="toast" id="toast"></div>

      <!-- modal -->
      <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true">
          <div class="modalHead">
            <div>
              <h3 id="modalTitle">–ó–∞–º–æ–∫</h3>
              <p id="modalSubtitle">–í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥.</p>
            </div>
            <div class="badge">–∫—Ä—É—Ç–∏ ‚Üë‚Üì</div>
          </div>
          <div class="modalBody" id="modalBody"></div>
        </div>
      </div>

      <!-- finale -->
      <div class="finale" id="finale">
        <div class="finaleGrid">
          <div class="photoCard">
            <div class="photoRail" id="photoRail"></div>
            <div class="photoDots" id="photoDots"></div>
          </div>
          <div class="noteCard">
            <div class="paper">
              <h4>–î–∂–∞–º–∞, —ç—Ç–æ —Ç–µ–±–µ üíó</h4>
              <p id="loveText"></p>
            </div>
            <div class="miniFooter">
              <span>üíå –æ—Ç —Ñ–∞–Ω–∞—Ç–∞</span>
              <span>–ª–∏—Å—Ç–∞–π —Ñ–æ—Ç–æ</span>
            </div>
          </div>
        </div>
      </div>

      <!-- chat widget -->
      <button class="chatFab" id="chatFab" aria-label="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –∫—É—Ä—å–µ—Ä–∞">
        <div class="ico">YC</div>
        <div class="badgeCount" id="chatBadge">1</div>
      </button>

      <div class="chatPanel" id="chatPanel" aria-hidden="true">
        <div class="chatHead">
          <div class="chatTitle">
            <div class="avatar">YC</div>
            <div class="meta">
              <div class="name">–Ø–Ω–¥–µ–∫—Å-–∫—É—Ä—å–µ—Ä</div>
              <div class="status" id="courierStatus">–Ω–∞ —Å–≤—è–∑–∏</div>
            </div>
          </div>
          <div class="chatBtns">
            <button class="iconBtn" id="hintBtn" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞">?</button>
            <button class="iconBtn" id="soundBtn" title="–ó–≤—É–∫">üîä</button>
            <button class="iconBtn" id="closeChatBtn" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
          </div>
        </div>
        <div class="chatBody" id="chatBody"></div>
      </div>

      <div class="crtScanlines"></div>
      <div class="crtNoise"></div>
      <div class="crtVignette"></div>
    </div>
  </div>

<script>
(() => {
  // ================== SETTINGS ==================
  const GIRL_NAME = "–î–∂–∞–º–∞";

  // –º–∞–∫—Å–∏–º—É–º 3‚Äì4 —Ñ–æ—Ç–æ
  const PHOTO_FILES = ["Images/1.jpg","Images/2.jpg","Images/3.jpg","Images/4.jpg"];

  const LOVE_TEXT =
`–Ø –Ω–µ –∑–Ω–∞—é, –∫–∞–∫ —É —Ç–µ–±—è —ç—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è,
–Ω–æ —Ä—è–¥–æ–º —Å —Ç–æ–±–æ–π –º–∏—Ä —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ç–∏—à–µ –∏ –¥–æ–±—Ä–µ–µ.

–¢—ã ‚Äî –º–æ–π –≤—ã–±–æ—Ä, –º–æ—è —Ä–∞–¥–æ—Å—Ç—å –∏ –º–æ–π —É—é—Ç.
–ü—É—Å—Ç—å —É –Ω–∞—Å –±—É–¥–µ—Ç –µ—â—ë —Ç—ã—Å—è—á–∞ –ø–æ–≤–æ–¥–æ–≤ —É–ª—ã–±–∞—Ç—å—Å—è.

–° –î–Ω—ë–º –≤—Å–µ—Ö –≤–ª—é–±–ª—ë–Ω–Ω—ã—Ö, –î–∂–∞–º–∞. üíó`;

  // 5 –Ω–æ—è–±—Ä—è 2025
  const BOX_CODE = { day: 5, monthIndex: 11, year: 2025 };

  // 01.02.2005
  const FAN_BDAY = { d: 1, m: 2, y: 2005 };

  // ================== DOM ==================
  const stage = document.getElementById("stage");
  const main = document.getElementById("main");
  const controls = document.getElementById("controls");
  const toast = document.getElementById("toast");

  const modalOverlay = document.getElementById("modalOverlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalSubtitle = document.getElementById("modalSubtitle");
  const modalBody = document.getElementById("modalBody");

  const finale = document.getElementById("finale");
  const photoRail = document.getElementById("photoRail");
  const photoDots = document.getElementById("photoDots");
  const loveTextEl = document.getElementById("loveText");
  loveTextEl.textContent = LOVE_TEXT;

  // chat
  const chatFab = document.getElementById("chatFab");
  const chatPanel = document.getElementById("chatPanel");
  const chatBody = document.getElementById("chatBody");
  const chatBadge = document.getElementById("chatBadge");
  const courierStatus = document.getElementById("courierStatus");
  const closeChatBtn = document.getElementById("closeChatBtn");
  const hintBtn = document.getElementById("hintBtn");
  const soundBtn = document.getElementById("soundBtn");

  // ================== Helpers ==================
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const qs = (sel, root=document) => root.querySelector(sel);

  function showToast(msg, ms=1400){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.classList.remove("show"), ms);
  }

  function vibrate(ms){
    if (navigator.vibrate) navigator.vibrate(ms);
  }

  // ================== Audio (WebAudio, no files) ==================
  let audioOn = true;
  let AC = null;
  let master = null;

  function ensureAudio(){
    if (AC) return;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) return;
    AC = new Ctx();
    master = AC.createGain();
    master.gain.value = 0.55;
    master.connect(AC.destination);
  }

  function beep({type="sine", freq=440, dur=0.07, vol=0.06, glide=1.0}){
    if(!audioOn) return;
    ensureAudio();
    if(!AC) return;
    if (AC.state === "suspended") AC.resume().catch(()=>{});

    const o = AC.createOscillator();
    const g = AC.createGain();

    o.type = type;
    o.frequency.value = freq;
    g.gain.value = 0.0001;

    o.connect(g);
    g.connect(master);

    const t = AC.currentTime;
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(Math.max(0.0002, vol), t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t + dur);

    o.frequency.setValueAtTime(freq, t);
    o.frequency.exponentialRampToValueAtTime(Math.max(40, freq * glide), t + dur);

    o.start(t);
    o.stop(t + dur + 0.02);
  }

  const sfx = {
    click(){ beep({type:"triangle", freq:520, dur:0.05, vol:0.05, glide:1.02}); },
    ok(){ beep({type:"triangle", freq:640, dur:0.06, vol:0.05, glide:1.06}); setTimeout(()=>beep({type:"sine", freq:920, dur:0.08, vol:0.04, glide:1.02}), 60); },
    bad(){ beep({type:"sawtooth", freq:180, dur:0.10, vol:0.05, glide:0.92}); setTimeout(()=>beep({type:"sawtooth", freq:140, dur:0.08, vol:0.04, glide:0.95}), 70); },
    unlock(){
      beep({type:"square", freq:220, dur:0.05, vol:0.045, glide:1.10});
      setTimeout(()=>beep({type:"triangle", freq:540, dur:0.08, vol:0.05, glide:1.05}), 60);
      setTimeout(()=>beep({type:"sine", freq:880, dur:0.09, vol:0.04, glide:1.02}), 140);
    },
    chatPop(){ beep({type:"sine", freq:360, dur:0.04, vol:0.02, glide:1.01}); },
    wheel(){ beep({type:"triangle", freq:420, dur:0.03, vol:0.02, glide:1.01}); },
  };

  soundBtn.addEventListener("click", () => {
    audioOn = !audioOn;
    soundBtn.textContent = audioOn ? "üîä" : "üîá";
    sfx.click();
  });

  // iOS/Telegram: audio must start after gesture
  window.addEventListener("pointerdown", () => ensureAudio(), {once:true, passive:true});

  // ================== Chat widget logic ==================
  let chatOpen = false;
  let unread = 0;

  function setUnread(n){
    unread = n;
    if (unread > 0){
      chatBadge.textContent = String(unread > 99 ? "99+" : unread);
      chatBadge.classList.add("show");
    } else {
      chatBadge.classList.remove("show");
    }
  }

  function openChat(){
    chatOpen = true;
    chatPanel.classList.add("show");
    chatPanel.setAttribute("aria-hidden", "false");
    setUnread(0);
    sfx.click();
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function closeChat(){
    chatOpen = false;
    chatPanel.classList.remove("show");
    chatPanel.setAttribute("aria-hidden", "true");
    sfx.click();
  }

  chatFab.addEventListener("click", () => {
    chatOpen ? closeChat() : openChat();
  });

  closeChatBtn.addEventListener("click", closeChat);

  function typingOn(){
    courierStatus.textContent = "–ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶";
    const t = document.createElement("div");
    t.className = "typing";
    t.dataset.typing = "1";
    t.innerHTML = `<span>‚Ä¶</span><span class="dots"><i></i><i></i><i></i></span>`;
    chatBody.appendChild(t);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function typingOff(){
    courierStatus.textContent = "–Ω–∞ —Å–≤—è–∑–∏";
    const t = chatBody.querySelector('[data-typing="1"]');
    if(t) t.remove();
  }

  async function say(text, delay=450){
    typingOn();
    await sleep(delay);
    typingOff();
    const b = document.createElement("div");
    b.className = "bubble";
    b.innerHTML = text;
    chatBody.appendChild(b);
    chatBody.scrollTop = chatBody.scrollHeight;

    if(!chatOpen) setUnread(unread + 1);
    sfx.chatPop();
  }

  function clearChat(){
    chatBody.innerHTML = "";
  }

  // Hint button in chat
  hintBtn.addEventListener("click", async () => {
    sfx.click();
    await say(getHintForScene(), 240);
    if(!chatOpen) openChat();
  });

  // ================== FX (hearts/confetti) ==================
  const fx = document.getElementById("fx");
  const fctx = fx.getContext("2d");
  let W=0,H=0,DPR=1;

  function resizeFx(){
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const r = stage.getBoundingClientRect();
    W = Math.floor(r.width * DPR);
    H = Math.floor(r.height * DPR);
    fx.width = W; fx.height = H;
    fx.style.width = r.width + "px";
    fx.style.height = r.height + "px";
  }
  window.addEventListener("resize", resizeFx, {passive:true});
  resizeFx();

  const particles = [];
  function spawnHearts(count=60){
    const r = stage.getBoundingClientRect();
    const ox = r.width * 0.55 * DPR;
    const oy = r.height * 0.45 * DPR;
    for(let i=0;i<count;i++){
      particles.push({
        x: ox + (Math.random()-0.5)*55*DPR,
        y: oy + (Math.random()-0.5)*28*DPR,
        vx: (Math.random()-0.5)*6*DPR,
        vy: (-2.4 - Math.random()*5.0)*DPR,
        g: (0.12 + Math.random()*0.10)*DPR,
        rot: Math.random()*Math.PI,
        vr: (Math.random()-0.5)*0.25,
        life: 110 + Math.random()*70,
        kind: Math.random() < 0.65 ? "heart" : "spark",
        s: (10 + Math.random()*14)*DPR,
        a: 1
      });
    }
  }

  function drawHeart(x,y,size,rot,alpha){
    fctx.save();
    fctx.translate(x,y);
    fctx.rotate(rot);
    fctx.globalAlpha = alpha;
    const s=size;
    fctx.beginPath();
    fctx.moveTo(0, s*0.25);
    fctx.bezierCurveTo(s*0.55, -s*0.15, s*0.65, s*0.55, 0, s*0.95);
    fctx.bezierCurveTo(-s*0.65, s*0.55, -s*0.55, -s*0.15, 0, s*0.25);
    fctx.closePath();
    fctx.fillStyle = "rgba(255,77,166,0.95)";
    fctx.fill();
    fctx.globalAlpha = alpha*0.55;
    fctx.fillStyle = "rgba(246,211,107,0.62)";
    fctx.fill();
    fctx.restore();
  }

  function drawSpark(x,y,size,alpha){
    fctx.save();
    fctx.globalAlpha = alpha;
    fctx.beginPath();
    fctx.arc(x,y,size*0.12,0,Math.PI*2);
    fctx.fillStyle = "rgba(255,255,255,0.95)";
    fctx.fill();
    fctx.restore();
  }

  function fxLoop(){
    fctx.clearRect(0,0,W,H);
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.vy += p.g;
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      p.life -= 1;
      p.a = clamp(p.life/90, 0, 1);

      if(p.kind === "heart") drawHeart(p.x,p.y,p.s,p.rot,p.a);
      else drawSpark(p.x,p.y,p.s,p.a);

      if(p.life <= 0 || p.y > H + 80) particles.splice(i,1);
    }
    requestAnimationFrame(fxLoop);
  }
  fxLoop();

  // ================== Rotator (drag + inertia) ==================
  function makeRotator(wrap, obj){
    let dragging=false;
    let lastX=0, lastY=0;
    let rx=-12, ry=18;
    let vx=0, vy=0;
    let raf=0;

    const friction = 0.92;
    const speed = 0.18;

    function apply(){
      rx = clamp(rx, -38, 28);
      if (ry > 180) ry -= 360;
      if (ry < -180) ry += 360;
      obj.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
    }

    function tick(){
      if(!dragging){
        rx += vx; ry += vy;
        vx *= friction; vy *= friction;
        if(Math.abs(vx) < 0.01) vx = 0;
        if(Math.abs(vy) < 0.01) vy = 0;
        apply();
      }
      raf = requestAnimationFrame(tick);
    }
    raf = requestAnimationFrame(tick);

    function onDown(e){
      dragging=true;
      wrap.setPointerCapture?.(e.pointerId);
      lastX = e.clientX; lastY = e.clientY;
    }
    function onMove(e){
      if(!dragging) return;
      const dx = e.clientX - lastX;
      const dy = e.clientY - lastY;
      lastX = e.clientX; lastY = e.clientY;

      ry += dx * speed;
      rx -= dy * speed;

      vy = dx * speed * 0.35;
      vx = -dy * speed * 0.35;

      apply();
    }
    function onUp(e){
      dragging=false;
      wrap.releasePointerCapture?.(e.pointerId);
    }

    wrap.addEventListener("pointerdown", onDown);
    wrap.addEventListener("pointermove", onMove);
    wrap.addEventListener("pointerup", onUp);
    wrap.addEventListener("pointercancel", onUp);

    apply();

    return {
      destroy(){
        cancelAnimationFrame(raf);
        wrap.removeEventListener("pointerdown", onDown);
        wrap.removeEventListener("pointermove", onMove);
        wrap.removeEventListener("pointerup", onUp);
        wrap.removeEventListener("pointercancel", onUp);
      },
      setRotation(x,y){ rx=x; ry=y; apply(); },
      kick(){ vx += (Math.random()-0.5)*2.2; vy += (Math.random()-0.5)*2.2; }
    };
  }

  // ================== Wheels (vertical drum) ==================
  function createWheel(values, initialIndex=0){
    const wheel = document.createElement("div");
    wheel.className = "wheel";
    wheel.innerHTML = `<div class="selector"></div><div class="items"></div>`;
    const items = wheel.querySelector(".items");

    const itemEls = values.map(v => {
      const el = document.createElement("div");
      el.className = "item";
      el.textContent = v;
      items.appendChild(el);
      return el;
    });

    let idx = clamp(initialIndex, 0, values.length-1);
    const rowH = 42;
    let offset = 0;
    let dragging=false;
    let lastY=0;
    let vel=0;

    function update(){
      itemEls.forEach((el,i)=> el.classList.toggle("active", i === idx));
      items.style.transform = `translateY(${(-idx * rowH + offset)}px)`;
    }

    function snap(){
      const raw = idx - offset/rowH;
      idx = Math.round(raw);
      idx = (idx % values.length + values.length) % values.length;
      offset = 0;
      update();
    }

    function onDown(e){
      dragging=true;
      wheel.setPointerCapture?.(e.pointerId);
      lastY = e.clientY;
      vel = 0;
    }
    function onMove(e){
      if(!dragging) return;
      const dy = e.clientY - lastY;
      lastY = e.clientY;
      offset += dy;

      while(offset > rowH){
        offset -= rowH;
        idx = (idx - 1 + values.length) % values.length;
      }
      while(offset < -rowH){
        offset += rowH;
        idx = (idx + 1) % values.length;
      }
      vel = dy;
      update();
    }
    function onUp(e){
      dragging=false;
      wheel.releasePointerCapture?.(e.pointerId);
      offset += clamp(vel, -18, 18);
      snap();
      sfx.wheel();
    }

    wheel.addEventListener("pointerdown", onDown);
    wheel.addEventListener("pointermove", onMove);
    wheel.addEventListener("pointerup", onUp);
    wheel.addEventListener("pointercancel", onUp);

    update();

    return {
      el: wheel,
      getValue(){ return values[idx]; },
      getIndex(){ return idx; }
    };
  }

  // ================== Scene machine ==================
  let rotator = null;
  let scene = 0; // 0 courier, 1 box, 2 envelope, 3 finale
  let throwDisabled = false;

  function setControls(btns){
    controls.innerHTML = "";
    if(!btns || btns.length === 0){
      controls.hidden = true;
      return;
    }
    btns.forEach(b => controls.appendChild(b));
    controls.hidden = false;
  }

  function mount(node){
    main.innerHTML = "";
    main.appendChild(node);
    node.classList.add("fadeIn");
  }

  function openModal(title, subtitle, bodyNode){
    modalTitle.textContent = title;
    modalSubtitle.textContent = subtitle;
    modalBody.innerHTML = "";
    modalBody.appendChild(bodyNode);
    modalOverlay.classList.add("show");
    modalOverlay.setAttribute("aria-hidden", "false");
  }

  function closeModal(){
    modalOverlay.classList.remove("show");
    modalOverlay.setAttribute("aria-hidden", "true");
  }

  function getHintForScene(){
    if(scene === 0) return "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ª—É—á—à–µ –Ω–∞–∂–∞—Ç—å <b>¬´–î–∞¬ª</b>, –∏–Ω–∞—á–µ –ø–æ—Å—ã–ª–∫—É –Ω–µ –æ—Ç–¥–∞–º üôÇ";
    if(scene === 1) return "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞–∂–º–∏ –Ω–∞ <b>—Å–≤–µ—Ç—è—â–∏–π—Å—è –∑–∞–º–æ–∫</b> –Ω–∞ –∫–æ—Ä–æ–±–∫–µ ‚ú®";
    if(scene === 2) return "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –æ—Ç–∫—Ä–æ–π –∫–æ–Ω–≤–µ—Ä—Ç. –î–ª—è –ø–µ—á–∞—Ç–∏ –Ω—É–∂–Ω–∞ –¥–∞—Ç–∞ <b>01.02.2005</b> üòâ";
    if(scene === 3) return "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ª–∏—Å—Ç–∞–π —Ñ–æ—Ç–æ –∏ —á–∏—Ç–∞–π –∑–∞–ø–∏—Å–∫—É üíó";
    return "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –≤—Å—ë –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º üôÇ";
  }

  // ================== Scenes ==================
  async function sceneCourier(){
    scene = 0;
    finale.classList.remove("show");
    closeModal();
    setControls([]);
    throwDisabled = false;

    if(rotator){ rotator.destroy(); rotator = null; }
    main.innerHTML = "";
    clearChat();

    // start: open chat briefly so she notices
    openChat();
    await say("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ üëã –Ø–Ω–¥–µ–∫—Å-–∫—É—Ä—å–µ—Ä.", 520);
    await say("–£ –≤–∞—Å –ø–æ—Å—ã–ª–∫–∞ <b>–æ—Ç —Ñ–∞–Ω–∞—Ç–∞</b>.", 520);
    await say("–ù—É–∂–Ω–æ —Ä–∞—Å–ø–∏—Å–∞—Ç—å—Å—è. –î–∞–º –±—É–º–∞–∂–∫—É‚Ä¶", 520);

    const panel = document.createElement("div");
    panel.className = "panel";
    panel.innerHTML = `
      <h2>[–ø–æ–¥–ø–∏—Å—å_–ø–æ–ª—É—á–∞—Ç–µ–ª—è]</h2>
      <p>–í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ø–æ—Å—ã–ª–∫—É –æ—Ç —Ñ–∞–Ω–∞—Ç–∞?</p>
      <div class="row" id="r"></div>
    `;
    mount(panel);

    const row = panel.querySelector("#r");

    const yes = document.createElement("button");
    yes.className = "btn primary";
    yes.textContent = "‚úÖ –î–∞";

    const no = document.createElement("button");
    no.className = "btn";
    no.textContent = "‚ùå –ù–µ—Ç";

    no.onclick = async () => {
      sfx.click();
      panel.classList.add("shake");
      vibrate(40);
      await say("–í—ã —á—Ç–æ, –±–∞–ª–±–µ—Å? üòë", 420);
      await say("–õ–∞–¥–Ω–æ, –Ω–∞ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –ø—Ä–æ—â–∞—é. –ù–æ –∫–Ω–æ–ø–∫–∏ ¬´–ù–µ—Ç¬ª –±–æ–ª—å—à–µ –Ω–µ—Ç.", 520);
      row.innerHTML = "";
      row.appendChild(yes);
      // auto close chat so it doesn't block
      closeChat();
    };

    yes.onclick = async () => {
      sfx.click();
      await say("–ü–æ–¥–ø–∏—Å—å –ø–æ–ª—É—á–µ–Ω–∞ ‚úÖ", 420);
      await say("–î–µ—Ä–∂–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É. –û–Ω–∞ –¥–ª—è <b>–î–∂–∞–º—ã</b>.", 520);
      closeChat();
      sceneBox();
    };

    row.appendChild(yes);
    row.appendChild(no);
  }

  function sceneBox(){
    scene = 1;
    closeModal();
    finale.classList.remove("show");
    setControls([]);

    if(rotator){ rotator.destroy(); rotator = null; }

    const wrap = document.createElement("div");
    wrap.className = "objectWrap";

    const obj = document.createElement("div");
    obj.className = "object box";
    obj.innerHTML = `
      <div class="boxLabel">–¥–ª—è <span>${GIRL_NAME.toLowerCase()}</span></div>
      <div class="lock" id="lockBtn" title="–ù–∞–∂–º–∏">
        <div class="lockGlow"></div>
        <div class="lockIcon"></div>
      </div>
    `;
    wrap.appendChild(obj);
    mount(wrap);

    rotator = makeRotator(wrap, obj);

    // no extra UI buttons. Only chat hint.
    say("–ö–æ—Ä–æ–±–∫–∞ –Ω–∞ –º–µ—Å—Ç–µ. –ï—Å–ª–∏ —á—Ç–æ ‚Äî –Ω–∞–∂–º–∏ <b>?</b> –≤ —á–∞—Ç–µ üôÇ", 450);

    qs("#lockBtn", obj).onclick = async () => {
      sfx.click();
      await say("–û, –∑–∞–º–æ–∫. –î–∞–≤–∞–π –∫–æ–¥.", 360);
      openLockGame();
    };
  }

  function openLockGame(){
    const days = Array.from({length:31}, (_,i)=> i+1).map(String);
    const months = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
    const years = Array.from({length: 50}, (_,i)=> (2000+i)).map(String);

    const body = document.createElement("div");
    body.innerHTML = `
      <div class="badge">–∫–æ–¥ = –≤–∞–∂–Ω–∞—è –¥–∞—Ç–∞ üíó</div>
      <div class="wheels" id="w"></div>
      <div class="modalActions" id="a"></div>
    `;

    const w = body.querySelector("#w");
    const wDay = createWheel(days, BOX_CODE.day-1);
    const wMonth = createWheel(months, BOX_CODE.monthIndex-1);
    const wYear = createWheel(years, years.indexOf(String(BOX_CODE.year)));

    w.appendChild(wDay.el);
    w.appendChild(wMonth.el);
    w.appendChild(wYear.el);

    const actions = body.querySelector("#a");

    const back = document.createElement("button");
    back.className = "btn";
    back.textContent = "‚Üê –ù–∞–∑–∞–¥";
    back.onclick = () => { sfx.click(); closeModal(); };

    const ok = document.createElement("button");
    ok.className = "btn ok";
    ok.textContent = "–ì–æ—Ç–æ–≤–æ ‚úì";
    ok.onclick = async () => {
      sfx.click();
      const day = parseInt(wDay.getValue(),10);
      const month = wMonth.getIndex()+1;
      const year = parseInt(wYear.getValue(),10);

      if(day === BOX_CODE.day && month === BOX_CODE.monthIndex && year === BOX_CODE.year){
        sfx.ok();
        closeModal();
        await say("–ö–æ–¥ –ø–æ–¥–æ—à—ë–ª ‚úÖ –û—Ç–∫—Ä—ã–≤–∞—é‚Ä¶", 520);
        unlockBoxSequence();
      } else {
        sfx.bad();
        vibrate(60);
        showToast("–ù–µ-–∞. –ö–æ–¥ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç üòà");
        await say("–ù–µ —Ç–æ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë üòâ", 320);
        const lockEl = qs(".lock", main);
        lockEl?.classList.add("shake");
        setTimeout(()=> lockEl?.classList.remove("shake"), 220);
        rotator?.kick();
      }
    };

    actions.appendChild(back);
    actions.appendChild(ok);

    openModal("–ó–∞–º–æ–∫", "–î–µ–Ω—å / –º–µ—Å—è—Ü / –≥–æ–¥", body);
  }

  function unlockBoxSequence(){
    sfx.unlock();
    showToast("–©—ë–ª–∫! –ó–∞–º–æ–∫ –æ—Ç–∫—Ä—ã–ª—Å—è üòå");
    spawnHearts(50);

    const wrap = document.createElement("div");
    wrap.className = "objectWrap";

    const obj = document.createElement("div");
    obj.className = "object box";
    obj.innerHTML = `
      <div class="boxLabel">–æ—Ç–∫—Ä—ã—Ç–æ ‚úÖ</div>
      <div style="
        position:absolute; left:50%; top:46%;
        transform: translate(-50%,-50%) translateZ(18px);
        width: 260px; height: 160px; border-radius: 18px;
        background: rgba(0,0,0,.22);
        border: 1px solid rgba(255,255,255,.14);
        display:flex; align-items:center; justify-content:center;
        font-weight:950; letter-spacing:.3px;
        font-family: var(--mono);">
        <span style="background:linear-gradient(90deg, var(--pink2), var(--gold));
          -webkit-background-clip:text; background-clip:text; color:transparent;">
          –ø–æ—è–≤–∏–ª—Å—è –∫–æ–Ω–≤–µ—Ä—Ç üíå
        </span>
      </div>
    `;
    wrap.appendChild(obj);
    mount(wrap);

    if(rotator){ rotator.destroy(); }
    rotator = makeRotator(wrap, obj);
    rotator.setRotation(-10, 22);

    const next = document.createElement("button");
    next.className = "btn primary";
    next.textContent = "–í–∑—è—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç ‚Üí";
    next.onclick = async () => {
      sfx.click();
      await say("–ê–∫–∫—É—Ä–∞—Ç–Ω–æ. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∫–æ–Ω–≤–µ—Ä—Ç—É üôÇ", 420);
      sceneEnvelope();
    };

    setControls([next]);
  }

  function sceneEnvelope(){
    scene = 2;
    closeModal();
    setControls([]);
    throwDisabled = false;

    if(rotator){ rotator.destroy(); rotator = null; }

    const wrap = document.createElement("div");
    wrap.className = "objectWrap";

    const obj = document.createElement("div");
    obj.className = "object envelope";
    obj.innerHTML = `
      <div class="envTop"></div>
      <div class="seal"><span>‚ù§</span></div>
    `;
    wrap.appendChild(obj);
    mount(wrap);

    rotator = makeRotator(wrap, obj);
    rotator.setRotation(-14, 16);

    const throwBtn = document.createElement("button");
    throwBtn.className = "btn danger";
    throwBtn.textContent = "üóëÔ∏è –í—ã–±—Ä–æ—Å–∏—Ç—å";

    const openBtn = document.createElement("button");
    openBtn.className = "btn primary";
    openBtn.textContent = "üíå –û—Ç–∫—Ä—ã—Ç—å";

    throwBtn.onclick = async () => {
      if(throwDisabled) return;
      throwDisabled = true;
      sfx.bad();
      vibrate(70);
      obj.classList.add("shake");
      showToast("–©–∞—Å –ø–æ —à–µ–µ –ø–æ–ª—É—á–∏—à—å");
      await say("–ù–µ-–Ω–µ-–Ω–µ üòê –í—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –Ω–µ–ª—å–∑—è.", 420);
      setTimeout(()=> obj.classList.remove("shake"), 240);

      // open replaces throw
      openBtn.animate([{transform:"translateX(0)"},{transform:"translateX(-6px)"}], {duration:260, easing:"cubic-bezier(.2,.8,.2,1)"});
      throwBtn.animate([{opacity:1, transform:"translateX(0)"},{opacity:0, transform:"translateX(14px)"}], {duration:260, easing:"cubic-bezier(.2,.8,.2,1)"})
        .onfinish = () => setControls([openBtn]);
    };

    openBtn.onclick = async () => {
      sfx.click();
      await say("–û—Ç–∫—Ä—ã—Ç—å? –¢–æ–≥–¥–∞ —Å–Ω–∞—á–∞–ª–∞ ‚Äî –¥–∞—Ç–∞ —Ñ–∞–Ω–∞—Ç–∞ üòâ", 450);
      openSealPrompt(obj);
    };

    setControls([throwBtn, openBtn]);
  }

  function openSealPrompt(envelopeEl){
    const body = document.createElement("div");
    body.innerHTML = `
      <div class="badge">–ø–µ—á–∞—Ç—å –¥–µ—Ä–∂–∏—Ç –∫–æ–Ω–≤–µ—Ä—Ç</div>
      <div class="datePrompt">
        <div style="color:var(--muted); font-size:12px; line-height:1.35; font-family: var(--mono);">
          –í–≤–µ–¥–∏—Ç–µ <b>–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ñ–∞–Ω–∞—Ç–∞</b> (–¥–¥.–º–º.–≥–≥–≥–≥)
        </div>
        <div class="field">
          <input id="dateIn" type="text" inputmode="numeric" placeholder="01.02.2005" maxlength="10" />
          <button class="btn ok" id="checkBtn">‚úì</button>
        </div>
        <div class="modalActions">
          <button class="btn" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
      </div>
    `;

    openModal("–ü–µ—á–∞—Ç—å", "–ë–µ–∑ –¥–∞—Ç—ã –Ω–µ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è üôÇ", body);

    const dateIn = body.querySelector("#dateIn");
    const checkBtn = body.querySelector("#checkBtn");
    const backBtn = body.querySelector("#backBtn");

    dateIn.addEventListener("input", () => {
      let v = dateIn.value.replace(/[^\d]/g,"").slice(0,8);
      if(v.length >= 3) v = v.slice(0,2) + "." + v.slice(2);
      if(v.length >= 6) v = v.slice(0,5) + "." + v.slice(5);
      dateIn.value = v;
    });

    backBtn.onclick = () => { sfx.click(); closeModal(); };

    checkBtn.onclick = async () => {
      sfx.click();
      const v = dateIn.value.trim();
      const m = v.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
      if(!m){
        sfx.bad();
        vibrate(40);
        showToast("–§–æ—Ä–º–∞—Ç: 01.02.2005");
        await say("–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: <b>–¥–¥.–º–º.–≥–≥–≥–≥</b>", 320);
        return;
      }
      const d = parseInt(m[1],10), mo = parseInt(m[2],10), y = parseInt(m[3],10);

      if(d === FAN_BDAY.d && mo === FAN_BDAY.m && y === FAN_BDAY.y){
        sfx.ok();
        closeModal();
        await say("–û–≥–æ‚Ä¶ –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚úÖ", 380);
        sealOffAndOpen(envelopeEl);
      } else {
        sfx.bad();
        vibrate(70);
        showToast("–ù–µ —Ç–æ üôÇ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑");
        await say("–ù–µ–∞. –ù–æ —Ç—ã –±–ª–∏–∑–∫–æ üòè", 320);
        envelopeEl.classList.add("shake");
        setTimeout(()=> envelopeEl.classList.remove("shake"), 220);
        rotator?.kick();
      }
    };

    setTimeout(()=> dateIn.focus(), 60);
  }

  function sealOffAndOpen(envelopeEl){
    sfx.unlock();
    showToast("–ü–µ—á–∞—Ç—å –æ—Ç–ø–∞–ª–∞‚Ä¶ üíó");
    spawnHearts(70);

    const seal = envelopeEl.querySelector(".seal");
    if(seal){
      seal.animate([
        { transform: "translate(-50%,-50%) translateZ(20px) scale(1)", opacity: 1 },
        { transform: "translate(-50%,-65%) translateZ(20px) scale(.88)", opacity: .9 },
        { transform: "translate(-50%,-85%) translateZ(20px) scale(.7)", opacity: 0 }
      ], { duration: 520, easing: "cubic-bezier(.2,.8,.2,1)" }).onfinish = () => {
        seal.remove();
        spawnHearts(140);
        setTimeout(()=> spawnHearts(95), 220);
        setTimeout(showFinale, 520);
      };
    } else {
      setTimeout(showFinale, 520);
    }
  }

  // ================== Finale ==================
  let photoIndex = 0;
  let photoTimer = null;

  function showFinale(){
    scene = 3;
    main.innerHTML = "";
    setControls([]);
    finale.classList.add("show");

    photoRail.innerHTML = "";
    photoDots.innerHTML = "";

    const files = PHOTO_FILES.slice(0,4);
    const good = [];
    let pending = files.length;

    function finish(){
      pending--;
      if(pending > 0) return;

      if(good.length === 0){
        const ph = document.createElement("div");
        ph.style.cssText =
          "width:100%;height:100%;display:grid;place-items:center;color:rgba(255,255,255,.75);font-family:var(--mono);";
        ph.textContent = "–î–æ–±–∞–≤—å —Ñ–æ—Ç–æ –≤ –ø–∞–ø–∫—É Images üôÇ";
        photoRail.appendChild(ph);
      } else {
        good.forEach((src) => {
          const img = new Image();
          img.src = src;
          img.alt = "photo";
          photoRail.appendChild(img);
        });

        good.forEach((_,i)=>{
          const b = document.createElement("button");
          b.onclick = () => { setPhoto(i, true); sfx.click(); };
          photoDots.appendChild(b);
        });

        setPhoto(0, false);
        clearInterval(photoTimer);
        photoTimer = setInterval(() => setPhoto((photoIndex+1) % good.length, false), 3300);
      }

      spawnHearts(160);
      sfx.ok();
      showToast("–° –¥–Ω—ë–º –≤–ª—é–±–ª—ë–Ω–Ω—ã—Ö üíó");
      say("–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ. –°—á–∞—Å—Ç—å—è –≤–∞–º –¥–≤–æ–∏–º üôÇ", 520);
    }

    if(files.length === 0){
      pending = 1;
      finish();
      return;
    }

    files.forEach(src=>{
      const img = new Image();
      img.onload = () => { good.push(src); finish(); };
      img.onerror = () => { finish(); };
      img.src = src;
    });
  }

  function setPhoto(i, manual){
    photoIndex = i;
    photoRail.style.transform = `translateX(${-i * 100}%)`;
    Array.from(photoDots.children).forEach((d,idx)=> d.classList.toggle("active", idx===i));
    if(manual){
      clearInterval(photoTimer);
      photoTimer = null;
    }
  }

  // ================== Boot ==================
  // polite click fallback
  document.addEventListener("click", (e)=>{
    if(e.target.closest("button")) sfx.click();
  }, {passive:true});

  // start with chat closed but badge will appear on first messages if user doesn't open it
  closeChat();
  setUnread(0);

  // auto: first scene
  sceneCourier();
})();
</script>
</body>
</html>
