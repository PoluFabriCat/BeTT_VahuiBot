<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, viewport-fit=cover, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ –¥–ª—è –î–∂–∞–º—ã</title>
  <style>
    /* =========================================================
       One-file SPA for Telegram WebView (mobile first)
       - No glassmorphism / no 3D
       - GPU-friendly: transform/opacity only
       - Lightweight particles + cute TV/pixel vibe
       ========================================================= */

    :root{
      --bg:#0a0b10;
      --bg2:#0f1320;

      --paper:#14182a;
      --paper2:#101325;

      --ink:#f2f3f8;
      --muted:rgba(242,243,248,.72);
      --muted2:rgba(242,243,248,.52);

      --line:rgba(242,243,248,.12);

      --pink:#ff4f9a;
      --pink2:#ff9bc8;
      --mint:#35f0c0;
      --amber:#ffd37a;
      --red:#ff6b6b;

      --shadow:rgba(0,0,0,.35);

      --r12:12px;
      --r16:16px;
      --r20:20px;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bot: env(safe-area-inset-bottom, 0px);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(255,79,154,.18), transparent 60%),
        radial-gradient(900px 700px at 110% 40%, rgba(125,150,255,.16), transparent 62%),
        radial-gradient(900px 800px at 0% 110%, rgba(53,240,192,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--ink);
      overflow:hidden;
      user-select:none;
      touch-action:none;
    }

    /* Root */
    .app{
      position:fixed; inset:0;
      display:flex;
      flex-direction:column;
      padding: calc(12px + var(--safe-top)) 12px calc(12px + var(--safe-bot));
      gap: 10px;
      opacity:0;
    }

    /* Top bar */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .tag{
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(20,24,42,.86);
      border:1px solid var(--line);
      box-shadow: 0 16px 40px rgba(0,0,0,.18);
      transform: translateZ(0);
    }
    .tag .pip{
      width:10px;height:10px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff, var(--pink));
    }
    .tag small{
      color: var(--muted);
      letter-spacing:.2px;
      font-weight: 650;
    }

    .audioBtn{
      pointer-events:auto;
      appearance:none;
      border:1px solid var(--line);
      background: rgba(20,24,42,.86);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 750;
      letter-spacing:.2px;
      cursor:pointer;
      transform: translateZ(0);
      transition: transform 120ms ease, opacity 180ms ease;
      touch-action: manipulation;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    .audioBtn:active{ transform: translate3d(0,1px,0) scale(.98); }
    .audioBtn b{ color: var(--pink2); }

    /* Stage */
    .stage{
      position:relative;
      flex:1;
      min-height:0;
      overflow:hidden;
      border-radius: var(--r20);
      background:
        linear-gradient(180deg, rgba(20,24,42,.92), rgba(16,19,37,.92));
      border:1px solid var(--line);
      box-shadow: 0 30px 90px rgba(0,0,0,.22);
      transform: translateZ(0);
    }

    /* Cute TV / pixel vibe */
    .tv{
      pointer-events:none;
      position:absolute; inset:0;
      opacity:.55;
      mix-blend-mode: overlay;
      transform: translateZ(0);
    }
    .tv:before{
      content:"";
      position:absolute; inset:0;
      /* soft scanlines */
      background: repeating-linear-gradient(
        0deg,
        rgba(255,255,255,.05) 0px,
        rgba(255,255,255,.05) 1px,
        rgba(255,255,255,0) 4px,
        rgba(255,255,255,0) 8px
      );
      opacity:.18;
    }
    .tv:after{
      content:"";
      position:absolute; inset:0;
      /* tiny pixel grid */
      background-image:
        linear-gradient(90deg, rgba(255,255,255,.04) 1px, transparent 1px),
        linear-gradient(0deg,  rgba(255,255,255,.04) 1px, transparent 1px);
      background-size: 7px 7px, 7px 7px;
      opacity:.10;
    }

    canvas#particles{
      position:absolute; inset:0;
      pointer-events:none;
      transform: translateZ(0);
    }

    /* Scenes */
    .scene{
      position:absolute; inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 12px;
      padding: 16px;
      opacity:0;
      transform: translate3d(0,10px,0);
      transition: opacity 340ms ease, transform 340ms ease;
      will-change: opacity, transform;
    }
    .scene.active{
      opacity:1;
      transform: translate3d(0,0,0);
    }
    .scene.hidden{ pointer-events:none; }

    /* Panels (flat, not glass) */
    .panel{
      width: min(540px, 94vw);
      border-radius: var(--r20);
      background:
        linear-gradient(180deg, rgba(20,24,42,.96), rgba(16,19,37,.96));
      border: 1px solid var(--line);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      padding: 14px;
      transform: translateZ(0);
    }

    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .title{ font-size: 18px; font-weight: 900; letter-spacing:.2px; }
    .sub{ margin-top:6px; color: var(--muted); font-size: 14px; line-height:1.35; }

    /* Speech */
    .speech{ display:flex; gap: 12px; align-items:flex-start; }
    .sprite{
      width: 56px; height: 56px;
      border-radius: var(--r16);
      background:
        linear-gradient(180deg, rgba(255,79,154,.18), rgba(255,255,255,0)),
        rgba(255,255,255,.03);
      border:1px solid var(--line);
      position:relative;
      overflow:hidden;
      flex:none;
    }
    .sprite:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 50% 36%, rgba(242,243,248,.9) 0 10px, transparent 11px),
        radial-gradient(circle at 50% 70%, rgba(242,243,248,.9) 0 16px, transparent 17px),
        radial-gradient(circle at 38% 36%, rgba(0,0,0,.24) 0 2px, transparent 3px),
        radial-gradient(circle at 62% 36%, rgba(0,0,0,.24) 0 2px, transparent 3px);
      opacity:.55;
    }
    .bubble{
      flex:1;
      border-radius: var(--r20);
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      padding: 12px 12px;
      line-height:1.35;
      font-size: 15px;
    }
    .bubble .name{ color: var(--pink2); font-weight: 950; letter-spacing:.2px; }

    /* Buttons */
    .btns{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--ink);
      padding: 12px 14px;
      border-radius: var(--r16);
      font-weight: 850;
      letter-spacing:.15px;
      min-width: 96px;
      cursor:pointer;
      transform: translateZ(0);
      transition: transform 120ms ease, opacity 200ms ease, background 120ms ease, border-color 120ms ease;
      touch-action: manipulation;
    }
    .btn:active{ transform: translate3d(0,1px,0) scale(.98); }
    .btn.primary{
      background: rgba(255,79,154,.14);
      border-color: rgba(255,79,154,.30);
    }
    .btn.ghost{ color: var(--muted); }
    .btn.danger{
      background: rgba(255,107,107,.12);
      border-color: rgba(255,107,107,.28);
    }
    .btn.icon{
      min-width:0;
      width:48px;
      padding: 12px 0;
    }

    /* Sheet */
    .sheet{
      width:min(540px, 94vw);
      border-radius: var(--r20);
      border:1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(20,24,42,.96), rgba(16,19,37,.96));
      box-shadow: 0 18px 70px rgba(0,0,0,.28);
      padding: 14px;
      opacity:0;
      transform: translate3d(0,10px,0);
      transition: opacity 240ms ease, transform 240ms ease;
    }
    .sheet.show{ opacity:1; transform: translate3d(0,0,0); }
    .sheet h3{ margin:0; font-size: 16px; font-weight: 950; letter-spacing:.2px; }
    .sheet p{ margin:8px 0 0; color: var(--muted); font-size: 14px; line-height:1.35; }

    /* Object area (2D rotation) */
    .objectArea{
      width:min(620px, 96vw);
      height: min(52vh, 520px);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }

    .hint{
      color: var(--muted2);
      font-size: 13px;
      text-align:center;
      line-height:1.3;
      width:min(560px, 94vw);
    }

    .sticker{
      width: min(340px, 82vw);
      height: min(250px, 60vw);
      position:relative;
      transform: translateZ(0);
      will-change: transform;
      touch-action:none;
    }

    /* Box (flat cute) */
    .box{
      position:absolute; inset:0;
      border-radius: 26px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.14));
      border:1px solid var(--line);
      box-shadow: 0 26px 70px rgba(0,0,0,.26);
      overflow:hidden;
    }
    .box:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 20% 15%, rgba(255,79,154,.18), transparent 55%),
        radial-gradient(circle at 80% 35%, rgba(255,155,200,.10), transparent 60%),
        radial-gradient(circle at 30% 90%, rgba(53,240,192,.08), transparent 55%);
      opacity:1;
    }
    .ribbon{
      position:absolute; left:0; right:0; top: 46%;
      height: 34px;
      transform: translateY(-50%);
      background: rgba(255,79,154,.22);
      border-top:1px solid rgba(255,79,154,.22);
      border-bottom:1px solid rgba(255,79,154,.22);
    }
    .label{
      position:absolute;
      left:14px; right:14px; top: 14px;
      padding: 10px 12px;
      border-radius: var(--r16);
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      font-weight: 950;
      letter-spacing:.2px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .label .to{ color: var(--pink2); }

    .lock{
      position:absolute;
      left:50%; top: 64%;
      transform: translate(-50%,-50%);
      width: 92px; height: 64px;
      border-radius: 18px;
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      will-change: transform, opacity;
    }
    .lock:before{
      content:"";
      position:absolute;
      top: -16px; left:50%;
      transform: translateX(-50%);
      width: 46px; height: 30px;
      border: 3px solid rgba(242,243,248,.60);
      border-bottom:none;
      border-radius: 20px 20px 0 0;
      opacity:.9;
    }
    .lock i{
      width: 34px; height: 26px;
      border-radius: 10px;
      background: rgba(242,243,248,.10);
      border:1px solid rgba(242,243,248,.16);
      display:block;
    }
    .lock.pulse{ animation: pulse 1.2s ease-in-out infinite; }
    @keyframes pulse{
      0%,100%{ transform: translate(-50%,-50%) scale(1); }
      50%{ transform: translate(-50%,-50%) scale(1.06); }
    }

    /* Envelope (flat cute) */
    .env{
      position:absolute; inset:0;
      border-radius: 26px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.14));
      border:1px solid var(--line);
      box-shadow: 0 26px 70px rgba(0,0,0,.26);
      overflow:hidden;
    }
    .env:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 18% 18%, rgba(255,79,154,.16), transparent 60%),
        radial-gradient(circle at 80% 30%, rgba(125,150,255,.14), transparent 58%);
    }
    .flap{
      position:absolute; inset:0;
      clip-path: polygon(0 0, 100% 0, 50% 58%);
      background: rgba(0,0,0,.22);
      border-bottom:1px solid rgba(242,243,248,.08);
      opacity:.8;
    }
    .seal{
      position:absolute;
      left:50%; top: 62%;
      transform: translate(-50%,-50%);
      width: 84px; height: 84px;
      border-radius: 999px;
      background: rgba(255,79,154,.18);
      border:1px solid rgba(255,79,154,.30);
      box-shadow: 0 18px 55px rgba(0,0,0,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      letter-spacing:.4px;
      color: rgba(242,243,248,.90);
    }
    .seal span{
      width: 44px; height: 44px;
      border-radius: 999px;
      border:1px dashed rgba(242,243,248,.26);
      display:flex; align-items:center; justify-content:center;
      font-size: 18px;
      background: rgba(0,0,0,.16);
    }

    /* Overlay modal */
    .overlay{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 16px;
      opacity:0;
      pointer-events:none;
      transition: opacity 220ms ease;
      will-change: opacity;
    }
    .overlay.show{
      opacity:1;
      pointer-events:auto;
    }
    .modal{
      width: min(540px, 94vw);
      border-radius: var(--r20);
      border:1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(20,24,42,.96), rgba(16,19,37,.96));
      box-shadow: 0 26px 90px rgba(0,0,0,.34);
      padding: 14px;
      transform: translate3d(0,10px,0);
      transition: transform 220ms ease;
      will-change: transform;
    }
    .overlay.show .modal{ transform: translate3d(0,0,0); }
    .modal h3{ margin:0; font-size: 16px; font-weight: 950; letter-spacing:.2px; }
    .modal .sub{ margin-top:6px; color: var(--muted); font-size: 13.5px; line-height:1.35; }

    /* Wheels */
    .wheels{
      margin-top: 12px;
      display:flex;
      gap:10px;
      justify-content:space-between;
    }
    .wheel{
      flex:1;
      height: 146px;
      border-radius: var(--r16);
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
      touch-action:none;
      transform: translateZ(0);
    }
    .wheel .center{
      position:absolute;
      left:10px; right:10px;
      top:50%;
      height: 42px;
      transform: translateY(-50%);
      border-radius: 12px;
      border:1px solid rgba(242,243,248,.10);
      background: rgba(242,243,248,.05);
      pointer-events:none;
    }
    .wheel .list{
      position:absolute;
      left:0; right:0;
      top:50%;
      transform: translate3d(0,-50%,0);
      will-change: transform;
    }
    .wheel .item{
      height: 42px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      letter-spacing:.2px;
      color: rgba(242,243,248,.85);
      opacity:.40;
    }
    .wheel .item.active{ opacity:1; }
    .wheel .cap{
      position:absolute;
      left:10px; right:10px; bottom:10px;
      color: rgba(242,243,248,.45);
      font-size: 11.5px;
      text-align:center;
      pointer-events:none;
    }

    /* Date input */
    .dateRow{
      display:flex;
      gap:10px;
      margin-top: 12px;
      align-items:center;
    }
    .input{
      flex:1;
      border-radius: var(--r16);
      padding: 12px 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--ink);
      font-weight: 900;
      letter-spacing:.2px;
      outline:none;
      transform: translateZ(0);
    }
    .input::placeholder{ color: rgba(242,243,248,.42); font-weight: 800; }

    /* Toast */
    .toast{
      position:absolute;
      left:50%;
      bottom: 16px;
      transform: translate3d(-50%, 18px,0);
      opacity:0;
      pointer-events:none;
      transition: opacity 220ms ease, transform 220ms ease;
      will-change: transform, opacity;
      padding: 12px 14px;
      border-radius: var(--r16);
      border:1px solid var(--line);
      background: rgba(0,0,0,.40);
      color: rgba(242,243,248,.92);
      box-shadow: 0 18px 60px rgba(0,0,0,.30);
      max-width: 92vw;
      text-align:center;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .toast.show{ opacity:1; transform: translate3d(-50%, 0,0); }

    /* Shake */
    .shake{ animation: shake 420ms ease; }
    @keyframes shake{
      0%{ transform: translate3d(0,0,0); }
      20%{ transform: translate3d(-6px,0,0); }
      40%{ transform: translate3d(6px,0,0); }
      60%{ transform: translate3d(-4px,0,0); }
      80%{ transform: translate3d(4px,0,0); }
      100%{ transform: translate3d(0,0,0); }
    }

    /* Photos */
    .photoWrap{
      width:min(540px, 94vw);
      border-radius: var(--r20);
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      position:relative;
      transform: translateZ(0);
      display:none;
    }
    .photo{
      width:100%;
      height: min(46vh, 360px);
      display:block;
      object-fit: cover;
      opacity:0;
      transform: scale(1.02);
      transition: opacity 380ms ease, transform 380ms ease;
      will-change: opacity, transform;
    }
    .photo.show{ opacity:1; transform: scale(1); }
    .photoOverlay{
      position:absolute; inset:0;
      background: radial-gradient(circle at 50% 18%, rgba(255,255,255,.10), transparent 60%),
                  linear-gradient(180deg, transparent 60%, rgba(0,0,0,.55));
      pointer-events:none;
    }
    .photoCaption{
      position:absolute; left:14px; right:14px; bottom:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(242,243,248,.82);
      font-size: 12.5px;
      font-weight: 850;
    }
    .dots{ display:flex; gap:6px; align-items:center; }
    .dots i{
      width:8px; height:8px; border-radius:50%;
      border:1px solid rgba(242,243,248,.22);
      background: rgba(242,243,248,.06);
      opacity:.75;
    }
    .dots i.on{
      background: radial-gradient(circle at 30% 30%, #fff, var(--pink));
      border-color: rgba(255,79,154,.35);
      opacity:1;
    }

    /* Paper letter */
    .paper{
      width:min(540px, 94vw);
      border-radius: var(--r20);
      border:1px solid var(--line);
      background:
        repeating-linear-gradient(0deg,
          rgba(242,243,248,.05) 0px,
          rgba(242,243,248,.05) 1px,
          rgba(242,243,248,0) 10px,
          rgba(242,243,248,0) 22px),
        rgba(0,0,0,.14);
      padding: 14px;
      box-shadow: 0 20px 80px rgba(0,0,0,.30);
      transform: translate3d(0,18px,0);
      opacity:0;
      transition: transform 380ms ease, opacity 380ms ease;
      will-change: transform, opacity;
      display:none;
    }
    .paper.show{ transform: translate3d(0,0,0); opacity:1; }
    .paper .lines{
      color: rgba(242,243,248,.86);
      font-size: 14px;
      line-height: 1.55;
      white-space: pre-line;
      letter-spacing:.15px;
      font-weight: 650;
    }
    .paper .sig{
      margin-top: 10px;
      color: rgba(242,243,248,.70);
      font-size: 12.5px;
      display:flex;
      justify-content:flex-end;
      font-weight: 850;
    }

    /* Loader */
    .loader{
      position:fixed; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(900px 700px at 20% 0%, rgba(255,79,154,.20), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      z-index: 50;
    }
    .loaderCard{
      width:min(460px, 92vw);
      border-radius: var(--r20);
      border:1px solid var(--line);
      background: rgba(20,24,42,.96);
      box-shadow: 0 26px 120px rgba(0,0,0,.32);
      padding: 14px;
    }
    .loaderTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .loaderTitle{
      font-weight: 1000;
      letter-spacing:.2px;
      font-size: 15px;
    }
    .loaderMsg{
      margin-top:8px;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
    }
    .bar{
      margin-top: 12px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,79,154,.0), rgba(255,79,154,.60), rgba(255,255,255,.18));
      transform: translateZ(0);
      transition: width 180ms ease;
      will-change: width;
    }
    .smallRow{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: rgba(242,243,248,.65);
      font-size: 12.5px;
      font-weight: 850;
    }
    .dotsAnim{
      display:inline-flex;
      gap:4px;
      align-items:center;
    }
    .dotsAnim i{
      width:6px; height:6px; border-radius:50%;
      background: rgba(242,243,248,.55);
      opacity:.25;
      animation: d 1.1s ease-in-out infinite;
    }
    .dotsAnim i:nth-child(2){ animation-delay: .12s; }
    .dotsAnim i:nth-child(3){ animation-delay: .24s; }
    @keyframes d{
      0%,100%{ opacity:.25; transform: translate3d(0,0,0); }
      50%{ opacity:.92; transform: translate3d(0,-2px,0); }
    }

    @media (max-width: 360px){
      .btn{ min-width: 86px; padding: 11px 12px; }
      .bubble{ font-size: 14px; }
      .title{ font-size: 17px; }
    }

    @media (prefers-reduced-motion: reduce){
      .scene,.sheet,.overlay,.photo,.paper{ transition:none !important; }
      .lock.pulse{ animation:none !important; }
      .dotsAnim i{ animation:none !important; }
    }
  </style>
</head>
<body>
  <!-- LOADER -->
  <div class="loader" id="loader">
    <div class="loaderCard">
      <div class="loaderTop">
        <div class="loaderTitle">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞–ª–µ–Ω—Ç–∏–Ω–∫–∏‚Ä¶</div>
        <div class="dotsAnim" aria-hidden="true"><i></i><i></i><i></i></div>
      </div>
      <div class="loaderMsg" id="loaderMsg">–ì–æ—Ç–æ–≤–ª—é —Ñ–æ—Ç–æ –∏ –º—É–∑—ã–∫—É.</div>
      <div class="bar"><i id="barFill"></i></div>
      <div class="smallRow">
        <span id="progressText">0%</span>
        <span id="assetText">assets‚Ä¶</span>
      </div>
    </div>
  </div>

  <div class="app" id="app">
    <div class="top">
      <div class="tag"><span class="pip"></span><small id="hudText">–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ ‚Ä¢ –¥–ª—è –î–∂–∞–º—ã</small></div>
      <button class="audioBtn" id="audioBtn" type="button" aria-label="–í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É">
        <span id="audioIcon">üîá</span>
        <span><b>–ú—É–∑—ã–∫–∞</b> <span id="audioLabel">–≤—ã–∫–ª</span></span>
      </button>
    </div>

    <div class="stage" id="stage">
      <div class="tv" aria-hidden="true"></div>
      <canvas id="particles"></canvas>

      <div class="toast" id="toast"></div>

      <!-- Scene 1 -->
      <section class="scene active" id="scene1" aria-label="–°—Ü–µ–Ω–∞ 1: –ö—É—Ä—å–µ—Ä">
        <div class="panel">
          <div class="speech">
            <div class="sprite" aria-hidden="true"></div>
            <div class="bubble">
              <div><span class="name">–ö—É—Ä—å–µ—Ä:</span> <span id="courierLine">–í–∞–º –ø–æ—Å—ã–ª–∫–∞ –æ—Ç —Ñ–∞–Ω–∞—Ç–∞ üòâ</span></div>
              <div class="sub">–ü–æ–¥–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞. –§–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç—å, –Ω–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω–∞—è.</div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="sheet" id="signSheet" role="dialog" aria-modal="true">
            <h3>–í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ø–æ—Å—ã–ª–∫—É –æ—Ç —Ñ–∞–Ω–∞—Ç–∞?</h3>
            <p>–û–¥–∏–Ω –∫–ª–∏–∫ ‚Äî –∏ –≤—Å—ë –ø–æ–π–¥—ë—Ç –ø–æ –∫—Ä–∞—Å–∏–≤–æ–º—É —Å—Ü–µ–Ω–∞—Ä–∏—é.</p>
            <div class="btns" id="signBtns">
              <button class="btn ghost" id="btnNo" type="button">–ù–µ—Ç</button>
              <button class="btn primary" id="btnYes" type="button">–î–∞</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Scene 2 -->
      <section class="scene hidden" id="scene2" aria-label="–°—Ü–µ–Ω–∞ 2: –ü–æ—Å—ã–ª–∫–∞">
        <div class="panel">
          <div class="row">
            <div>
              <div class="title">–ü–æ—Å—ã–ª–∫–∞</div>
              <div class="sub">–ü–æ–≤–µ—Ä–Ω–∏ –ø–∞–ª—å—Ü–µ–º. –ù–∞–∂–º–∏ –Ω–∞ –∑–∞–º–æ–∫.</div>
            </div>
          </div>
        </div>

        <div class="objectArea">
          <div class="sticker" id="boxSticker" aria-label="–ö–æ—Ä–æ–±–∫–∞ (–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–∞–ª—å—Ü–µ–º)">
            <div class="box">
              <div class="label">
                <span>–¥–ª—è <span class="to">–î–∂–∞–º—ã</span></span>
                <span style="color:rgba(242,243,248,.60); font-weight:950;">‚ô•</span>
              </div>
              <div class="ribbon"></div>
              <button class="lock pulse" id="lockBtn" type="button" aria-label="–ó–∞–º–æ–∫">
                <i></i>
              </button>
            </div>
          </div>
        </div>

        <div class="hint">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π, —á—Ç–æ–±—ã –∫—Ä—É—Ç–∏—Ç—å (–∏–Ω–µ—Ä—Ü–∏—è + –¥–µ–º–ø—Ñ–∏—Ä–æ–≤–∞–Ω–∏–µ). –°–∫–æ—Ä–æ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞.</div>

        <div class="overlay" id="lockOverlay" aria-hidden="true">
          <div class="modal">
            <h3>–ö–æ–¥–æ–≤—ã–π –∑–∞–º–æ–∫</h3>
            <div class="sub">–ü—Ä–æ–∫—Ä—É—Ç–∏ –∫–æ–ª—ë—Å–∏–∫–∏ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑: –¥–µ–Ω—å ‚Ä¢ –º–µ—Å—è—Ü ‚Ä¢ –≥–æ–¥</div>

            <div class="wheels">
              <div class="wheel" data-wheel="day" aria-label="–î–µ–Ω—å">
                <div class="center"></div>
                <div class="list"></div>
                <div class="cap">–¥–µ–Ω—å</div>
              </div>
              <div class="wheel" data-wheel="month" aria-label="–ú–µ—Å—è—Ü">
                <div class="center"></div>
                <div class="list"></div>
                <div class="cap">–º–µ—Å—è—Ü</div>
              </div>
              <div class="wheel" data-wheel="year" aria-label="–ì–æ–¥">
                <div class="center"></div>
                <div class="list"></div>
                <div class="cap">–≥–æ–¥</div>
              </div>
            </div>

            <div class="btns" style="justify-content:space-between;">
              <button class="btn ghost" id="lockBack" type="button">–ù–∞–∑–∞–¥</button>
              <button class="btn primary" id="lockDone" type="button">–ì–æ—Ç–æ–≤–æ</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Scene 3 -->
      <section class="scene hidden" id="scene3" aria-label="–°—Ü–µ–Ω–∞ 3: –ö–æ–Ω–≤–µ—Ä—Ç">
        <div class="panel" id="scene3Panel">
          <div class="row">
            <div>
              <div class="title">–ö–æ–Ω–≤–µ—Ä—Ç</div>
              <div class="sub">–ö—Ä—É—Ç–∏—Ç—Å—è –ø–∞–ª—å—Ü–µ–º. –î–∞–ª—å—à–µ ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Å—Ç–Ω–æ.</div>
            </div>
          </div>
          <div class="btns" id="envBtns">
            <button class="btn danger" id="btnThrow" type="button">–í—ã–±—Ä–æ—Å–∏—Ç—å</button>
            <button class="btn primary" id="btnOpen" type="button">–û—Ç–∫—Ä—ã—Ç—å</button>
          </div>
        </div>

        <div class="objectArea">
          <div class="sticker" id="envSticker" aria-label="–ö–æ–Ω–≤–µ—Ä—Ç (–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–∞–ª—å—Ü–µ–º)">
            <div class="env">
              <div class="flap"></div>
              <div class="seal" id="seal"><span>J</span></div>
            </div>
          </div>
        </div>

        <div class="overlay" id="sealOverlay" aria-hidden="true">
          <div class="modal" id="sealModal">
            <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥</h3>
            <div class="sub">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ñ–∞–Ω–∞—Ç–∞ (—Ñ–æ—Ä–º–∞—Ç: –î–î.–ú–ú.–ì–ì–ì–ì)</div>

            <div class="dateRow">
              <input class="input" id="bdayInput" inputmode="numeric" placeholder="01.02.2005" maxlength="10" />
              <button class="btn primary icon" id="bdayOk" type="button" aria-label="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å">‚úì</button>
            </div>
            <div class="sub" id="bdayHint" style="margin-top:10px; opacity:.9;">
              –ü–æ–¥—Å–∫–∞–∑–∫–∞: —ç—Ç–æ –Ω–∞—á–∞–ª–æ —Ñ–µ–≤—Ä–∞–ª—è.
            </div>

            <div class="btns" style="justify-content:flex-start;">
              <button class="btn ghost" id="sealBack" type="button">–ù–∞–∑–∞–¥</button>
            </div>
          </div>
        </div>

        <div class="panel" id="finalPanel" style="display:none;">
          <div class="title">–û—Ç–∫—Ä—ã–ª–æ—Å—å</div>
          <div class="sub">–¢–µ–ø–µ—Ä—å ‚Äî —Ñ–æ—Ç–æ, –ø–æ—Ç–æ–º –ø–∏—Å—å–º–æ. –í—Å—ë —Å–ø–æ–∫–æ–π–Ω–æ –∏ –∫—Ä–∞—Å–∏–≤–æ.</div>
        </div>

        <div class="photoWrap" id="photoWrap">
          <img class="photo" id="photoEl" alt="–ù–∞—à–µ —Ñ–æ—Ç–æ" />
          <div class="photoOverlay"></div>
          <div class="photoCaption">
            <span id="photoIdx">1/4</span>
            <span class="dots" id="photoDots" aria-hidden="true"></span>
          </div>
        </div>

        <div class="paper" id="paper">
          <div class="lines" id="letterText">
–ü—Ä–∏–≤–µ—Ç, –î–∂–∞–º–∞.

[–¢–£–¢ –ë–£–î–ï–¢ –¢–í–û–ô –¢–ï–ö–°–¢ ‚Äî 6‚Äì10 —Å—Ç—Ä–æ–∫]
–ù–∞–ø—Ä–∏–º–µ—Ä:
‚Äî –Ø —Ö–æ—Ç–µ–ª —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ —á—É—Ç—å –∏–Ω–∞—á–µ, —á–µ–º –æ–±—ã—á–Ω–æ.
‚Äî –ß—Ç–æ–±—ã —Ç—ã —É–ª—ã–±–Ω—É–ª–∞—Å—å –Ω–µ –Ω–∞ —Å–µ–∫—É–Ω–¥—É, –∞ –ø–æ–¥–æ–ª—å—à–µ.
‚Äî –¢—ã –ø—Ä–∞–≤–¥–∞ –æ—Å–æ–±–µ–Ω–Ω–∞—è.
‚Äî –ò —è —Ä–∞–¥, —á—Ç–æ –º–æ–≥—É –±—ã—Ç—å —Ä—è–¥–æ–º (—Ö–æ—Ç—è –±—ã —Ç–∞–∫).
‚Äî –° –î–Ω—ë–º –í–∞–ª–µ–Ω—Ç–∏–Ω–∞.
‚Äî ‚ù§Ô∏è
          </div>
          <div class="sig">‚Äî —Ç–≤–æ–π —Ñ–∞–Ω–∞—Ç</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Only background music uses mp3 (yours). Other SFX are generated in WebAudio. -->
  <audio id="bgm" src="Audio/bgm.mp3" preload="auto" loop></audio>

  <script>
  (() => {
    "use strict";

    /* ===========================
       CONFIG
       =========================== */
    const IMAGES = [
      "Images/photo1.jpg",
      "Images/photo2.jpg",
      "Images/photo3.jpg",
      "Images/photo4.jpg",
    ].filter(Boolean);

    const MONTHS = ["—è–Ω–≤–∞—Ä—å","—Ñ–µ–≤—Ä–∞–ª—å","–º–∞—Ä—Ç","–∞–ø—Ä–µ–ª—å","–º–∞–π","–∏—é–Ω—å","–∏—é–ª—å","–∞–≤–≥—É—Å—Ç","—Å–µ–Ω—Ç—è–±—Ä—å","–æ–∫—Ç—è–±—Ä—å","–Ω–æ—è–±—Ä—å","–¥–µ–∫–∞–±—Ä—å"];

    // Codes
    const LOCK_TARGET = { day: 5, monthIndex: 10, year: 2025 }; // 5 –Ω–æ—è–±—Ä—è 2025 (monthIndex: —è–Ω–≤–∞—Ä—å=0)
    const BDAY_TARGET = "01.02.2005";

    /* ===========================
       DOM helpers
       =========================== */
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

    const loader = $("#loader");
    const barFill = $("#barFill");
    const progressText = $("#progressText");
    const assetText = $("#assetText");
    const loaderMsg = $("#loaderMsg");
    const app = $("#app");

    const stage = $("#stage");
    const toast = $("#toast");

    const hudText = $("#hudText");
    const audioBtn = $("#audioBtn");
    const audioIcon = $("#audioIcon");
    const audioLabel = $("#audioLabel");

    const scene1 = $("#scene1");
    const scene2 = $("#scene2");
    const scene3 = $("#scene3");

    const courierLine = $("#courierLine");
    const signSheet = $("#signSheet");
    const btnNo = $("#btnNo");
    const btnYes = $("#btnYes");

    const boxSticker = $("#boxSticker");
    const lockBtn = $("#lockBtn");
    const lockOverlay = $("#lockOverlay");
    const lockBack = $("#lockBack");
    const lockDone = $("#lockDone");

    const envSticker = $("#envSticker");
    const btnThrow = $("#btnThrow");
    const btnOpen = $("#btnOpen");

    const sealOverlay = $("#sealOverlay");
    const sealModal = $("#sealModal");
    const seal = $("#seal");
    const bdayInput = $("#bdayInput");
    const bdayOk = $("#bdayOk");
    const bdayHint = $("#bdayHint");
    const sealBack = $("#sealBack");

    const finalPanel = $("#finalPanel");
    const photoWrap = $("#photoWrap");
    const photoEl = $("#photoEl");
    const photoIdx = $("#photoIdx");
    const photoDots = $("#photoDots");
    const paper = $("#paper");

    const bgm = $("#bgm");

    /* ===========================
       State
       =========================== */
    const state = {
      scene: 1,
      audioEnabled: false,

      // rotation physics (2D)
      rotBox: { a: 0, v: 0, dragging:false, lx:0, lastT:0 },
      rotEnv: { a: 0, v: 0, dragging:false, lx:0, lastT:0 },

      // wheel values
      dayValues: Array.from({length:31}, (_,i)=>i+1),
      monthValues: MONTHS.map((m,i)=>({label:m, idx:i})),
      yearValues: Array.from({length:11}, (_,i)=>2020+i),

      wheels: { dayIdx: 0, monthIdx: 0, yearIdx: 0 },

      unlocked:false,
      opened:false,

      photoIndex: 0,
      photoTimer: 0,
      carouselTick: null,

      raf: 0,
      t0: performance.now(),
    };

    /* ===========================
       Small utils
       =========================== */
    const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
    const now = ()=>performance.now();

    function addShake(el){
      el.classList.remove("shake");
      void el.offsetWidth;
      el.classList.add("shake");
    }

    let toastTimer = 0;
    function showToast(text, ms=1200){
      toast.textContent = text;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.classList.remove("show"), ms);
    }

    function setScene(n){
      state.scene = n;
      const all = [scene1,scene2,scene3];
      all.forEach((s,i)=>{
        const active = (i+1)===n;
        s.classList.toggle("active", active);
        s.classList.toggle("hidden", !active);
      });
      if(n===1) hudText.textContent = "–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ ‚Ä¢ –∫—É—Ä—å–µ—Ä";
      if(n===2) hudText.textContent = "–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ ‚Ä¢ –ø–æ—Å—ã–ª–∫–∞";
      if(n===3) hudText.textContent = "–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ ‚Ä¢ –∫–æ–Ω–≤–µ—Ä—Ç";
    }

    /* ===========================
       WebAudio SFX (generated)
       - click: short tick
       - success: small upward arpeggio
       - error: soft descending wobble
       =========================== */
    let AC = null;
    function ensureAudio(){
      if(AC) return AC;
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(!Ctx) return null;
      AC = new Ctx();
      return AC;
    }

    function tone(freq, t, dur, type="sine", gain=0.25){
      if(!AC) return;
      const o = AC.createOscillator();
      const g = AC.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, t);

      // envelope
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(gain, t + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + dur);

      o.connect(g);
      g.connect(AC.destination);
      o.start(t);
      o.stop(t + dur + 0.02);
    }

    function noiseTick(t, dur=0.045, gain=0.10){
      if(!AC) return;
      const bufferSize = Math.max(1, Math.floor(AC.sampleRate * dur));
      const buffer = AC.createBuffer(1, bufferSize, AC.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<bufferSize;i++) data[i] = (Math.random()*2-1) * (1 - i/bufferSize);

      const src = AC.createBufferSource();
      src.buffer = buffer;

      const g = AC.createGain();
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(gain, t + 0.008);
      g.gain.exponentialRampToValueAtTime(0.0001, t + dur);

      src.connect(g);
      g.connect(AC.destination);
      src.start(t);
      src.stop(t + dur + 0.02);
    }

    function sfxClick(){
      if(!state.audioEnabled) return;
      const ac = ensureAudio(); if(!ac) return;
      if(ac.state === "suspended") ac.resume().catch(()=>{});
      const t = ac.currentTime + 0.001;
      noiseTick(t, 0.035, 0.08);
      tone(1400, t, 0.035, "triangle", 0.05);
    }

    function sfxSuccess(){
      if(!state.audioEnabled) return;
      const ac = ensureAudio(); if(!ac) return;
      if(ac.state === "suspended") ac.resume().catch(()=>{});
      const t = ac.currentTime + 0.001;
      tone(520, t, 0.10, "sine", 0.16);
      tone(780, t+0.06, 0.12, "sine", 0.14);
      tone(1040, t+0.12, 0.14, "sine", 0.12);
      noiseTick(t+0.10, 0.06, 0.05);
    }

    function sfxError(){
      if(!state.audioEnabled) return;
      const ac = ensureAudio(); if(!ac) return;
      if(ac.state === "suspended") ac.resume().catch(()=>{});
      const t = ac.currentTime + 0.001;
      tone(420, t, 0.14, "square", 0.07);
      tone(320, t+0.08, 0.18, "square", 0.06);
      noiseTick(t+0.02, 0.09, 0.05);
    }

    function setAudio(enabled){
      state.audioEnabled = enabled;
      audioIcon.textContent = enabled ? "üîä" : "üîá";
      audioLabel.textContent = enabled ? "–≤–∫–ª" : "–≤—ã–∫–ª";

      if(enabled){
        ensureAudio(); // init context on gesture
        try{
          bgm.volume = 0.22;
          bgm.play().catch(()=>{});
        }catch(_){}
      }else{
        try{ bgm.pause(); }catch(_){}
      }
    }

    audioBtn.addEventListener("click", () => {
      setAudio(!state.audioEnabled);
      sfxClick();
      showToast(state.audioEnabled ? "–ú—É–∑—ã–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞" : "–ú—É–∑—ã–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞", 900);
    });

    /* ===========================
       Preload (images + bgm only)
       =========================== */
    async function preload(){
      const assets = [];
      IMAGES.forEach(src => assets.push({type:"img", src}));
      assets.push({type:"aud", el:bgm});
      let loaded = 0;
      const total = assets.length;

      const update = () => {
        const p = total ? Math.round((loaded/total)*100) : 100;
        barFill.style.width = p + "%";
        progressText.textContent = p + "%";
        assetText.textContent = `${loaded}/${total}`;
      };
      update();

      loaderMsg.textContent = "–ì–æ—Ç–æ–≤–ª—é —Ñ–æ—Ç–æ –∏ –º—É–∑—ã–∫—É.";

      const imgPromises = IMAGES.map(src => new Promise(res=>{
        const img = new Image();
        img.onload = ()=>{ loaded++; update(); res(true); };
        img.onerror = ()=>{ loaded++; update(); res(false); };
        img.src = src;
      }));

      const audPromise = new Promise(res=>{
        const done = ()=>{ loaded++; update(); cleanup(); res(true); };
        const fail = ()=>{ loaded++; update(); cleanup(); res(false); };
        const cleanup = ()=>{
          bgm.removeEventListener("loadeddata", done);
          bgm.removeEventListener("canplaythrough", done);
          bgm.removeEventListener("error", fail);
        };
        bgm.addEventListener("loadeddata", done, {once:true});
        bgm.addEventListener("canplaythrough", done, {once:true});
        bgm.addEventListener("error", fail, {once:true});
        try{ bgm.load(); }catch(_){}
      });

      await Promise.all([...imgPromises, audPromise]);

      loader.style.opacity = "0";
      loader.style.transition = "opacity 260ms ease";
      setTimeout(() => {
        loader.style.display = "none";
        app.style.opacity = "1";
        app.style.transition = "opacity 300ms ease";
        setTimeout(()=>signSheet.classList.add("show"), 180);
      }, 260);
    }

    /* ===========================
       Scene 1
       =========================== */
    btnNo.addEventListener("click", () => {
      sfxClick();
      signSheet.classList.remove("show");
      courierLine.textContent = "–í—ã —á—Ç–æ, –±–∞–ª–±–µ—Å? –ù–∞ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –ø—Ä–æ—â–∞—é.";
      setTimeout(() => {
        signSheet.classList.add("show");
        btnNo.style.display = "none";
      }, 620);
    });

    btnYes.addEventListener("click", () => {
      sfxClick();
      signSheet.classList.remove("show");
      courierLine.textContent = "–ü—Ä–∏–Ω—è—Ç–æ. –ü–µ—Ä–µ–¥–∞—é –ø–æ—Å—ã–ª–∫—É –∞–∫–∫—É—Ä–∞—Ç–Ω–æ.";
      showToast("–ü–æ—Å—ã–ª–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞", 1000);
      setTimeout(() => {
        setScene(2);
        lockBtn.classList.add("pulse");
      }, 950);
    });

    /* ===========================
       2D rotation physics (box/envelope)
       - drag to rotate, inertia + damping, speed clamp
       =========================== */
    function attachRotate(el, model){
      const DEG_PER_PX = 0.22;
      const MAX_V = 220;      // deg/s
      const DAMP = 7.8;

      const onDown = (e) => {
        // block when overlay open
        if(el === boxSticker && lockOverlay.classList.contains("show")) return;
        if(el === envSticker && sealOverlay.classList.contains("show")) return;

        model.dragging = true;
        model.lx = (e.clientX ?? 0);
        model.lastT = now();
        model.v = 0;
        try{ el.setPointerCapture(e.pointerId); }catch(_){}
      };

      const onMove = (e) => {
        if(!model.dragging) return;
        const x = (e.clientX ?? 0);
        const dx = x - model.lx;
        model.lx = x;

        model.a += dx * DEG_PER_PX;

        const t = now();
        const dt = Math.max(0.008, Math.min(0.04, (t - model.lastT)/1000));
        model.lastT = t;

        model.v = clamp((dx * DEG_PER_PX)/dt, -MAX_V, MAX_V);
      };

      const onUp = () => { model.dragging = false; };

      el.addEventListener("pointerdown", onDown, {passive:true});
      window.addEventListener("pointermove", onMove, {passive:true});
      window.addEventListener("pointerup", onUp, {passive:true});
      window.addEventListener("pointercancel", onUp, {passive:true});

      model.step = (dt) => {
        if(model.dragging) return;
        // exponential damping
        model.v = model.v * Math.exp(-DAMP * dt);
        model.a += model.v * dt;
      };
    }

    attachRotate(boxSticker, state.rotBox);
    attachRotate(envSticker, state.rotEnv);

    function applyTransforms(){
      boxSticker.style.transform = `translateZ(0) rotate(${state.rotBox.a}deg)`;
      envSticker.style.transform = `translateZ(0) rotate(${state.rotEnv.a}deg)`;
    }

    /* ===========================
       Wheels (correct + robust)
       =========================== */
    function initWheels(){
      // Set defaults near target but not exactly
      state.wheels.dayIdx = 4;      // 5
      state.wheels.monthIdx = 9;    // –æ–∫—Ç—è–±—Ä—å
      state.wheels.yearIdx = 5;     // 2025

      // Build wheel DOM
      const wheelDefs = [
        { key:"day",   values: state.dayValues.map(v=>String(v)) },
        { key:"month", values: state.monthValues.map(v=>v.label) },
        { key:"year",  values: state.yearValues.map(v=>String(v)) },
      ];

      wheelDefs.forEach(def => {
        const wheel = $(`.wheel[data-wheel="${def.key}"]`);
        const list = $(".list", wheel);
        list.textContent = "";
        def.values.forEach((txt, idx) => {
          const it = document.createElement("div");
          it.className = "item";
          it.textContent = txt;
          it.dataset.idx = String(idx);
          list.appendChild(it);
        });
        // initial
        setWheel(def.key, state.wheels[def.key+"Idx"], false);
        attachWheelSwipe(wheel, def.key, def.values.length);
      });
    }

    function setWheel(key, idx, animate=true){
      const wheel = $(`.wheel[data-wheel="${key}"]`);
      const list = $(".list", wheel);
      const items = $$(".item", list);
      const H = 42;
      const max = items.length;

      idx = (idx % max + max) % max;
      state.wheels[key+"Idx"] = idx;

      const y = -idx * H;
      if(!animate){
        list.style.transition = "none";
        list.style.transform = `translate3d(0, calc(-50% + ${y}px), 0)`;
        void list.offsetWidth;
        list.style.transition = "";
      }else{
        list.style.transform = `translate3d(0, calc(-50% + ${y}px), 0)`;
      }

      items.forEach(it => it.classList.toggle("active", Number(it.dataset.idx) === idx));
    }

    function attachWheelSwipe(wheel, key, count){
      let dragging = false;
      let lastY = 0;
      let accum = 0;
      const TH = 18;

      const down = (e) => {
        dragging = true;
        lastY = e.clientY;
        accum = 0;
        try{ wheel.setPointerCapture(e.pointerId); }catch(_){}
      };
      const move = (e) => {
        if(!dragging) return;
        const dy = e.clientY - lastY;
        lastY = e.clientY;
        accum += dy;

        if(Math.abs(accum) >= TH){
          const step = (accum > 0) ? 1 : -1;
          accum = 0;
          // swipe down => next, swipe up => prev
          setWheel(key, state.wheels[key+"Idx"] + step, true);
          sfxClick();
        }
      };
      const up = ()=> dragging = false;

      wheel.addEventListener("pointerdown", down, {passive:true});
      wheel.addEventListener("pointermove", move, {passive:true});
      wheel.addEventListener("pointerup", up, {passive:true});
      wheel.addEventListener("pointercancel", up, {passive:true});
    }

    function getWheelValues(){
      const day = state.dayValues[state.wheels.dayIdx];
      const monthIndex = state.wheels.monthIdx; // already 0-based index
      const year = state.yearValues[state.wheels.yearIdx];
      return { day, monthIndex, year };
    }

    /* ===========================
       Scene 2 (lock)
       =========================== */
    lockBtn.addEventListener("click", () => {
      sfxClick();
      lockOverlay.classList.add("show");
      lockOverlay.setAttribute("aria-hidden","false");
    });

    lockBack.addEventListener("click", () => {
      sfxClick();
      lockOverlay.classList.remove("show");
      lockOverlay.setAttribute("aria-hidden","true");
    });

    lockDone.addEventListener("click", () => {
      sfxClick();
      const v = getWheelValues();
      const ok = (v.day === LOCK_TARGET.day) && (v.monthIndex === LOCK_TARGET.monthIndex) && (v.year === LOCK_TARGET.year);

      if(!ok){
        sfxError();
        addShake($(".modal", lockOverlay));
        showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥", 1000);
        return;
      }

      state.unlocked = true;
      sfxSuccess();
      lockBtn.classList.remove("pulse");
      lockBtn.style.transition = "transform 280ms ease, opacity 280ms ease";
      lockBtn.style.transform = "translate(-50%,-50%) scale(.92)";
      lockBtn.style.opacity = "0";

      lockOverlay.classList.remove("show");
      lockOverlay.setAttribute("aria-hidden","true");

      showToast("–©—ë–ª–∫! –û—Ç–∫—Ä—ã—Ç–æ", 1000);
      burst(0.52, 0.58, 18);

      setTimeout(() => setScene(3), 900);
    });

    /* ===========================
       Scene 3 (throw/open + birthday)
       =========================== */
    let throwUsed = false;
    btnThrow.addEventListener("click", () => {
      sfxClick();
      if(throwUsed) return;
      throwUsed = true;

      addShake($("#scene3Panel"));
      addShake(envSticker);
      sfxError();
      showToast("–©–∞—Å –ø–æ —à–µ–µ –ø–æ–ª—É—á–∏—à—å", 1200);

      // replace button: Open slides in, Throw fades out then removed
      btnThrow.style.transition = "opacity 260ms ease, transform 260ms ease";
      btnThrow.style.opacity = "0";
      btnThrow.style.transform = "translate3d(14px,0,0) scale(.98)";

      btnOpen.style.transition = "transform 420ms ease";
      btnOpen.style.transform = "translate3d(-56px,0,0)";

      setTimeout(() => {
        btnThrow.remove();
        btnOpen.style.transform = "translate3d(0,0,0)";
      }, 520);
    });

    btnOpen.addEventListener("click", () => {
      sfxClick();
      // tiny emphasis on seal
      seal.style.transition = "transform 220ms ease";
      seal.style.transform = "translate(-50%,-50%) scale(1.06)";
      setTimeout(() => {
        sealOverlay.classList.add("show");
        sealOverlay.setAttribute("aria-hidden","false");
        bdayInput.focus({preventScroll:true});
      }, 170);
    });

    sealBack.addEventListener("click", () => {
      sfxClick();
      sealOverlay.classList.remove("show");
      sealOverlay.setAttribute("aria-hidden","true");
      seal.style.transform = "translate(-50%,-50%) scale(1)";
    });

    function normalizeBday(s){
      s = (s || "").trim().replace(/[^\d.]/g,"");
      const digits = s.replace(/\./g,"").slice(0,8);
      let out = "";
      for(let i=0;i<digits.length;i++){
        out += digits[i];
        if(i===1 || i===3) out += ".";
      }
      return out.slice(0,10);
    }

    bdayInput.addEventListener("input", () => {
      const v = normalizeBday(bdayInput.value);
      if(v !== bdayInput.value) bdayInput.value = v;
    });

    function checkBday(){
      const v = normalizeBday(bdayInput.value);
      bdayInput.value = v;
      if(v !== BDAY_TARGET){
        sfxError();
        addShake(sealModal);
        bdayHint.textContent = "–ü–æ–¥—Å–∫–∞–∑–∫–∞: 01.02.2005";
        bdayHint.style.color = "rgba(255,211,122,.95)";
        setTimeout(()=>bdayHint.style.color="rgba(242,243,248,.72)", 1200);
        return false;
      }
      return true;
    }

    bdayOk.addEventListener("click", () => {
      sfxClick();
      if(!checkBday()) return;

      state.opened = true;
      sfxSuccess();

      seal.style.transition = "transform 420ms ease, opacity 420ms ease";
      seal.style.transform = "translate(-50%, calc(-50% + 70px)) scale(.92)";
      seal.style.opacity = "0";

      sealOverlay.classList.remove("show");
      sealOverlay.setAttribute("aria-hidden","true");

      burst(0.50, 0.60, 44);
      showToast("–û—Ç–∫—Ä—ã–≤–∞–µ–º‚Ä¶", 1100);

      setTimeout(() => {
        // reveal finals
        finalPanel.style.display = "";
        photoWrap.style.display = "";
        paper.style.display = "";

        // animate in
        finalPanel.style.opacity = "0";
        finalPanel.style.transform = "translate3d(0,10px,0)";
        finalPanel.style.transition = "opacity 360ms ease, transform 360ms ease";
        requestAnimationFrame(() => {
          finalPanel.style.opacity = "1";
          finalPanel.style.transform = "translate3d(0,0,0)";
        });

        startCarousel();
        paper.classList.add("show");
      }, 520);
    });

    bdayInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){ e.preventDefault(); bdayOk.click(); }
    });

    /* ===========================
       Photo carousel
       =========================== */
    function buildDots(n){
      photoDots.textContent = "";
      for(let i=0;i<n;i++){
        const d = document.createElement("i");
        if(i===0) d.classList.add("on");
        photoDots.appendChild(d);
      }
    }

    function showPhoto(i){
      const n = IMAGES.length || 1;
      i = (i % n + n) % n;
      state.photoIndex = i;

      photoEl.classList.remove("show");
      setTimeout(() => {
        photoEl.onload = () => requestAnimationFrame(()=>photoEl.classList.add("show"));
        photoEl.onerror = () => showToast("–§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø–∞–ø–∫–µ Images/", 1300);
        photoEl.src = IMAGES[i] || "";

        photoIdx.textContent = `${i+1}/${n}`;
        const dots = Array.from(photoDots.children);
        dots.forEach((d, idx) => d.classList.toggle("on", idx===i));
      }, 110);
    }

    function startCarousel(){
      if(!IMAGES.length){
        showToast("–î–æ–±–∞–≤—å 3‚Äì4 —Ñ–æ—Ç–æ –≤ –ø–∞–ø–∫—É Images/", 2000);
        return;
      }

      buildDots(IMAGES.length);
      state.photoTimer = now();
      showPhoto(0);

      let stopped = false;
      photoWrap.addEventListener("click", () => {
        sfxClick();
        stopped = true;
        showPhoto(state.photoIndex + 1);
      });

      state.carouselTick = () => {
        if(stopped) return;
        const t = now();
        if(t - state.photoTimer > 3800){
          state.photoTimer = t;
          showPhoto(state.photoIndex + 1);
        }
      };
    }

    /* ===========================
       Particles (hearts + sparks)
       =========================== */
    const c = $("#particles");
    const ctx = c.getContext("2d", { alpha:true });
    let W=1, H=1, dpr=1;
    const parts = [];

    function resize(){
      const r = stage.getBoundingClientRect();
      dpr = Math.min(2, window.devicePixelRatio || 1);
      W = Math.max(1, Math.floor(r.width));
      H = Math.max(1, Math.floor(r.height));
      c.width = Math.floor(W*dpr);
      c.height = Math.floor(H*dpr);
      c.style.width = W+"px";
      c.style.height = H+"px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", resize, {passive:true});

    function spawn(x, y, kind){
      const p = {
        x, y,
        vx: (Math.random()*2-1)*0.9,
        vy: -0.9 - Math.random()*1.8,
        a: 1,
        r: 3 + Math.random()*3.5,
        rot: Math.random()*Math.PI*2,
        vr: (Math.random()*2-1)*0.08,
        kind,
        life: 900 + Math.random()*900,
        born: now()
      };
      parts.push(p);
      if(parts.length > 140) parts.splice(0, parts.length-140);
    }

    function burst(nx, ny, n){
      const x = nx * W;
      const y = ny * H;
      for(let i=0;i<n;i++){
        spawn(x + (Math.random()*2-1)*18, y + (Math.random()*2-1)*18, Math.random()<0.6 ? "heart" : "spark");
      }
    }

    function drawHeart(x,y,s,rot,alpha){
      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(rot);
      ctx.globalAlpha = alpha;
      ctx.beginPath();
      const k = s/14;
      ctx.moveTo(0, 4*k);
      ctx.bezierCurveTo(0, 0, -6*k, 0, -6*k, 4*k);
      ctx.bezierCurveTo(-6*k, 8*k, 0, 10*k, 0, 12*k);
      ctx.bezierCurveTo(0, 10*k, 6*k, 8*k, 6*k, 4*k);
      ctx.bezierCurveTo(6*k, 0, 0, 0, 0, 4*k);
      ctx.closePath();
      ctx.fillStyle = "rgba(255,79,154,0.95)";
      ctx.fill();
      ctx.restore();
    }

    function drawSpark(x,y,s,rot,alpha){
      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(rot);
      ctx.globalAlpha = alpha;
      ctx.fillStyle = "rgba(242,243,248,0.92)";
      ctx.fillRect(-s*0.5, -1, s, 2);
      ctx.fillRect(-1, -s*0.5, 2, s);
      ctx.restore();
    }

    /* ===========================
       RAF loop: physics + particles + carousel
       =========================== */
    function tick(t){
      const dt = Math.min(0.033, (t - state.t0) / 1000);
      state.t0 = t;

      if(state.scene === 2) state.rotBox.step(dt);
      if(state.scene === 3) state.rotEnv.step(dt);

      applyTransforms();

      // particles
      ctx.clearRect(0,0,W,H);
      const T = now();
      for(let i=parts.length-1;i>=0;i--){
        const p = parts[i];
        const k = (T - p.born) / p.life;
        if(k >= 1){ parts.splice(i,1); continue; }

        p.x += p.vx * (dt*60);
        p.y += p.vy * (dt*60);
        p.vy += 0.03 * (dt*60);
        p.rot += p.vr * (dt*60);

        const alpha = (1 - k) * 0.85;
        if(p.kind === "heart") drawHeart(p.x,p.y,p.r*2.2,p.rot,alpha);
        else drawSpark(p.x,p.y,p.r*1.3,p.rot,alpha);
      }

      // ambient
      if(Math.random() < 0.06){
        spawn(Math.random()*W, H + 10, Math.random()<0.5 ? "heart":"spark");
      }

      if(state.scene === 3 && state.opened && typeof state.carouselTick === "function"){
        state.carouselTick();
      }

      state.raf = requestAnimationFrame(tick);
    }

    /* ===========================
       Prevent scroll bounce (iOS)
       =========================== */
    document.addEventListener("touchmove", (e)=>e.preventDefault(), {passive:false});

    /* ===========================
       Start
       =========================== */
    function setup(){
      resize();
      initWheels();
      signSheet.classList.remove("show"); // will be shown after loader
      state.t0 = performance.now();
      state.raf = requestAnimationFrame(tick);
      burst(0.50, 0.32, 10);
    }

    preload()
      .then(() => { setup(); })
      .catch(() => {
        // still start if something fails
        loader.style.display = "none";
        app.style.opacity = "1";
        app.style.transition = "opacity 260ms ease";
        setup();
        signSheet.classList.add("show");
        showToast("–ù–µ –≤—Å—ë –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –Ω–æ –∏–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç.", 1600);
      });

  })();
  </script>

  <!--
    ===========================
    –§–ê–ô–õ–´ –†–Ø–î–û–ú –° index.html
    ===========================
    Images/photo1.jpg ... photo4.jpg  (3‚Äì4 —à—Ç—É–∫–∏)
    Audio/bgm.mp3                    (—Ç–≤–æ—è –º—É–∑—ã–∫–∞)
    –û—Å—Ç–∞–ª—å–Ω—ã–µ –∑–≤—É–∫–∏ –ù–ï –Ω—É–∂–Ω—ã ‚Äî –æ–Ω–∏ —Å–∏–Ω—Ç–µ–∑–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–¥–µ.
  -->
</body>
</html>
