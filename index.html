<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0e0f12" />
  <title>–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ –¥–ª—è –î–∂–∞–º—ã</title>
  <style>
    /* =========================================================
       VALENTINE SPA ‚Äî single file
       Images expected in ./Images/ (next to index.html)
       Optional audio expected in ./Audio/ (next to index.html)
       ========================================================= */

    :root{
      --bg0:#0b0c0f;
      --bg1:#12141a;
      --paper:#f2efe5;
      --paper2:#eae4d5;
      --ink:#1b1c20;
      --muted:#60636f;
      --accent:#ff4d7d;
      --accent2:#ffb3c7;
      --good:#3ee59a;
      --bad:#ff6b6b;

      --radius:18px;
      --radius2:26px;
      --shadow: 0 12px 34px rgba(0,0,0,.32);
      --shadow2: 0 10px 22px rgba(0,0,0,.22);
      --stroke: rgba(20,22,28,.25);

      --uiScale: 1;
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeLeft: env(safe-area-inset-left, 0px);
      --safeRight: env(safe-area-inset-right, 0px);
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%; margin:0; background: radial-gradient(1400px 900px at 50% -10%, #20253a 0%, #0b0c0f 55%, #07080b 100%);}
    body{
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--paper);
      overflow:hidden;
      touch-action: none; /* we manage gestures */
    }

    /* Subtle "cute CRT" overlay */
    .crt{
      position:fixed; inset:0; pointer-events:none; z-index:50;
      opacity:.20;
      mix-blend-mode: soft-light;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.03) 0px,
          rgba(255,255,255,.03) 1px,
          rgba(0,0,0,.0) 3px,
          rgba(0,0,0,.0) 6px
        );
      filter: blur(.2px);
      animation: crtFlicker 5.5s infinite linear;
    }
    .crt::before{
      content:"";
      position:absolute; inset:-20%;
      background: radial-gradient(closest-side at 50% 40%, rgba(255,180,210,.08), rgba(0,0,0,0) 60%);
      transform: rotate(1.5deg);
    }
    .crt::after{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(90deg, rgba(255,0,100,.05), rgba(0,255,240,.05));
      mix-blend-mode: overlay;
      opacity:.25;
      animation: chroma 7s infinite linear;
    }
    @keyframes crtFlicker{
      0%,100%{opacity:.18}
      25%{opacity:.22}
      55%{opacity:.16}
      78%{opacity:.24}
    }
    @keyframes chroma{
      0%{transform:translateX(-1.2%)}
      50%{transform:translateX(1.2%)}
      100%{transform:translateX(-1.2%)}
    }

    /* App root */
    #app{
      position:fixed; inset:0;
      padding: calc(14px + var(--safeTop)) calc(14px + var(--safeRight)) calc(14px + var(--safeBottom)) calc(14px + var(--safeLeft));
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* Paper textures using CSS noise + grain */
    .paperTex{
      position:relative;
      background:
        radial-gradient(180px 140px at 20% 15%, rgba(255,255,255,.65), rgba(255,255,255,0) 65%),
        radial-gradient(220px 160px at 80% 10%, rgba(255,215,230,.22), rgba(255,255,255,0) 70%),
        linear-gradient(180deg, var(--paper) 0%, var(--paper2) 100%);
      color: var(--ink);
      border:1px solid rgba(40,42,52,.25);
      box-shadow: var(--shadow);
      border-radius: var(--radius2);
      overflow:hidden;
    }
    .paperTex::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E") repeat;
      mix-blend-mode:multiply;
      opacity:.45;
      transform: scale(1.1);
    }
    .paperTex::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        radial-gradient(800px 520px at 50% 0%, rgba(0,0,0,.06), rgba(0,0,0,0) 55%),
        radial-gradient(700px 450px at 0% 100%, rgba(0,0,0,.05), rgba(0,0,0,0) 60%),
        radial-gradient(700px 450px at 100% 100%, rgba(0,0,0,.05), rgba(0,0,0,0) 60%);
      opacity:.9;
    }

    /* Main stage card */
    .stage{
      width:min(430px, 100%);
      height:min(820px, 100%);
      max-height: 100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;
    }

    /* Top title bar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(18,20,26,.65);
      border: 1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      user-select:none;
    }
    .topbar .brand{
      display:flex; align-items:center; gap:10px;
      color: rgba(240,240,245,.92);
      font-weight: 700;
      letter-spacing:.2px;
      font-size: 14px;
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      color:#fff;
      background: linear-gradient(135deg, rgba(255,77,125,.95), rgba(255,179,199,.85));
      box-shadow: 0 10px 18px rgba(255,77,125,.18);
      border: 1px solid rgba(255,255,255,.14);
    }

    /* Scene container */
    .viewport{
      position:relative;
      flex:1;
      border-radius: var(--radius2);
      overflow:hidden;
      box-shadow: var(--shadow2);
      border: 1px solid rgba(255,255,255,.06);
      background:
        radial-gradient(1200px 700px at 50% 0%, rgba(255,77,125,.16), rgba(0,0,0,0) 55%),
        radial-gradient(900px 540px at 10% 95%, rgba(80,160,255,.12), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, rgba(18,20,26,.55), rgba(10,11,15,.85));
    }

    .scene{
      position:absolute; inset:0;
      padding: 14px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:14px;
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      transition: opacity .45s ease, transform .55s cubic-bezier(.2,.8,.2,1);
    }
    .scene.active{
      opacity:1;
      transform: translateY(0px);
      pointer-events:auto;
    }

    .center{
      display:flex; align-items:center; justify-content:center;
      flex:1;
      position:relative;
    }

    /* Speech bubble */
    .bubble{
      align-self:center;
      max-width: 92%;
      padding: 12px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(245,246,250,.92);
      box-shadow: 0 16px 36px rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      line-height:1.2;
      user-select:none;
    }
    .bubble .who{font-size:12px; opacity:.72; margin-bottom:6px;}
    .bubble .txt{font-size:16px; font-weight:650;}
    .bubble.small .txt{font-size:14px; font-weight:600;}
    .bubble.shake{animation: shake .35s ease;}
    @keyframes shake{
      0%{transform:translateX(0)}
      20%{transform:translateX(-6px)}
      40%{transform:translateX(6px)}
      60%{transform:translateX(-5px)}
      80%{transform:translateX(4px)}
      100%{transform:translateX(0)}
    }

    /* Button row */
    .row{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }

    .btn{
      position:relative;
      border:none;
      padding: 12px 16px;
      border-radius: 18px;
      color: rgba(250,250,255,.95);
      font-weight: 750;
      font-size: 14px;
      letter-spacing: .2px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
      transition: transform .12s ease, filter .12s ease, background .18s ease, opacity .22s ease;
      user-select:none;
      touch-action: manipulation;
      cursor:pointer;
    }
    .btn:active{ transform: translateY(1px) scale(.99); filter: brightness(1.05); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(255,77,125,.95), rgba(255,179,199,.88));
      border: 1px solid rgba(255,255,255,.18);
      color:#1a1115;
      box-shadow: 0 16px 30px rgba(255,77,125,.18), 0 12px 26px rgba(0,0,0,.22);
    }
    .btn.ghost{ background: rgba(0,0,0,.12); }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,107,107,.92), rgba(255,179,199,.65));
      border:1px solid rgba(255,255,255,.15);
      color:#1a1115;
    }
    .btn.hidden{opacity:0; pointer-events:none; transform: translateX(12px) scale(.98);}
    .btn.wide{ min-width: 160px; }

    /* Modal paper sheet */
    .modalWrap{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.32);
      opacity:0;
      pointer-events:none;
      transition: opacity .28s ease;
    }
    .modalWrap.show{opacity:1; pointer-events:auto;}
    .modal{
      width:min(380px, 100%);
      padding: 16px 16px 14px 16px;
      border-radius: var(--radius2);
      transform: translateY(10px) scale(.99);
      transition: transform .35s cubic-bezier(.2,.8,.2,1);
    }
    .modalWrap.show .modal{ transform: translateY(0) scale(1); }
    .modal h3{
      margin:0 0 8px 0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .modal p{
      margin:0 0 14px 0;
      color: rgba(20,20,24,.78);
      font-weight: 600;
      line-height:1.25;
    }

    /* =========================================================
       3D-ish objects (box & envelope) with paper/cardboard vibe
       ========================================================= */
    .objectStage{
      width: 100%;
      height: 100%;
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .objectHint{
      position:absolute;
      top: 10px; left: 10px; right: 10px;
      display:flex; justify-content:center;
      pointer-events:none;
      opacity:.86;
    }
    .hintPill{
      padding: 8px 12px;
      font-size: 12px;
      font-weight:700;
      color: rgba(250,250,255,.90);
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      backdrop-filter: blur(8px);
      box-shadow: 0 12px 22px rgba(0,0,0,.20);
    }

    .object3d{
      width: min(310px, 86vw);
      aspect-ratio: 1 / 1;
      position:relative;
      transform-style: preserve-3d;
      will-change: transform;
      filter: drop-shadow(0 26px 28px rgba(0,0,0,.32));
      touch-action: none;
      user-select:none;
    }

    /* Pixel-ish edge */
    .pixelEdge{
      position:absolute; inset:0;
      border-radius: 26px;
      overflow:hidden;
    }
    .pixelEdge::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        linear-gradient(0deg, rgba(0,0,0,.16), rgba(0,0,0,0) 35%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,0) 35%);
      opacity:.8;
    }

    /* Cardboard box faces */
    .boxFace{
      position:absolute;
      inset: 9%;
      border-radius: 22px;
      background:
        radial-gradient(220px 140px at 25% 20%, rgba(255,255,255,.22), rgba(255,255,255,0) 60%),
        radial-gradient(220px 140px at 75% 15%, rgba(255,255,255,.10), rgba(255,255,255,0) 70%),
        linear-gradient(135deg, #caa57f 0%, #b88f69 55%, #a37c5a 100%);
      border: 1px solid rgba(0,0,0,.18);
      overflow:hidden;
    }
    .boxFace::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E") repeat;
      opacity:.55;
      mix-blend-mode:multiply;
      transform: scale(1.08);
    }

    /* Tape stripe */
    .tape{
      position:absolute; left: 12%; right:12%; top: 46%;
      height: 16%;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,240,200,.75), rgba(230,205,160,.75));
      border:1px solid rgba(0,0,0,.14);
      transform: rotate(-3deg);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.22), inset 0 -2px 0 rgba(0,0,0,.12);
      opacity:.95;
    }

    /* Label "–¥–ª—è –î–∂–∞–º—ã" */
    .label{
      position:absolute; left: 16%; right:16%; top: 18%;
      padding: 10px 12px;
      border-radius: 16px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.72), rgba(240,235,220,.85));
      border: 1px solid rgba(0,0,0,.12);
      color: rgba(22,22,26,.90);
      font-weight: 800;
      text-align:center;
      letter-spacing: .2px;
      box-shadow: 0 10px 18px rgba(0,0,0,.14);
    }
    .label small{
      display:block;
      margin-top:4px;
      font-weight:700;
      color: rgba(40,40,48,.55);
      font-size:12px;
    }

    /* Lock button */
    .lock{
      position:absolute;
      width: 84px;
      height: 84px;
      left: 50%;
      top: 62%;
      transform: translate(-50%,-50%);
      border-radius: 22px;
      background:
        radial-gradient(22px 18px at 30% 30%, rgba(255,255,255,.65), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, #f1dca5, #d9b96a);
      border: 1px solid rgba(0,0,0,.16);
      box-shadow: 0 18px 26px rgba(0,0,0,.20);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      touch-action: manipulation;
      user-select:none;
      will-change: transform;
      animation: pulse 1.25s infinite ease-in-out;
    }
    .lock::before{
      content:"";
      width: 30px; height: 22px;
      border-radius: 12px 12px 10px 10px;
      border: 6px solid rgba(30,24,10,.55);
      border-bottom: 0;
      transform: translateY(-14px);
      opacity:.95;
    }
    .lock::after{
      content:"";
      position:absolute;
      width: 22px; height: 30px;
      border-radius: 10px;
      background: rgba(30,24,10,.55);
      transform: translateY(8px);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.18);
    }
    @keyframes pulse{
      0%,100%{transform: translate(-50%,-50%) scale(1)}
      50%{transform: translate(-50%,-50%) scale(1.06)}
    }

    /* Envelope */
    .envFace{
      position:absolute;
      inset: 10%;
      border-radius: 24px;
      background:
        radial-gradient(220px 160px at 25% 15%, rgba(255,255,255,.40), rgba(255,255,255,0) 62%),
        linear-gradient(135deg, #f6e6ea 0%, #f2d2da 55%, #e7bcc8 100%);
      border: 1px solid rgba(0,0,0,.16);
      overflow:hidden;
    }
    .envFace::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.78' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.15'/%3E%3C/svg%3E") repeat;
      opacity:.60;
      mix-blend-mode:multiply;
      transform: scale(1.08);
    }
    .envFlap{
      position:absolute; left: 14%; right:14%; top: 18%;
      height: 44%;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.40), rgba(0,0,0,.04));
      clip-path: polygon(50% 85%, 0% 0%, 100% 0%);
      opacity:.9;
    }
    .seal{
      position:absolute; left:50%; top: 58%;
      width: 84px; height: 84px;
      transform: translate(-50%,-50%);
      border-radius: 24px;
      background:
        radial-gradient(22px 18px at 35% 30%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, #ff6c90, #ff3f73);
      border: 1px solid rgba(0,0,0,.18);
      box-shadow: 0 18px 26px rgba(255,77,125,.20), 0 14px 24px rgba(0,0,0,.20);
      display:flex; align-items:center; justify-content:center;
    }
    .seal b{
      color: rgba(15,10,12,.75);
      font-size: 18px;
      letter-spacing:.6px;
      transform: translateY(1px);
    }
    .seal.wiggle{ animation: sealWiggle .35s ease; }
    @keyframes sealWiggle{
      0%{transform:translate(-50%,-50%) rotate(0)}
      30%{transform:translate(-50%,-50%) rotate(-6deg)}
      65%{transform:translate(-50%,-50%) rotate(6deg)}
      100%{transform:translate(-50%,-50%) rotate(0)}
    }

    /* =========================================================
       Lock minigame (3 reels)
       ========================================================= */
    .lockUI{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .reels{
      display:grid;
      grid-template-columns: 1fr 1.2fr 1fr;
      gap: 10px;
    }
    .reel{
      position:relative;
      height: 160px;
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.14);
      background:
        radial-gradient(160px 120px at 30% 20%, rgba(255,255,255,.58), rgba(255,255,255,0) 65%),
        linear-gradient(180deg, rgba(255,255,255,.84), rgba(240,235,220,.94));
      box-shadow: 0 12px 22px rgba(0,0,0,.14);
      touch-action: none;
      user-select:none;
    }
    .reel::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.16'/%3E%3C/svg%3E") repeat;
      opacity:.40; mix-blend-mode:multiply;
      pointer-events:none;
    }
    .reelHeader{
      position:absolute; top: 10px; left:10px; right:10px;
      font-weight: 850;
      font-size: 12px;
      color: rgba(30,30,34,.65);
      letter-spacing:.2px;
      text-align:center;
      pointer-events:none;
    }
    .windowLine{
      position:absolute; left:10px; right:10px; top: 50%;
      height: 46px;
      transform: translateY(-50%);
      border-radius: 16px;
      border: 1px dashed rgba(20,20,26,.28);
      background: rgba(255,255,255,.36);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.40), inset 0 -2px 0 rgba(0,0,0,.06);
      pointer-events:none;
    }
    .reelList{
      position:absolute; left:0; right:0; top:0; bottom:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 18px;
      padding: 24px 10px;
      transform: translateY(0);
      will-change: transform;
    }
    .reelItem{
      font-weight: 950;
      font-size: 18px;
      color: rgba(20,20,26,.86);
      text-align:center;
      letter-spacing:.4px;
      min-height: 22px;
      padding: 2px 6px;
      border-radius: 10px;
    }
    .reelItem.dim{opacity:.38; filter: blur(.1px);}
    .lockFooter{
      display:flex; justify-content:space-between; gap:10px;
    }
    .lockFooter .btn{flex:1}

    /* =========================================================
       Date check (birthday)
       ========================================================= */
    .dateCard{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 14px 14px 12px 14px;
      border-radius: 22px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(8px);
      box-shadow: 0 16px 36px rgba(0,0,0,.25);
    }
    .dateRow{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:center;
    }
    .chip{
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(250,250,255,.92);
      font-weight: 800;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .chip input{
      appearance:none;
      border:none;
      outline:none;
      background: transparent;
      color: rgba(250,250,255,.92);
      font-weight: 850;
      font-size: 14px;
      min-width: 168px;
    }
    .hint{
      text-align:center;
      font-size: 12px;
      font-weight: 650;
      color: rgba(255,255,255,.72);
      line-height:1.2;
      user-select:none;
    }

    /* =========================================================
       Photo carousel (3-4 images) + letter sheet
       ========================================================= */
    .gallery{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:center;
      padding-bottom: 8px;
    }
    .photoFrame{
      width: min(360px, 100%);
      aspect-ratio: 9/12;
      border-radius: 24px;
      overflow:hidden;
      position:relative;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 32px rgba(0,0,0,.25);
      background: rgba(0,0,0,.14);
    }
    .photoFrame img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: cover;
      opacity:0;
      transform: scale(1.02);
      transition: opacity .8s ease, transform 1.1s cubic-bezier(.2,.8,.2,1);
      filter: saturate(1.02) contrast(1.02);
    }
    .photoFrame img.show{
      opacity:1;
      transform: scale(1);
    }
    .photoOverlay{
      position:absolute; inset:0;
      pointer-events:none;
      background:
        radial-gradient(900px 650px at 50% 0%, rgba(255,255,255,.08), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.30));
    }
    .dots{
      display:flex; gap:8px;
      justify-content:center;
      align-items:center;
      user-select:none;
    }
    .dot{
      width: 8px; height: 8px;
      border-radius: 99px;
      background: rgba(255,255,255,.20);
      border: 1px solid rgba(255,255,255,.12);
      transition: transform .15s ease, background .15s ease;
    }
    .dot.on{
      background: rgba(255,179,199,.85);
      transform: scale(1.35);
    }

    .letter{
      width: min(380px, 100%);
      padding: 14px 14px 12px 14px;
    }
    .letter .title{
      font-weight: 950;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .lines{
      display:flex; flex-direction:column; gap:8px;
    }
    .line{
      height: 12px;
      border-radius: 8px;
      background: linear-gradient(90deg, rgba(30,30,36,.12), rgba(30,30,36,.08), rgba(30,30,36,.12));
      border: 1px solid rgba(0,0,0,.08);
    }
    .line.short{ width: 72%; }
    .line.mid{ width: 88%; }
    .line.long{ width: 96%; }

    /* =========================================================
       Loader
       ========================================================= */
    .loader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:80;
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(255,77,125,.18), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, rgba(10,11,15,.92), rgba(8,8,11,.98));
      transition: opacity .45s ease, transform .55s ease;
    }
    .loader.hide{opacity:0; pointer-events:none; transform: translateY(-6px);}
    .loaderCard{
      width: min(380px, 92vw);
      padding: 16px;
      border-radius: 26px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      box-shadow: 0 24px 46px rgba(0,0,0,.35);
      text-align:center;
      user-select:none;
    }
    .loaderTitle{
      font-weight: 950;
      letter-spacing: .2px;
      font-size: 16px;
      margin-bottom: 6px;
      color: rgba(250,250,255,.95);
    }
    .loaderSub{
      font-weight: 650;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      margin-bottom: 14px;
      line-height:1.25;
    }
    .bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      box-shadow: inset 0 2px 0 rgba(255,255,255,.05);
    }
    .bar > i{
      display:block;
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,77,125,.95), rgba(255,179,199,.85));
      box-shadow: 0 10px 18px rgba(255,77,125,.18);
      transition: width .22s ease;
    }
    .tapToStart{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.88);
      font-weight: 850;
      font-size: 12px;
      letter-spacing:.2px;
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      opacity:.0;
      transform: translateY(6px);
      transition: opacity .35s ease, transform .45s cubic-bezier(.2,.8,.2,1);
    }
    .tapToStart.show{opacity:1; transform: translateY(0);}
    .tapDot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(255,179,199,.95);
      box-shadow: 0 0 0 6px rgba(255,77,125,.12);
      animation: tapPulse 1.1s infinite ease-in-out;
    }
    @keyframes tapPulse{
      0%,100%{transform: scale(1)}
      50%{transform: scale(1.35)}
    }

    /* Particles canvas */
    canvas#fx{
      position:absolute; inset:0;
      pointer-events:none;
      z-index: 6;
    }

    /* Small footer */
    .foot{
      display:flex; justify-content:center;
      color: rgba(255,255,255,.55);
      font-weight:650;
      font-size:11px;
      padding-bottom: 2px;
      user-select:none;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important;}
    }
  </style>
</head>
<body>
  <div class="loader" id="loader">
    <div class="loaderCard">
      <div class="loaderTitle">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ—Å—ã–ª–∫–∏‚Ä¶</div>
      <div class="loaderSub">–¢–µ–∫—Å—Ç—É—Ä—ã, —Ñ–æ—Ç–æ –∏ –∑–≤—É–∫–∏ –≥—Ä—É–∑—è—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ Telegram. <br/>–ü–æ—Ç–æ–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –æ–¥–∏–Ω —Ä–∞–∑ —Ç–∞–ø–Ω—É—Ç—å, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É.</div>
      <div class="bar"><i id="barFill"></i></div>
      <div class="tapToStart" id="tapToStart"><span class="tapDot"></span>–¢–∞–ø–Ω–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
    </div>
  </div>

  <div id="app" aria-label="valentine-spa">
    <div class="stage">
      <div class="topbar">
        <div class="brand">
          <span style="opacity:.9;">üì¶</span>
          <span>–ú–∏–Ω–∏-–∏–≥—Ä–∞-–≤–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞</span>
        </div>
        <div class="badge" id="sceneBadge">–°—Ü–µ–Ω–∞ 1/3</div>
      </div>

      <div class="viewport" id="viewport">
        <canvas id="fx"></canvas>

        <!-- SCENE 1 -->
        <section class="scene" id="scene1" aria-label="scene-1">
          <div class="bubble" id="courierBubble">
            <div class="who">–ö—É—Ä—å–µ—Ä</div>
            <div class="txt" id="courierText">–í–∞–º –ø–æ—Å—ã–ª–∫–∞ –æ—Ç —Ñ–∞–Ω–∞—Ç–∞ üòâ</div>
          </div>

          <div class="center">
            <div class="objectStage">
              <div class="objectHint"><div class="hintPill">–¢—É—Ç –≤—Å—ë –±—É–º–∞–∂–Ω–æ–µ, –Ω–æ ‚Äú–∂–∏–≤–æ–µ‚Äù üôÇ</div></div>
              <!-- Stylized courier card -->
              <div class="paperTex" style="width:min(360px,100%); padding:14px; border-radius:26px;">
                <div style="display:flex; gap:12px; align-items:center;">
                  <div style="width:78px;height:78px;border-radius:22px;background:rgba(0,0,0,.10);border:1px solid rgba(0,0,0,.10);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;">
                    <div style="width:54px;height:54px;border-radius:20px;background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.10));border:1px solid rgba(0,0,0,.10);"></div>
                    <div style="position:absolute;bottom:8px;left:10px;right:10px;height:8px;border-radius:6px;background:rgba(0,0,0,.12);"></div>
                  </div>
                  <div style="flex:1;">
                    <div style="font-weight:950;font-size:16px;letter-spacing:.2px;">–ö—É—Ä—å–µ—Ä</div>
                    <div style="margin-top:4px;color:rgba(0,0,0,.62);font-weight:700;font-size:12px;line-height:1.2;">
                      –¢–∏—Ö–æ, –±–µ–∑ –ª–æ–≥–æ—Ç–∏–ø–æ–≤. –ü—Ä–æ—Å—Ç–æ –¥–æ—Å—Ç–∞–≤–ª—è—é —Å—Ç—Ä–∞–Ω–Ω—ã–µ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–µ —à—Ç—É–∫–∏.
                    </div>
                  </div>
                </div>
                <div style="margin-top:12px;display:flex;gap:10px;align-items:center;">
                  <div style="height:10px;flex:1;border-radius:999px;background:rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.08);overflow:hidden;">
                    <div style="height:100%;width:78%;border-radius:999px;background:linear-gradient(90deg, rgba(255,77,125,.85), rgba(255,179,199,.78));"></div>
                  </div>
                  <div style="font-weight:950;color:rgba(0,0,0,.55);font-size:12px;">78%</div>
                </div>
              </div>
            </div>
          </div>

          <div class="modalWrap" id="signModal">
            <div class="modal paperTex" id="signPaper">
              <h3>–ë—É–º–∞–∂–∫–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏</h3>
              <p>–í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ø–æ—Å—ã–ª–∫—É –æ—Ç —Ñ–∞–Ω–∞—Ç–∞?</p>
              <div class="row" id="signButtons">
                <button class="btn ghost wide" id="btnNo">–ù–µ—Ç</button>
                <button class="btn primary wide" id="btnYes">–î–∞</button>
              </div>
            </div>
          </div>
        </section>

        <!-- SCENE 2 -->
        <section class="scene" id="scene2" aria-label="scene-2">
          <div class="bubble small" id="boxBubble">
            <div class="who">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
            <div class="txt">–ü–æ–∫—Ä—É—Ç–∏ –∫–æ—Ä–æ–±–∫—É –ø–∞–ª—å—Ü–µ–º. –ü–æ—Ç–æ–º –Ω–∞–∂–º–∏ –Ω–∞ –∑–∞–º–æ–∫.</div>
          </div>

          <div class="center">
            <div class="objectStage">
              <div class="objectHint"><div class="hintPill">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π: –≤—Ä–∞—â–µ–Ω–∏–µ —Å –∏–Ω–µ—Ä—Ü–∏–µ–π</div></div>

              <div class="object3d" id="box3d" aria-label="3d-box">
                <div class="pixelEdge"></div>
                <div class="boxFace">
                  <div class="label">
                    –¥–ª—è –î–∂–∞–º—ã
                    <small>–æ—Ç —Ñ–∞–Ω–∞—Ç–∞ üòâ</small>
                  </div>
                  <div class="tape"></div>
                  <div class="lock" id="lockBtn" aria-label="lock"></div>
                </div>
              </div>

              <div class="modalWrap" id="lockModal">
                <div class="modal paperTex">
                  <div class="lockUI">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                      <div>
                        <div style="font-weight:950;font-size:16px;margin-bottom:2px;">–ö–æ–¥–æ–≤—ã–π –∑–∞–º–æ–∫</div>
                        <div style="font-weight:700;color:rgba(20,20,24,.62);font-size:12px;line-height:1.2;">
                          3 –∫–æ–ª—ë—Å–∏–∫–∞ ‚Äî –¥–µ–Ω—å, –º–µ—Å—è—Ü, –≥–æ–¥. –°–≤–∞–π–ø–∞–π –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑.
                        </div>
                      </div>
                      <div style="font-weight:950;color:rgba(20,20,24,.55);font-size:12px;padding:8px 10px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:rgba(0,0,0,.04);">
                        üîí
                      </div>
                    </div>

                    <div class="reels" id="reels">
                      <div class="reel" data-reel="day">
                        <div class="reelHeader">–î–ï–ù–¨</div>
                        <div class="windowLine"></div>
                        <div class="reelList" id="reelDay"></div>
                      </div>
                      <div class="reel" data-reel="month">
                        <div class="reelHeader">–ú–ï–°–Ø–¶</div>
                        <div class="windowLine"></div>
                        <div class="reelList" id="reelMonth"></div>
                      </div>
                      <div class="reel" data-reel="year">
                        <div class="reelHeader">–ì–û–î</div>
                        <div class="windowLine"></div>
                        <div class="reelList" id="reelYear"></div>
                      </div>
                    </div>

                    <div class="lockFooter">
                      <button class="btn ghost" id="lockBack">–ù–∞–∑–∞–¥</button>
                      <button class="btn primary" id="lockDone">–ì–æ—Ç–æ–≤–æ</button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="row">
            <button class="btn ghost wide" id="boxReset">–°–±—Ä–æ—Å–∏—Ç—å –≤—Ä–∞—â–µ–Ω–∏–µ</button>
          </div>
        </section>

        <!-- SCENE 3 -->
        <section class="scene" id="scene3" aria-label="scene-3">
          <div class="bubble small" id="envBubble">
            <div class="who">–ü–æ—Å—ã–ª–∫–∞</div>
            <div class="txt">–í–Ω—É—Ç—Ä–∏ ‚Äî –ø–∏—Å—å–º–æ. –ù–æ —Å–Ω–∞—á–∞–ª–∞‚Ä¶ –ø–µ—á–∞—Ç—å.</div>
          </div>

          <div class="center">
            <div class="objectStage">
              <div class="objectHint"><div class="hintPill">–¢—É—Ç —Ç–æ–∂–µ –º–æ–∂–Ω–æ –≤—Ä–∞—â–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç</div></div>

              <div class="object3d" id="env3d" aria-label="3d-envelope">
                <div class="pixelEdge"></div>
                <div class="envFace">
                  <div class="envFlap"></div>
                  <div class="seal" id="sealBtn"><b>‚ô•</b></div>
                </div>
              </div>

              <!-- Date check overlay (hidden at first) -->
              <div class="modalWrap" id="dateModal">
                <div class="modal" style="padding:0; border-radius: 26px; background:transparent; box-shadow:none; border:none;">
                  <div class="dateCard">
                    <div style="text-align:center;font-weight:950;font-size:16px;">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ñ–∞–Ω–∞—Ç–∞</div>
                    <div class="hint">–û—Ç–∫—Ä–æ–µ—Ç—Å—è –∫–∞–ª–µ–Ω–¥–∞—Ä—å. –í—ã–±–µ—Ä–∏ –¥–∞—Ç—É –∏ –Ω–∞–∂–º–∏ ‚Äú–û–ö‚Äù, –ø–æ—Ç–æ–º ‚Äî –≥–∞–ª–æ—á–∫—É.</div>

                    <div class="dateRow">
                      <label class="chip" style="cursor:pointer;">
                        üìÖ
                        <input id="dateInput" type="date" />
                      </label>
                      <button class="btn primary" id="dateCheck" style="min-width: 76px; border-radius: 18px;">‚úì</button>
                    </div>

                    <div class="hint" id="dateHint" style="min-height: 16px;"></div>

                    <div class="row">
                      <button class="btn ghost wide" id="dateCancel">–ù–∞–∑–∞–¥</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Final content (hidden until success) -->
              <div class="modalWrap" id="finalModal" style="background: rgba(0,0,0,.26);">
                <div class="modal" style="width:min(410px,100%); padding:0; background:transparent; box-shadow:none; border:none;">
                  <div class="gallery">
                    <div class="photoFrame" aria-label="photos">
                      <img id="ph0" alt="photo 1" />
                      <img id="ph1" alt="photo 2" />
                      <img id="ph2" alt="photo 3" />
                      <img id="ph3" alt="photo 4" />
                      <div class="photoOverlay"></div>
                    </div>
                    <div class="dots" id="dots"></div>

                    <div class="letter paperTex" id="letter">
                      <div class="title">–ü–∏—Å—å–º–æ üìù</div>
                      <!-- Placeholder lines (replace with your text) -->
                      <div style="font-weight:700;color:rgba(20,20,24,.70);font-size:12px;margin-bottom:10px;line-height:1.25;">
                        –ó–∞–º–µ–Ω–∏—à—å —ç—Ç–æ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –Ω–∞ —Å–≤–æ–π —Ç–µ–∫—Å—Ç (6‚Äì10 —Å—Ç—Ä–æ–∫). –ú–æ–∂–Ω–æ –ø—Ä—è–º–æ –≤ HTML –Ω–∏–∂–µ.
                      </div>

                      <div id="letterText" style="font-weight:800;color:rgba(20,20,24,.84);line-height:1.35;font-size:14px;">
                        <div>–î–∂–∞–º–∞, –ø—Ä–∏–≤–µ—Ç‚Ä¶</div>
                        <div>–≠—Ç–æ –º–∞–ª–µ–Ω—å–∫–∞—è –ø–æ—Å—ã–ª–∫–∞,</div>
                        <div>–≤ –∫–æ—Ç–æ—Ä–æ–π —Å–ø—Ä—è—Ç–∞–Ω–æ —á—É—Ç—å-—á—É—Ç—å</div>
                        <div>–º–æ–µ–≥–æ —Ç–µ–ø–ª–∞ –∏ —É–ª—ã–±–∫–∏.</div>
                        <div>–ï—Å–ª–∏ —Ç—ã —á–∏—Ç–∞–µ—à—å —ç—Ç–æ ‚Äî</div>
                        <div>–∑–Ω–∞—á–∏—Ç —Ç—ã –≤—Å—ë —Å–¥–µ–ª–∞–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ. ‚ô•</div>
                        <div>‚Ä¶</div>
                      </div>

                      <div style="margin-top:12px;" class="lines" aria-hidden="true">
                        <div class="line long"></div>
                        <div class="line mid"></div>
                        <div class="line long"></div>
                        <div class="line short"></div>
                      </div>
                    </div>

                    <div class="row">
                      <button class="btn primary wide" id="restart">–ï—â—ë —Ä–∞–∑</button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="row" id="envButtons">
            <button class="btn danger wide" id="throwBtn">–í—ã–±—Ä–æ—Å–∏—Ç—å</button>
            <button class="btn primary wide" id="openBtn">–û—Ç–∫—Ä—ã—Ç—å</button>
          </div>
        </section>

      </div>

      <div class="foot">–õ—É—á—à–µ –≤ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ ‚Ä¢ –≤–Ω—É—Ç—Ä–∏ Telegram WebView</div>
    </div>
  </div>

  <div class="crt" aria-hidden="true"></div>

  <script>
    /* =========================================================
       CONFIG ‚Äî change filenames here
       ========================================================= */
    const CONFIG = {
      images: [
        // Put your 3‚Äì4 photos here (in Images/ directory)
        "Images/photo1.jpg",
        "Images/photo2.jpg",
        "Images/photo3.jpg",
        "Images/photo4.jpg"
      ],
      // Optional: if you have a paper texture image you want to reuse.
      // Not required; style already includes procedural texture.
      audio: {
        // Background music (optional). If file missing, app still runs.
        // Put your track in Audio/JeTeLaisseraiDesMots.mp3 (or change name).
        bgm: "Audio/JeTeLaisseraiDesMots.mp3",

        // Short SFX (optional). If missing, we synthesize with WebAudio.
        click: "Audio/click.mp3",
        paper: "Audio/paper.mp3",
        lock: "Audio/lock.mp3",
        success: "Audio/success.mp3",
        wrong: "Audio/wrong.mp3",
        whoosh: "Audio/whoosh.mp3"
      },

      // Correct codes:
      lockCode: { day: 5, monthIndex: 10, year: 2025 }, // 5 November 2025 (monthIndex 10 if Jan=0)
      fanBirthday: "2005-02-01", // yyyy-mm-dd

      // Performance: cap particle count
      maxParticles: 90
    };

    /* =========================================================
       Helpers
       ========================================================= */
    const $ = (id) => document.getElementById(id);
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const lerp = (a,b,t)=>a+(b-a)*t;
    const now = ()=>performance.now();

    function supportsWebP(){
      const canvas = document.createElement("canvas");
      return canvas.toDataURL("image/webp").startsWith("data:image/webp");
    }

    // Prevent iOS bounce scroll inside Telegram webview
    document.addEventListener("touchmove", (e)=> e.preventDefault(), {passive:false});

    /* =========================================================
       Minimal Audio Engine:
       - Tries to load files
       - If missing, falls back to synthesized SFX
       - BGM starts after first user tap (required by mobile)
       ========================================================= */
    class AudioEngine{
      constructor(){
        this.ctx = null;
        this.unlocked = false;
        this.buffers = new Map();
        this.bgmEl = null;
        this.bgmGain = 0.26;
        this.sfxGain = 0.70;
        this.master = null;
        this.sfxBus = null;
        this.bgmBus = null;
      }

      async init(){
        if (this.ctx) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        this.ctx = new AudioContext();
        this.master = this.ctx.createGain();
        this.master.gain.value = 0.85;
        this.master.connect(this.ctx.destination);

        this.sfxBus = this.ctx.createGain();
        this.sfxBus.gain.value = this.sfxGain;
        this.sfxBus.connect(this.master);

        this.bgmBus = this.ctx.createGain();
        this.bgmBus.gain.value = this.bgmGain;
        this.bgmBus.connect(this.master);

        // Attempt to prefetch SFX buffers
        const sfxKeys = ["click","paper","lock","success","wrong","whoosh"];
        await Promise.all(sfxKeys.map(k => this._tryLoadBuffer(k, CONFIG.audio[k])));
      }

      async unlock(){
        if (!this.ctx) await this.init();
        if (!this.ctx) return;

        if (this.ctx.state !== "running"){
          try{ await this.ctx.resume(); }catch(e){}
        }

        // "Warm-up" tiny silent beep
        this._beep(0.0001, 220, 0.01, 0.0);
        this.unlocked = true;

        // Start BGM if available
        this.startBGM();
      }

      async _tryLoadBuffer(key, url){
        if (!url) return;
        try{
          const res = await fetch(url, {cache:"force-cache"});
          if (!res.ok) return;
          const arr = await res.arrayBuffer();
          const buf = await this.ctx.decodeAudioData(arr);
          this.buffers.set(key, buf);
        }catch(e){
          // ignore
        }
      }

      _playBuffer(key, volume=1){
        if (!this.ctx || !this.unlocked) return false;
        const buf = this.buffers.get(key);
        if (!buf) return false;
        const src = this.ctx.createBufferSource();
        src.buffer = buf;

        const g = this.ctx.createGain();
        g.gain.value = volume;

        src.connect(g);
        g.connect(this.sfxBus);

        src.start();
        return true;
      }

      /* Synth SFX (cute/soft, not harsh) */
      _beep(vol, freq, dur, type=0){
        if (!this.ctx || !this.unlocked) return;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.type = type===0 ? "sine" : (type===1 ? "triangle" : "square");
        osc.frequency.value = freq;

        g.gain.value = 0;
        osc.connect(g);
        g.connect(this.sfxBus);

        const t0 = this.ctx.currentTime;
        g.gain.setValueAtTime(0, t0);
        g.gain.linearRampToValueAtTime(vol, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

        osc.start(t0);
        osc.stop(t0 + dur + 0.02);
      }

      sfx(name){
        // Try file buffer first; fallback to synth
        const ok = this._playBuffer(name, 1);

        if (ok) return;

        if (!this.unlocked) return;

        switch(name){
          case "click":
            this._beep(0.06, 520, 0.06, 1);
            this._beep(0.03, 760, 0.04, 0);
            break;
          case "paper":
            // soft rustle: quick filtered noise emulation via many tiny beeps
            this._beep(0.03, 240, 0.06, 1);
            this._beep(0.02, 310, 0.05, 1);
            this._beep(0.02, 420, 0.05, 1);
            break;
          case "lock":
            this._beep(0.06, 220, 0.08, 1);
            this._beep(0.05, 320, 0.10, 0);
            break;
          case "wrong":
            this._beep(0.05, 180, 0.10, 2);
            this._beep(0.04, 140, 0.10, 2);
            break;
          case "success":
            this._beep(0.06, 520, 0.08, 0);
            this._beep(0.05, 660, 0.10, 1);
            this._beep(0.04, 820, 0.12, 0);
            break;
          case "whoosh":
            this._beep(0.03, 240, 0.18, 1);
            this._beep(0.02, 180, 0.20, 1);
            break;
        }
      }

      async startBGM(){
        if (!this.unlocked) return;
        const url = CONFIG.audio.bgm;
        if (!url) return;

        // Use HTMLAudioElement for streaming
        if (!this.bgmEl){
          this.bgmEl = new Audio(url);
          this.bgmEl.loop = true;
          this.bgmEl.preload = "auto";
          this.bgmEl.volume = this.bgmGain;

          // On iOS, HTMLAudio volume is OK. If blocked, it will just fail quietly.
          try{ await this.bgmEl.play(); }catch(e){}
        } else {
          try{ await this.bgmEl.play(); }catch(e){}
        }
      }
    }

    const audio = new AudioEngine();

    /* =========================================================
       Loader / Preload images + first tap to unlock audio
       ========================================================= */
    const loader = $("loader");
    const barFill = $("barFill");
    const tapToStart = $("tapToStart");

    const PRELOAD = {
      total: 0,
      done: 0,
      setProgress(p){
        barFill.style.width = `${Math.round(p*100)}%`;
      }
    };

    async function preloadImages(urls){
      const unique = urls.filter(Boolean).slice(0,4);
      PRELOAD.total += unique.length;

      const results = await Promise.all(unique.map((u)=>new Promise((resolve)=>{
        const img = new Image();
        img.decoding = "async";
        img.loading = "eager";
        img.onload = ()=>{ PRELOAD.done++; PRELOAD.setProgress(PRELOAD.done / PRELOAD.total); resolve({url:u, ok:true}); };
        img.onerror = ()=>{ PRELOAD.done++; PRELOAD.setProgress(PRELOAD.done / PRELOAD.total); resolve({url:u, ok:false}); };
        img.src = u;
      })));

      return results;
    }

    async function preload(){
      // We "preload" audio by just initializing context and trying to fetch SFX once unlocked.
      PRELOAD.total = 1; // baseline
      PRELOAD.done = 0;
      PRELOAD.setProgress(0);

      // Preload images
      const imgs = CONFIG.images.slice(0,4);
      PRELOAD.total = imgs.length + 1;

      await preloadImages(imgs);
      PRELOAD.done++;
      PRELOAD.setProgress(PRELOAD.done / PRELOAD.total);

      // After assets, show "tap to start"
      tapToStart.classList.add("show");
    }

    /* =========================================================
       Scene routing
       ========================================================= */
    const scenes = [
      { id:"scene1", el:$("scene1") },
      { id:"scene2", el:$("scene2") },
      { id:"scene3", el:$("scene3") },
    ];
    let sceneIndex = 0;

    function setBadge(i){
      $("sceneBadge").textContent = `–°—Ü–µ–Ω–∞ ${i+1}/3`;
    }
    function showScene(i){
      sceneIndex = clamp(i,0,2);
      scenes.forEach((s, idx)=> s.el.classList.toggle("active", idx===sceneIndex));
      setBadge(sceneIndex);
    }

    /* =========================================================
       Physics-y rotation controller (touch drag with inertia)
       ========================================================= */
    class InertialRotator{
      constructor(el){
        this.el = el;
        this.active = false;
        this.dragging = false;

        this.rotX = 10; // degrees
        this.rotY = -18;

        this.vx = 0; // deg/s
        this.vy = 0;

        this.maxSpeed = 240; // deg/s
        this.damping = 10.5; // higher = more damping
        this.spring = 42; // return to gentle X range
        this.xMin = -18;
        this.xMax = 28;

        this.lastT = 0;

        this._px = 0;
        this._py = 0;

        this._raf = null;

        this._onDown = (e)=> this.onDown(e);
        this._onMove = (e)=> this.onMove(e);
        this._onUp = (e)=> this.onUp(e);

        this.enable();
      }

      enable(){
        if (this.active) return;
        this.active = true;
        this.el.addEventListener("pointerdown", this._onDown, {passive:false});
        window.addEventListener("pointermove", this._onMove, {passive:false});
        window.addEventListener("pointerup", this._onUp, {passive:false});
        window.addEventListener("pointercancel", this._onUp, {passive:false});
        this.lastT = now();
        this.loop();
      }

      disable(){
        this.active = false;
        this.dragging = false;
        this.el.removeEventListener("pointerdown", this._onDown);
        window.removeEventListener("pointermove", this._onMove);
        window.removeEventListener("pointerup", this._onUp);
        window.removeEventListener("pointercancel", this._onUp);
        if (this._raf) cancelAnimationFrame(this._raf);
        this._raf = null;
      }

      reset(){
        this.rotX = 10;
        this.rotY = -18;
        this.vx = 0;
        this.vy = 0;
        this.apply();
      }

      onDown(e){
        if (!this.active) return;
        // Only primary pointer
        if (e.isPrimary === false) return;
        this.dragging = true;
        this.el.setPointerCapture?.(e.pointerId);
        this._px = e.clientX;
        this._py = e.clientY;
        this.vx = 0; this.vy = 0;
        audio.sfx("click");
      }

      onMove(e){
        if (!this.dragging) return;
        const dx = e.clientX - this._px;
        const dy = e.clientY - this._py;
        this._px = e.clientX;
        this._py = e.clientY;

        // Pixels -> degrees
        const scale = 0.22;
        this.rotY += dx * scale;
        this.rotX -= dy * scale;

        // Add velocity (deg/s approximation)
        // We'll compute in loop using delta time; here store instantaneous
        const instantVX = (-dy * scale) * 60;
        const instantVY = (dx * scale) * 60;
        this.vx = clamp(lerp(this.vx, instantVX, 0.35), -this.maxSpeed, this.maxSpeed);
        this.vy = clamp(lerp(this.vy, instantVY, 0.35), -this.maxSpeed, this.maxSpeed);

        // Soft clamp X with elasticity
        if (this.rotX < this.xMin) this.rotX = lerp(this.rotX, this.xMin, 0.35);
        if (this.rotX > this.xMax) this.rotX = lerp(this.rotX, this.xMax, 0.35);

        this.apply();
      }

      onUp(e){
        if (!this.dragging) return;
        this.dragging = false;
        audio.sfx("paper");
      }

      loop(){
        if (!this.active) return;
        const t = now();
        const dt = Math.min(0.033, (t - this.lastT)/1000);
        this.lastT = t;

        if (!this.dragging){
          // Apply damping to velocities (exponential)
          const damp = Math.exp(-this.damping * dt);
          this.vx *= damp;
          this.vy *= damp;

          // Integrate
          this.rotX += this.vx * dt;
          this.rotY += this.vy * dt;

          // Spring X back into range
          if (this.rotX < this.xMin){
            const diff = (this.xMin - this.rotX);
            this.vx += diff * this.spring * dt;
          } else if (this.rotX > this.xMax){
            const diff = (this.xMax - this.rotX);
            this.vx += diff * this.spring * dt;
          }

          // Keep speed bounded
          this.vx = clamp(this.vx, -this.maxSpeed, this.maxSpeed);
          this.vy = clamp(this.vy, -this.maxSpeed, this.maxSpeed);

          // tiny snap to still
          if (Math.abs(this.vx) < 0.02) this.vx = 0;
          if (Math.abs(this.vy) < 0.02) this.vy = 0;

          if (this.vx !== 0 || this.vy !== 0){
            this.apply();
          }
        }

        this._raf = requestAnimationFrame(()=>this.loop());
      }

      apply(){
        // slight perspective / depth
        this.el.style.transform =
          `rotateX(${this.rotX.toFixed(2)}deg) rotateY(${this.rotY.toFixed(2)}deg)`;
      }
    }

    /* =========================================================
       Reel (slot) controller with touch drag & snapping
       ========================================================= */
    class Reel{
      constructor(rootEl, listEl, values, formatter){
        this.root = rootEl;
        this.list = listEl;
        this.values = values;
        this.formatter = formatter || ((v)=>String(v));
        this.index = 0;

        this.offset = 0;   // px offset (positive pushes down)
        this.velocity = 0; // px/s
        this.dragging = false;

        this.itemGap = 18;
        this.itemH = 24; // approximate, will measure
        this.centerY = 0;

        this.maxVel = 1800;
        this.damping = 12;
        this.snapK = 85;

        this._py = 0;
        this._lastT = now();
        this._raf = null;

        this.populate();
        this.measure();

        this._down = (e)=>this.onDown(e);
        this._move = (e)=>this.onMove(e);
        this._up = (e)=>this.onUp(e);

        this.root.addEventListener("pointerdown", this._down, {passive:false});
        window.addEventListener("pointermove", this._move, {passive:false});
        window.addEventListener("pointerup", this._up, {passive:false});
        window.addEventListener("pointercancel", this._up, {passive:false});

        this.render();
        this.loop();
      }

      populate(){
        this.list.innerHTML = "";
        // We render 7 visible items around the current
        for (let i=0;i<9;i++){
          const div = document.createElement("div");
          div.className = "reelItem";
          div.textContent = "";
          this.list.appendChild(div);
        }
      }

      measure(){
        // Use first element height if available
        const first = this.list.querySelector(".reelItem");
        if (first){
          const r = first.getBoundingClientRect();
          if (r.height > 0) this.itemH = r.height;
        }
      }

      setIndex(idx, quiet=false){
        const n = this.values.length;
        this.index = ((idx % n) + n) % n;
        if (!quiet) audio.sfx("click");
        this.offset = 0;
        this.velocity = 0;
        this.render();
      }

      getValue(){
        return this.values[this.index];
      }

      onDown(e){
        if (e.isPrimary === false) return;
        this.dragging = true;
        this.root.setPointerCapture?.(e.pointerId);
        this._py = e.clientY;
        this.velocity = 0;
        audio.sfx("click");
      }

      onMove(e){
        if (!this.dragging) return;
        const dy = e.clientY - this._py;
        this._py = e.clientY;

        this.offset += dy;
        // Update velocity approximate
        this.velocity = clamp(lerp(this.velocity, dy * 60, 0.35), -this.maxVel, this.maxVel);

        // When offset exceeds one step, change index and wrap offset
        const step = this.itemH + this.itemGap;
        while (this.offset > step){
          this.offset -= step;
          this.index = (this.index - 1 + this.values.length) % this.values.length; // dragging down -> previous
          audio.sfx("paper");
        }
        while (this.offset < -step){
          this.offset += step;
          this.index = (this.index + 1) % this.values.length; // dragging up -> next
          audio.sfx("paper");
        }

        this.render();
      }

      onUp(){
        if (!this.dragging) return;
        this.dragging = false;
        audio.sfx("paper");
      }

      loop(){
        const t = now();
        const dt = Math.min(0.033, (t - this._lastT)/1000);
        this._lastT = t;

        if (!this.dragging){
          // integrate inertia
          const damp = Math.exp(-this.damping * dt);
          this.velocity *= damp;
          this.offset += this.velocity * dt;

          // Apply index changes for big offset
          const step = this.itemH + this.itemGap;
          while (this.offset > step){
            this.offset -= step;
            this.index = (this.index - 1 + this.values.length) % this.values.length;
          }
          while (this.offset < -step){
            this.offset += step;
            this.index = (this.index + 1) % this.values.length;
          }

          // Snap offset to 0 with spring
          const snapForce = -this.offset * this.snapK;
          this.velocity += snapForce * dt;

          if (Math.abs(this.offset) < 0.4 && Math.abs(this.velocity) < 8){
            this.offset = 0;
            this.velocity = 0;
          }

          this.render();
        }

        this._raf = requestAnimationFrame(()=>this.loop());
      }

      render(){
        const items = [...this.list.children];
        // For 9 items: center is 4
        const center = 4;
        const n = this.values.length;

        for (let i=0;i<items.length;i++){
          const rel = i - center;
          const idx = (this.index + rel + n) % n;
          items[i].textContent = this.formatter(this.values[idx]);

          // visual dimming
          if (Math.abs(rel) >= 3) items[i].classList.add("dim");
          else items[i].classList.remove("dim");
        }

        this.list.style.transform = `translateY(${this.offset}px)`;
      }
    }

    /* =========================================================
       FX particles (hearts + confetti) ‚Äî lightweight canvas
       ========================================================= */
    class FX{
      constructor(canvas){
        this.c = canvas;
        this.ctx = canvas.getContext("2d");
        this.w = 0; this.h = 0;
        this.dpr = Math.min(2, window.devicePixelRatio || 1);

        this.particles = [];
        this.active = false;

        this._last = now();
        this._raf = null;

        this.resize = ()=> this.onResize();
        window.addEventListener("resize", this.resize, {passive:true});
        this.onResize();
      }

      onResize(){
        const r = this.c.getBoundingClientRect();
        this.w = Math.max(1, Math.floor(r.width));
        this.h = Math.max(1, Math.floor(r.height));
        this.c.width = Math.floor(this.w * this.dpr);
        this.c.height = Math.floor(this.h * this.dpr);
        this.ctx.setTransform(this.dpr,0,0,this.dpr,0,0);
      }

      burst(kind="hearts"){
        // spawn particles near center
        const count = kind==="hearts" ? 34 : 48;
        const max = CONFIG.maxParticles;
        const cx = this.w * 0.5;
        const cy = this.h * 0.42;

        for (let i=0;i<count;i++){
          if (this.particles.length >= max) break;

          const a = (Math.random() * Math.PI * 2);
          const sp = (kind==="hearts" ? (90 + Math.random()*220) : (120 + Math.random()*260));
          const vx = Math.cos(a)*sp;
          const vy = Math.sin(a)*sp - (kind==="hearts" ? 160 : 120);

          this.particles.push({
            x: cx + (Math.random()*24-12),
            y: cy + (Math.random()*24-12),
            vx, vy,
            g: kind==="hearts" ? 620 : 720,
            life: 1,
            rot: Math.random()*Math.PI*2,
            vr: (Math.random()*2-1)*6,
            s: kind==="hearts" ? (10 + Math.random()*10) : (7 + Math.random()*7),
            kind
          });
        }

        this.active = true;
        if (!this._raf) this.loop();
      }

      loop(){
        const t = now();
        const dt = Math.min(0.033, (t-this._last)/1000);
        this._last = t;

        this.ctx.clearRect(0,0,this.w,this.h);

        for (let i=this.particles.length-1;i>=0;i--){
          const p = this.particles[i];
          p.vy += p.g * dt;
          p.x += p.vx * dt;
          p.y += p.vy * dt;
          p.rot += p.vr * dt;
          p.life -= dt * (p.kind==="hearts" ? 0.55 : 0.72);

          const alpha = clamp(p.life, 0, 1);
          if (alpha <= 0 || p.y > this.h + 80){
            this.particles.splice(i,1);
            continue;
          }

          this.ctx.save();
          this.ctx.globalAlpha = alpha;

          // Simple shapes, no heavy gradients
          this.ctx.translate(p.x, p.y);
          this.ctx.rotate(p.rot);

          if (p.kind==="hearts"){
            this.drawHeart(0,0,p.s);
          } else {
            this.drawConfetti(0,0,p.s);
          }

          this.ctx.restore();
        }

        if (this.particles.length > 0){
          this._raf = requestAnimationFrame(()=>this.loop());
        } else {
          this._raf = null;
          this.active = false;
        }
      }

      drawHeart(x,y,s){
        const ctx = this.ctx;
        ctx.beginPath();
        const topCurveHeight = s * 0.3;
        ctx.moveTo(x, y + topCurveHeight);
        ctx.bezierCurveTo(x, y, x - s / 2, y, x - s / 2, y + topCurveHeight);
        ctx.bezierCurveTo(x - s / 2, y + (s + topCurveHeight) / 2, x, y + (s + topCurveHeight) / 1.2, x, y + s);
        ctx.bezierCurveTo(x, y + (s + topCurveHeight) / 1.2, x + s / 2, y + (s + topCurveHeight) / 2, x + s / 2, y + topCurveHeight);
        ctx.bezierCurveTo(x + s / 2, y, x, y, x, y + topCurveHeight);
        ctx.closePath();

        // Fill with a light pink-ish alpha (no fixed palette required; keep minimal)
        ctx.fillStyle = "rgba(255,179,199,.85)";
        ctx.fill();

        // soft outline
        ctx.strokeStyle = "rgba(0,0,0,.18)";
        ctx.lineWidth = 1;
        ctx.stroke();
      }

      drawConfetti(x,y,s){
        const ctx = this.ctx;
        ctx.beginPath();
        ctx.rect(x - s*0.6, y - s*0.3, s*1.2, s*0.6);
        ctx.fillStyle = "rgba(255,255,255,.72)";
        ctx.fill();
        ctx.strokeStyle = "rgba(0,0,0,.16)";
        ctx.lineWidth = 1;
        ctx.stroke();
      }
    }

    const fx = new FX($("fx"));

    /* =========================================================
       Scene 1 logic
       ========================================================= */
    const signModal = $("signModal");
    const courierText = $("courierText");
    const btnNo = $("btnNo");
    const btnYes = $("btnYes");
    let noUsed = false;

    function openSignModal(){
      signModal.classList.add("show");
    }
    function closeSignModal(){
      signModal.classList.remove("show");
    }

    btnNo.addEventListener("click", ()=>{
      audio.sfx("wrong");
      closeSignModal();
      noUsed = true;

      courierText.textContent = "–í—ã —á—Ç–æ, –±–∞–ª–±–µ—Å? –ù–∞ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –ø—Ä–æ—â–∞—é.";
      $("courierBubble").classList.add("shake");
      setTimeout(()=> $("courierBubble").classList.remove("shake"), 380);

      setTimeout(()=>{
        // Re-open but without "–ù–µ—Ç"
        openSignModal();
        btnNo.remove();
      }, 650);
    });

    btnYes.addEventListener("click", async ()=>{
      audio.sfx("click");
      audio.sfx("paper");
      closeSignModal();

      courierText.textContent = "–ü–æ–¥–ø–∏—Å—å –µ—Å—Ç—å. –ü–µ—Ä–µ–¥–∞—é –∫–æ—Ä–æ–±–∫—É‚Ä¶";
      // quick "handoff" animation: fade courier card by dimming scene center
      const centerCard = $("scene1").querySelector(".paperTex");
      centerCard.style.transition = "transform .55s cubic-bezier(.2,.8,.2,1), opacity .55s ease";
      centerCard.style.transform = "translateY(10px) scale(.98)";
      centerCard.style.opacity = ".0";

      setTimeout(()=>{
        showScene(1);
        // reset visuals
        centerCard.style.transform = "";
        centerCard.style.opacity = "";
      }, 620);
    });

    /* =========================================================
       Scene 2: box rotation + lock minigame
       ========================================================= */
    const box3d = $("box3d");
    const lockBtn = $("lockBtn");
    const lockModal = $("lockModal");
    const lockBack = $("lockBack");
    const lockDone = $("lockDone");
    const boxReset = $("boxReset");

    const boxRot = new InertialRotator(box3d);

    boxReset.addEventListener("click", ()=>{
      audio.sfx("click");
      boxRot.reset();
    });

    function openLock(){
      audio.sfx("lock");
      lockModal.classList.add("show");
      // disable box rotation when modal open
      boxRot.dragging = false;
      box3d.style.pointerEvents = "none";
    }
    function closeLock(){
      audio.sfx("paper");
      lockModal.classList.remove("show");
      box3d.style.pointerEvents = "auto";
    }

    lockBtn.addEventListener("click", ()=>{
      openLock();
    });

    lockBack.addEventListener("click", ()=>{
      closeLock();
    });

    // Reels setup
    const days = Array.from({length:31}, (_,i)=>i+1);
    const months = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
    const years = [2020,2021,2022,2023,2024,2025,2026];

    const reelDay = new Reel($("reels").querySelector('[data-reel="day"]'), $("reelDay"), days, (v)=>String(v));
    const reelMonth = new Reel($("reels").querySelector('[data-reel="month"]'), $("reelMonth"), months, (v)=>v);
    const reelYear = new Reel($("reels").querySelector('[data-reel="year"]'), $("reelYear"), years, (v)=>String(v));

    // Start at a plausible random-ish
    reelDay.setIndex(0, true);
    reelMonth.setIndex(0, true);
    reelYear.setIndex(0, true);

    function lockShake(){
      audio.sfx("wrong");
      const modal = lockModal.querySelector(".modal");
      modal.style.animation = "shake .35s ease";
      setTimeout(()=> modal.style.animation = "", 380);
    }

    async function unlockSequence(){
      audio.sfx("success");
      audio.sfx("lock");

      // Nice box "open" illusion: scale & fade lock pulse off, then transition to scene3
      lockBtn.style.animation = "none";
      lockBtn.style.transform = "translate(-50%,-50%) scale(.92)";
      lockBtn.style.opacity = ".0";

      closeLock();

      // small dramatic shake of the box
      box3d.animate([
        { transform: `${box3d.style.transform} translateZ(0)`, offset: 0 },
        { transform: `${box3d.style.transform} translateX(-4px)`, offset: 0.25 },
        { transform: `${box3d.style.transform} translateX(4px)`, offset: 0.55 },
        { transform: `${box3d.style.transform} translateX(0px)`, offset: 1 }
      ], { duration: 420, easing: "ease-out" });

      fx.burst("confetti");
      fx.burst("hearts");

      // "Open" by scaling box face
      const face = box3d.querySelector(".boxFace");
      face.animate([
        { transform: "scale(1)", filter: "brightness(1)" },
        { transform: "scale(1.02)", filter: "brightness(1.05)" },
        { transform: "scale(.92)", filter: "brightness(1.12)", opacity: 0.0 }
      ], { duration: 780, easing: "cubic-bezier(.2,.8,.2,1)" });

      audio.sfx("whoosh");

      setTimeout(()=>{
        // move to scene 3
        showScene(2);

        // restore lock for possible restart
        lockBtn.style.opacity = "";
        lockBtn.style.transform = "";
        lockBtn.style.animation = "pulse 1.25s infinite ease-in-out";
      }, 760);
    }

    lockDone.addEventListener("click", ()=>{
      audio.sfx("click");
      const day = reelDay.getValue();
      const month = reelMonth.getValue();
      const year = reelYear.getValue();

      const ok = (
        day === CONFIG.lockCode.day &&
        months.indexOf(month) === CONFIG.lockCode.monthIndex &&
        year === CONFIG.lockCode.year
      );

      if (!ok){
        lockShake();
        return;
      }

      unlockSequence();
    });

    /* =========================================================
       Scene 3: envelope rotation + throw/open + date check + final
       ========================================================= */
    const env3d = $("env3d");
    const sealBtn = $("sealBtn");
    const throwBtn = $("throwBtn");
    const openBtn = $("openBtn");
    const envButtons = $("envButtons");

    const dateModal = $("dateModal");
    const dateInput = $("dateInput");
    const dateCheck = $("dateCheck");
    const dateHint = $("dateHint");
    const dateCancel = $("dateCancel");

    const finalModal = $("finalModal");
    const restart = $("restart");

    const envRot = new InertialRotator(env3d);

    function toast(text){
      const b = $("envBubble");
      const prev = $("envBubble").querySelector(".txt").textContent;
      $("envBubble").querySelector(".txt").textContent = text;
      b.classList.add("shake");
      setTimeout(()=>b.classList.remove("shake"), 380);
      setTimeout(()=> $("envBubble").querySelector(".txt").textContent = prev, 1200);
    }

    let throwUsed = false;

    throwBtn.addEventListener("click", ()=>{
      audio.sfx("wrong");
      audio.sfx("paper");

      // shake everything slightly
      env3d.animate([
        { transform: `${env3d.style.transform}` },
        { transform: `${env3d.style.transform} translateX(-4px)` },
        { transform: `${env3d.style.transform} translateX(4px)` },
        { transform: `${env3d.style.transform}` }
      ], { duration: 360, easing:"ease-out" });

      toast("–©–∞—Å –ø–æ —à–µ–µ –ø–æ–ª—É—á–∏—à—å");

      // Replace button layout: "–û—Ç–∫—Ä—ã—Ç—å" pushes out "–í—ã–±—Ä–æ—Å–∏—Ç—å"
      if (!throwUsed){
        throwUsed = true;
        // animate: hide throw button, shift open button left
        throwBtn.classList.add("hidden");
        openBtn.animate([
          { transform: "translateX(0)" },
          { transform: "translateX(-14px)" },
          { transform: "translateX(0)" }
        ], { duration: 480, easing:"cubic-bezier(.2,.8,.2,1)" });

        setTimeout(()=>{
          // remove throw button from layout
          throwBtn.remove();
        }, 260);
      }
    });

    function openDateCheck(){
      audio.sfx("click");
      audio.sfx("paper");
      dateHint.textContent = "";
      dateModal.classList.add("show");
      env3d.style.pointerEvents = "none";
      envRot.dragging = false;

      // focus date input; on mobile it will open native picker
      setTimeout(()=>{ try{ dateInput.focus(); }catch(e){} }, 120);
    }

    function closeDateCheck(){
      audio.sfx("paper");
      dateModal.classList.remove("show");
      env3d.style.pointerEvents = "auto";
    }

    openBtn.addEventListener("click", ()=>{
      audio.sfx("whoosh");

      // camera "zoom" to seal
      env3d.animate([
        { transform: `${env3d.style.transform} scale(1)` },
        { transform: `${env3d.style.transform} scale(1.06)` }
      ], { duration: 520, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards" });

      setTimeout(()=>{
        // show date modal
        openDateCheck();
      }, 380);
    });

    dateCancel.addEventListener("click", ()=>{
      closeDateCheck();
      // zoom back a bit
      env3d.animate([
        { transform: `${env3d.style.transform} scale(1.06)` },
        { transform: `${env3d.style.transform} scale(1)` }
      ], { duration: 460, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards" });
    });

    function sealFail(){
      audio.sfx("wrong");
      sealBtn.classList.add("wiggle");
      setTimeout(()=>sealBtn.classList.remove("wiggle"), 380);
      dateHint.textContent = "–•–º‚Ä¶ –ø–æ—á—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ üòå";
      dateHint.style.color = "rgba(255,255,255,.78)";
    }

    function sealSuccess(){
      audio.sfx("success");
      audio.sfx("paper");
      closeDateCheck();

      // seal "slides off"
      sealBtn.animate([
        { transform: "translate(-50%,-50%) rotate(0deg)", opacity: 1 },
        { transform: "translate(-50%,-10%) rotate(16deg)", opacity: 0.0 }
      ], { duration: 620, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards" });

      // envelope open effect
      const flap = env3d.querySelector(".envFlap");
      flap.animate([
        { transform: "translateY(0) rotate(0deg)", opacity: .9 },
        { transform: "translateY(-8px) rotateX(55deg)", opacity: .78 }
      ], { duration: 680, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards" });

      fx.burst("hearts");
      setTimeout(()=>fx.burst("confetti"), 120);

      // show photos + letter
      setTimeout(()=>{
        showFinal();
      }, 680);
    }

    dateCheck.addEventListener("click", ()=>{
      audio.sfx("click");
      const v = dateInput.value; // yyyy-mm-dd
      if (!v){
        sealFail();
        return;
      }
      if (v !== CONFIG.fanBirthday){
        sealFail();
        return;
      }
      sealSuccess();
    });

    /* =========================================================
       Final modal: photos fade carousel
       ========================================================= */
    const photoEls = [ $("ph0"), $("ph1"), $("ph2"), $("ph3") ];
    const dots = $("dots");
    let galleryTimer = null;
    let galleryIndex = 0;
    let galleryUrls = [];

    function setupGallery(){
      galleryUrls = CONFIG.images.slice(0,4).filter(Boolean);
      // Assign src and keep hidden until shown
      for (let i=0;i<photoEls.length;i++){
        const el = photoEls[i];
        if (galleryUrls[i]){
          el.src = galleryUrls[i];
          el.style.display = "block";
          el.classList.remove("show");
        } else {
          el.removeAttribute("src");
          el.style.display = "none";
          el.classList.remove("show");
        }
      }

      dots.innerHTML = "";
      const n = galleryUrls.length;
      for (let i=0;i<n;i++){
        const d = document.createElement("div");
        d.className = "dot" + (i===0 ? " on" : "");
        dots.appendChild(d);
      }
      galleryIndex = 0;
      showPhoto(0);

      if (galleryTimer) clearInterval(galleryTimer);
      if (n > 1){
        galleryTimer = setInterval(()=>{
          showPhoto((galleryIndex+1) % n);
        }, 2700);
      }
    }

    function showPhoto(i){
      const n = galleryUrls.length;
      if (!n) return;
      galleryIndex = i;

      for (let k=0;k<photoEls.length;k++){
        photoEls[k].classList.toggle("show", k===i);
      }
      const dotEls = [...dots.children];
      dotEls.forEach((d, idx)=> d.classList.toggle("on", idx===i));
    }

    function showFinal(){
      audio.sfx("success");
      finalModal.classList.add("show");
      setupGallery();

      // gentle "settle" feeling
      const letter = $("letter");
      letter.animate([
        { transform: "translateY(10px) scale(.99)", opacity: 0.0 },
        { transform: "translateY(0px) scale(1)", opacity: 1.0 }
      ], { duration: 680, easing:"cubic-bezier(.2,.8,.2,1)", fill:"forwards" });
    }

    /* =========================================================
       Restart
       ========================================================= */
    restart.addEventListener("click", ()=>{
      audio.sfx("click");
      // stop gallery
      if (galleryTimer) clearInterval(galleryTimer);
      galleryTimer = null;

      // reset UI
      finalModal.classList.remove("show");
      dateModal.classList.remove("show");

      // reset buttons
      if (!document.getElementById("throwBtn")){
        // If removed, recreate it for a clean restart
        const btn = document.createElement("button");
        btn.className = "btn danger wide";
        btn.id = "throwBtn";
        btn.textContent = "–í—ã–±—Ä–æ—Å–∏—Ç—å";
        envButtons.prepend(btn);

        // rewire handler
        btn.addEventListener("click", ()=>{
          audio.sfx("wrong");
          audio.sfx("paper");
          env3d.animate([
            { transform: `${env3d.style.transform}` },
            { transform: `${env3d.style.transform} translateX(-4px)` },
            { transform: `${env3d.style.transform} translateX(4px)` },
            { transform: `${env3d.style.transform}` }
          ], { duration: 360, easing:"ease-out" });
          toast("–©–∞—Å –ø–æ —à–µ–µ –ø–æ–ª—É—á–∏—à—å");

          if (!throwUsed){
            throwUsed = true;
            btn.classList.add("hidden");
            openBtn.animate([
              { transform: "translateX(0)" },
              { transform: "translateX(-14px)" },
              { transform: "translateX(0)" }
            ], { duration: 480, easing:"cubic-bezier(.2,.8,.2,1)" });

            setTimeout(()=> btn.remove(), 260);
          }
        });
      }
      throwUsed = false;

      // reset seal + flap
      sealBtn.style.transform = "translate(-50%,-50%)";
      sealBtn.style.opacity = "1";
      sealBtn.getAnimations().forEach(a=>a.cancel());

      const flap = env3d.querySelector(".envFlap");
      flap.style.transform = "none";
      flap.style.opacity = ".9";
      flap.getAnimations().forEach(a=>a.cancel());

      // reset env scale
      env3d.style.transform = `rotateX(${envRot.rotX}deg) rotateY(${envRot.rotY}deg)`;
      env3d.getAnimations().forEach(a=>a.cancel());

      // reset lock visuals
      lockBtn.style.animation = "pulse 1.25s infinite ease-in-out";
      lockBtn.style.opacity = "";
      lockBtn.style.transform = "";

      // reset rotators
      boxRot.reset();
      envRot.reset();

      // reset reels to start
      reelDay.setIndex(0, true);
      reelMonth.setIndex(0, true);
      reelYear.setIndex(0, true);

      // reset signature modal
      // easiest: reload scene 1 UI state (keep current DOM changes)
      location.reload();
    });

    /* =========================================================
       Boot
       ========================================================= */
    function setDefaultDateConstraints(){
      // Nice UX: set min/max around 2000..2010 for picker, but allow any if you want.
      dateInput.min = "1998-01-01";
      dateInput.max = "2010-12-31";
      // don‚Äôt auto-fill; user must choose
      dateInput.value = "";
    }

    function startApp(){
      // Start with scene 1 and show modal
      showScene(0);
      setDefaultDateConstraints();

      // open signature modal after short beat
      setTimeout(()=> openSignModal(), 420);
    }

    // Tap anywhere on loader to unlock audio + hide loader
    async function onFirstTap(){
      loader.removeEventListener("pointerdown", onFirstTap);
      audio.sfx("click");
      await audio.unlock(); // unlock + start bgm
      loader.classList.add("hide");
      setTimeout(()=> loader.style.display="none", 520);
      startApp();
    }

    (async ()=>{
      await preload();
      // prepare audio context in advance (won't play until unlock)
      try{ await audio.init(); }catch(e){}
      loader.addEventListener("pointerdown", onFirstTap, {passive:true});
    })();

    /* =========================================================
       Telegram WebView niceties (safe no-op)
       ========================================================= */
    // Prevent accidental double-tap zoom on iOS
    let lastTouchEnd = 0;
    document.addEventListener("touchend", (e)=>{
      const t = Date.now();
      if (t - lastTouchEnd <= 280) e.preventDefault();
      lastTouchEnd = t;
    }, {passive:false});
  </script>
</body>
</html>
