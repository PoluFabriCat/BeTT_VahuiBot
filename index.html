<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#f2e9dc" />
  <title>–î–ª—è –î–∂–∞–º—ã üíå</title>
  <style>
    /* =======================
       Lightweight "paper/pixel" Valentine SPA (Telegram WebView)
       One-file: index.html
       Assets expected next to index.html:
       Images/photo1.jpg ... photo4.jpg (3-4 photos)
       Images/tex_paper.jpg (optional)
       Images/box.png, Images/lock.png, Images/envelope.png, Images/seal.png (optional, will fallback to CSS)
       Audio/bgm.mp3  (Je te laisserai des mots - user-owned)
       Audio/click.mp3, Audio/woosh.mp3, Audio/lock.mp3, Audio/error.mp3, Audio/success.mp3 (optional)
       ======================= */

    :root{
      --bg:#f2e9dc;
      --ink:#2a2320;
      --muted:#6f625a;
      --paper:#f7f0e6;
      --paper2:#efe2d2;
      --accent:#d75d6a;
      --accent2:#ff9aa7;
      --good:#2f8f5b;
      --bad:#bf3d3d;

      --radius:18px;
      --radius2:22px;

      --shadow: 0 10px 30px rgba(0,0,0,.10);
      --shadowSoft: 0 6px 18px rgba(0,0,0,.08);

      --ease: cubic-bezier(.2,.9,.2,1);
      --ease2: cubic-bezier(.2,.8,.2,1);

      --safeTop: env(safe-area-inset-top);
      --safeBot: env(safe-area-inset-bottom);

      --pixel: 1px; /* used for scanlines */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg);
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: none; /* we handle gestures */
    }

    /* Subtle paper texture + cute CRT grain */
    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 900px at 70% 0%, rgba(215,93,106,.10), transparent 55%),
        radial-gradient(1000px 700px at 20% 100%, rgba(255,154,167,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.20)),
        linear-gradient(0deg, rgba(0,0,0,.03), rgba(0,0,0,0));
      overflow:hidden;
    }
    .bg::before{
      content:"";
      position:absolute; inset:-30px;
      background-image:
        url("Images/tex_paper.jpg");
      background-size: cover;
      background-position:center;
      opacity:.14;
      filter: saturate(.9) contrast(1.05);
      transform: translateZ(0);
      pointer-events:none;
    }
    .bg::after{
      /* scanlines + mild pixel CRT */
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          180deg,
          rgba(0,0,0,.035),
          rgba(0,0,0,.035) var(--pixel),
          rgba(255,255,255,0) calc(var(--pixel) * 2),
          rgba(255,255,255,0) calc(var(--pixel) * 5)
        ),
        radial-gradient(900px 700px at 50% 40%, rgba(0,0,0,.06), transparent 60%);
      opacity:.35;
      mix-blend-mode:multiply;
      pointer-events:none;
      transform: translateZ(0);
    }

    /* Root app layout */
    #app{
      position:fixed; inset:0;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding: max(14px, var(--safeTop)) 14px max(14px, var(--safeBot));
    }

    .stage{
      width:min(520px, 100%);
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;
      will-change: transform, opacity;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 8px 6px 0 6px;
      user-select:none;
    }

    .title{
      font-weight:700;
      letter-spacing:.2px;
      font-size: 15px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      background: rgba(255,255,255,.55);
      border:1px solid rgba(42,35,32,.08);
      border-radius: 999px;
      box-shadow: var(--shadowSoft);
      backdrop-filter: blur(2px);
    }

    .content{
      flex:1;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 8px 0 14px 0;
      overflow:hidden;
    }

    /* Paper card style */
    .card{
      width: 100%;
      max-width: 520px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.74)),
        radial-gradient(600px 300px at 30% 20%, rgba(215,93,106,.10), transparent 60%);
      border:1px solid rgba(42,35,32,.10);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 14px;
      position:relative;
      transform: translateZ(0);
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      border-radius: var(--radius2);
      background:
        radial-gradient(1000px 700px at 0% 0%, rgba(0,0,0,.03), transparent 45%),
        radial-gradient(800px 600px at 100% 100%, rgba(0,0,0,.04), transparent 50%);
      pointer-events:none;
      opacity:.8;
    }

    /* Buttons */
    .btnrow{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .btn{
      appearance:none; border:0;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.78);
      border:1px solid rgba(42,35,32,.12);
      color:var(--ink);
      font-weight:700;
      letter-spacing:.2px;
      min-width: 132px;
      box-shadow: 0 7px 16px rgba(0,0,0,.08);
      transform: translateZ(0);
      transition: transform 160ms var(--ease), background 160ms var(--ease), box-shadow 160ms var(--ease), opacity 220ms var(--ease);
      user-select:none;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateZ(0) scale(.98); box-shadow: 0 4px 10px rgba(0,0,0,.07); }
    .btn:hover{ background: rgba(255,255,255,.92); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(215,93,106,.22), rgba(215,93,106,.10)), rgba(255,255,255,.78);
      border-color: rgba(215,93,106,.25);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(191,61,61,.18), rgba(191,61,61,.06)), rgba(255,255,255,.78);
      border-color: rgba(191,61,61,.22);
    }
    .btn.icon{
      min-width:auto;
      padding: 10px 12px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn.disabled, .btn:disabled{
      opacity:.55;
      pointer-events:none;
    }

    /* Scene transitions */
    .scene{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 8px 10px 14px 10px;
      opacity:0;
      transform: translate3d(0,10px,0);
      pointer-events:none;
      transition: opacity 260ms var(--ease), transform 260ms var(--ease);
      will-change: opacity, transform;
    }
    .scene.active{
      opacity:1;
      transform: translate3d(0,0,0);
      pointer-events:auto;
    }

    /* Courier character panel */
    .courierWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      width:100%;
      max-width:520px;
    }
    .courier{
      width: 220px;
      height: 220px;
      border-radius: 28px;
      background:
        radial-gradient(90px 90px at 45% 35%, rgba(255,255,255,.75), rgba(255,255,255,.10) 70%),
        linear-gradient(180deg, rgba(42,35,32,.10), rgba(42,35,32,.03)),
        rgba(255,255,255,.55);
      border:1px solid rgba(42,35,32,.12);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
    }
    .courier::before{
      /* stylized silhouette (no logos) */
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(55px 70px at 55% 35%, rgba(42,35,32,.25), rgba(42,35,32,0) 70%),
        radial-gradient(95px 85px at 50% 70%, rgba(42,35,32,.22), rgba(42,35,32,0) 72%),
        linear-gradient(90deg, rgba(42,35,32,.06), rgba(42,35,32,0));
      opacity:.75;
      filter: contrast(1.06);
    }
    .bubble{
      width:100%;
      max-width:520px;
      padding: 12px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.74);
      border:1px solid rgba(42,35,32,.10);
      box-shadow: var(--shadowSoft);
      text-align:center;
      font-weight:700;
      user-select:none;
    }
    .sub{
      font-size: 13px;
      color:var(--muted);
      font-weight:600;
      margin-top:6px;
    }

    /* Modal (paper sheet) */
    .modal{
      position:fixed; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.16);
      opacity:0;
      pointer-events:none;
      transition: opacity 220ms var(--ease);
      will-change: opacity;
      z-index:30;
    }
    .modal.show{ opacity:1; pointer-events:auto; }
    .sheet{
      width:min(520px, 100%);
      border-radius: 24px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.76));
      border: 1px solid rgba(42,35,32,.12);
      box-shadow: 0 18px 50px rgba(0,0,0,.18);
      padding: 16px;
      position:relative;
      transform: translate3d(0,12px,0);
      transition: transform 220ms var(--ease);
    }
    .modal.show .sheet{ transform: translate3d(0,0,0); }

    .sheet h3{
      margin:0 0 8px 0;
      font-size: 16px;
      letter-spacing:.1px;
    }
    .sheet p{
      margin:0;
      color:var(--muted);
      font-weight:600;
      font-size: 13px;
      line-height:1.45;
    }

    /* 3D-ish object stage (GPU friendly: only transform) */
    .objArea{
      width: 100%;
      max-width: 520px;
      height: min(460px, 60vh);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      margin: 0 auto;
      perspective: 900px;
      perspective-origin: 50% 45%;
      transform: translateZ(0);
    }

    .obj{
      width:min(330px, 78vw);
      height:min(330px, 78vw);
      max-width: 340px;
      max-height: 340px;
      position:relative;
      transform-style:preserve-3d;
      will-change: transform;
      user-select:none;
      touch-action: none;
      image-rendering: pixelated; /* requested mild pixel feel */
      filter: saturate(1.02) contrast(1.03);
    }

    /* Box fallback art */
    .box{
      border-radius: 26px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.06)),
        repeating-linear-gradient(90deg, rgba(0,0,0,.03), rgba(0,0,0,.03) 6px, rgba(255,255,255,0) 6px, rgba(255,255,255,0) 12px),
        linear-gradient(180deg, #e8d0b6, #d9b997);
      border: 1px solid rgba(42,35,32,.16);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:absolute; inset:0;
      transform: translateZ(0);
    }
    .box::before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(90deg, rgba(42,35,32,.08), rgba(42,35,32,0) 45%),
        radial-gradient(180px 130px at 30% 20%, rgba(255,255,255,.20), transparent 70%);
      opacity:.8;
      pointer-events:none;
    }
    .label{
      position:absolute;
      left: 14px; right: 14px; top: 14px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.55);
      border:1px solid rgba(42,35,32,.12);
      font-weight:800;
      text-align:center;
      letter-spacing:.3px;
      box-shadow: var(--shadowSoft);
      transform: translateZ(40px);
      user-select:none;
    }

    .lockHotspot{
      position:absolute;
      left:50%;
      top:58%;
      width: 92px;
      height: 92px;
      transform: translate(-50%,-50%) translateZ(60px);
      border-radius: 22px;
      background: rgba(255,255,255,.45);
      border:1px solid rgba(215,93,106,.24);
      box-shadow: 0 10px 24px rgba(215,93,106,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform 160ms var(--ease), box-shadow 160ms var(--ease), background 160ms var(--ease);
      will-change: transform;
      overflow:hidden;
    }
    .lockHotspot:active{
      transform: translate(-50%,-50%) translateZ(60px) scale(.98);
    }
    .lockHotspot::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(70px 70px at 50% 45%, rgba(255,154,167,.35), transparent 60%),
        radial-gradient(70px 70px at 55% 55%, rgba(215,93,106,.22), transparent 65%);
      opacity:.9;
      pointer-events:none;
    }
    .lockIcon{
      width: 44px; height: 44px;
      opacity:.85;
      transform: translateZ(0);
      background-size: contain;
      background-repeat:no-repeat;
      background-position:center;
      filter: contrast(1.1);
    }
    .pulse{
      animation: pulse 1.35s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ box-shadow: 0 10px 24px rgba(215,93,106,.14); }
      50%{ box-shadow: 0 12px 30px rgba(215,93,106,.24); }
    }

    /* Envelope fallback */
    .envelope{
      position:absolute; inset:0;
      border-radius: 26px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.06)),
        linear-gradient(180deg, #f0d9df, #e3b7c1);
      border: 1px solid rgba(42,35,32,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateZ(0);
    }
    .envelope::before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(45deg, rgba(42,35,32,.06), transparent 55%),
        linear-gradient(-45deg, rgba(42,35,32,.06), transparent 55%),
        radial-gradient(150px 100px at 50% 25%, rgba(255,255,255,.22), transparent 70%);
      opacity:.9;
      pointer-events:none;
    }
    .sealSpot{
      position:absolute;
      left:50%;
      top:55%;
      width: 92px;
      height: 92px;
      transform: translate(-50%,-50%) translateZ(70px);
      border-radius: 26px;
      background: rgba(255,255,255,.45);
      border:1px solid rgba(215,93,106,.22);
      box-shadow: 0 10px 22px rgba(215,93,106,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .seal{
      width: 56px; height: 56px;
      border-radius: 18px;
      background:
        radial-gradient(18px 18px at 35% 35%, rgba(255,255,255,.55), rgba(255,255,255,0) 70%),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.04)),
        #d75d6a;
      border:1px solid rgba(42,35,32,.16);
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
      position:relative;
      transform: translateZ(0);
    }
    .seal::after{
      content:"‚ù§";
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      color: rgba(255,255,255,.92);
      font-weight:900;
      font-size: 22px;
      text-shadow: 0 2px 0 rgba(0,0,0,.10);
    }

    /* Drawer panels (mini games) */
    .panel{
      width:min(520px, 100%);
      border-radius: 24px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.76));
      border:1px solid rgba(42,35,32,.12);
      box-shadow: 0 16px 42px rgba(0,0,0,.16);
      padding: 14px;
    }
    .panel h3{
      margin:0 0 10px 0;
      font-size: 16px;
      letter-spacing:.1px;
    }
    .hint{
      font-size: 12px;
      color:var(--muted);
      font-weight:700;
      margin-top: 6px;
      line-height:1.35;
    }

    /* Lock wheels */
    .wheels{
      display:flex;
      gap: 10px;
      justify-content:center;
      align-items:stretch;
      margin: 12px 0 8px 0;
    }
    .wheel{
      flex:1;
      min-width: 0;
      height: 150px;
      border-radius: 18px;
      background: rgba(255,255,255,.65);
      border:1px solid rgba(42,35,32,.12);
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
      overflow:hidden;
      position:relative;
      touch-action: none;
    }
    .wheel::before{
      /* center highlight */
      content:"";
      position:absolute; left:0; right:0; top:50%;
      height: 46px;
      transform: translateY(-50%);
      background: linear-gradient(180deg, rgba(215,93,106,.14), rgba(215,93,106,.06));
      border-top:1px solid rgba(215,93,106,.14);
      border-bottom:1px solid rgba(215,93,106,.14);
      pointer-events:none;
      opacity:.95;
    }
    .wheelList{
      position:absolute; inset:0;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      justify-content:flex-start;
      will-change: transform;
      transform: translate3d(0,0,0);
    }
    .wheelItem{
      height: 46px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      letter-spacing:.2px;
      color: rgba(42,35,32,.78);
      text-transform: none;
      user-select:none;
    }
    .wheelItem.dim{
      color: rgba(42,35,32,.38);
      font-weight:800;
    }

    /* Calendar-style date input (simple custom) */
    .dateRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      margin-top: 10px;
      flex-wrap:wrap;
    }
    .field{
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.65);
      border:1px solid rgba(42,35,32,.12);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      min-width: 220px;
      font-weight:800;
      letter-spacing:.2px;
      user-select:none;
    }
    .field small{
      display:block;
      font-size: 11px;
      color:var(--muted);
      font-weight:700;
      margin-bottom: 6px;
      letter-spacing:.1px;
    }
    .field span{
      display:block;
      font-size: 14px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom: calc(18px + var(--safeBot));
      transform: translate3d(-50%, 14px, 0);
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.85);
      border:1px solid rgba(42,35,32,.12);
      box-shadow: 0 14px 34px rgba(0,0,0,.16);
      opacity:0;
      pointer-events:none;
      transition: transform 200ms var(--ease), opacity 200ms var(--ease);
      font-weight:900;
      letter-spacing:.2px;
      z-index:40;
      max-width:min(520px, calc(100vw - 28px));
      text-align:center;
    }
    .toast.show{
      opacity:1;
      transform: translate3d(-50%,0,0);
    }

    /* Shake animation */
    .shake{
      animation: shake 400ms var(--ease2);
    }
    @keyframes shake{
      0%{ transform: translate3d(0,0,0); }
      20%{ transform: translate3d(-6px,0,0); }
      40%{ transform: translate3d(6px,0,0); }
      60%{ transform: translate3d(-4px,0,0); }
      80%{ transform: translate3d(4px,0,0); }
      100%{ transform: translate3d(0,0,0); }
    }

    /* Preloader */
    .preloader{
      position:fixed; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index:50;
      background: linear-gradient(180deg, rgba(242,233,220,.98), rgba(242,233,220,.92));
      opacity:1;
      transition: opacity 320ms var(--ease);
    }
    .preloader.hide{ opacity:0; pointer-events:none; }
    .preCard{
      width:min(520px, 100%);
      padding: 16px;
      border-radius: 24px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
      border:1px solid rgba(42,35,32,.12);
      box-shadow: 0 20px 50px rgba(0,0,0,.16);
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .preTitle{
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.2px;
      margin: 0 0 6px 0;
    }
    .preText{
      margin:0;
      color:var(--muted);
      font-weight:700;
      font-size: 13px;
      line-height:1.4;
    }
    .bar{
      margin-top: 14px;
      height: 12px;
      background: rgba(42,35,32,.08);
      border-radius: 999px;
      overflow:hidden;
      border:1px solid rgba(42,35,32,.10);
    }
    .bar > i{
      display:block;
      height:100%;
      width: 10%;
      background: linear-gradient(90deg, rgba(215,93,106,.55), rgba(255,154,167,.55));
      border-radius: 999px;
      transform: translate3d(0,0,0);
      transition: width 200ms var(--ease);
    }
    .tapHint{
      margin-top: 12px;
      font-size: 12px;
      color: rgba(42,35,32,.72);
      font-weight:800;
      opacity:.0;
      transform: translate3d(0,6px,0);
      transition: opacity 240ms var(--ease), transform 240ms var(--ease);
    }
    .tapHint.show{
      opacity:1;
      transform: translate3d(0,0,0);
    }

    /* Photos carousel */
    .photos{
      width: 100%;
      border-radius: 20px;
      overflow:hidden;
      border:1px solid rgba(42,35,32,.12);
      background: rgba(255,255,255,.55);
      box-shadow: var(--shadowSoft);
      height: 220px;
      position:relative;
      transform: translateZ(0);
    }
    .photo{
      position:absolute; inset:0;
      background-size: cover;
      background-position: center;
      opacity:0;
      transition: opacity 460ms var(--ease);
      will-change: opacity;
      transform: translateZ(0);
    }
    .photo.show{ opacity:1; }

    /* Final letter */
    .letter{
      margin-top: 12px;
      padding: 14px;
      border-radius: 22px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.80));
      border:1px dashed rgba(42,35,32,.18);
      box-shadow: var(--shadowSoft);
      position:relative;
      overflow:hidden;
    }
    .letter::before{
      /* "notebook" subtle lines */
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          180deg,
          rgba(42,35,32,.06),
          rgba(42,35,32,.06) 1px,
          rgba(255,255,255,0) 1px,
          rgba(255,255,255,0) 28px
        );
      opacity:.22;
      pointer-events:none;
    }
    .letter pre{
      position:relative;
      margin:0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      line-height: 1.55;
      font-weight: 800;
      color: rgba(42,35,32,.78);
      white-space: pre-wrap;
    }

    /* Particles canvas */
    canvas#fx{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:20;
      transform: translateZ(0);
    }

    /* Helpers */
    .fadeIn{
      animation: fadeIn 260ms var(--ease);
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translate3d(0,10px,0); }
      to{ opacity:1; transform: translate3d(0,0,0); }
    }
    .center{
      text-align:center;
    }
    .small{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
    }
  </style>
</head>

<body>
  <div class="bg"></div>
  <canvas id="fx"></canvas>

  <!-- Preloader -->
  <div class="preloader" id="preloader">
    <div class="preCard">
      <div class="preTitle">–û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Å—ã–ª–∫—É‚Ä¶</div>
      <p class="preText">–¢–µ–∫—Å—Ç—É—Ä—ã, —Ñ–æ—Ç–∫–∏ –∏ –∑–≤—É–∫ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è.<br/>–í–Ω—É—Ç—Ä–∏ –≤—Å—ë –±—É–¥–µ—Ç –ø–ª–∞–≤–Ω–æ –∏ ‚Äú—Ñ–∏–∑–∏—á–Ω–æ‚Äù.</p>
      <div class="bar"><i id="barFill"></i></div>
      <div class="tapHint" id="tapHint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É üéµ</div>
    </div>
  </div>

  <div id="app">
    <div class="stage">
      <div class="topbar">
        <div class="title">
          <span class="chip">üíå –î–ª—è –î–∂–∞–º—ã</span>
        </div>
        <button class="btn icon" id="soundBtn" aria-label="sound">
          üîä
        </button>
      </div>

      <div class="content">
        <!-- Scene 1 -->
        <section class="scene active" id="scene1">
          <div class="courierWrap">
            <div class="courier" aria-hidden="true"></div>
            <div class="bubble" id="courierBubble">
              –í–∞–º –ø–æ—Å—ã–ª–∫–∞ –æ—Ç —Ñ–∞–Ω–∞—Ç–∞ üòâ
              <div class="sub" id="courierSub">–ü–æ–¥–ø–∏—à–µ—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ?</div>
            </div>

            <div class="card">
              <div class="center small">
                –≠—Ç–æ –º–∏–Ω–∏-–∏–≥—Ä–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Telegram. –õ—É—á—à–µ –¥–µ—Ä–∂–∞—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ üì±
              </div>
              <div class="btnrow">
                <button class="btn primary" id="startSign">–ü–æ–¥–ø–∏—Å–∞—Ç—å</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Scene 2 -->
        <section class="scene" id="scene2">
          <div style="width:100%;max-width:520px;">
            <div class="objArea">
              <div class="obj" id="boxObj" aria-label="box">
                <div class="box" id="boxFace"></div>
                <div class="label">–¥–ª—è –î–∂–∞–º—ã</div>
                <div class="lockHotspot pulse" id="lockBtn" role="button" aria-label="lock">
                  <div class="lockIcon" id="lockIcon"></div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="center" style="font-weight:900;">
                –ü–æ–≤–µ—Ä–Ω–∏ –ø–æ—Å—ã–ª–∫—É –ø–∞–ª—å—Ü–µ–º. –ü–æ—Ç–æ–º –Ω–∞–∂–º–∏ –Ω–∞ –∑–∞–º–æ–∫.
              </div>
              <div class="hint center">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∫–æ–¥ ‚Äî –¥–∞—Ç–∞. –ù–æ –∫–∞–∫–∞—è? üòâ</div>
            </div>
          </div>
        </section>

        <!-- Scene 2 - Lock panel -->
        <section class="scene" id="scene2lock">
          <div class="panel" style="max-width:520px;">
            <h3>–ö–æ–¥–æ–≤—ã–π –∑–∞–º–æ–∫</h3>
            <div class="small">–°–≤–∞–π–ø–∞–π –∫–æ–ª—ë—Å–∏–∫–∏ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑. –ü–æ—Ç–æ–º –∂–º–∏ ‚Äú–ì–æ—Ç–æ–≤–æ‚Äù.</div>

            <div class="wheels" id="wheels">
              <div class="wheel" data-wheel="day"><div class="wheelList" id="wheelDay"></div></div>
              <div class="wheel" data-wheel="month"><div class="wheelList" id="wheelMonth"></div></div>
              <div class="wheel" data-wheel="year"><div class="wheelList" id="wheelYear"></div></div>
            </div>

            <div class="btnrow">
              <button class="btn" id="lockBack">–ù–∞–∑–∞–¥</button>
              <button class="btn primary" id="lockDone">–ì–æ—Ç–æ–≤–æ</button>
            </div>
            <div class="hint center">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥: <b>5 –Ω–æ—è–±—Ä—è 2025</b> (–Ω–æ —ç—Ç–æ ‚Äú—Å—é—Ä–ø—Ä–∏–∑‚Äù, –¥–∞ üòÑ)</div>
          </div>
        </section>

        <!-- Scene 3 -->
        <section class="scene" id="scene3">
          <div style="width:100%;max-width:520px;">
            <div class="objArea">
              <div class="obj" id="envObj" aria-label="envelope">
                <div class="envelope" id="envFace"></div>
                <div class="label">–¥–ª—è –î–∂–∞–º—ã</div>
                <div class="sealSpot" id="sealSpot">
                  <div class="seal" id="seal"></div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="center" style="font-weight:900;">–ö–æ–Ω–≤–µ—Ä—Ç —Å –ø–µ—á–∞—Ç—å—é. –ü–æ–≤–µ—Ä–Ω–∏ –µ–≥–æ, –ø–æ—Ç–æ–º —Ä–µ—à–∞–π üòà</div>
              <div class="btnrow" id="envButtons">
                <button class="btn danger" id="throwBtn">–í—ã–±—Ä–æ—Å–∏—Ç—å</button>
                <button class="btn primary" id="openBtn">–û—Ç–∫—Ä—ã—Ç—å</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Scene 3 - Birthday check -->
        <section class="scene" id="scene3check">
          <div class="panel" style="max-width:520px;">
            <h3>–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ñ–∞–Ω–∞—Ç–∞</h3>
            <div class="small">–ù–∞–∂–º–∏ –Ω–∞ –ø–æ–ª–µ ‚Äî –≤—ã–±–µ—Ä–∏ –¥–∞—Ç—É. –ó–∞—Ç–µ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –≥–∞–ª–æ—á–∫–æ–π.</div>

            <div class="dateRow">
              <div class="field" id="dateField" role="button" aria-label="date field">
                <small>–í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞</small>
                <span id="dateText">–Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
              </div>

              <button class="btn icon primary" id="checkDateBtn" aria-label="check">
                ‚úÖ
              </button>
            </div>

            <div class="hint center">–ü–æ–¥—Å–∫–∞–∑–∫–∞ –º—è–≥–∫–∞—è: —ç—Ç–æ <b>1 —Ñ–µ–≤—Ä–∞–ª—è 2005</b>.</div>

            <div class="btnrow">
              <button class="btn" id="checkBack">–ù–∞–∑–∞–¥</button>
            </div>
          </div>
        </section>

        <!-- Scene 4 - Finale -->
        <section class="scene" id="scene4">
          <div class="card" style="max-width:520px;">
            <div class="center" style="font-size:18px;font-weight:900;">–û—Ç–∫—Ä—ã—Ç–æ üíò</div>
            <div class="small center" style="margin-top:6px;">–¢—É—Ç –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ —Å–≤–æ–π ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π –±–ª–æ–∫ –Ω–∏–∂–µ.</div>

            <div class="photos" id="photos">
              <div class="photo" id="p0"></div>
              <div class="photo" id="p1"></div>
              <div class="photo" id="p2"></div>
              <div class="photo" id="p3"></div>
            </div>

            <div class="letter" id="letter">
              <pre id="loveText">–î–∂–∞–º–∞, –ø—Ä–∏–≤–µ—Ç üíå
–Ø –Ω–µ —É–º–µ—é –∫—Ä–∞—Å–∏–≤–æ –≥–æ–≤–æ—Ä–∏—Ç—å –≤—Å–ª—É—Ö,
–ø–æ—ç—Ç–æ–º—É —Å–ø—Ä—è—Ç–∞–ª —ç—Ç–æ –≤ –ø–æ—Å—ã–ª–∫–µ.

[–ó–î–ï–°–¨ –¢–í–û–ô –¢–ï–ö–°–¢ ‚Äî 6‚Äì10 –°–¢–†–û–ö]
–ù–∞–ø—Ä–∏–º–µ—Ä:
–¢—ã ‚Äî –º–æ–π —É—é—Ç, –º–æ–π —Å–º–µ—Ö –∏ –º–æ—è —É–¥–∞—á–∞.
–Ø —Ä—è–¥–æ–º ‚Äî –¥–∞–∂–µ –∫–æ–≥–¥–∞ –¥–∞–ª–µ–∫–æ.
–•–æ—á—É —á–∞—â–µ –≤–∏–¥–µ—Ç—å —Ç–≤–æ—é —É–ª—ã–±–∫—É.
–ò –¥–∞‚Ä¶ —ç—Ç–æ –≤—Å—ë –æ—Ç —Ñ–∞–Ω–∞—Ç–∞ üòâ</pre>
            </div>

            <div class="btnrow">
              <button class="btn" id="restartBtn">–ï—â—ë —Ä–∞–∑</button>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Signature modal -->
  <div class="modal" id="signModal" aria-hidden="true">
    <div class="sheet" id="signSheet">
      <h3>–í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ø–æ—Å—ã–ª–∫—É –æ—Ç —Ñ–∞–Ω–∞—Ç–∞?</h3>
      <p>–ü–æ–¥–ø–∏—Å—å –Ω—É–∂–Ω–∞ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ. –ù–æ –æ—Ç–∫–∞–∑‚Ä¶ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–∞—Å–µ–Ω.</p>
      <div class="btnrow" id="signButtons">
        <button class="btn danger" id="noBtn">–ù–µ—Ç</button>
        <button class="btn primary" id="yesBtn">–î–∞</button>
      </div>
    </div>
  </div>

  <!-- Hidden native date picker -->
  <input id="nativeDate" type="date" style="position:fixed; left:-9999px; top:-9999px; opacity:0;" />

  <div class="toast" id="toast"></div>

<script>
(() => {
  "use strict";

  /* ============================
     Utilities
  ============================ */
  const $ = (s, el=document) => el.querySelector(s);
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const lerp = (a,b,t) => a + (b-a)*t;
  const now = () => performance.now();

  function rafThrottle(fn){
    let queued = false;
    let lastArgs = null;
    return (...args) => {
      lastArgs = args;
      if (queued) return;
      queued = true;
      requestAnimationFrame(() => {
        queued = false;
        fn(...lastArgs);
      });
    };
  }

  /* ============================
     Telegram WebView small helpers
     (No dependency. If TG object exists we can expand.)
  ============================ */
  try{
    const tg = window.Telegram && window.Telegram.WebApp;
    if (tg){
      tg.ready();
      tg.expand();
      // tg.disableVerticalSwipes?.(); // optional, not always available
    }
  }catch(e){}

  /* ============================
     Asset config (edit filenames if needed)
  ============================ */
  const assets = {
    photos: [
      "Images/photo1.jpg",
      "Images/photo2.jpg",
      "Images/photo3.jpg",
      "Images/photo4.jpg"
    ],
    textures: [
      "Images/tex_paper.jpg",
      "Images/box.png",
      "Images/lock.png",
      "Images/envelope.png",
      "Images/seal.png"
    ],
    audio: {
      bgm: "Audio/bgm.mp3",
      click: "Audio/click.mp3",
      woosh: "Audio/woosh.mp3",
      lock: "Audio/lock.mp3",
      error: "Audio/error.mp3",
      success: "Audio/success.mp3"
    }
  };

  // Use only 3‚Äì4 photos max; if some missing, it will silently skip.
  // You can remove items or keep 4.

  /* ============================
     Preloader (images + audio warm-up)
  ============================ */
  const preloader = $("#preloader");
  const barFill = $("#barFill");
  const tapHint = $("#tapHint");

  let audioUnlocked = false;

  function loadImage(url){
    return new Promise((resolve) => {
      const img = new Image();
      img.decoding = "async";
      img.loading = "eager";
      img.onload = () => resolve({url, ok:true, img});
      img.onerror = () => resolve({url, ok:false, img:null});
      img.src = url;
    });
  }

  async function preloadAll(){
    const list = [
      ...assets.photos.slice(0,4),
      ...assets.textures
    ];
    const unique = Array.from(new Set(list));
    let done = 0;
    const total = unique.length || 1;

    const update = rafThrottle(() => {
      const pct = Math.round((done/total)*100);
      barFill.style.width = `${clamp(pct, 8, 100)}%`;
    });

    const results = [];
    for (const url of unique){
      // sequential keeps memory low & avoids burst on mobile webview
      const res = await loadImage(url);
      results.push(res);
      done++;
      update();
    }

    // Set icons if provided
    const lockUrl = assets.textures[2]; // Images/lock.png
    $("#lockIcon").style.backgroundImage = `url("${lockUrl}")`;

    return results;
  }

  /* ============================
     Audio engine (lightweight)
     - HTMLAudio for BGM + few SFX
     - Plays only after user gesture (WebView restriction)
  ============================ */
  const audio = {
    bgm: null,
    sfx: new Map(),
    enabled: true
  };

  function makeAudio(src, {loop=false, volume=1}={}){
    const a = new Audio();
    a.src = src;
    a.loop = loop;
    a.preload = "auto";
    a.volume = volume;
    a.playsInline = true;
    return a;
  }

  function initAudio(){
    // create but do not autoplay (needs gesture)
    audio.bgm = makeAudio(assets.audio.bgm, {loop:true, volume:0.18});

    for (const [k, src] of Object.entries(assets.audio)){
      if (k === "bgm") continue;
      audio.sfx.set(k, makeAudio(src, {loop:false, volume:0.55}));
    }
  }

  function unlockAudio(){
    if (audioUnlocked) return;
    audioUnlocked = true;
    try{
      // Tiny silent play trick
      const test = makeAudio(assets.audio.click, {loop:false, volume:0.01});
      test.play().then(() => {
        test.pause();
        test.currentTime = 0;
      }).catch(()=>{});
    }catch(e){}

    // Start BGM quietly
    if (audio.enabled){
      audio.bgm.play().catch(()=>{});
    }
    tapHint.classList.remove("show");
  }

  function playSfx(name){
    if (!audioUnlocked || !audio.enabled) return;
    const a = audio.sfx.get(name);
    if (!a) return;
    try{
      a.currentTime = 0;
      a.play().catch(()=>{});
    }catch(e){}
  }

  function setSoundEnabled(on){
    audio.enabled = on;
    $("#soundBtn").textContent = on ? "üîä" : "üîà";
    if (!audioUnlocked) return;
    if (on){
      audio.bgm.play().catch(()=>{});
    }else{
      audio.bgm.pause();
    }
  }

  /* ============================
     Scenes control
  ============================ */
  const scenes = {
    s1: $("#scene1"),
    s2: $("#scene2"),
    s2lock: $("#scene2lock"),
    s3: $("#scene3"),
    s3check: $("#scene3check"),
    s4: $("#scene4"),
  };

  function showScene(key){
    for (const [k, el] of Object.entries(scenes)){
      if (k === key) el.classList.add("active");
      else el.classList.remove("active");
    }
  }

  /* ============================
     Toast
  ============================ */
  const toast = $("#toast");
  let toastTimer = 0;
  function showToast(text, ms=1400){
    toast.textContent = text;
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove("show"), ms);
  }

  /* ============================
     FX: hearts/confetti particles (canvas)
     GPU-friendly drawing; only when needed
  ============================ */
  const fx = $("#fx");
  const ctx = fx.getContext("2d", {alpha:true});
  let W=0,H=0, DPR=1;

  function resizeFX(){
    DPR = Math.min(2, window.devicePixelRatio || 1);
    W = fx.width = Math.floor(innerWidth * DPR);
    H = fx.height = Math.floor(innerHeight * DPR);
    fx.style.width = innerWidth + "px";
    fx.style.height = innerHeight + "px";
  }
  window.addEventListener("resize", resizeFX, {passive:true});
  resizeFX();

  const particles = [];
  let fxRunning = false;

  function spawnBurst(x,y, count=40){
    for (let i=0;i<count;i++){
      const t = Math.random();
      particles.push({
        x, y,
        vx: (Math.random()*2-1) * (3 + Math.random()*5),
        vy: (Math.random()*-1) * (4 + Math.random()*6),
        g: 0.22 + Math.random()*0.12,
        life: 70 + Math.random()*40,
        r: 4 + Math.random()*4,
        kind: (t<0.55) ? "heart" : "dot",
        rot: Math.random()*Math.PI*2,
        vr: (Math.random()*2-1)*0.08,
        a: 1
      });
    }
    fxRunning = true;
  }

  function drawHeart(cx, cy, s, rot, alpha){
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(rot);
    ctx.globalAlpha = alpha;
    ctx.fillStyle = "rgba(215,93,106,.95)";
    ctx.beginPath();
    const k = s;
    // simple heart path
    ctx.moveTo(0, k*0.25);
    ctx.bezierCurveTo(k*0.5, -k*0.35, k*1.05, k*0.15, 0, k*0.85);
    ctx.bezierCurveTo(-k*1.05, k*0.15, -k*0.5, -k*0.35, 0, k*0.25);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function fxLoop(){
    if (!fxRunning) return;
    ctx.clearRect(0,0,W,H);

    let alive = 0;
    for (let i=0;i<particles.length;i++){
      const p = particles[i];
      p.life -= 1;
      if (p.life <= 0) continue;

      p.vy += p.g;
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;

      const fade = clamp(p.life/80, 0, 1);
      p.a = fade;

      const x = p.x * DPR;
      const y = p.y * DPR;

      if (p.kind === "heart"){
        drawHeart(x, y, p.r * DPR, p.rot, p.a);
      }else{
        ctx.globalAlpha = p.a;
        ctx.fillStyle = "rgba(255,154,167,.92)";
        ctx.beginPath();
        ctx.arc(x, y, (p.r*0.6)*DPR, 0, Math.PI*2);
        ctx.fill();
      }

      alive++;
    }

    // compact array
    if (alive === 0){
      particles.length = 0;
      fxRunning = false;
      ctx.clearRect(0,0,W,H);
      return;
    }else{
      // remove dead occasionally
      if (particles.length > alive + 30){
        const keep = [];
        for (const p of particles) if (p.life > 0) keep.push(p);
        particles.length = 0;
        particles.push(...keep);
      }
    }

    requestAnimationFrame(fxLoop);
  }

  /* ============================
     "Physical" drag rotation (inertia + damping + spring-ish clamp)
     - for box and envelope
     - Only transform updates, per rAF
  ============================ */
  function makeRotator(el, opts={}){
    const state = {
      rx: 0, ry: 0,     // current angles
      vx: 0, vy: 0,     // angular velocities
      tx: 0, ty: 0,     // target angles (for spring)
      dragging: false,
      lastX: 0, lastY: 0,
      lastT: 0
    };

    const conf = {
      maxSpeed: 1.6,     // clamp angular speed
      dragGain: 0.32,    // gesture sensitivity
      damp: 0.92,        // velocity damping
      spring: 0.16,      // pull to target
      maxTilt: 18,       // limit pitch (rx)
      ...opts
    };

    function applyTransform(){
      // rx limited for nicer look
      state.rx = clamp(state.rx, -conf.maxTilt, conf.maxTilt);
      el.style.transform = `rotateX(${state.rx}deg) rotateY(${state.ry}deg) translateZ(0)`;
    }

    function tick(){
      // spring towards target (adds "elastic")
      const ax = (state.tx - state.rx) * conf.spring;
      const ay = (state.ty - state.ry) * conf.spring;

      state.vx = (state.vx + ax) * conf.damp;
      state.vy = (state.vy + ay) * conf.damp;

      // clamp speed
      state.vx = clamp(state.vx, -conf.maxSpeed, conf.maxSpeed);
      state.vy = clamp(state.vy, -conf.maxSpeed, conf.maxSpeed);

      state.rx += state.vx;
      state.ry += state.vy;

      applyTransform();

      // stop when slow
      if (!state.dragging && (Math.abs(state.vx)+Math.abs(state.vy) < 0.02) && (Math.abs(state.tx-state.rx)+Math.abs(state.ty-state.ry) < 0.2)){
        return; // end loop
      }
      requestAnimationFrame(tick);
    }

    function startLoop(){
      requestAnimationFrame(tick);
    }

    function onDown(ev){
      unlockAudio();
      state.dragging = true;
      const p = getPoint(ev);
      state.lastX = p.x;
      state.lastY = p.y;
      state.lastT = now();
      // lock target to current to avoid jump
      state.tx = state.rx;
      state.ty = state.ry;
      startLoop();
      ev.preventDefault?.();
    }

    function onMove(ev){
      if (!state.dragging) return;
      const p = getPoint(ev);
      const t = now();
      const dt = Math.max(8, t - state.lastT); // ms
      const dx = p.x - state.lastX;
      const dy = p.y - state.lastY;

      state.lastX = p.x;
      state.lastY = p.y;
      state.lastT = t;

      // convert gesture to angle changes
      const g = conf.dragGain;
      state.ty += dx * g;     // yaw
      state.tx += -dy * g;    // pitch

      // velocity approximation
      const s = 16/dt;
      state.vy = clamp((dx * g) * s, -conf.maxSpeed, conf.maxSpeed);
      state.vx = clamp((-dy * g) * s, -conf.maxSpeed, conf.maxSpeed);
    }

    function onUp(){
      if (!state.dragging) return;
      state.dragging = false;
      // keep target where it is -> inertia carries then settles
      state.tx = state.rx;
      state.ty = state.ry;
    }

    el.addEventListener("pointerdown", onDown, {passive:false});
    window.addEventListener("pointermove", onMove, {passive:false});
    window.addEventListener("pointerup", onUp, {passive:true});
    window.addEventListener("pointercancel", onUp, {passive:true});

    function getPoint(ev){
      if (ev.touches && ev.touches[0]) return {x: ev.touches[0].clientX, y: ev.touches[0].clientY};
      return {x: ev.clientX, y: ev.clientY};
    }

    return {
      setAngles(rx, ry){
        state.rx = rx; state.ry = ry;
        state.tx = rx; state.ty = ry;
        applyTransform();
      }
    };
  }

  const boxRot = makeRotator($("#boxObj"), { maxTilt: 14, dragGain: 0.26, damp: 0.90, spring: 0.18, maxSpeed: 1.45 });
  const envRot = makeRotator($("#envObj"), { maxTilt: 16, dragGain: 0.28, damp: 0.90, spring: 0.18, maxSpeed: 1.55 });

  /* ============================
     Scene 2 lock wheels (swipe vertical)
  ============================ */
  const months = [
    "—è–Ω–≤–∞—Ä—è","—Ñ–µ–≤—Ä–∞–ª—è","–º–∞—Ä—Ç–∞","–∞–ø—Ä–µ–ª—è","–º–∞—è","–∏—é–Ω—è",
    "–∏—é–ª—è","–∞–≤–≥—É—Å—Ç–∞","—Å–µ–Ω—Ç—è–±—Ä—è","–æ–∫—Ç—è–±—Ä—è","–Ω–æ—è–±—Ä—è","–¥–µ–∫–∞–±—Ä—è"
  ];
  const correctLock = { day: 5, month: "–Ω–æ—è–±—Ä—è", year: 2025 };

  // Build wheel lists with some buffer items for smooth scroll illusion
  function buildWheel(el, values){
    el.innerHTML = "";
    // add padding items at top/bottom
    const pad = 3;
    for (let i=0;i<pad;i++){
      const d = document.createElement("div");
      d.className = "wheelItem dim";
      d.textContent = "¬∑";
      el.appendChild(d);
    }
    for (const v of values){
      const it = document.createElement("div");
      it.className = "wheelItem";
      it.textContent = v;
      el.appendChild(it);
    }
    for (let i=0;i<pad;i++){
      const d = document.createElement("div");
      d.className = "wheelItem dim";
      d.textContent = "¬∑";
      el.appendChild(d);
    }
  }

  const dayVals = Array.from({length:31}, (_,i)=> String(i+1));
  const yearVals = [];
  for (let y=2020;y<=2026;y++) yearVals.push(String(y));

  buildWheel($("#wheelDay"), dayVals);
  buildWheel($("#wheelMonth"), months);
  buildWheel($("#wheelYear"), yearVals);

  function makeWheel(wheelEl, values, initialIndex){
    const list = wheelEl.querySelector(".wheelList");
    const itemH = 46;
    const pad = 3;
    let idx = clamp(initialIndex, 0, values.length-1);
    let y = -(idx * itemH); // list translate
    let vy = 0;
    let dragging = false;
    let lastY = 0;
    let lastT = 0;
    let rafId = 0;

    function apply(){
      list.style.transform = `translate3d(0, ${y + pad*itemH}px, 0)`;
    }

    function snap(){
      const target = -(idx * itemH);
      y = lerp(y, target, 0.22);
      vy *= 0.72;
      if (Math.abs(y - target) < 0.5 && Math.abs(vy) < 0.08){
        y = target; vy = 0;
        apply();
        rafId = 0;
        return;
      }
      apply();
      rafId = requestAnimationFrame(snap);
    }

    function startSnap(){
      if (rafId) return;
      rafId = requestAnimationFrame(snap);
    }

    function onDown(ev){
      unlockAudio();
      dragging = true;
      lastY = (ev.touches && ev.touches[0]) ? ev.touches[0].clientY : ev.clientY;
      lastT = now();
      vy = 0;
      if (rafId){ cancelAnimationFrame(rafId); rafId=0; }
      ev.preventDefault?.();
    }
    function onMove(ev){
      if (!dragging) return;
      const cy = (ev.touches && ev.touches[0]) ? ev.touches[0].clientY : ev.clientY;
      const t = now();
      const dt = Math.max(8, t-lastT);
      const dy = cy - lastY;
      lastY = cy; lastT = t;

      y += dy * 0.95;
      // soft clamp beyond ends with rubber band
      const minY = -((values.length-1) * itemH);
      const maxY = 0;
      if (y > maxY) y = maxY + (y-maxY)*0.25;
      if (y < minY) y = minY + (y-minY)*0.25;

      vy = (dy / dt) * 16; // ~ per frame
      apply();
      ev.preventDefault?.();
    }
    function onUp(){
      if (!dragging) return;
      dragging = false;

      // inertia then snap
      const minY = -((values.length-1) * itemH);
      const maxY = 0;

      // project inertia quickly
      y += clamp(vy, -3.0, 3.0) * itemH * 0.55;
      y = clamp(y, minY, maxY);

      idx = clamp(Math.round(-y / itemH), 0, values.length-1);
      startSnap();
    }

    wheelEl.addEventListener("pointerdown", onDown, {passive:false});
    window.addEventListener("pointermove", onMove, {passive:false});
    window.addEventListener("pointerup", onUp, {passive:true});
    window.addEventListener("pointercancel", onUp, {passive:true});

    function setIndex(i){
      idx = clamp(i, 0, values.length-1);
      y = -(idx*itemH);
      apply();
    }
    function value(){
      return values[idx];
    }

    setIndex(idx);
    return { setIndex, value, getIndex:()=>idx };
  }

  // Default wheel positions
  const wheelDay = makeWheel($('[data-wheel="day"]'), dayVals, 4); // show 5 by default-ish
  const wheelMonth = makeWheel($('[data-wheel="month"]'), months, 10); // –Ω–æ—è–±—Ä—å
  const wheelYear = makeWheel($('[data-wheel="year"]'), yearVals, 5); // 2025

  /* ============================
     Photo carousel (fade)
  ============================ */
  const photoEls = [$("#p0"), $("#p1"), $("#p2"), $("#p3")];
  let photoUrls = assets.photos.slice(0,4);
  let photoIndex = 0;
  let photoTimer = 0;

  function startCarousel(){
    // assign backgrounds (only those that exist will show; missing will be black but still ok)
    photoEls.forEach((el, i) => {
      el.style.backgroundImage = `url("${photoUrls[i] || ""}")`;
      el.classList.remove("show");
    });
    photoIndex = 0;
    if (photoEls[0]) photoEls[0].classList.add("show");

    clearInterval(photoTimer);
    photoTimer = setInterval(() => {
      const next = (photoIndex + 1) % Math.max(1, photoUrls.length);
      if (photoEls[photoIndex]) photoEls[photoIndex].classList.remove("show");
      if (photoEls[next]) photoEls[next].classList.add("show");
      photoIndex = next;
    }, 2200);
  }

  /* ============================
     Scene logic
  ============================ */
  const signModal = $("#signModal");
  const signButtons = $("#signButtons");
  const courierBubble = $("#courierBubble");
  const courierSub = $("#courierSub");

  let noWasPressed = false;

  function openSign(){
    playSfx("woosh");
    signModal.classList.add("show");
    signModal.setAttribute("aria-hidden","false");
  }
  function closeSign(){
    signModal.classList.remove("show");
    signModal.setAttribute("aria-hidden","true");
  }

  $("#startSign").addEventListener("click", () => {
    unlockAudio();
    playSfx("click");
    openSign();
  });

  $("#noBtn").addEventListener("click", () => {
    unlockAudio();
    playSfx("error");
    closeSign();

    // Courier says the phrase, then modal returns without "–ù–µ—Ç"
    courierBubble.classList.add("fadeIn");
    courierBubble.textContent = "–í—ã —á—Ç–æ, –±–∞–ª–±–µ—Å? –ù–∞ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –ø—Ä–æ—â–∞—é.";
    courierSub.textContent = "";

    noWasPressed = true;

    setTimeout(() => {
      courierBubble.classList.remove("fadeIn");
      courierBubble.textContent = "–í–∞–º –ø–æ—Å—ã–ª–∫–∞ –æ—Ç —Ñ–∞–Ω–∞—Ç–∞ üòâ";
      courierSub.textContent = "–ü–æ–¥–ø–∏—à–µ—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ?";
      // remove "–ù–µ—Ç" button
      const noBtn = $("#noBtn");
      if (noBtn) noBtn.remove();
      openSign();
    }, 1200);
  });

  $("#yesBtn").addEventListener("click", () => {
    unlockAudio();
    playSfx("woosh");

    // Courier "hands over box": small fx + move to scene 2
    closeSign();
    courierBubble.classList.add("fadeIn");
    courierBubble.textContent = "–í–æ—Ç. –ë–µ—Ä–µ–≥–∏—Ç–µ üòå";
    courierSub.textContent = "";

    setTimeout(() => {
      playSfx("click");
      showScene("s2");
      boxRot.setAngles(0, -10);
    }, 520);
  });

  // Scene 2: lock button
  $("#lockBtn").addEventListener("click", (ev) => {
    unlockAudio();
    playSfx("click");
    // open lock mini game
    showScene("s2lock");
    // set wheels close to something
    // keep current wheel positions as is
  });

  $("#lockBack").addEventListener("click", () => {
    unlockAudio();
    playSfx("woosh");
    showScene("s2");
  });

  function lockSuccess(){
    // lock click + open box -> show envelope
    playSfx("success");
    const boxObj = $("#boxObj");
    boxObj.classList.add("shake");
    setTimeout(() => boxObj.classList.remove("shake"), 450);

    // pulse off
    $("#lockBtn").classList.remove("pulse");

    // transition to scene 3
    setTimeout(() => {
      showScene("s3");
      envRot.setAngles(0, 10);
      // small "burst"
      spawnBurst(innerWidth*0.5, innerHeight*0.45, 34);
      requestAnimationFrame(fxLoop);
    }, 520);
  }

  function lockFail(){
    playSfx("error");
    const panel = $("#scene2lock .panel");
    panel.classList.add("shake");
    setTimeout(()=>panel.classList.remove("shake"), 420);
  }

  $("#lockDone").addEventListener("click", () => {
    unlockAudio();
    playSfx("lock");
    const d = parseInt(wheelDay.value(), 10);
    const m = wheelMonth.value();
    const y = parseInt(wheelYear.value(), 10);

    if (d === correctLock.day && m === correctLock.month && y === correctLock.year){
      lockSuccess();
    }else{
      lockFail();
    }
  });

  // Scene 3: Throw/Open
  const envButtons = $("#envButtons");
  const throwBtn = $("#throwBtn");
  const openBtn = $("#openBtn");
  let throwPunished = false;

  throwBtn.addEventListener("click", () => {
    unlockAudio();
    playSfx("error");

    // Shake everything lightly
    $("#envObj").classList.add("shake");
    setTimeout(()=>$("#envObj").classList.remove("shake"), 420);

    showToast("–©–∞—Å –ø–æ —à–µ–µ –ø–æ–ª—É—á–∏—à—å", 1200);

    if (!throwPunished){
      throwPunished = true;

      // Replace layout: Open button slides left and "eats" Throw button
      // We'll animate by fading throw away and expanding open
      throwBtn.classList.add("disabled");
      throwBtn.style.opacity = "0";
      throwBtn.style.transform = "translate3d(0,0,0) scale(.95)";

      openBtn.style.minWidth = "280px";
      openBtn.style.transform = "translate3d(-10px,0,0)";
      openBtn.style.transition = "transform 260ms var(--ease), min-width 260ms var(--ease)";

      setTimeout(() => {
        throwBtn.remove();
        openBtn.style.transform = "translate3d(0,0,0)";
      }, 280);
    }
  });

  openBtn.addEventListener("click", () => {
    unlockAudio();
    playSfx("woosh");
    // "camera" zoom to seal -> go to date check
    showScene("s3check");
  });

  $("#checkBack").addEventListener("click", () => {
    unlockAudio();
    playSfx("woosh");
    showScene("s3");
  });

  // Date picker
  const nativeDate = $("#nativeDate");
  const dateField = $("#dateField");
  const dateText = $("#dateText");
  let chosenDate = null;

  dateField.addEventListener("click", () => {
    unlockAudio();
    playSfx("click");
    // open native picker (best for Telegram WebView)
    nativeDate.focus();
    nativeDate.click();
  });

  nativeDate.addEventListener("change", () => {
    if (!nativeDate.value) return;
    chosenDate = nativeDate.value; // YYYY-MM-DD
    // format RU
    const [yy, mm, dd] = chosenDate.split("-").map(n=>parseInt(n,10));
    const mName = months[(mm-1)] || "";
    dateText.textContent = `${dd} ${mName} ${yy}`;
  });

  function dateFail(){
    playSfx("error");
    const panel = $("#scene3check .panel");
    panel.classList.add("shake");
    setTimeout(()=>panel.classList.remove("shake"), 420);
    showToast("–•–º–º‚Ä¶ –ø–æ—á—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ üòå", 1400);
  }

  function dateSuccess(){
    playSfx("success");

    // seal "falls off" visual: just toast + fx burst + move to finale
    spawnBurst(innerWidth*0.5, innerHeight*0.42, 60);
    requestAnimationFrame(fxLoop);

    // small pause for drama
    setTimeout(() => {
      showScene("s4");
      startCarousel();
    }, 520);
  }

  $("#checkDateBtn").addEventListener("click", () => {
    unlockAudio();
    playSfx("click");

    // correct: 2005-02-01
    if (chosenDate === "2005-02-01"){
      dateSuccess();
    }else{
      dateFail();
    }
  });

  $("#restartBtn").addEventListener("click", () => {
    unlockAudio();
    playSfx("woosh");
    // reset state
    throwPunished = false;
    chosenDate = null;
    nativeDate.value = "";
    dateText.textContent = "–Ω–µ –≤—ã–±—Ä–∞–Ω–∞";
    // restore throw button if removed
    if (!$("#throwBtn")){
      const newThrow = document.createElement("button");
      newThrow.className = "btn danger";
      newThrow.id = "throwBtn";
      newThrow.textContent = "–í—ã–±—Ä–æ—Å–∏—Ç—å";
      envButtons.prepend(newThrow);

      // re-bind quickly
      newThrow.addEventListener("click", () => {
        unlockAudio();
        playSfx("error");
        $("#envObj").classList.add("shake");
        setTimeout(()=>$("#envObj").classList.remove("shake"), 420);
        showToast("–©–∞—Å –ø–æ —à–µ–µ –ø–æ–ª—É—á–∏—à—å", 1200);

        if (!throwPunished){
          throwPunished = true;
          newThrow.classList.add("disabled");
          newThrow.style.opacity = "0";
          newThrow.style.transform = "translate3d(0,0,0) scale(.95)";
          openBtn.style.minWidth = "280px";
          openBtn.style.transform = "translate3d(-10px,0,0)";
          openBtn.style.transition = "transform 260ms var(--ease), min-width 260ms var(--ease)";
          setTimeout(() => {
            newThrow.remove();
            openBtn.style.transform = "translate3d(0,0,0)";
          }, 280);
        }
      });
    }
    // restore open btn sizing
    openBtn.style.minWidth = "";
    openBtn.style.transform = "";
    openBtn.style.transition = "";

    // reset lock pulse
    $("#lockBtn").classList.add("pulse");

    // scene back to 1 or 2? We'll go to 1 for full loop
    showScene("s1");
  });

  // Sound toggle
  $("#soundBtn").addEventListener("click", () => {
    unlockAudio();
    playSfx("click");
    setSoundEnabled(!audio.enabled);
  });

  // Tap anywhere on preloader to unlock audio
  preloader.addEventListener("click", () => {
    unlockAudio();
    playSfx("click");
    // allow to hide preloader once loaded
    if (preloader.classList.contains("ready")){
      preloader.classList.add("hide");
    }
  });

  /* ============================
     Boot
  ============================ */
  initAudio();

  // If paper texture missing, bg::before will fail silently (ok).
  // Start preloading:
  (async () => {
    const results = await preloadAll();

    // Mark photos that actually loaded; shrink carousel list if needed
    const okPhotos = [];
    for (const u of assets.photos.slice(0,4)){
      const r = results.find(x => x.url === u);
      if (!r || r.ok) okPhotos.push(u); // if not found, keep anyway
    }
    // Keep at least 3 if possible; but don't exceed 4
    photoUrls = okPhotos.slice(0,4);
    // Fallback: if none, just keep original array
    if (photoUrls.length === 0) photoUrls = assets.photos.slice(0,4);

    // Make hint appear; user should tap to enable music
    tapHint.classList.add("show");

    // Ready to close preloader after first interaction
    preloader.classList.add("ready");
    barFill.style.width = "100%";

    // If user already interacted before preload finished, hide now
    if (audioUnlocked){
      preloader.classList.add("hide");
    }
  })();

  // Safety: prevent scroll rubber-banding in mobile webview
  document.addEventListener("touchmove", (e) => e.preventDefault(), {passive:false});

})();
</script>
</body>
</html>
